<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-03-21 Sun 00:03 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sacha Chua's Emacs configuration</title>
<meta name="author" content="Sacha Chua" />
<meta name="generator" content="Org Mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css"
       href="https://sachachua.com/blog/wp-content/themes/sacha-v3/foundation/css/foundation.min.css"></link>
       <link rel="stylesheet" type="text/css" href="https://sachachua.com/org-export.css"></link>
       <link rel="stylesheet" type="text/css" href="https://sachachua.com/blog/wp-content/themes/sacha-v3/style.css"></link>
       <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
       <script src="https://sachachua.com/blog/wp-content/themes/sacha-v3/misc.js"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="preamble" class="status">
<a name="top" id="top"></a>
</div>
<div id="content">
<h1 class="title">Sacha Chua's Emacs configuration</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org5532f7b">Configuration&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></a>
<ul>
<li><a href="#babel-init">About this file</a></li>
<li><a href="#org1b4f201">Starting up</a></li>
<li><a href="#orga0b4971">System information</a></li>
<li><a href="#org6794720">Personal information</a></li>
<li><a href="#orge37b9c5">Emacs initialization</a>
<ul>
<li><a href="#org84c2d5a">Add package sources</a></li>
<li><a href="#orgc970a2c">Add my elisp directory and other files</a></li>
</ul>
</li>
<li><a href="#org541c89e">General configuration</a>
<ul>
<li><a href="#org9b2666d">Reload</a></li>
<li><a href="#org6f7a8f0">Libraries</a></li>
<li><a href="#org9e7aec7">Backups</a></li>
<li><a href="#orge2c1a07">History</a></li>
<li><a href="#org7b6c674">Windows configuration&#xa0;&#xa0;&#xa0;<span class="tag"><span class="drill">drill</span></span></a></li>
<li><a href="#org1cd5d0f">Time in the modeline</a></li>
<li><a href="#org644f084">Winner mode - undo and redo window configuration</a></li>
<li><a href="#org519c0b6">Sentences end with a single space</a></li>
<li><a href="#orgc4fbe4e">Trying out Marginalia, Selectrum, Embark, and Consult</a>
<ul>
<li><a href="#org8a9dd5e">Basic configuration</a></li>
<li><a href="#org7b886d9">Using projects as a source for consult-buffer</a></li>
<li><a href="#orgf4342de">Completing sketches</a></li>
<li><a href="#org175a01e">Marginalia and hiding the value of password-ish variables</a></li>
<li><a href="#org6b3a13e">Marginalia and annotating functions with their arguments</a></li>
<li><a href="#org992ebe5">Using Embark to offer context-sensitive actions for Org elements</a></li>
<li><a href="#orge42d945">Cargo-culted stuff</a></li>
</ul>
</li>
<li><a href="#org555e08a">Contextual actions with cmap</a></li>
<li><a href="#orgd09f4d9">Helm - interactive completion</a>
<ul>
<li><a href="#orge244aae">Getting Helm and org-refile to clock in or create tasks&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="org">org</span>&#xa0;<span class="helm">helm</span></span></a></li>
<li><a href="#org95dab6d">Org Mode: Create a quick timestamped note and capture a screenshot&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="org">org</span></span></a></li>
</ul>
</li>
<li><a href="#orge6ec299">Recomplete</a></li>
<li><a href="#org4274af7">Mode line format</a></li>
<li><a href="#org6723871">Change "yes or no" to "y or n"</a></li>
<li><a href="#orgf2b1e0d">Minibuffer editing - more space!</a></li>
<li><a href="#org0f9db8a">Set up a light-on-dark color scheme</a></li>
<li><a href="#orge08a178">Undo tree mode - visualize your undos and branches</a></li>
<li><a href="#orgfb9e6b4">which-key and which-key-posframe</a></li>
<li><a href="#org4abb115">UTF-8</a></li>
<li><a href="#org064c5e4">Killing text</a></li>
<li><a href="#org293a548">Repeatable commands</a>
<ul>
<li><a href="#orgaca3987"><span class="todo TODO">TODO</span> Look for opportunities to use this</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgc697db8">Navigation</a>
<ul>
<li><a href="#orgad34db0">Pop to mark</a></li>
<li><a href="#org9aed53b">Helm-swoop - quickly finding lines</a></li>
<li><a href="#org4d916b7">Highlight Line Mode</a></li>
<li><a href="#orgea87887">Windmove - switching between windows</a></li>
<li><a href="#orgcbb0aaf">Frequently-accessed files</a></li>
<li><a href="#key-chord">Key chords and Hydras</a></li>
<li><a href="#orge2c6344">Smartscan</a></li>
<li><a href="#orgfcc3e98">Dired</a>
<ul>
<li><a href="#orgc26b84f">peep-dired</a></li>
<li><a href="#orgfcff0d0">Saving photos</a></li>
</ul>
</li>
<li><a href="#org2b4bc03">Move to beginning of line</a></li>
<li><a href="#org56302db">Recent files</a></li>
<li><a href="#org24ecd1e">Copy filename to clipboard</a></li>
<li><a href="#orga22d4b0">Open files externally</a></li>
<li><a href="#org6790a66">Toggle</a></li>
</ul>
</li>
<li><a href="#org733442b">Reading</a></li>
<li><a href="#org5f364a2">Shuffling lines</a></li>
<li><a href="#org0841013">Writing and editing</a>
<ul>
<li><a href="#orgec58cc3">Markdown</a></li>
<li><a href="#org5d24a25">Avoiding weasel words</a></li>
<li><a href="#orgfe5daa7">Unfill paragraph</a></li>
<li><a href="#orgc2a6d8f">Unicode</a></li>
<li><a href="#orgd17e166">Clean up spaces</a></li>
<li><a href="#org2f8c418">Expand</a></li>
<li><a href="#subed">Subtitles</a>
<ul>
<li><a href="#org593e94d">Extract part of a video</a></li>
<li><a href="#org133ac41">Hide IDs and times</a></li>
<li><a href="#org23626f2">Other subtitle code</a></li>
<li><a href="#org1203248">Using Emacs to fix automatically generated subtitle timestamps&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></a></li>
<li><a href="#org0923275">Using word-level timing information when editing subtitles or captions in Emacs</a></li>
<li><a href="#org7be4d44">Edit text</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgbde001e"><span class="todo TOBLOG">TOBLOG</span> Manage photos with geeqie</a></li>
<li><a href="#org9d52d98">Org&#xa0;&#xa0;&#xa0;<span class="tag"><span class="org">org</span></span></a>
<ul>
<li><a href="#org-files">My files</a></li>
<li><a href="#orga676f80">Modules</a></li>
<li><a href="#orgae41edc">Keyboard shortcuts</a>
<ul>
<li><a href="#orgd5ecdc1">Speed commands</a></li>
</ul>
</li>
<li><a href="#orgbab32c5">Navigation</a>
<ul>
<li><a href="#org85d80d6">Link Org subtrees and navigate between them</a></li>
<li><a href="#org1ff3cfd">Viewing, navigating, and editing the Org tree</a></li>
<li><a href="#org2f272d2">Finding my place on a small mobile screen with org-back-to-heading</a></li>
<li><a href="#org04fed81">Dealing with big tables</a></li>
</ul>
</li>
<li><a href="#org5148ded">Taking notes</a>
<ul>
<li><a href="#org7f30a33">Date trees</a></li>
<li><a href="#org2f5944b">Templates</a></li>
<li><a href="#org05f9dd8">Refiling</a></li>
<li><a href="#org326c4d9"><span class="todo TODO">TODO</span> Bounce to another file&#xa0;&#xa0;&#xa0;<span class="tag"><span class="computer">computer</span>&#xa0;<span class="phone">phone</span></span></a></li>
<li><a href="#org166defa">Estimating WPM</a></li>
</ul>
</li>
<li><a href="#org7997d88">Tasks</a>
<ul>
<li><a href="#org21bfe07">Managing tasks</a></li>
<li><a href="#subset">Estimating tasks</a></li>
<li><a href="#org876c652">Flexible scheduling of tasks</a></li>
<li><a href="#org5313727">Task dependencies</a></li>
<li><a href="#orge1d5d7c">Quick way to archive all DONE from inbox&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="computer">computer</span></span></a></li>
</ul>
</li>
<li><a href="#orgac10a4a">Templates</a>
<ul>
<li><a href="#org7e83dad">Structure templates</a></li>
<li><a href="#org0b36541">Emacs chats, Emacs hangouts</a></li>
</ul>
</li>
<li><a href="#orgfa2f592">Org agenda</a>
<ul>
<li><a href="#project_subtasks">Basic configuration</a></li>
<li><a href="#org3129eab">Starting my weeks on Saturday</a></li>
<li><a href="#agenda_commands">Display projects with associated subtasks</a></li>
<li><a href="#orgddd660b">Org agenda custom commands</a></li>
<li><a href="#org70dabe4">Making it easier to tag inbox items</a></li>
<li><a href="#orgcb90d4c">Make it easy to mark a task as done</a></li>
<li><a href="#org92807da">Make it easy to mark a task as done and create a follow-up task</a></li>
<li><a href="#org1cfafec">Capture something based on the agenda</a></li>
<li><a href="#org061eaec">Sorting by date and priority</a></li>
<li><a href="#orged667fa">Preventing things from falling through the cracks</a></li>
<li><a href="#org7e86e98">Synchronizing with Google Calendar</a></li>
<li><a href="#org2f037d5">Projects</a></li>
</ul>
</li>
<li><a href="#org20c31c1">Reviews</a>
<ul>
<li><a href="#weekly-review">Weekly review</a></li>
<li><a href="#monthly-reviews">Monthly reviews</a></li>
</ul>
</li>
<li><a href="#orgea4b41a">Filing</a>
<ul>
<li><a href="#destination">Moving lines around</a></li>
<li><a href="#org593b3ab">Organizing my blog index</a></li>
<li><a href="#org2ae0801">Quickly refiling Org Mode notes to headings in the same file</a></li>
</ul>
</li>
<li><a href="#orgc04653c">Inserting code</a></li>
<li><a href="#org40ecb67">Org Babel</a></li>
<li><a href="#org9229486">Publishing</a>
<ul>
<li><a href="#org8a08c3a">Cleaning up export</a></li>
<li><a href="#org6aadea7">Org2blog</a></li>
<li><a href="#org3ab3083">Publish without prompting</a></li>
<li><a href="#org6230f43">Stylesheet / header</a></li>
<li><a href="#org186f6a2">Footer</a></li>
<li><a href="#orgc914931">Copy region</a></li>
<li><a href="#orgd6df06d">UTF-8 checkboxes</a></li>
<li><a href="#orge2db266">Share my Emacs configuration</a></li>
<li><a href="#org3a467b8">Beamer</a></li>
<li><a href="#org580d1c9">PlantUML</a></li>
<li><a href="#orgb964644">ox-hugo</a></li>
</ul>
</li>
<li><a href="#org70ab446">Org roam</a></li>
<li><a href="#org56353ea">Fix incompatible changes from Org 8 to Org 9</a></li>
<li><a href="#org17dc98c">Links</a>
<ul>
<li><a href="#org28afa70">Quick links</a></li>
<li><a href="#orga2ad39d">Custom links</a></li>
<li><a href="#orgd3e6bc5">Links from org-protocol</a></li>
<li><a href="#orga70cfba">Fix elisp links</a></li>
<li><a href="#org-dired">Dired</a></li>
</ul>
</li>
<li><a href="#orgc89c673">Journal</a>
<ul>
<li><a href="#orgfe15035">Working with journal entries</a></li>
<li><a href="#org606b392">Photos</a></li>
</ul>
</li>
<li><a href="#orgbdc0769">Attachments</a></li>
<li><a href="#org638d2f7">HTTP</a></li>
<li><a href="#org2f4d020">Lilypond</a></li>
<li><a href="#orgbb5ca5d">Diagrams and graphics</a></li>
<li><a href="#org0df4830">Counting</a></li>
<li><a href="#org692c123">Spreadsheets</a></li>
<li><a href="#orgdd5ed39">Literate programming</a>
<ul>
<li><a href="#orgd6a5abf">Editing source code</a></li>
<li><a href="#orgc860ead">Copying and sharing code</a></li>
<li><a href="#orgf8db126">Tables</a></li>
</ul>
</li>
<li><a href="#orgb4d3555">Invoices</a></li>
<li><a href="#org99ff594">Archiving</a></li>
<li><a href="#org01b8065">Presentations</a></li>
<li><a href="#orgc181a4e">Allow dashes in tags</a></li>
<li><a href="#org3ad5524">Copying information from my phone</a></li>
<li><a href="#emacs-news">Emacs packages, other settings for easy Emacs News generation</a>
<ul>
<li><a href="#orgf1d722c">Package links</a></li>
<li><a href="#org68a5e35">ASCII export</a></li>
<li><a href="#org41d5efa">Reddit</a></li>
<li><a href="#orgc75328a">Sorting Org Mode lists using a sequence of regular expressions&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="org">org</span></span></a></li>
</ul>
</li>
<li><a href="#org6f26e60">Save when Emacs loses focus</a></li>
</ul>
</li>
<li><a href="#org2788607">Coding</a>
<ul>
<li><a href="#orgbdb7ad3">Web development</a></li>
<li><a href="#org00d072b">LSP</a></li>
<li><a href="#org8931e6a">Tab width of 2 is compact and readable</a></li>
<li><a href="#org289d442">More indentation things</a></li>
<li><a href="#orgc2ce225">Adapt to being on Windows</a></li>
<li><a href="#org315e934">Expand region</a></li>
<li><a href="#org442fa53">Compilation</a></li>
<li><a href="#orgb9b5618">Emacs Lisp</a>
<ul>
<li><a href="#org5808c46">Eldoc</a></li>
<li><a href="#org10cd4dd">Refactoring&#xa0;&#xa0;&#xa0;<span class="tag"><span class="drill">drill</span></span></a></li>
<li><a href="#org4638c6a">Jumping to code</a></li>
<li><a href="#org0941808">Sorting</a></li>
<li><a href="#org6c2d485">Evaluation</a></li>
<li><a href="#org1f25502">Stubbing</a></li>
</ul>
</li>
<li><a href="#orga359a03">Snippets</a></li>
<li><a href="#org2c8f56d">Show column number</a></li>
<li><a href="#orgdc5d08d">Don't show whitespace in diff, but show context</a></li>
<li><a href="#orgcc4c7bd">Javascript</a>
<ul>
<li><a href="#org28c05cc">React</a></li>
</ul>
</li>
<li><a href="#org7b89afb">HTML</a></li>
<li><a href="#magit">Magit - nice git interface</a>
<ul>
<li><a href="#org4e260e9"><span class="todo TODO">TODO</span> Make this better by adding a post command options variable</a></li>
</ul>
</li>
<li><a href="#org369b372">Checking things out</a></li>
<li><a href="#org68a971b">git-messenger - shows commit message</a></li>
<li><a href="#orgff1c16c">Tag files</a></li>
<li><a href="#orgd78f760">Projects</a></li>
<li><a href="#org6150eb2">Exploring MELPA recipes</a></li>
<li><a href="#org46e09d4">Ruby</a></li>
<li><a href="#org9e986b3">Skewer</a></li>
<li><a href="#org9571225">Autocomplete</a></li>
<li><a href="#org00c9ace">Tern - for Javascript</a></li>
<li><a href="#org9c81b2d">Docker</a></li>
</ul>
</li>
<li><a href="#org232c964">Internet Relay Chat</a></li>
<li><a href="#orgb548069">Self-tracking, statistics, and other data transformations</a>
<ul>
<li><a href="#clock-in">Quantified Awesome</a></li>
<li><a href="#compare-time">Compare times and effort estimates</a></li>
<li><a href="#org81edd2e">Workrave</a></li>
<li><a href="#org203f439">Blog</a></li>
<li><a href="#org5d3e837">Artrage</a></li>
</ul>
</li>
<li><a href="#orga202465">Workarounds</a>
<ul>
<li><a href="#orgf39a9fd">GnuTLS on Windows</a></li>
<li><a href="#org3de8d36">color-theme sometimes comes across lists. Odd!</a></li>
<li><a href="#orgc745dd7">ido-sort-mtime stopped working when I upgraded to Windows 8</a></li>
<li><a href="#orga944b14">Cygwin mogrify doesn't work for me, but ImageMagick does</a></li>
<li><a href="#orgd1ee171">SSH and &#x2013;daemon</a></li>
</ul>
</li>
<li><a href="#org3052a45">Display</a></li>
<li><a href="#org2ba0485">On my phone</a></li>
<li><a href="#orgd9ad1a0">Clipboard</a></li>
<li><a href="#org3f00582">Search</a></li>
<li><a href="#org8a126f1">Mail</a>
<ul>
<li><a href="#org7e51dad">Gnus</a></li>
<li><a href="#orgcf68201">Notmuch</a></li>
</ul>
</li>
<li><a href="#orgd4ac4dd">Ledger (personal finance)</a></li>
<li><a href="#orga421655">Emacs server</a></li>
<li><a href="#org92a8fb3">Collaboration</a></li>
<li><a href="#orgc27b51f">Menus</a></li>
<li><a href="#orgb8d718d">CSVs</a></li>
<li><a href="#org5ab1db8">Advanced stuff / things I tend to forget about</a>
<ul>
<li><a href="#org6b7e46e">Editing multiple things</a>
<ul>
<li><a href="#org7c913ae">Multiple cursors mode&#xa0;&#xa0;&#xa0;<span class="tag"><span class="drill">drill</span></span></a></li>
</ul>
</li>
<li><a href="#org1369861">Edit list&#xa0;&#xa0;&#xa0;<span class="tag"><span class="drill">drill</span></span></a></li>
<li><a href="#org18dd32c">Quickly jump to positions</a></li>
<li><a href="#org3a666e6">Deleting things</a>
<ul>
<li><a href="#orgf6799ef"><span class="todo TODO">TODO</span> Get zap-to-isearch to work with helm-swoop</a></li>
</ul>
</li>
<li><a href="#org934647f">Network: TRAMP and editing files over SSH</a></li>
<li><a href="#org32fd7ac">Checking URLs</a></li>
</ul>
</li>
<li><a href="#streaming">Streaming</a>
<ul>
<li><a href="#org6ad2a79">Setting up</a></li>
<li><a href="#org9d9db40">Controlling my stream audio from Emacs: background music, typing sounds, and push to talk&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></a></li>
<li><a href="#orgf400784">Messages</a></li>
<li><a href="#org876bdc3">Show Emacs-related tasks</a></li>
<li><a href="#orgc693024">General streaming configuration</a></li>
<li><a href="#org8ab4a1a">Playing recordings</a></li>
<li><a href="#org49a0c18">Live captions</a></li>
<li><a href="#org283b87e">Stream notes</a></li>
<li><a href="#speech-to-text"><span class="todo TODO">TODO</span> Try continuous streaming and the Google Speech Recognition API</a></li>
</ul>
</li>
<li><a href="#org4d7d932">Other nifty Emacs things I want to learn</a>
<ul>
<li><a href="#orgefb0fd2">Smartparens mode&#xa0;&#xa0;&#xa0;<span class="tag"><span class="drill">drill</span></span></a></li>
</ul>
</li>
<li><a href="#org0aaaff1">Encryption</a></li>
<li><a href="#org9bba70f"><span class="done DONE">DONE</span> Scan ~/bin and turn the scripts into interactive commands</a></li>
<li><a href="#orgc9fd6f4">Syncthing</a></li>
<li><a href="#orgc500905">Search logs</a></li>
</ul>
</li>
<li><a href="#links">Other cool configs you may want to check out</a></li>
<li><a href="#orgbfcb161">Temporary workarounds</a>
<ul>
<li><a href="#org423520b">Tablet clicks count as drags</a></li>
</ul>
</li>
<li><a href="#org7bb7d66">Inactive/infrequent things</a>
<ul>
<li><a href="#org2676d3a">Paint</a></li>
<li><a href="#org19b43f0">Oddmuse</a></li>
<li><a href="#orga1306ea">Building a today-I-learned habit, and displaying the documentation for random Emacs commands&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></a></li>
<li><a href="#org14f049b">Org - mapping blog posts and image URLs from bulk exports</a></li>
<li><a href="#orgc9da641">Transcript editing</a></li>
<li><a href="#beeminder">Beeminder</a></li>
<li><a href="#org689da29">Strike through DONE headlines</a></li>
<li><a href="#org5efbdf0">Rainbow delimiters</a></li>
<li><a href="#org895f5c2">Org - send things to the bottom of the list</a></li>
<li><a href="#orgbf9c725">Time tracking, previous weekly review</a>
<ul>
<li><a href="#org4ffae5d">List upcoming tasks so that I can see if I'm overloaded</a></li>
<li><a href="#orgb7b480d">Compare time use</a></li>
</ul>
</li>
<li><a href="#org761b0c0">Animation for Emacs chats</a></li>
<li><a href="#orgd45ff03">Idle timer</a></li>
<li><a href="#org1876955">Old Flickr/Evernote export</a></li>
<li><a href="#org0fb423c">Enable minibuffer completion</a></li>
<li><a href="#org9735b48">Encryption</a></li>
<li><a href="#org8aed466">Drawing</a>
<ul>
<li><a href="#org1f1345f">Finding sketches</a></li>
<li><a href="#org49d2b3c">Org Mode sketch: links</a></li>
<li><a href="#org1c58ddf">Copy</a></li>
<li><a href="#orgd8dfe50">Config</a></li>
<li><a href="#orga548c8b">Helm completion with my/helm-org-sketches</a></li>
<li><a href="#orgd18041f">Button-based interface</a></li>
<li><a href="#org7302be3">Templates</a></li>
<li><a href="#org4742107">Easily backfill my journal</a></li>
<li><a href="#org514a139">Rename scanned index cards</a></li>
<li><a href="#org58b3752">Automatically resize images</a></li>
<li><a href="#orge64ab12">Get information for sketched books</a></li>
<li><a href="#org8eabcf7">Make it easy to follow up on a sketch</a></li>
<li><a href="#org58f5d5a">Move to-blog sketches to a staging folder for easier upload</a></li>
<li><a href="#orgeed3c33">Digital index piles with Emacs</a></li>
<li><a href="#insert-point">Sketched books</a></li>
<li><a href="#org877d3ec">Other sketches</a></li>
<li><a href="#orgfb2f682">Other sketch-related functions</a></li>
</ul>
</li>
<li><a href="#orgd1691ed">Tools for organizing</a></li>
<li><a href="#orgb0d45fe">Games</a>
<ul>
<li><a href="#org08bc4b2">Typing of Emacs</a></li>
</ul>
</li>
<li><a href="#orgd9a4fb5">Speech synthesis (experimental)</a></li>
</ul>
</li>
<li><a href="#org3c53962">Exwm</a></li>
<li><a href="#org175a6f2">Path</a></li>
<li><a href="#orge124634">Local Variables</a></li>
</ul>
</div>
</div>

<div id="outline-container-org5532f7b" class="outline-2">
<h2 id="org5532f7b">Configuration&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></h2>
<div class="outline-text-2" id="text-org5532f7b">
</div>
<div id="outline-container-babel-init" class="outline-3">
<h3 id="babel-init">About this file</h3>
<div class="outline-text-3" id="text-babel-init">
<p>
<a id="org9c39036"></a>
</p>

<p>
This is my personal config. It's really long, but that's partly
because I sometimes leave blog posts in it as commentary. (And also
because I've got a lot of little customizations that I might not even
remember. =) ). If you want to see a table of contents and other
useful niceties, go to <a href="http://sachachua.com/dotemacs">http://sachachua.com/dotemacs</a> . Other links for
this page: <a href="https://raw.githubusercontent.com/sachac/.emacs.d/gh-pages/Sacha.org">Org Mode version</a>, <a href="http://github.com/sachac/.emacs.d/">Github repository</a>
</p>

<p>
If you're new to Emacs Lisp, you probably don't want to copy and paste
large chunks of this code. Instead, copy small parts of it (always
making sure to copy a complete set of parentheses) into your
<code>*scratch*</code> buffer or some other buffer in <code>emacs-lisp-mode</code>. Use <code>M-x
eval-buffer</code> to evaluate the code and see if you like the way that
Emacs behaves. See <a href="https://www.gnu.org/software/emacs/manual/html_mono/eintr.html">An Introduction to Programming in Emacs Lisp</a> for
more details on Emacs Lisp. You can also find the manual by using <code>C-h
i</code> (<code>info</code>) and choosing "Emacs Lisp Intro".
</p>

<p>
I've installed a lot of packages. See the section to
add the repositories to your configuration. When you see <code>use-package</code>
and a package name you might like, you can use <code>M-x package-install</code>
to install the package of that name. Note that use-package is itself
provided by a package, so you'll probably want to install that and
<code>bind-key</code>.
</p>

<p>
If you're viewing the Org file, you can open source code blocks (those
are the ones in begin_src) in a separate buffer by moving your point
inside them and typing C-c ' (<code>org-edit-special</code>). This opens another
buffer in <code>emacs-lisp-mode</code>, so you can use <code>M-x eval-buffer</code> to load
the changes. If you want to explore how functions work, use <code>M-x
edebug-defun</code> to set up debugging for that function, and then call it.
You can learn more about edebug in the <a href="http://www.gnu.org/software/emacs/manual/html_node/elisp/Edebug.html">Emacs Lisp</a> manual.
</p>

<p>
I like using <code>(setq ...)</code> more than Customize because I can neatly
organize my configuration that way. Ditto for <code>use-package</code> - I mostly
use it to group together package-related config without lots of
<code>with-eval-after-load</code> calls, and it also makes declaring keybindings
easier.
</p>

<p>
My <code>~/.config/emacs/init</code> is now a symlink to <code>Sacha.el</code>, which is what
<code>M-x org-babel-tangle</code> (<code>C-c C-v t</code>) produces. <b>A note about Org
updates:</b> I like running Org Mode from checked-out source code instead
of package.el. I add the Lisp directories to my <code>load-path</code>, and I
also use the <code>:load-path</code> option in my first <code>use-package org</code> call to
set the load path. One of those is probably doing the trick and the
other one is redundant, but maybe it's a belt-and-suspenders sort of
thing. Using the git checkout also makes upgrading Org easy. All I
have to do is <code>git pull; make</code>, and stuff happens in an external Emacs
process. Since I create <code>Sacha.el</code> via <code>org-babel-tangle</code>, my Emacs
config can load <code>Sacha.el</code> without loading Org first.
</p>
</div>
</div>

<div id="outline-container-org1b4f201" class="outline-3">
<h3 id="org1b4f201">Starting up</h3>
<div class="outline-text-3" id="text-org1b4f201">
<p>
Here's how we start:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">This sets up the load path so that we can override it</span>
(package-initialize)
(add-to-list 'load-path <span class="org-string">"/usr/local/share/emacs/site-lisp"</span>)
(add-to-list 'load-path <span class="org-string">"~/vendor/org-mode/lisp"</span>)
(add-to-list 'load-path <span class="org-string">"~/vendor/org-mode/contrib/lisp"</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">org</span>)
(<span class="org-keyword">setq</span> custom-file <span class="org-string">"~/.config/emacs/custom-settings.el"</span>)
(<span class="org-keyword">setq</span> use-package-always-ensure t)
(load custom-file t)
</pre>
</div>
</div>
</div>

<div id="outline-container-orga0b4971" class="outline-3">
<h3 id="orga0b4971">System information</h3>
<div class="outline-text-3" id="text-orga0b4971">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/laptop-p</span> (equal (system-name) <span class="org-string">"sacha-kubuntu"</span>))
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/server-p</span> (<span class="org-keyword">and</span> (equal (system-name) <span class="org-string">"localhost"</span>) (equal user-login-name <span class="org-string">"sacha"</span>)))
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/phone-p</span> (not (null (getenv <span class="org-string">"ANDROID_ROOT"</span>)))
  <span class="org-doc">"If non-nil, GNU Emacs is running on Termux."</span>)
(<span class="org-keyword">when</span> my/phone-p (<span class="org-keyword">setq</span> gnutls-algorithm-priority <span class="org-string">"NORMAL:-VERS-TLS1.3"</span>))
(global-auto-revert-mode)  <span class="org-comment-delimiter">; </span><span class="org-comment">simplifies syncing</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6794720" class="outline-3">
<h3 id="org6794720">Personal information</h3>
<div class="outline-text-3" id="text-org6794720">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> user-full-name <span class="org-string">"Sacha Chua"</span>
      user-mail-address <span class="org-string">"sacha@sachachua.com"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-orge37b9c5" class="outline-3">
<h3 id="orge37b9c5">Emacs initialization</h3>
<div class="outline-text-3" id="text-orge37b9c5">
</div>
<div id="outline-container-org84c2d5a" class="outline-4">
<h4 id="org84c2d5a">Add package sources</h4>
<div class="outline-text-4" id="text-org84c2d5a">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">unless</span> (assoc-default <span class="org-string">"melpa"</span> package-archives)
  (add-to-list 'package-archives '(<span class="org-string">"melpa"</span> . <span class="org-string">"https://melpa.org/packages/"</span>) t))
(<span class="org-keyword">unless</span> (assoc-default <span class="org-string">"org"</span> package-archives)
  (add-to-list 'package-archives '(<span class="org-string">"org"</span> . <span class="org-string">"https://orgmode.org/elpa/"</span>) t))
</pre>
</div>

<p>
Use <code>M-x package-refresh-contents</code> to reload the list of packages
after adding these for the first time.
</p>
</div>
</div>

<div id="outline-container-orgc970a2c" class="outline-4">
<h4 id="orgc970a2c">Add my elisp directory and other files</h4>
<div class="outline-text-4" id="text-orgc970a2c">
<p>
Sometimes I load files outside the package system. As long as they're
in a directory in my <code>load-path</code>, Emacs can find them.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-to-list 'load-path <span class="org-string">"~/elisp"</span>)
(<span class="org-keyword">unless</span> (package-installed-p 'use-package)
  (package-install 'use-package))
(<span class="org-keyword">setq</span> use-package-verbose t)
(<span class="org-keyword">setq</span> use-package-always-ensure t)
(<span class="org-keyword">require</span> '<span class="org-constant">use-package</span>)
(<span class="org-keyword">use-package</span> <span class="org-constant">quelpa</span>)
(<span class="org-keyword">use-package</span> <span class="org-constant">quelpa-use-package</span>)
(<span class="org-keyword">use-package</span> <span class="org-constant">auto-compile</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:config</span> (auto-compile-on-load-mode))
(<span class="org-keyword">setq</span> load-prefer-newer t)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org541c89e" class="outline-3">
<h3 id="org541c89e">General configuration</h3>
<div class="outline-text-3" id="text-org541c89e">
</div>
<div id="outline-container-org9b2666d" class="outline-4">
<h4 id="org9b2666d">Reload</h4>
<div class="outline-text-4" id="text-org9b2666d">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/reload-emacs-configuration</span> ()
  (<span class="org-keyword">interactive</span>)
  (load-file <span class="org-string">"~/code/.emacs.d/Sacha.el"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-org6f7a8f0" class="outline-4">
<h4 id="org6f7a8f0">Libraries</h4>
<div class="outline-text-4" id="text-org6f7a8f0">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">dash</span> <span class="org-builtin">:ensure</span> t)
(<span class="org-keyword">use-package</span> <span class="org-constant">diminish</span> <span class="org-builtin">:ensure</span> t)
</pre>
</div>
</div>
</div>

<div id="outline-container-org9e7aec7" class="outline-4">
<h4 id="org9e7aec7">Backups</h4>
<div class="outline-text-4" id="text-org9e7aec7">
<p>
This is one of the things people usually want to change right away. By default, Emacs saves backup files in the current directory. These are the files ending in <code>~</code> that are cluttering up your directory lists. The following code stashes them all in <code>~/.config/emacs/backups</code>, where I can find them with <code>C-x C-f</code> (<code>find-file</code>) if I really need to.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> backup-directory-alist '((<span class="org-string">"."</span> . <span class="org-string">"~/.config/emacs/backups"</span>)))
</pre>
</div>

<p>
Disk space is cheap. Save lots.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> delete-old-versions -1)
(<span class="org-keyword">setq</span> version-control t)
(<span class="org-keyword">setq</span> vc-make-backup-files t)
(<span class="org-keyword">setq</span> auto-save-file-name-transforms '((<span class="org-string">".*"</span> <span class="org-string">"~/.config/emacs/auto-save-list/"</span> t)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orge2c1a07" class="outline-4">
<h4 id="orge2c1a07">History</h4>
<div class="outline-text-4" id="text-orge2c1a07">
<p>
From <a href="http://www.wisdomandwonder.com/wp-content/uploads/2014/03/C3F.html">http://www.wisdomandwonder.com/wp-content/uploads/2014/03/C3F.html</a>:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> savehist-file <span class="org-string">"~/.config/emacs/savehist"</span>)
(savehist-mode 1)
(<span class="org-keyword">setq</span> history-length t)
(<span class="org-keyword">setq</span> history-delete-duplicates t)
(<span class="org-keyword">setq</span> savehist-save-minibuffer-history 1)
(<span class="org-keyword">setq</span> savehist-additional-variables
      '(kill-ring
        search-ring
        regexp-search-ring))
</pre>
</div>
</div>
</div>

<div id="outline-container-org7b6c674" class="outline-4">
<h4 id="org7b6c674">Windows configuration&#xa0;&#xa0;&#xa0;<span class="tag"><span class="drill">drill</span></span></h4>
<div class="outline-text-4" id="text-org7b6c674">
<p>
When you're starting out, the tool bar can be very helpful. <a href="http://sachachua.com/blog/2014/03/emacs-basics-using-mouse/">(Emacs Basics: Using the Mouse</a>). Eventually, you may want to reclaim that extra little bit of screenspace. The following code turns that thing off. (Although I changed my mind about the menu - I want that again.)
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(tool-bar-mode -1)
</pre>
</div>
</div>
</div>

<div id="outline-container-org1cd5d0f" class="outline-4">
<h4 id="org1cd5d0f">Time in the modeline</h4>
<div class="outline-text-4" id="text-org1cd5d0f">
<p>
I like having the clock.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(display-time-mode 1)
</pre>
</div>
</div>
</div>

<div id="outline-container-org644f084" class="outline-4">
<h4 id="org644f084">Winner mode - undo and redo window configuration</h4>
<div class="outline-text-4" id="text-org644f084">
<p>
<code>winner-mode</code> lets you use <code>C-c &lt;left&gt;</code> and <code>C-c &lt;right&gt;</code> to switch between window configurations. This is handy when something has popped up a buffer that you want to look at briefly before returning to whatever you were working on. When you're done, press <code>C-c &lt;left&gt;</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">winner</span>
  <span class="org-builtin">:defer</span> t)
</pre>
</div>
</div>
</div>

<div id="outline-container-org519c0b6" class="outline-4">
<h4 id="org519c0b6">Sentences end with a single space</h4>
<div class="outline-text-4" id="text-org519c0b6">
<p>
In my world, sentences end with a single space. This makes
sentence navigation commands work for me.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> sentence-end-double-space nil)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc4fbe4e" class="outline-4">
<h4 id="orgc4fbe4e">Trying out Marginalia, Selectrum, Embark, and Consult</h4>
<div class="outline-text-4" id="text-orgc4fbe4e">
<p>
Based on <a href="https://www.rousette.org.uk/archives/switching-to-selectrum-for-incremental-narrowing-in-emacs/">BSAG » Switching to Selectrum for incremental narrowing in Emacs</a>
I like marginalia for M-x, but I've gotten used to Helm for finding files.
</p>
</div>

<div id="outline-container-org8a9dd5e" class="outline-5">
<h5 id="org8a9dd5e">Basic configuration</h5>
<div class="outline-text-5" id="text-org8a9dd5e">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">selectrum</span> <span class="org-builtin">:quelpa</span> (selectrum <span class="org-builtin">:fetcher</span> github <span class="org-builtin">:repo</span> <span class="org-string">"raxod502/selectrum"</span>) <span class="org-builtin">:init</span> (selectrum-mode +1)) 
(<span class="org-keyword">use-package</span> <span class="org-constant">prescient</span> <span class="org-builtin">:config</span> (prescient-persist-mode +1))
(<span class="org-keyword">use-package</span> <span class="org-constant">selectrum-prescient</span> <span class="org-builtin">:init</span> (selectrum-prescient-mode +1) <span class="org-builtin">:after</span> selectrum)
(<span class="org-keyword">use-package</span> <span class="org-constant">company-prescient</span> <span class="org-builtin">:init</span> (company-prescient-mode +1))
(<span class="org-keyword">use-package</span> <span class="org-constant">consult</span> <span class="org-builtin">:quelpa</span> (consult <span class="org-builtin">:fetcher</span> github <span class="org-builtin">:repo</span> <span class="org-string">"minad/consult"</span>)
  <span class="org-builtin">:after</span> projectile
  <span class="org-builtin">:bind</span> ((<span class="org-string">"C-x r x"</span> . consult-register)
         (<span class="org-string">"C-x r b"</span> . consult-bookmark)
         (<span class="org-string">"C-c k"</span> . consult-kmacro)
         (<span class="org-string">"C-x M-:"</span> . consult-complex-command)     <span class="org-comment-delimiter">;; </span><span class="org-comment">orig. repeat-complet-command</span>
         (<span class="org-string">"C-x 4 b"</span> . consult-buffer-other-window) <span class="org-comment-delimiter">;; </span><span class="org-comment">orig. switch-to-buffer-other-window</span>
         (<span class="org-string">"C-x 5 b"</span> . consult-buffer-other-frame)
         (<span class="org-string">"M-#"</span> . consult-register-load)
         (<span class="org-string">"M-'"</span> . consult-register-store)          <span class="org-comment-delimiter">;; </span><span class="org-comment">orig. abbrev-prefix-mark (unrelated)</span>
         (<span class="org-string">"C-M-#"</span> . consult-register)
         (<span class="org-string">"M-g o"</span> . consult-outline) 
         (<span class="org-string">"M-g m"</span> . consult-mark)
         (<span class="org-string">"C-x b"</span> . consult-buffer)
         (<span class="org-string">"M-y"</span> . consult-yank-pop)
         (<span class="org-string">"&lt;help&gt; a"</span> . consult-apropos)            <span class="org-comment-delimiter">;; </span><span class="org-comment">orig. apropos-command</span>
         (<span class="org-string">"M-g M-g"</span> . consult-goto-line)           <span class="org-comment-delimiter">;; </span><span class="org-comment">orig. goto-line</span>
         (<span class="org-string">"M-g o"</span> . consult-outline)
         (<span class="org-string">"M-g m"</span> . consult-mark)
         (<span class="org-string">"M-g k"</span> . consult-global-mark)
         (<span class="org-string">"M-g i"</span> . consult-imenu)
         (<span class="org-string">"M-g I"</span> . consult-project-imenu)
         (<span class="org-string">"M-g e"</span> . consult-error)
         <span class="org-comment-delimiter">;; </span><span class="org-comment">M-s bindings (search-map)</span>
         (<span class="org-string">"M-s f"</span> . consult-find)
         (<span class="org-string">"M-s L"</span> . consult-locate)
         (<span class="org-string">"M-s g"</span> . consult-grep)
         (<span class="org-string">"M-s G"</span> . consult-git-grep)
         (<span class="org-string">"M-s r"</span> . consult-ripgrep)
         (<span class="org-string">"M-s l"</span> . consult-line)
         (<span class="org-string">"M-s m"</span> . consult-multi-occur)
         (<span class="org-string">"M-s k"</span> . consult-keep-lines)
         (<span class="org-string">"M-s u"</span> . consult-focus-lines)
         <span class="org-comment-delimiter">;; </span><span class="org-comment">Isearch integration</span>
         (<span class="org-string">"M-s e"</span> . consult-isearch)
         (<span class="org-string">"M-g l"</span> . consult-line)    
         (<span class="org-string">"M-s m"</span> . consult-multi-occur)
         (<span class="org-string">"C-x c o"</span> . consult-multi-occur)
         (<span class="org-string">"C-x c SPC"</span> . consult-mark)
         <span class="org-builtin">:map</span> isearch-mode-map
         (<span class="org-string">"M-e"</span> . consult-isearch)                 <span class="org-comment-delimiter">;; </span><span class="org-comment">orig. isearch-edit-string</span>
         (<span class="org-string">"M-s e"</span> . consult-isearch)               <span class="org-comment-delimiter">;; </span><span class="org-comment">orig. isearch-edit-string</span>
         (<span class="org-string">"M-s l"</span> . consult-line))
  <span class="org-builtin">:init</span>
  (<span class="org-keyword">setq</span> register-preview-delay 0
        register-preview-function #'consult-register-format)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> consult-project-root-function #'projectile-project-root)
  (<span class="org-keyword">setq</span> consult-narrow-key <span class="org-string">"&lt;"</span>))
(<span class="org-keyword">use-package</span> <span class="org-constant">marginalia</span> <span class="org-builtin">:quelpa</span> (marginalia <span class="org-builtin">:fetcher</span> github <span class="org-builtin">:repo</span> <span class="org-string">"minad/marginalia"</span>)
  <span class="org-builtin">:init</span>
  (marginalia-mode)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> marginalia-annotators (<span class="org-keyword">if</span> my/laptop-p
                                  '(marginalia-annotators-heavy marginalia-annotators-light)
                                '(marginalia-annotators-light)))
  (advice-add #'marginalia-cycle <span class="org-builtin">:after</span>
              (<span class="org-keyword">lambda</span> () (<span class="org-keyword">when</span> (<span class="org-keyword">bound-and-true-p</span> selectrum-mode) (selectrum-exhibit))))
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> minibuffer-local-completion-map
              (<span class="org-string">"C-i"</span> . marginalia-cycle-annotators)))
(<span class="org-keyword">use-package</span> <span class="org-constant">embark</span> 
  <span class="org-builtin">:after</span> selectrum 
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> embark-prompter 'embark-keymap-prompter) 
  (add-to-list 'embark-target-finders 'my/embark-org-element) 
  (add-to-list 'embark-allow-edit-commands #'my/stream-message)
  (add-to-list 'embark-allow-edit-commands #'my/journal-post)
  (<span class="org-keyword">embark-define-keymap</span> embark-sketch-actions
    (<span class="org-string">"o"</span> (<span class="org-keyword">lambda</span> (f) (<span class="org-keyword">interactive</span>) (insert (org-link-make-string <span class="org-string">"sketch:"</span> (file-name-nondirectory f)))))
    (<span class="org-string">"v"</span> my/geeqie-view))
  (<span class="org-keyword">embark-define-keymap</span> embark-journal-actions
    (<span class="org-string">"e"</span> my/journal-edit))
  <span class="org-builtin">:bind</span>
  (<span class="org-builtin">:map</span> minibuffer-local-map
        ((<span class="org-string">"C-c e"</span> . embark-act)
         (<span class="org-string">"C-;"</span> . embark-act))
        <span class="org-builtin">:map</span> embark-general-map
        ((<span class="org-string">"j"</span> . my/journal-post)
         (<span class="org-string">"m"</span> . my/stream-message))
        <span class="org-builtin">:map</span> embark-variable-map
        (<span class="org-string">"l"</span> . edit-list)))

(<span class="org-keyword">use-package</span> 
  embark-consult 
  <span class="org-builtin">:after</span> (embark consult) 
  <span class="org-builtin">:demand</span> t                <span class="org-comment-delimiter">; </span><span class="org-comment">only necessary if you have the hook below</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">if you want to have consult previews as you move around an</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">auto-updating embark collect buffer</span>
  <span class="org-builtin">:hook</span> (embark-collect-mode . embark-consult-preview-minor-mode))
</pre>
</div>
</div>
</div>
<div id="outline-container-org7b886d9" class="outline-5">
<h5 id="org7b886d9">Using projects as a source for consult-buffer</h5>
<div class="outline-text-5" id="text-org7b886d9">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">consult</span>
  <span class="org-builtin">:after</span> projectile
  <span class="org-builtin">:defines</span> consult-buffer-sources
  <span class="org-builtin">:config</span>
  (projectile-load-known-projects)
  (<span class="org-keyword">setq</span> my/consult-source-projectile-projects
        `(<span class="org-builtin">:name</span> <span class="org-string">"Projectile projects"</span>
                <span class="org-builtin">:narrow</span>   ?P
                <span class="org-builtin">:category</span> project
                <span class="org-builtin">:action</span>   ,#'projectile-switch-project-by-name
                <span class="org-builtin">:items</span>    ,projectile-known-projects))
  (add-to-list 'consult-buffer-sources my/consult-source-projectile-projects 'append))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf4342de" class="outline-5">
<h5 id="orgf4342de">Completing sketches</h5>
<div class="outline-text-5" id="text-orgf4342de">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/date-from-filename</span> (filename)
  (<span class="org-keyword">let</span> ((f (file-name-nondirectory filename)))
    (<span class="org-keyword">if</span> (string-match <span class="org-string">"^[-0-9]+"</span> f)
        (replace-regexp-in-string <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">0-9]"</span> <span class="org-string">""</span> (match-string 0 f))
      nil)))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/sketches</span> nil <span class="org-doc">"Cache for sketch filenames."</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/update-sketch-cache</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">setq</span> my/sketches (sort
                          (apply 'append (mapcar (<span class="org-keyword">lambda</span> (dir)
                                                   (directory-files dir t <span class="org-string">"\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">jpe?g</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">png</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">$"</span>))
                                                 my/sketch-directories))
                          (<span class="org-keyword">lambda</span> (a b)
                            (string&lt; (concat (<span class="org-keyword">or</span> (my/date-from-filename b) <span class="org-string">"0"</span>) (file-name-nondirectory b))
                                     (concat (<span class="org-keyword">or</span> (my/date-from-filename a) <span class="org-string">"0"</span>) (file-name-nondirectory a)) )))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/complete-sketch-filename</span> ()
  (consult--read (<span class="org-keyword">or</span> my/sketches (my/update-sketch-cache))
   <span class="org-builtin">:sort</span> nil
   <span class="org-builtin">:prompt</span> <span class="org-string">"Sketch: "</span> <span class="org-builtin">:category</span> 'sketch))

(<span class="org-keyword">use-package</span> <span class="org-constant">marginalia</span>
  <span class="org-builtin">:config</span>
  (add-to-list 'marginalia-prompt-categories '(<span class="org-string">"sketch"</span> . sketch)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org175a01e" class="outline-5">
<h5 id="org175a01e">Marginalia and hiding the value of password-ish variables</h5>
<div class="outline-text-5" id="text-org175a01e">
<p>
I like the way <a href="https://github.com/minad/marginalia">Marginalia</a> adds annotations to minibuffer completion.
I'm experimenting with <a href="https://twitch.tv/sachachua">streaming</a>, so I'm <b>trying</b> to not leak
passwords while playing around with marginalia. (I'll probably mess up
at some point. Please be nice! =) )
</p>

<p>
This is the annotator function:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/marginalia-annotate-variable</span> (cand)
  <span class="org-doc">"Annotate variable CAND with its documentation string."</span>
  (<span class="org-keyword">when-let</span> (sym (intern-soft cand))
    (<span class="org-keyword">marginalia--fields</span>
     ((marginalia--symbol-class sym) <span class="org-builtin">:face</span> 'marginalia-modified)
     ((<span class="org-keyword">let</span> ((print-escape-newlines t)
            (print-escape-control-characters t)
            (print-escape-multibyte t))
        (prin1-to-string
         (<span class="org-keyword">cond</span>
          ((string-match <span class="org-string">"pass"</span> cand) <span class="org-string">"*******"</span>)
          ((boundp sym) (symbol-value sym))
          (t 'unbound))))
      <span class="org-builtin">:truncate</span> (/ marginalia-truncate-width 3) <span class="org-builtin">:face</span> 'marginalia-variable)
     ((documentation-property sym 'variable-documentation)
      <span class="org-builtin">:truncate</span> marginalia-truncate-width <span class="org-builtin">:face</span> 'marginalia-documentation))))
</pre>
</div>

<p>
Something like the following code adds it to my annotator functions.
The actual code I evaluate is in my <code>use-package marginalia</code>
declaration in my <a href="http://sachachua.com/dotemacs">Emacs config</a>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">marginalia</span>
  <span class="org-builtin">:config</span>
  (setcdr (assoc 'variable marginalia-annotators-heavy) #'my/marginalia-annotate-variable))
</pre>
</div>
</div>
</div>

<div id="outline-container-org6b3a13e" class="outline-5">
<h5 id="org6b3a13e">Marginalia and annotating functions with their arguments</h5>
<div class="outline-text-5" id="text-org6b3a13e">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">require</span> '<span class="org-constant">elisp-mode</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my/elisp-get-function-args</span> (sym)
  <span class="org-doc">"Return a string with the function arguments for SYM.</span>
<span class="org-doc">Based on `</span><span class="org-doc"><span class="org-constant">elisp-get-fnsym-args-string.</span></span><span class="org-doc">'"</span>
  (<span class="org-keyword">cond</span>
   ((not (<span class="org-keyword">and</span> sym (symbolp sym) (fboundp sym))) nil)
   ((<span class="org-keyword">and</span> (eq sym (aref elisp--eldoc-last-data 0))
         (eq 'function (aref elisp--eldoc-last-data 2)))
    (aref elisp--eldoc-last-data 1))
   (t
    (<span class="org-keyword">let*</span> ((advertised (gethash (indirect-function sym)
                                advertised-signature-table t))
           doc
           (args
            (<span class="org-keyword">cond</span>
             ((listp advertised) advertised)
             ((<span class="org-keyword">setq</span> doc (help-split-fundoc
                         (<span class="org-keyword">condition-case</span> nil (documentation sym t)
                           (invalid-function nil))
                         sym))
              (substitute-command-keys (car doc)))
             (t (help-function-arglist sym)))))
      <span class="org-comment-delimiter">;; </span><span class="org-comment">Stringify, and store before highlighting, downcasing, etc.</span>
      (elisp-function-argstring args)))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/marginalia-annotate-journal</span> (cand)
  (<span class="org-keyword">when-let</span> ((o (cdr (assoc cand my/journal-search-cache))))
    (<span class="org-keyword">marginalia--fields</span>
     ((plist-get o <span class="org-builtin">:Category</span>)
      <span class="org-builtin">:face</span> 'marginalia-documentation
      <span class="org-builtin">:truncate</span> 13))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/marginalia-annotate-function-with-args</span> (cand)
  <span class="org-doc">"Annotate symbol CAND with its arguments and documentation string."</span>
  (<span class="org-keyword">when-let</span> (sym (intern-soft cand))
    (<span class="org-keyword">let</span> ((symbol-class-width 5))
      (<span class="org-keyword">marginalia--fields</span>
       ((marginalia--symbol-class sym) <span class="org-builtin">:face</span> 'marginalia-modified
        <span class="org-builtin">:truncate</span> symbol-class-width)
       ((my/elisp-get-function-args sym) 
        <span class="org-builtin">:truncate</span> (/ (- marginalia-truncate-width symbol-class-width) 3)
        <span class="org-builtin">:face</span> 'my/marginalia-arguments)
       ((marginalia--function-doc sym)
        <span class="org-builtin">:truncate</span> marginalia-truncate-width
        <span class="org-builtin">:face</span> 'marginalia-documentation)))))
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/marginalia-function-width</span> 30 <span class="org-doc">"Width of variable value annotation string."</span>)
(<span class="org-keyword">defface</span> <span class="org-variable-name">my/marginalia-arguments</span> '((t <span class="org-builtin">:inherit</span> marginalia-key))
  <span class="org-doc">"Face used to highlight function arguments in `</span><span class="org-doc"><span class="org-constant">marginalia-mode</span></span><span class="org-doc">'."</span>
  <span class="org-builtin">:group</span> 'marginalia)
(<span class="org-keyword">use-package</span> <span class="org-constant">marginalia</span>
  <span class="org-builtin">:after</span> elisp-mode
  <span class="org-builtin">:config</span>
  (add-to-list 'marginalia-annotators-heavy (cons 'journal #'my/marginalia-annotate-journal))
  (add-to-list 'marginalia-annotators-heavy (cons 'function #'my/marginalia-annotate-function-with-args))
  (add-to-list 'marginalia-prompt-categories (cons <span class="org-string">"\\&lt;function\\&gt;"</span> 'function)))
</pre>
</div>
</div>
</div>


<div id="outline-container-org992ebe5" class="outline-5">
<h5 id="org992ebe5">Using Embark to offer context-sensitive actions for Org elements</h5>
<div class="outline-text-5" id="text-org992ebe5">
<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org5a36e56">(<span class="org-keyword">defun</span> <span class="org-function-name">my/embark-org-element</span> () 
  <span class="org-doc">"Target an Org Mode element at point."</span>
  (<span class="org-keyword">save-window-excursion</span>
    (<span class="org-keyword">save-excursion</span>
      (<span class="org-keyword">save-restriction</span>
        (<span class="org-keyword">when</span> (derived-mode-p 'org-agenda-mode)
          (org-goto-marker-or-bmk (org-get-at-bol 'org-marker))
          (org-back-to-heading))
        (<span class="org-keyword">when</span> (derived-mode-p 'org-mode)
          (<span class="org-keyword">let*</span> ((context <span class="org-comment-delimiter">;; </span><span class="org-comment">Borrowed from org-open-at-point</span>
                  <span class="org-comment-delimiter">;; </span><span class="org-comment">Only consider supported types, even if they are not the</span>
                  <span class="org-comment-delimiter">;; </span><span class="org-comment">closest one.</span>
                  (org-element-lineage (org-element-context) 
                                       '(headline src-block link) t)) 
                 (type (org-element-type context)) 
                 (value (org-element-property <span class="org-builtin">:value</span> context))) 
            (<span class="org-keyword">cond</span> ((eq type 'headline) 
                   (cons 'org-heading (org-element-property <span class="org-builtin">:title</span> context))) 
                  ((eq type 'src-block) 
                   (cons 'org-src-block (org-element-property <span class="org-builtin">:name</span> context)))
                  ((eq type 'link) 
                   (cons 'url (org-element-property <span class="org-builtin">:raw-link</span> context))))))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/embark-org-src-block-copy-noweb-reference</span> (element) 
  (kill-new (<span class="org-keyword">if</span> (org-element-property element <span class="org-builtin">:parameters</span>) 
                (format <span class="org-string">"&lt;&lt;%s(%s)&gt;&gt;"</span> (org-element-property element <span class="org-builtin">:name</span>) 
                        (org-element-property element <span class="org-builtin">:parameters</span>)) 
              (format <span class="org-string">"&lt;&lt;%s&gt;&gt;"</span> (org-element-property element <span class="org-builtin">:parameters</span>)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-orge42d945" class="outline-5">
<h5 id="orge42d945">Cargo-culted stuff</h5>
<div class="outline-text-5" id="text-orge42d945">
<p>
<a href="https://github.com/oantolin/embark/wiki/Additional-Configuration#pause-selectrum-while-using-embark-collect-live">https://github.com/oantolin/embark/wiki/Additional-Configuration#pause-selectrum-while-using-embark-collect-live</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/refresh-selectrum</span> () 
  (<span class="org-keyword">setq</span> selectrum--previous-input-string nil))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/store-action-key+cmd</span> (cmd) 
  (<span class="org-keyword">setq</span> keycast--this-command-keys (this-single-command-keys) keycast--this-command cmd))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/force-keycast-update</span> (<span class="org-type">&amp;rest</span> _) 
  (force-mode-line-update t))
(<span class="org-keyword">use-package</span> <span class="org-constant">keycast</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:after</span> embark 
  <span class="org-builtin">:config</span> (<span class="org-keyword">dolist</span> (cmd '(embark-act embark-act-noexit embark-become)) 
            (advice-add cmd 
                        <span class="org-builtin">:before</span> #'my/force-keycast-update)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/shrink-selectrum</span> () 
  (<span class="org-keyword">when</span> (eq embark-collect--kind <span class="org-builtin">:live</span>) 
    (<span class="org-keyword">with-selected-window</span> (active-minibuffer-window) 
      (<span class="org-keyword">setq-local</span> selectrum-num-candidates-displayed 1) 
      (<span class="org-keyword">setq-local</span> selectrum-display-style '(horizontal <span class="org-builtin">:before-candidates</span> <span class="org-string">"["</span> 
                                                       <span class="org-builtin">:after-candidates</span> <span class="org-string">"]"</span> 
                                                       <span class="org-builtin">:more-candidates</span> <span class="org-string">""</span> 
                                                       <span class="org-builtin">:candidates-separator</span> <span class="org-string">""</span>)))))
(<span class="org-keyword">use-package</span> 
  embark 
  <span class="org-builtin">:config</span>
                                        <span class="org-comment-delimiter">;</span><span class="org-comment">(setq embark-prompter 'embark-completing-read-prompter)</span>
  (advice-add 'embark-keymap-prompter <span class="org-builtin">:filter-return</span> #'my/store-action-key+cmd) 
  (add-to-list 'embark-allow-edit-commands #'my/stream-message) 
  (add-hook 'embark-collect-mode-hook #'my/shrink-selectrum) 
  (add-hook 'embark-pre-action-hook #'my/refresh-selectrum))
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-org555e08a" class="outline-4">
<h4 id="org555e08a">Contextual actions with cmap</h4>
<div class="outline-text-4" id="text-org555e08a">
<p>
It doesn't look like Embark allows me to consider different targets. cmap might be interesting.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">      (<span class="org-keyword">defun</span> <span class="org-function-name">my/cmap-org-block-target</span> ()
  (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (derived-mode-p 'org-mode)
       (org-in-src-block-p))
    (cons 'my/cmap-org-block-map 'cmap-no-arg)))
      (<span class="org-keyword">defun</span> <span class="org-function-name">my/org-indent-block</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-excursion</span>
   (<span class="org-keyword">unless</span> (looking-at <span class="org-string">"^[ \t]*#\\+begin"</span>)
     (re-search-backward <span class="org-string">"^[ \t]*#\\+begin"</span> nil t))
   (org-indent-block)))
      (<span class="org-keyword">defun</span> <span class="org-function-name">my/org-copy-block-contents</span> ()
  (<span class="org-keyword">interactive</span>)
  (kill-new (org-element-property <span class="org-builtin">:value</span> (org-element-context))))
      (<span class="org-keyword">use-package</span> <span class="org-constant">cmap</span> <span class="org-builtin">:quelpa</span> (cmap <span class="org-builtin">:fetcher</span> github <span class="org-builtin">:repo</span> <span class="org-string">"jyp/cmap"</span>)
  <span class="org-builtin">:config</span>
  (add-to-list 'cmap-targets #'my/cmap-org-block-target)
  (<span class="org-keyword">defvar</span> <span class="org-variable-name">my/cmap-org-block-map</span> 
    (<span class="org-keyword">cmap-keymap</span>
     (<span class="org-string">"w"</span> . my/org-copy-block-contents)
     (<span class="org-string">"i"</span> . my/org-indent-block)))
  <span class="org-builtin">:bind</span> (<span class="org-string">"C-c e"</span> . cmap-cmap))
</pre>
</div>
<p>
<a href="https://github.com/oantolin/embark/issues/92">https://github.com/oantolin/embark/issues/92</a>
</p>
</div>
</div>
<div id="outline-container-orgd09f4d9" class="outline-4">
<h4 id="orgd09f4d9">Helm - interactive completion</h4>
<div class="outline-text-4" id="text-orgd09f4d9">
<p>
Helm makes it easy to complete various things. I find it to be easier
to configure than ido in order to get completion in as many places as
possible, although I prefer ido's way of switching buffers.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">helm</span>
  <span class="org-builtin">:diminish</span> helm-mode
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">progn</span>
    (<span class="org-keyword">require</span> '<span class="org-constant">helm-config</span>)
    (<span class="org-keyword">require</span> '<span class="org-constant">helm-for-files</span>)
    (<span class="org-keyword">setq</span> helm-candidate-number-limit 100)
    (<span class="org-keyword">setq</span> helm-completing-read-handlers-alist
          '((describe-function)
            (consult-bookmark)
            (org-refile-get-location)
            (consult-outline)
            (consult-line)
            (org-olpath-completing-read)
            (consult-mark)
            (org-refile)
            (consult-multi-occur)
            (describe-variable)
            (execute-extended-command)
            (consult-yank)))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">From https://gist.github.com/antifuchs/9238468</span>
    (<span class="org-keyword">setq</span> helm-idle-delay 0.0 <span class="org-comment-delimiter">; </span><span class="org-comment">update fast sources immediately (doesn't).</span>
          helm-input-idle-delay 0.01  <span class="org-comment-delimiter">; </span><span class="org-comment">this actually updates things</span>
                                        <span class="org-comment-delimiter">; </span><span class="org-comment">reeeelatively quickly.</span>
          helm-yas-display-key-on-candidate t
          helm-quick-update t
          helm-M-x-requires-pattern nil
          helm-ff-skip-boring-files t))
  (<span class="org-keyword">defadvice</span> <span class="org-function-name">helm-files-insert-as-org-links</span> (around sacha activate)
    (insert (mapconcat (<span class="org-keyword">lambda</span> (candidate)
                         (org-link-make-string candidate))
                       (helm-marked-candidates)
                       <span class="org-string">"\n"</span>)))
  <span class="org-builtin">:bind</span> ((<span class="org-string">"C-c h"</span> . helm-mini)
         (<span class="org-string">"C-h a"</span> . helm-apropos)
         (<span class="org-string">"C-x C-b"</span> . helm-buffers-list)
         (<span class="org-string">"C-x c o"</span> . helm-occur)
         (<span class="org-string">"C-x c s"</span> . helm-swoop)
         (<span class="org-string">"C-x c y"</span> . helm-yas-complete)
         (<span class="org-string">"C-x c Y"</span> . helm-yas-create-snippet-on-region)
         (<span class="org-string">"C-x c SPC"</span> . helm-all-mark-rings)))
(<span class="org-keyword">use-package</span> <span class="org-constant">helm-ls-git</span>
  <span class="org-builtin">:if</span> my/laptop-p)
</pre>
</div>
<p>
Great for describing bindings. I'll replace the binding for <code>where-is</code> too.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">helm-descbinds</span>
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:bind</span> ((<span class="org-string">"C-h b"</span> . helm-descbinds)
         (<span class="org-string">"C-h w"</span> . helm-descbinds)))
</pre>
</div>

<p>
helm-grep? Bit slow and hard to read, though.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/book-notes-directory</span> <span class="org-string">"~/Dropbox/books"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/helm-do-grep-book-notes</span> ()
  <span class="org-doc">"Search my book notes."</span>
  (<span class="org-keyword">interactive</span>)
  (helm-do-grep-1 (list my/book-notes-directory)))
</pre>
</div>
</div>

<div id="outline-container-orge244aae" class="outline-5">
<h5 id="orge244aae">Getting Helm and org-refile to clock in or create tasks&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="org">org</span>&#xa0;<span class="helm">helm</span></span></h5>
<div class="outline-text-5" id="text-orge244aae">
<p>
I've been thinking about how to improve the way that I navigate to,
clock in, and create tasks in Org Mode. If the task is one of the ones
I've planned for today, I use my Org agenda. If I know that the task
exists, I use <code>C-u C-c C-w</code> (<code>org-refile</code>) to jump to it, and then <code>!</code>
(one of my <code>org-speed-commands-user</code> options) to clock in and track it
on Quantified Awesome. If I want to resume an interrupted task, I use
<code>C-u C-c j</code> (my shortcut for <code>org-clock-goto</code>). For new tasks, I go to
the appropriate project entry and create it, although I really should
be using <code>org-capture</code> instead.
</p>

<p>
<a href="https://www.flickr.com/photos/65214961@N00/16218018829">2015-01-30 Org Mode jumping to tasks &#x2013; index card #emacs #org</a>
</p>

<p>
I thought about how I can reduce some of these distinctions. For
example, what if it didn't matter whether or not a task already
exists? I can modify the org-refile interface to make it easier for me
to create tasks if my description doesn't match anything. To make
things simpler, I'll just reuse one of my <code>org-capture-templates</code>, and
I'll pre-fill it with the candidate from Helm.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my/org-capture-prefill-template</span> ()
  (<span class="org-keyword">should</span>
   <span class="org-comment-delimiter">;; </span><span class="org-comment">It should fill things in one field at ia time</span>
   (string=
    (my/org-capture-prefill-template
     <span class="org-string">"* TODO %^{Task}\nSCHEDULED: %^t\n:PROPERTIES:\n:Effort: %^{effort|1:00|0:05|0:15|0:30|2:00|4:00}\n:END:\n%?\n"</span>
     <span class="org-string">"Hello World"</span>)
    <span class="org-string">"* TODO Hello World\nSCHEDULED: %^t\n:PROPERTIES:\n:Effort: %^{effort|1:00|0:05|0:15|0:30|2:00|4:00}\n:END:\n%?\n"</span>
    ))
  (<span class="org-keyword">should</span>
   (string=
    (my/org-capture-prefill-template
     <span class="org-string">"* TODO %^{Task}\nSCHEDULED: %^t\n:PROPERTIES:\n:Effort: %^{effort|1:00|0:05|0:15|0:30|2:00|4:00}\n:END:\n%?\n"</span>
     <span class="org-string">"Hello World"</span> <span class="org-string">"&lt;2015-01-01&gt;"</span>)
    <span class="org-string">"* TODO Hello World\nSCHEDULED: &lt;2015-01-01&gt;\n:PROPERTIES:\n:Effort: %^{effort|1:00|0:05|0:15|0:30|2:00|4:00}\n:END:\n%?\n"</span>))
  (<span class="org-keyword">should</span>
   (string=
    (my/org-capture-prefill-template
     <span class="org-string">"* TODO %^{Task}\nSCHEDULED: %^t\n:PROPERTIES:\n:Effort: %^{effort|1:00|0:05|0:15|0:30|2:00|4:00}\n:END:\n%?\n"</span>
     <span class="org-string">"Hello World"</span> <span class="org-string">"&lt;2015-01-01&gt;"</span> <span class="org-string">"0:05"</span>)
    <span class="org-string">"* TODO Hello World\nSCHEDULED: &lt;2015-01-01&gt;\n:PROPERTIES:\n:Effort: 0:05\n:END:\n%?\n"</span>)))

(<span class="org-keyword">declare-function</span> org-capture-get <span class="org-string">"org-capture"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-capture-prefill-template</span> (template <span class="org-type">&amp;rest</span> values)
  <span class="org-doc">"Pre-fill TEMPLATE with VALUES."</span>
  (<span class="org-keyword">setq</span> template (<span class="org-keyword">or</span> template (org-capture-get <span class="org-builtin">:template</span>)))
  (<span class="org-keyword">with-temp-buffer</span>
    (insert template)
    (goto-char (point-min))
    (<span class="org-keyword">while</span> (re-search-forward
            (concat <span class="org-string">"%</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">"</span>
                    <span class="org-string">"\\[</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">"</span>
                    <span class="org-string">"&lt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&gt;\n]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&gt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">"</span>
                    <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[tTuUaliAcxkKInfF]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">"</span>
                    <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">:[-a-zA-Z]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">"</span>
                    <span class="org-string">"\\^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">{</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">}]*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">}</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
                    <span class="org-string">"?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[gGtTuUCLp]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">"</span>
                    <span class="org-string">"%\\\\</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[1-9][0-9]*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
                    <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>) <span class="org-warning">nil t)</span>
      (<span class="org-keyword">if</span> (car values)
          (replace-match (car values) nil t))
      (<span class="org-keyword">setq</span> values (cdr values)))
    (buffer-string)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-get-current-refile-location</span> ()
  <span class="org-doc">"Return the current entry as a location understood by org-refile."</span>
  (<span class="org-keyword">interactive</span>)
  (list (elt (org-heading-components) 4)
        (<span class="org-keyword">or</span> buffer-file-name
            (<span class="org-keyword">with-current-buffer</span> (buffer-base-buffer (current-buffer))
              buffer-file-name))
        nil
        (point)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/helm-org-create-task</span> (candidate)
  <span class="org-doc">"Creates the task and returns the location."</span>
  (<span class="org-keyword">let</span> ((entry (org-capture-select-template <span class="org-string">"T"</span>)))
    (org-capture-set-plist entry)
    (org-capture-get-template)
    (org-capture-set-target-location)
    (<span class="org-keyword">condition-case</span> error
        (<span class="org-keyword">progn</span>
          (org-capture-put
           <span class="org-builtin">:template</span>
           (org-capture-fill-template
            (my/org-capture-prefill-template (org-capture-get <span class="org-builtin">:template</span>)
                                             candidate)))
          (org-capture-place-template
           (equal (car (org-capture-get <span class="org-builtin">:target</span>)) 'function))
          (<span class="org-keyword">setq</span> org-refile-target-table (org-refile-get-targets))
          <span class="org-comment-delimiter">;; </span><span class="org-comment">Return the new location</span>
          (my/org-get-current-refile-location))
      ((<span class="org-warning">error</span> quit)
       (<span class="org-keyword">if</span> (get-buffer <span class="org-string">"*Capture*"</span>) (kill-buffer <span class="org-string">"*Capture*"</span>))
       (<span class="org-warning">error</span> <span class="org-string">"Capture abort: %s"</span> error)))))

<span class="org-comment-delimiter">;; </span><span class="org-comment">(my/org-refile-get-location-by-substring "Try again")</span>
</pre>
</div>

<p>
Next, I want to add this to the way that Helm prompts me to refile.
That means that my creation task should return something ready for
<code>org-refile</code>. Actually, maybe I don't have to do that if I know I'm
always going to call it when I want to jump to something. I might as
well add that bit of code that sets up clocking in, too.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/helm-org-refile-locations</span> nil)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/org-refile-last-location</span> nil)

(<span class="org-keyword">defun</span> <span class="org-function-name">my/helm-org-clock-in-and-track-from-refile</span> (candidate)
  (<span class="org-keyword">let</span> ((location (org-refile--get-location candidate my/helm-org-refile-locations)))
    (<span class="org-keyword">save-window-excursion</span>
      (org-refile 4 nil location)
      (my/org-clock-in-and-track)
      t)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-get-todays-items-as-refile-candidates</span> ()
  <span class="org-doc">"Return items scheduled for today, ready for choosing during refiling."</span>
  (delq
   nil
   (mapcar
    (<span class="org-keyword">lambda</span> (s)
      (<span class="org-keyword">if</span> (get-text-property 0 'org-marker s)
          (list
           s
           (buffer-file-name (marker-buffer (get-text-property 0 'org-marker s)))
           nil
           (marker-position (get-text-property 0 'org-marker s)))))
    (<span class="org-keyword">save-window-excursion</span> (my/org-get-entries-fn (calendar-current-date) (calendar-current-date))))))

<span class="org-comment-delimiter">;; </span><span class="org-comment">Based on http://emacs.stackexchange.com/questions/4063/how-to-get-the-raw-data-for-an-org-mode-agenda-without-an-agenda-view</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-get-entries-fn</span> (begin end)
  <span class="org-doc">"Return org schedule items between BEGIN and END.</span>
<span class="org-doc">         USAGE:  (org-get-entries-fn '(6 1 2015) '(6 30 2015))"</span>
  (<span class="org-keyword">require</span> '<span class="org-constant">calendar</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">org</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">org-agenda</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">cl</span>)
  (<span class="org-keyword">unless</span>
      (<span class="org-keyword">and</span>
       (calendar-date-is-valid-p begin)
       (calendar-date-is-valid-p end))
    (<span class="org-keyword">let</span> ((debug-on-quit nil))
      (<span class="org-warning">signal</span> 'quit `(<span class="org-string">"One or both of your gregorian dates are invalid."</span>))))
  (<span class="org-keyword">let*</span> (
         result
         (org-agenda-entry-types '(<span class="org-builtin">:scheduled</span>))
         (date-after
          (<span class="org-keyword">lambda</span> (date num)
            <span class="org-doc">"Return the date after NUM days from DATE."</span>
            (calendar-gregorian-from-absolute
             (+ (calendar-absolute-from-gregorian date) num))))
         (enumerate-days
          (<span class="org-keyword">lambda</span> (begin end)
            <span class="org-doc">"Enumerate date objects between BEGIN and END."</span>
            (<span class="org-keyword">when</span> (&gt; (calendar-absolute-from-gregorian begin)
                     (calendar-absolute-from-gregorian end))
              (<span class="org-warning">error</span> <span class="org-string">"Invalid period : %S - %S"</span> begin end))
            (<span class="org-keyword">let</span> ((d begin) ret (cont t))
              (<span class="org-keyword">while</span> cont
                (<span class="org-keyword">push</span> (copy-sequence d) ret)
                (<span class="org-keyword">setq</span> cont (not (equal d end)))
                (<span class="org-keyword">setq</span> d (funcall date-after d 1)))
              (nreverse ret)))) )
    (org-agenda-reset-markers)
    (<span class="org-keyword">setq</span> org-agenda-buffer
          (<span class="org-keyword">when</span> (buffer-live-p org-agenda-buffer)
            org-agenda-buffer))
    (org-compile-prefix-format nil)
    (<span class="org-keyword">setq</span> result
          (<span class="org-keyword">loop</span> for date in (funcall enumerate-days begin end) append
                (<span class="org-keyword">loop</span> for file in (org-agenda-files nil 'ifmode)
                      append
                      (<span class="org-keyword">progn</span>
                        (org-check-agenda-file file)
                        (apply 'org-agenda-get-day-entries file date org-agenda-entry-types)))))
    (<span class="org-keyword">unless</span> (buffer-live-p (get-buffer org-agenda-buffer-name))
      (get-buffer-create org-agenda-buffer-name))
    (<span class="org-keyword">with-current-buffer</span> (get-buffer org-agenda-buffer-name)
      (org-agenda-mode)
      (<span class="org-keyword">setq</span> buffer-read-only t)
      (<span class="org-keyword">let</span> ((inhibit-read-only t))
        (erase-buffer))
      (mapc
       (<span class="org-keyword">lambda</span> (x)
         (<span class="org-keyword">let</span> ((inhibit-read-only t))
           (insert (format <span class="org-string">"%s"</span> x) <span class="org-string">"\n"</span>)))
       result))
    <span class="org-comment-delimiter">;;    </span><span class="org-comment">(display-buffer org-agenda-buffer-name t)</span>
    result))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/helm-org-refile-read-location</span> (tbl)
  (<span class="org-keyword">setq</span> my/helm-org-refile-locations tbl)
  (helm
   (list
    <span class="org-comment-delimiter">;; </span><span class="org-comment">(helm-build-sync-source "Today's tasks"</span>
    <span class="org-comment-delimiter">;;   </span><span class="org-comment">:candidates (mapcar (lambda (a) (cons (car a) a))</span>
    <span class="org-comment-delimiter">;;                       </span><span class="org-comment">(my/org-get-todays-items-as-refile-candidates))</span>
    <span class="org-comment-delimiter">;;   </span><span class="org-comment">:action '(("Select" . identity)</span>
    <span class="org-comment-delimiter">;;             </span><span class="org-comment">("Clock in and track" . my/helm-org-clock-in-and-track-from-refile)</span>
    <span class="org-comment-delimiter">;;             </span><span class="org-comment">("Draw index card" . my/helm-org-prepare-index-card-for-subtree))</span>
    <span class="org-comment-delimiter">;;   </span><span class="org-comment">:history 'org-refile-history)</span>
    (<span class="org-keyword">helm-build-sync-source</span> <span class="org-string">"Refile targets"</span>
      <span class="org-builtin">:candidates</span> (mapcar (<span class="org-keyword">lambda</span> (a) (cons (car a) a)) tbl)
      <span class="org-builtin">:action</span> '((<span class="org-string">"Select"</span> . identity)
                (<span class="org-string">"Clock in and track"</span> . my/helm-org-clock-in-and-track-from-refile)
                (<span class="org-string">"Draw index card"</span> . my/helm-org-prepare-index-card-for-subtree))
      <span class="org-builtin">:history</span> 'org-refile-history)
    (<span class="org-keyword">helm-build-dummy-source</span> <span class="org-string">"Create task"</span>
      <span class="org-builtin">:action</span> (helm-make-actions
               <span class="org-string">"Create task"</span>
               'my/helm-org-create-task)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-refile-get-location</span> (<span class="org-type">&amp;optional</span> prompt default-buffer new-nodes no-exclude)
  <span class="org-doc">"Prompt the user for a refile location, using PROMPT.</span>
<span class="org-doc">           PROMPT should not be suffixed with a colon and a space, because</span>
<span class="org-doc">           this function appends the default value from</span>
<span class="org-doc">           `</span><span class="org-doc"><span class="org-constant">org-refile-history</span></span><span class="org-doc">' automatically, if that is not empty."</span>
  (<span class="org-keyword">let</span> ((org-refile-targets org-refile-targets)
        (org-refile-use-outline-path org-refile-use-outline-path))
    (<span class="org-keyword">setq</span> org-refile-target-table
          (org-refile-get-targets default-buffer))
    (<span class="org-keyword">unless</span> org-refile-target-table
      (<span class="org-warning">user-error</span> <span class="org-string">"No refile targets"</span>))
    (<span class="org-keyword">let*</span> ((cbuf (current-buffer))
           (partial-completion-mode nil)
           (cfn (buffer-file-name (buffer-base-buffer cbuf)))
           (cfunc (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> org-refile-use-outline-path
                           org-outline-path-complete-in-steps)
                      'org-olpath-completing-read
                    'org-icompleting-read))
           (extra (<span class="org-keyword">if</span> org-refile-use-outline-path <span class="org-string">"/"</span> <span class="org-string">""</span>))
           (cbnex (concat (buffer-name) extra))
           (filename (<span class="org-keyword">and</span> cfn (expand-file-name cfn)))
           (tbl (mapcar
                 (<span class="org-keyword">lambda</span> (x)
                   (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (not (member org-refile-use-outline-path
                                         '(file full-file-path)))
                            (not (equal filename (nth 1 x))))
                       (cons (concat (car x) extra <span class="org-string">" ("</span>
                                     (file-name-nondirectory (nth 1 x)) <span class="org-string">")"</span>)
                             (cdr x))
                     (cons (concat (car x) extra) (cdr x))))
                 org-refile-target-table))
           (completion-ignore-case t)
           cdef
           (prompt (concat prompt
                           (<span class="org-keyword">or</span> (<span class="org-keyword">and</span> (car org-refile-history)
                                    (concat <span class="org-string">" (default "</span> (car org-refile-history) <span class="org-string">")"</span>))
                               (<span class="org-keyword">and</span> (assoc cbnex tbl) (<span class="org-keyword">setq</span> cdef cbnex)
                                    (concat <span class="org-string">" (default "</span> cbnex <span class="org-string">")"</span>))) <span class="org-string"><span class="org-warning">": "</span></span><span class="org-warning">))</span>
           pa answ parent-target child parent old-hist)
      (<span class="org-keyword">setq</span> old-hist org-refile-history)
      <span class="org-comment-delimiter">;; </span><span class="org-comment">Use Helm's sources instead</span>
      (<span class="org-keyword">setq</span> answ (my/helm-org-refile-read-location tbl))
      (<span class="org-keyword">cond</span>
       ((<span class="org-keyword">and</span> (stringp answ)
             (<span class="org-keyword">setq</span> pa (org-refile--get-location answ tbl)))
        (org-refile-check-position pa)
        (<span class="org-keyword">when</span> (<span class="org-keyword">or</span> (not org-refile-history)
                  (not (eq old-hist org-refile-history))
                  (not (equal (car pa) (car org-refile-history))))
          (<span class="org-keyword">setq</span> org-refile-history
                (cons (car pa) (<span class="org-keyword">if</span> (assoc (car org-refile-history) tbl)
                                   org-refile-history
                                 (cdr org-refile-history))))
          (<span class="org-keyword">if</span> (equal (car org-refile-history) (nth 1 org-refile-history))
              (<span class="org-keyword">pop</span> org-refile-history)))
        (<span class="org-keyword">setq</span> my/org-refile-last-location pa)
        pa)
       ((<span class="org-keyword">and</span> (stringp answ) (string-match <span class="org-string">"\\`</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">/]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\'"</span> answ))
        (<span class="org-keyword">setq</span> parent (match-string 1 answ)
              child (match-string 2 answ))
        (<span class="org-keyword">setq</span> parent-target (org-refile--get-location parent tbl))
        (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> parent-target
                   (<span class="org-keyword">or</span> (eq new-nodes t)
                       (<span class="org-keyword">and</span> (eq new-nodes 'confirm)
                            (y-or-n-p (format <span class="org-string">"Create new node \"%s\"? "</span>
                                              child)))))
          (org-refile-new-child parent-target child)))
       ((listp answ) answ) <span class="org-comment-delimiter">;; </span><span class="org-comment">Sacha: Helm returned a refile location</span>
       ((not (equal answ t))
        (<span class="org-warning">user-error</span> <span class="org-string">"Invalid target location"</span>))))))

<span class="org-comment-delimiter">;</span><span class="org-comment">(fset 'org-refile-get-location 'my/org-refile-get-location)</span>
</pre>
</div>

<p>
Hooray! Now <code>C-u C-c C-w</code> (<code>org-refile</code>) also lets me use <code>TAB</code> or
<code>F2</code> to select the alternative action of quickly clocking in on a
task. Mwahaha.
</p>

<p>
I think I'm getting the hang of tweaking Helm. Yay!
</p>
</div>
</div>

<div id="outline-container-org95dab6d" class="outline-5">
<h5 id="org95dab6d">Org Mode: Create a quick timestamped note and capture a screenshot&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="org">org</span></span></h5>
<div class="outline-text-5" id="text-org95dab6d">
<p>
I wanted to be able to quickly create timestamped notes and possibly
capture a screenshot. Prompting for a value inside an
<code>org-capture-template</code> disrupts my screen a little, so maybe this will
make it as easy as possible. I could probably do this without going
through org-capture-templates, but I wanted to take advantage of the
fact that Org Mode will deal with the date tree and finding the right
position itself.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-capture-prefill-template</span> (template <span class="org-type">&amp;rest</span> values)
  <span class="org-doc">"Pre-fill TEMPLATE with VALUES."</span>
  (<span class="org-keyword">setq</span> template (<span class="org-keyword">or</span> template (org-capture-get <span class="org-builtin">:template</span>)))
  (<span class="org-keyword">with-temp-buffer</span>
    (insert template)
    (goto-char (point-min))
    (<span class="org-keyword">while</span> (re-search-forward
            (concat <span class="org-string">"%</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">"</span>
                    <span class="org-string">"\\[</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">"</span>
                    <span class="org-string">"&lt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&gt;\n]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&gt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">"</span>
                    <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[tTuUaliAcxkKInfF]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">"</span>
                    <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">:[-a-zA-Z]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">"</span>
                    <span class="org-string">"\\^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">{</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">}]*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">}</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
                    <span class="org-string">"?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[gGtTuUCLp]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">"</span>
                    <span class="org-string">"%\\\\</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[1-9][0-9]*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
                    <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>) <span class="org-warning">nil t)</span>
      (<span class="org-keyword">if</span> (car values)
          (replace-match (car values) nil t))
      (<span class="org-keyword">setq</span> values (cdr values)))
    (buffer-string)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/capture-screenshot</span> (time <span class="org-type">&amp;optional</span> note)
  <span class="org-doc">"Capture screenshot and save it to a file labeled with TIME and NOTE.</span>
<span class="org-doc">       Return the filename."</span>
  (<span class="org-keyword">interactive</span> (list (current-time) (read-string <span class="org-string">"Note: "</span>)))
  (<span class="org-keyword">let*</span> ((filename (expand-file-name
                    (concat <span class="org-string">"Screenshot_"</span>
                            (format-time-string <span class="org-string">"%Y%0m%d_%H%M%S"</span> time)
                            (<span class="org-keyword">if</span> note (concat <span class="org-string">" "</span> note) <span class="org-string">""</span>)
                            <span class="org-string">".png"</span>)
                    <span class="org-string">"~/Pictures"</span>))
         (cmd (concat <span class="org-string">"spectacle -b -o "</span>
                      (shell-quote-argument filename))))
    (shell-command cmd)
    filename))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/capture-timestamped-note</span> (time note)
  <span class="org-doc">"Disable Helm and capture a quick timestamped note."</span>
  (<span class="org-keyword">interactive</span> (list (current-time) (read-string <span class="org-string">"Note: "</span>)))
  (<span class="org-keyword">let</span> ((helm-completing-read-handlers-alist '((org-capture . nil)))
        (entry (org-capture-select-template <span class="org-string">"p"</span>)))
    (org-capture-set-plist entry)
    (org-capture-get-template)
    (org-capture-set-target-location)
    (org-capture-put
     <span class="org-builtin">:template</span> (org-capture-fill-template
                (my/org-capture-prefill-template (org-capture-get <span class="org-builtin">:template</span>)
                                                 (format-time-string <span class="org-string">"%H:%M:%S,%3N"</span>)
                                                 note)))
    (org-capture-place-template)
    (org-capture-finalize)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/capture-timestamped-note-with-screenshot</span> (time note)
  (<span class="org-keyword">interactive</span> (list (current-time) (read-string <span class="org-string">"Note: "</span>)))
  (kill-new (my/capture-screenshot time note))
  (my/capture-timestamped-note time note))
</pre>
</div>

<p>
Then I can call it with <code>h h n</code> for <code>my/capture-timestamped-note</code> or
<code>h h i</code> for <code>my/capture-timestamped-note-with-screenshot</code> via keyboard
shortcuts defined elsewhere in my <a href="https://sachachua.com/dotemacs">config</a> (see <code>my/key-chord-commands</code>).
</p>
</div>
</div>
</div>

<div id="outline-container-orge6ec299" class="outline-4">
<h4 id="orge6ec299">Recomplete</h4>
<div class="outline-text-4" id="text-orge6ec299">
<p>
<a href="https://gitlab.com/ideasman42/emacs-recomplete">https://gitlab.com/ideasman42/emacs-recomplete</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">recomplete</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:quelpa</span> (recomplete <span class="org-builtin">:fetcher</span> gitlab <span class="org-builtin">:repo</span> <span class="org-string">"ideasman42/emacs-recomplete"</span>)
  <span class="org-builtin">:bind</span> (<span class="org-string">"M-/"</span> . recomplete-dabbrev))
</pre>
</div>

<p>
I like this because it lets me see the completions coming up.
</p>
</div>
</div>

<div id="outline-container-org4274af7" class="outline-4">
<h4 id="org4274af7">Mode line format</h4>
<div class="outline-text-4" id="text-org4274af7">
<p>
Display a more compact mode line
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">smart-mode-line</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org6723871" class="outline-4">
<h4 id="org6723871">Change "yes or no" to "y or n"</h4>
<div class="outline-text-4" id="text-org6723871">
<p>
Lazy people like me never want to type "yes" when "y" will suffice.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(fset 'yes-or-no-p 'y-or-n-p)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf2b1e0d" class="outline-4">
<h4 id="orgf2b1e0d">Minibuffer editing - more space!</h4>
<div class="outline-text-4" id="text-orgf2b1e0d">
<p>
Sometimes you want to be able to do fancy things with the text
that you're entering into the minibuffer. Sometimes you just want
to be able to read it, especially when it comes to lots of text.
This binds <code>C-M-e</code> in a minibuffer) so that you can edit the
contents of the minibuffer before submitting it.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">miniedit</span>
  <span class="org-builtin">:commands</span> minibuffer-edit
  <span class="org-builtin">:init</span> (miniedit-install))
</pre>
</div>
</div>
</div>

<div id="outline-container-org0f9db8a" class="outline-4">
<h4 id="org0f9db8a">Set up a light-on-dark color scheme</h4>
<div class="outline-text-4" id="text-org0f9db8a">
<p>
I like light on dark because I find it to be more restful. The
color-theme in ELPA was a little odd, though, so we define some advice to make
it work. Some things still aren't quite right.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/setup-color-theme</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">when</span> (display-graphic-p) 
    (color-theme-sanityinc-solarized-dark))
  (set-background-color <span class="org-string">"black"</span>)
  (set-face-foreground 'secondary-selection <span class="org-string">"darkblue"</span>)
  (set-face-background 'secondary-selection <span class="org-string">"lightblue"</span>)
  (set-face-background 'font-lock-doc-face <span class="org-string">"black"</span>)
  (set-face-foreground 'font-lock-doc-face <span class="org-string">"wheat"</span>)
  (set-face-background 'font-lock-string-face <span class="org-string">"black"</span>))
(<span class="org-keyword">use-package</span> <span class="org-constant">color-theme-sanityinc-solarized</span> <span class="org-builtin">:config</span> (my/setup-color-theme))
</pre>
</div>

<p>
I sometimes need to switch to a lighter background for screenshots.
For that, I use <code>color-theme-vim</code>.
</p>

<p>
Some more tweaks to solarized:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">when</span> window-system
  (custom-set-faces
   '(erc-input-face ((t (<span class="org-builtin">:foreground</span> <span class="org-string">"antique white"</span>))))
   '(helm-selection ((t (<span class="org-builtin">:background</span> <span class="org-string">"ForestGreen"</span> <span class="org-builtin">:foreground</span> <span class="org-string">"black"</span>))))
   '(org-agenda-clocking ((t (<span class="org-builtin">:inherit</span> secondary-selection <span class="org-builtin">:foreground</span> <span class="org-string">"black"</span>))) t)
   '(org-agenda-done ((t (<span class="org-builtin">:foreground</span> <span class="org-string">"dim gray"</span> <span class="org-builtin">:strike-through</span> nil))))
   '(org-done ((t (<span class="org-builtin">:foreground</span> <span class="org-string">"PaleGreen"</span> <span class="org-builtin">:weight</span> normal <span class="org-builtin">:strike-through</span> t))))
   '(org-clock-overlay ((t (<span class="org-builtin">:background</span> <span class="org-string">"SkyBlue4"</span> <span class="org-builtin">:foreground</span> <span class="org-string">"black"</span>))))
   '(org-headline-done ((((class color) (min-colors 16) (background dark)) (<span class="org-builtin">:foreground</span> <span class="org-string">"LightSalmon"</span> <span class="org-builtin">:strike-through</span> t))))
   '(outline-1 ((t (<span class="org-builtin">:inherit</span> font-lock-function-name-face <span class="org-builtin">:foreground</span> <span class="org-string">"cornflower blue"</span>))))))

</pre>
</div>
</div>
</div>

<div id="outline-container-orge08a178" class="outline-4">
<h4 id="orge08a178">Undo tree mode - visualize your undos and branches</h4>
<div class="outline-text-4" id="text-orge08a178">
<p>
People often struggle with the Emacs undo model, where there's really no concept of "redo" - you simply undo the undo.
</p>

<p>
This lets you use <code>C-x u</code> (<code>undo-tree-visualize</code>) to visually walk through the changes you've made, undo back to a certain point (or redo), and go down different branches.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">undo-tree</span>
  <span class="org-builtin">:diminish</span> undo-tree-mode
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">progn</span>
    (global-undo-tree-mode)
    (<span class="org-keyword">setq</span> undo-tree-visualizer-timestamps t)
    (<span class="org-keyword">setq</span> undo-tree-visualizer-diff t)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfb9e6b4" class="outline-4">
<h4 id="orgfb9e6b4">which-key and which-key-posframe</h4>
<div class="outline-text-4" id="text-orgfb9e6b4">
<p>
It's hard to remember keyboard shortcuts. 
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">which-key</span> <span class="org-builtin">:init</span> (which-key-mode 1))
(<span class="org-keyword">use-package</span> <span class="org-constant">which-key-posframe</span> <span class="org-builtin">:if</span> my/laptop-p <span class="org-builtin">:init</span> (which-key-posframe-mode 1))
</pre>
</div>
</div>
</div>

<div id="outline-container-org4abb115" class="outline-4">
<h4 id="org4abb115">UTF-8</h4>
<div class="outline-text-4" id="text-org4abb115">
<p>
From <a href="http://www.wisdomandwonder.com/wordpress/wp-content/uploads/2014/03/C3F.html">http://www.wisdomandwonder.com/wordpress/wp-content/uploads/2014/03/C3F.html</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(prefer-coding-system 'utf-8)
(<span class="org-keyword">when</span> (display-graphic-p)
  (<span class="org-keyword">setq</span> x-select-request-type '(UTF8_STRING COMPOUND_TEXT TEXT STRING)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org064c5e4" class="outline-4">
<h4 id="org064c5e4">Killing text</h4>
<div class="outline-text-4" id="text-org064c5e4">
<div class="org-src-container">
<pre class="src src-emacs-lisp">    (<span class="org-keyword">setq</span> kill-ring-max 1000)
</pre>
</div>

<p>
From <a href="https://github.com/itsjeyd/emacs-config/blob/emacs24/init.el">https://github.com/itsjeyd/emacs-config/blob/emacs24/init.el</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice</span> <span class="org-function-name">kill-region</span> (before slick-cut activate compile)
  <span class="org-doc">"When called interactively with no active region, kill a single line instead."</span>
  (<span class="org-keyword">interactive</span>
   (<span class="org-keyword">if</span> mark-active (list (region-beginning) (region-end))
     (list (line-beginning-position)
           (line-beginning-position 2)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org293a548" class="outline-4">
<h4 id="org293a548">Repeatable commands</h4>
<div class="outline-text-4" id="text-org293a548">
<p>
Based on <a href="http://oremacs.com/2015/01/14/repeatable-commands/">http://oremacs.com/2015/01/14/repeatable-commands/</a> . Modified to
accept <code>nil</code> as the first value if you don't want the keymap to run a
command by default, and to use <code>kbd</code> for the keybinding definitions.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/def-rep-command</span> (alist)
  <span class="org-doc">"Return a lambda that calls the first function of ALIST.</span>
<span class="org-doc">      It sets the transient map to all functions of ALIST,</span>
<span class="org-doc">      allowing you to repeat those functions as needed."</span>
  (<span class="org-keyword">let</span> ((keymap (make-sparse-keymap))
        (func (cdar alist)))
    (mapc (<span class="org-keyword">lambda</span> (x)
            (<span class="org-keyword">when</span> x
              (define-key keymap (kbd (car x)) (cdr x))))
          alist)
    (<span class="org-keyword">lambda</span> (arg)
      (<span class="org-keyword">interactive</span> <span class="org-string">"p"</span>)
      (<span class="org-keyword">when</span> func
        (funcall func arg))
      (set-transient-map keymap t))))
</pre>
</div>
</div>

<div id="outline-container-orgaca3987" class="outline-5">
<h5 id="orgaca3987"><span class="todo TODO">TODO</span> Look for opportunities to use this</h5>
</div>
</div>
</div>

<div id="outline-container-orgc697db8" class="outline-3">
<h3 id="orgc697db8">Navigation</h3>
<div class="outline-text-3" id="text-orgc697db8">
</div>
<div id="outline-container-orgad34db0" class="outline-4">
<h4 id="orgad34db0">Pop to mark</h4>
<div class="outline-text-4" id="text-orgad34db0">
<p>
Handy way of getting back to previous places.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">bind-key</span> <span class="org-string">"C-x p"</span> 'pop-to-mark-command)
(<span class="org-keyword">setq</span> set-mark-command-repeat-pop t)
</pre>
</div>
</div>
</div>

<div id="outline-container-org9aed53b" class="outline-4">
<h4 id="org9aed53b">Helm-swoop - quickly finding lines</h4>
<div class="outline-text-4" id="text-org9aed53b">
<p>
This promises to be a fast way to find things. Let's bind it to <code>Ctrl-Shift-S</code> to see if I can get used to that&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">helm-swoop</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:bind</span>
  ((<span class="org-string">"C-S-s"</span> . helm-swoop)
   (<span class="org-string">"M-i"</span> . helm-swoop)
   (<span class="org-string">"M-s s"</span> . helm-swoop)
   (<span class="org-string">"M-s M-s"</span> . helm-swoop)
   (<span class="org-string">"M-I"</span> . helm-swoop-back-to-last-point)
   (<span class="org-string">"C-c M-i"</span> . helm-multi-swoop)
   (<span class="org-string">"C-x M-i"</span> . helm-multi-swoop-all)
   )
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">progn</span>
    (define-key isearch-mode-map (kbd <span class="org-string">"M-i"</span>) 'helm-swoop-from-isearch)
    (define-key helm-swoop-map (kbd <span class="org-string">"M-i"</span>) 'helm-multi-swoop-all-from-helm-swoop))
  )
</pre>
</div>
</div>
</div>

<div id="outline-container-org4d916b7" class="outline-4">
<h4 id="org4d916b7">Highlight Line Mode</h4>
<div class="outline-text-4" id="text-org4d916b7">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(global-hl-line-mode 1)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgea87887" class="outline-4">
<h4 id="orgea87887">Windmove - switching between windows</h4>
<div class="outline-text-4" id="text-orgea87887">
<p>
Windmove lets you move between windows with something more natural than cycling through <code>C-x o</code> (<code>other-window</code>).
Windmove doesn't behave well with Org, so we need to use different keybindings.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">windmove</span>
  <span class="org-builtin">:bind</span>
  ((<span class="org-string">"&lt;f2&gt; &lt;right&gt;"</span> . windmove-right)
   (<span class="org-string">"&lt;f2&gt; &lt;left&gt;"</span> . windmove-left)
   (<span class="org-string">"&lt;f2&gt; &lt;up&gt;"</span> . windmove-up)
   (<span class="org-string">"&lt;f2&gt; &lt;down&gt;"</span> . windmove-down)
   ))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcbb0aaf" class="outline-4">
<h4 id="orgcbb0aaf">Frequently-accessed files</h4>
<div class="outline-text-4" id="text-orgcbb0aaf">
<p>
Registers allow you to jump to a file or other location quickly. To
jump to a register, use <code>C-x r j</code> followed by the letter of the
register. Using registers for all these file shortcuts is probably a bit of a waste since I can easily define my own keymap, but since I rarely go beyond register A anyway. Also, I might as well add shortcuts for refiling.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> bookmark-watch-bookmark-file 'silent)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/refile-map</span> (make-sparse-keymap))
(<span class="org-keyword">require</span> '<span class="org-constant">bookmark</span>)
(<span class="org-keyword">defmacro</span> <span class="org-function-name">my/defshortcut</span> (key file)
  `(<span class="org-keyword">progn</span>
     (set-register ,key (cons 'file ,file))
     (bookmark-store ,file (list (cons 'filename ,file)
                                 (cons 'position 1)
                                 (cons 'front-context-string <span class="org-string">""</span>)) <span class="org-warning">nil)</span>
     (define-key my/refile-map
       (char-to-string ,key)
       (<span class="org-keyword">lambda</span> (prefix)
         (<span class="org-keyword">interactive</span> <span class="org-string">"p"</span>)
         (<span class="org-keyword">let</span> ((org-refile-targets '(((,file) <span class="org-builtin">:maxlevel</span> . 6)))
               (current-prefix-arg (<span class="org-keyword">or</span> current-prefix-arg '(4))))
           (call-interactively 'org-refile))))))


(define-key my/refile-map <span class="org-string">","</span> 'my/org-refile-to-previous-in-file)

(<span class="org-keyword">let*</span> ((file <span class="org-string">"~/code/emacs-calendar/README.org"</span>)
       (record `((filename . ,file) (position . 1) (rear-context-string) (front-context-string))))
  (bookmark-store file record nil))
     
(<span class="org-keyword">my/defshortcut</span> ?C <span class="org-string">"~/code/emacs-calendar/README.org"</span>)
(<span class="org-keyword">my/defshortcut</span> ?e <span class="org-string">"~/code/.emacs.d/Sacha.org"</span>)
(<span class="org-keyword">my/defshortcut</span> ?E <span class="org-string">"~/sync/emacs-news/index.org"</span>)
(<span class="org-keyword">my/defshortcut</span> ?f <span class="org-string">"~/code/font/README.org"</span>)
(<span class="org-keyword">my/defshortcut</span> ?i <span class="org-string">"~/orgzly/computer-inbox.org"</span>)
(<span class="org-keyword">my/defshortcut</span> ?I <span class="org-string">"~/orgzly/Inbox.org"</span>)
(<span class="org-keyword">my/defshortcut</span> ?o <span class="org-string">"~/orgzly/organizer.org"</span>)
(<span class="org-keyword">my/defshortcut</span> ?s <span class="org-string">"~/code/stream/notes.org"</span>)
(<span class="org-keyword">my/defshortcut</span> ?b <span class="org-string">"~/personal/business.org"</span>)
(<span class="org-keyword">my/defshortcut</span> ?p <span class="org-string">"/ssh:web:/mnt/prev/home/sacha/planet/en.ini"</span>)
(<span class="org-keyword">my/defshortcut</span> ?B <span class="org-string">"~/Dropbox/books"</span>)
(<span class="org-keyword">my/defshortcut</span> ?n <span class="org-string">"~/sync/notes"</span>)
(<span class="org-keyword">my/defshortcut</span> ?N <span class="org-string">"~/sync/notes/QuickNote.md"</span>)
(<span class="org-keyword">my/defshortcut</span> ?w <span class="org-string">"~/Dropbox/public/sharing/index.org"</span>)
(<span class="org-keyword">my/defshortcut</span> ?W <span class="org-string">"~/Dropbox/public/sharing/blog.org"</span>)
(<span class="org-keyword">my/defshortcut</span> ?r <span class="org-string">"~/personal/reviews.org"</span>)
(<span class="org-keyword">my/defshortcut</span> ?j <span class="org-string">"~/personal/journal.org"</span>)
(<span class="org-keyword">my/defshortcut</span> ?J <span class="org-string">"~/cloud/a/Journal.csv"</span>)
(<span class="org-keyword">my/defshortcut</span> ?g <span class="org-string">"~/code/sachac.github.io/evil-plans/index.org"</span>)
(<span class="org-keyword">my/defshortcut</span> ?c <span class="org-string">"~/code/dev/elisp-course.org"</span>)
(<span class="org-keyword">my/defshortcut</span> ?C <span class="org-string">"~/personal/calendar.org"</span>)
(<span class="org-keyword">my/defshortcut</span> ?l <span class="org-string">"~/orgzly/learning.org"</span>)
(<span class="org-keyword">my/defshortcut</span> ?L <span class="org-string">"~/orgzly/stories.org"</span>)
(<span class="org-keyword">my/defshortcut</span> ?q <span class="org-string">"~/sync/notes/QuickNote.md"</span>)
(<span class="org-keyword">my/defshortcut</span> ?Q <span class="org-string">"~/personal/questions.org"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-key-chord" class="outline-4">
<h4 id="key-chord">Key chords and Hydras</h4>
<div class="outline-text-4" id="text-key-chord">
<p>
I'm on a Dvorak keyboard, so these might not work for you.
Experimenting with this. <code>key-chord</code> lets you define keyboard
shortcuts that use ordinary keys.
</p>

<p>
Some code from <a href="http://emacsredux.com/blog/2013/04/28/switch-to-previous-buffer/">http://emacsredux.com/blog/2013/04/28/switch-to-previous-buffer/</a>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/key-chord-define</span> (keymap keys command)
  <span class="org-doc">"Define in KEYMAP, a key-chord of two keys in KEYS starting a COMMAND.</span>
<span class="org-doc">      \nKEYS can be a string or a vector of two elements. Currently only elements</span>
<span class="org-doc">      that corresponds to ascii codes in the range 32 to 126 can be used.</span>
<span class="org-doc">      \nCOMMAND can be an interactive function, a string, or nil.</span>
<span class="org-doc">      If COMMAND is nil, the key-chord is removed.</span>

<span class="org-doc">      MODIFICATION: Do not define the transposed key chord.</span>
<span class="org-doc">      "</span>
  (<span class="org-keyword">if</span> (/= 2 (length keys))
      (<span class="org-warning">error</span> <span class="org-string">"Key-chord keys must have two elements"</span>))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Exotic chars in a string are &gt;255 but define-key wants 128..255 for those</span>
  (<span class="org-keyword">let</span> ((key1 (logand 255 (aref keys 0)))
        (key2 (logand 255 (aref keys 1))))
    (define-key keymap (vector 'key-chord key1 key2) command)))
(fset 'key-chord-define 'my/key-chord-define)

(<span class="org-keyword">defun</span> <span class="org-function-name">my/switch-to-previous-buffer</span> ()
  <span class="org-doc">"Switch to previously open buffer.</span>
<span class="org-doc">      Repeated invocations toggle between the two most recently open buffers."</span>
  (<span class="org-keyword">interactive</span>)
  (switch-to-buffer (other-buffer (current-buffer) 1)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-check-agenda</span> ()
  <span class="org-doc">"Peek at agenda."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">cond</span>
   ((derived-mode-p 'org-agenda-mode)
    (<span class="org-keyword">if</span> (window-parent) (delete-window) (bury-buffer)))
   ((get-buffer <span class="org-string">"*Org Agenda*"</span>)
    (switch-to-buffer-other-window <span class="org-string">"*Org Agenda*"</span>))
   (t (org-agenda nil <span class="org-string">"a"</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/goto-random-char</span> ()
  (<span class="org-keyword">interactive</span>)
  (goto-char (random (point-max))))

(<span class="org-keyword">use-package</span> <span class="org-constant">hydra</span>
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">defhydra</span> my/goto-random-char-hydra ()
    (<span class="org-string">"r"</span> my/goto-random-char))

  (<span class="org-keyword">defhydra</span> my/window-movement ()
    (<span class="org-string">"&lt;left&gt;"</span> windmove-left)
    (<span class="org-string">"&lt;right&gt;"</span> windmove-right)
    (<span class="org-string">"&lt;down&gt;"</span> windmove-down)
    (<span class="org-string">"&lt;up&gt;"</span> windmove-up)
    (<span class="org-string">"y"</span> other-window <span class="org-string">"other"</span>)
    (<span class="org-string">"h"</span> switch-window <span class="org-string">"switch-window"</span>)
    (<span class="org-string">"f"</span> find-file <span class="org-string">"file"</span>)
    (<span class="org-string">"F"</span> find-file-other-window <span class="org-string">"other file"</span>)
    (<span class="org-string">"v"</span> (<span class="org-keyword">progn</span> (split-window-right) (windmove-right)))
    (<span class="org-string">"o"</span> delete-other-windows <span class="org-builtin">:color</span> blue)
    (<span class="org-string">"a"</span> ace-window)
    (<span class="org-string">"s"</span> ace-swap-window)
    (<span class="org-string">"d"</span> delete-window <span class="org-string">"delete"</span>)
    (<span class="org-string">"D"</span> ace-delete-window <span class="org-string">"ace delete"</span>)
    (<span class="org-string">"i"</span> ace-maximize-window <span class="org-string">"maximize"</span>)
    (<span class="org-string">"b"</span> helm-buffers-list)
    (<span class="org-string">"q"</span> nil))
  (<span class="org-keyword">defhydra</span> join-lines ()
    (<span class="org-string">"&lt;up&gt;"</span> join-line)
    (<span class="org-string">"&lt;down&gt;"</span> (join-line 1))
    (<span class="org-string">"t"</span> join-line)
    (<span class="org-string">"n"</span> (join-line 1)))
  (<span class="org-keyword">defhydra</span> my/org (<span class="org-builtin">:color</span> blue)
    <span class="org-doc">"Convenient Org stuff."</span>
    (<span class="org-string">"p"</span> my/org-show-active-projects <span class="org-string">"Active projects"</span>)
    (<span class="org-string">"a"</span> (org-agenda nil <span class="org-string">"a"</span>) <span class="org-string">"Agenda"</span>))
  (<span class="org-keyword">defhydra</span> my/engine-mode-hydra (<span class="org-builtin">:color</span> blue)
    <span class="org-doc">"Engine mode"</span>
    (<span class="org-string">"b"</span> engine/search-my-blog <span class="org-string">"blog"</span>)
    (<span class="org-string">"f"</span> engine/search-my-photos <span class="org-string">"flickr"</span>)
    (<span class="org-string">"m"</span> engine/search-mail <span class="org-string">"mail"</span>)
    (<span class="org-string">"g"</span> engine/search-google <span class="org-string">"google"</span>)
    (<span class="org-string">"e"</span> engine/search-emacswiki <span class="org-string">"emacswiki"</span>))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">From https://github.com/abo-abo/hydra</span>
  (<span class="org-keyword">defhydra</span> hydra-buffer-menu (<span class="org-builtin">:color</span> pink
                                      <span class="org-builtin">:hint</span> nil)
    <span class="org-doc">"</span>
<span class="org-doc">      ^Mark^             ^Unmark^           ^Actions^          ^Search</span>
<span class="org-doc">      ^^^^^^^^-----------------------------------------------------------------</span>
<span class="org-doc">      _m_: mark          _u_: unmark        _x_: execute       _R_: re-isearch</span>
<span class="org-doc">      _s_: save          _U_: unmark up     _b_: bury          _I_: isearch</span>
<span class="org-doc">      _d_: delete        ^ ^                _g_: refresh       _O_: multi-occur</span>
<span class="org-doc">      _D_: delete up     ^ ^                _T_: files only: % -28`Buffer-menu-files-only</span>
<span class="org-doc">      _~_: modified</span>
<span class="org-doc">      "</span>
    (<span class="org-string">"m"</span> Buffer-menu-mark)
    (<span class="org-string">"u"</span> Buffer-menu-unmark)
    (<span class="org-string">"U"</span> Buffer-menu-backup-unmark)
    (<span class="org-string">"d"</span> Buffer-menu-delete)
    (<span class="org-string">"D"</span> Buffer-menu-delete-backwards)
    (<span class="org-string">"s"</span> Buffer-menu-save)
    (<span class="org-string">"~"</span> Buffer-menu-not-modified)
    (<span class="org-string">"x"</span> Buffer-menu-execute)
    (<span class="org-string">"b"</span> Buffer-menu-bury)
    (<span class="org-string">"g"</span> revert-buffer)
    (<span class="org-string">"T"</span> Buffer-menu-toggle-files-only)
    (<span class="org-string">"O"</span> Buffer-menu-multi-occur <span class="org-builtin">:color</span> blue)
    (<span class="org-string">"I"</span> Buffer-menu-isearch-buffers <span class="org-builtin">:color</span> blue)
    (<span class="org-string">"R"</span> Buffer-menu-isearch-buffers-regexp <span class="org-builtin">:color</span> blue)
    (<span class="org-string">"c"</span> nil <span class="org-string">"cancel"</span>)
    (<span class="org-string">"v"</span> Buffer-menu-select <span class="org-string">"select"</span> <span class="org-builtin">:color</span> blue)
    (<span class="org-string">"o"</span> Buffer-menu-other-window <span class="org-string">"other-window"</span> <span class="org-builtin">:color</span> blue)
    (<span class="org-string">"q"</span> quit-window <span class="org-string">"quit"</span> <span class="org-builtin">:color</span> blue))

  (define-key Buffer-menu-mode-map <span class="org-string">"."</span> 'hydra-buffer-menu/body)

  (<span class="org-keyword">defun</span> <span class="org-function-name">my/org-update-link-description</span> (description)
    <span class="org-doc">"Update the current link's DESCRIPTION."</span>
    (<span class="org-keyword">interactive</span> <span class="org-string">"MDescription: "</span>)
    (<span class="org-keyword">let</span> (link)
      (<span class="org-keyword">save-excursion</span>
        (<span class="org-keyword">cond</span>
         ((org-in-regexp org-link-bracket-re 1)
          (<span class="org-keyword">setq</span> link (org-link-unescape (match-string-no-properties 1)))
          (delete-region (match-beginning 0) (match-end 0))
          (insert (org-link-make-string link description))
          (sit-for 0))
         ((<span class="org-keyword">or</span> (org-in-regexp org-link-angle-re)
              (org-in-regexp org-link-plain-re))
          (<span class="org-keyword">setq</span> link (org-unbracket-string <span class="org-string">"&lt;"</span> <span class="org-string">"&gt;"</span> (match-string 0)))
          (delete-region (match-beginning 0) (match-end 0))
          (insert (org-link-make-string link description))
          (sit-for 0))))))
  
  (<span class="org-keyword">defhydra</span> my/shortcuts (<span class="org-builtin">:exit</span> t)
    <span class="org-doc">"Shortcuts"</span>
    (<span class="org-string">"f"</span> (helm <span class="org-builtin">:sources</span> '(helm-source-projectile-files-list
                          helm-source-files-in-current-dir
                          helm-source-projectile-projects
                          helm-source-recentf
                          helm-source-bookmarks
                          helm-source-ls-git
                          helm-source-locate)
               <span class="org-builtin">:buffer</span> <span class="org-string">"*helm-find-files*"</span>) <span class="org-string"><span class="org-warning">"Find"</span></span><span class="org-warning">)</span>
    (<span class="org-string">"j"</span> my/helm-journal <span class="org-string">"Journal"</span>)
    (<span class="org-string">"n"</span> my/capture-timestamped-note)
    (<span class="org-string">"l"</span> (my/toggle-or-create <span class="org-string">"*scratch*"</span> (<span class="org-keyword">lambda</span> () (switch-to-buffer (startup--get-buffer-create-scratch)))) <span class="org-string">"Lisp"</span>)
    (<span class="org-string">"d"</span> my/emacs-news-check-duplicates <span class="org-string">"Dupe"</span>)
    (<span class="org-string">"c"</span> my/org-categorize-emacs-news/body <span class="org-string">"Categorize"</span>)
    (<span class="org-string">"h"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (my/org-update-link-description <span class="org-string">"HN"</span>)) <span class="org-string">"Link HN"</span>)
    (<span class="org-string">"i"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (my/org-update-link-description <span class="org-string">"Irreal"</span>)) <span class="org-string">"Link Irreal"</span>)
    (<span class="org-string">"s"</span> save-buffer <span class="org-string">"Save"</span>)
    (<span class="org-string">"m"</span> my/share-emacs-news <span class="org-string">"Mail"</span>))
  (global-set-key (kbd <span class="org-string">"&lt;f5&gt;"</span>) 'my/shortcuts/body))
(<span class="org-keyword">use-package</span> <span class="org-constant">hydra-posframe</span> <span class="org-builtin">:quelpa</span> (hydra-posframe <span class="org-builtin">:fetcher</span> github <span class="org-builtin">:repo</span> <span class="org-string">"Ladicle/hydra-posframe"</span>) <span class="org-builtin">:if</span> my/laptop-p <span class="org-builtin">:after</span> hydra)

(<span class="org-keyword">use-package</span> <span class="org-constant">pretty-hydra</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-insert-link</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">when</span> (org-in-regexp org-bracket-link-regexp 1)
    (goto-char (match-end 0))
    (insert <span class="org-string">"\n"</span>))
  (call-interactively 'org-insert-link))

(<span class="org-keyword">defhydra</span> my/key-chord-commands ()
  <span class="org-doc">"Main"</span>
  (<span class="org-string">"k"</span> kill-sexp)
  (<span class="org-string">"h"</span> my/org-jump <span class="org-builtin">:color</span> blue)
  (<span class="org-string">"x"</span> my/org-finish-previous-task-and-clock-in-new-one <span class="org-string">"Finish and clock in"</span> <span class="org-builtin">:color</span> blue)
  (<span class="org-string">"b"</span> helm-buffers-list <span class="org-builtin">:color</span> blue)
  (<span class="org-string">"f"</span> find-file <span class="org-builtin">:color</span> blue)
  (<span class="org-string">"a"</span> my/org-check-agenda <span class="org-builtin">:color</span> blue)
  (<span class="org-string">"c"</span> (call-interactively 'org-capture) <span class="org-string">"capture"</span> <span class="org-builtin">:color</span> blue)
  (<span class="org-string">"t"</span> (org-capture nil <span class="org-string">"T"</span>) <span class="org-string">"Capture task"</span>)
  (<span class="org-string">"."</span> repeat)
  (<span class="org-string">"C-t"</span> transpose-chars)
  (<span class="org-string">"o"</span> my/org-off-my-computer <span class="org-builtin">:color</span> blue)
  (<span class="org-string">"w"</span> my/engine-mode-hydra/body <span class="org-string">"web"</span> <span class="org-builtin">:exit</span> t)
  (<span class="org-string">"m"</span> imenu <span class="org-builtin">:color</span> blue)
  (<span class="org-string">"i"</span> my/capture-timestamped-note-with-screenshot <span class="org-builtin">:exit</span> t)
  (<span class="org-string">"n"</span> my/capture-timestamped-note <span class="org-string">"Timestamped note"</span> <span class="org-builtin">:exit</span> t)
  (<span class="org-string">"q"</span> quantified-track <span class="org-builtin">:color</span> blue)
  (<span class="org-string">"r"</span> my/describe-random-interactive-function)
  (<span class="org-string">"l"</span> org-insert-last-stored-link)
  (<span class="org-string">"L"</span> my/org-insert-link)
  (<span class="org-string">"+"</span> text-scale-increase)
  (<span class="org-string">"-"</span> text-scale-decrease))
</pre>
</div>

<p>
Now let's set up the actual keychords.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">key-chord</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:init</span>
  (<span class="org-keyword">setq</span> key-chord-one-key-delay 0.16)
  (<span class="org-keyword">setq</span> key-chord-two-keys-delay 0.002)
  (key-chord-define-global <span class="org-string">"uu"</span>     'undo)
  (key-chord-define-global <span class="org-string">"jr"</span>     'my/goto-random-char-hydra/my/goto-random-char)
  (key-chord-define-global <span class="org-string">"kk"</span>     'kill-whole-line)
  (key-chord-define-global <span class="org-string">"et"</span> 'my/stream-message)
  (key-chord-define-global <span class="org-string">"em"</span> 'embark-act)
  (key-chord-define-global <span class="org-string">".t"</span> 'my/stream/body)
  (key-chord-define-global <span class="org-string">"jj"</span>     'avy-goto-word-1)
  (key-chord-define-global <span class="org-string">"yy"</span>    'my/window-movement/body)
  (key-chord-define-global <span class="org-string">"jw"</span>     'switch-window)
  (key-chord-define-global <span class="org-string">"jl"</span>     'avy-goto-line)
  (key-chord-define-global <span class="org-string">"j."</span>     'join-lines/body)
  (key-chord-define-global <span class="org-string">"FF"</span>     'find-file)
  (key-chord-define-global <span class="org-string">"qq"</span>     'my/quantified-hydra/body)
  (key-chord-define-global <span class="org-string">"hh"</span>     'my/key-chord-commands/body)
  (key-chord-define-global <span class="org-string">"xx"</span>     'er/expand-region)
  (key-chord-define-global <span class="org-string">"  "</span>     'my/insert-space-or-expand)
  (key-chord-define-global <span class="org-string">"vv"</span> 'god-mode-all)
  (key-chord-define-global <span class="org-string">"JJ"</span>     'my/switch-to-previous-buffer)
  (key-chord-mode 1))
</pre>
</div>

<p>
Hmm, good point about <code>C-t</code> being more useful as a Hydra than as <code>transpose-char</code>. It turns out I actually do use <code>C-t</code> a fair bit, but I can always add it back as an option.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">bind-key</span> <span class="org-string">"C-t"</span> 'my/key-chord-commands/body)
</pre>
</div>

<p>
I used to have these as part of my main hydra, but I haven't been
doing transcripts lately, so I'll free up those keystrokes for
something else.
</p>

<pre class="example" id="orgb87dfb0">
                                     ("h" emms-pause :color blue)
                                     ("t" emms-seek-backward)
                                     ("s" emms-seek-to :color blue)
</pre>
</div>
</div>
<div id="outline-container-orge2c6344" class="outline-4">
<h4 id="orge2c6344">Smartscan</h4>
<div class="outline-text-4" id="text-orge2c6344">
<p>
From <a href="https://github.com/itsjeyd/emacs-config/blob/emacs24/init.el">https://github.com/itsjeyd/emacs-config/blob/emacs24/init.el</a>, this makes <code>M-n</code> and <code>M-p</code> look for the symbol at point.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">smartscan</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:config</span> (global-smartscan-mode t))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfcc3e98" class="outline-4">
<h4 id="orgfcc3e98">Dired</h4>
<div class="outline-text-4" id="text-orgfcc3e98">
<p>
From <a href="http://www.masteringemacs.org/articles/2011/03/25/working-multiple-files-dired/">http://www.masteringemacs.org/articles/2011/03/25/working-multiple-files-dired/</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">require</span> '<span class="org-constant">find-dired</span>)
(<span class="org-keyword">setq</span> find-ls-option '(<span class="org-string">"-print0 | xargs -0 ls -ld"</span> . <span class="org-string">"-ld"</span>))
</pre>
</div>
</div>

<div id="outline-container-orgc26b84f" class="outline-5">
<h5 id="orgc26b84f">peep-dired</h5>
<div class="outline-text-5" id="text-orgc26b84f">
<p>
Allow my use of <code>C-x C-q</code> while in peep-dired mode.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">peep-dired</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> peep-dired-mode-map 
              (<span class="org-string">"SPC"</span> . nil)
              (<span class="org-string">"&lt;backspace&gt;"</span> . nil)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfcff0d0" class="outline-5">
<h5 id="orgfcff0d0">Saving photos</h5>
<div class="outline-text-5" id="text-orgfcff0d0">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/save-photo</span> (name)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MName: "</span>)
  (<span class="org-keyword">let*</span> ((file (dired-get-filename))
         new-name)
    (<span class="org-keyword">cond</span> 
     ((string-match <span class="org-string">"CameraZOOM-</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9][0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> file)
      (<span class="org-keyword">setq</span> new-name
            (format <span class="org-string">"%s-%s-%s %s.%s.%s.%s %s.jpg"</span>
                    (match-string 1 file)
                    (match-string 2 file)
                    (match-string 3 file)
                    (match-string 4 file)
                    (match-string 5 file)
                    (match-string 6 file)
                    (match-string 7 file)
                    name)))
     ((string-match <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9][0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">[\\.-]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">[\\.-]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">[\\.- ]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> file)
      (<span class="org-keyword">setq</span> new-name
            (format <span class="org-string">"%s-%s-%s %s.%s.%s %s.jpg"</span>
                    (match-string 1 file)
                    (match-string 2 file)
                    (match-string 3 file)
                    (match-string 4 file)
                    (match-string 5 file)
                    (match-string 6 file)
                    name)))
     (t (<span class="org-keyword">setq</span> new-name (concat (file-name-sans-extension (file-name-nondirectory file)) <span class="org-string">" "</span> name <span class="org-string">".jpg"</span>))))
    (<span class="org-keyword">when</span> (string-match <span class="org-string">"A-"</span> name)
      (copy-file file (expand-file-name new-name my/kid-photo-directory)))
    (rename-file file (expand-file-name new-name <span class="org-string">"~/archives/2016/photos/selected/"</span>))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/backup-media</span> ()
  (<span class="org-keyword">interactive</span>)
  (mapcar (<span class="org-keyword">lambda</span> (file)
            (rename-file
             file
             (expand-file-name
              (file-name-nondirectory file)
              (<span class="org-keyword">cond</span>
               ((string-match <span class="org-string">"mp4"</span> file) <span class="org-string">"~/archives/2016/videos/"</span>)
               ((string-match <span class="org-string">"mp3</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">wav"</span> file) <span class="org-string">"~/archives/2016/audio/"</span>)
               (t <span class="org-string">"~/archives/2016/photos/backup/"</span>)))))
          (dired-get-marked-files)))
(<span class="org-keyword">bind-key</span> <span class="org-string">"b"</span> 'my/save-photo dired-mode-map)
(<span class="org-keyword">bind-key</span> <span class="org-string">"r"</span> 'my/backup-media dired-mode-map)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org2b4bc03" class="outline-4">
<h4 id="org2b4bc03">Move to beginning of line</h4>
<div class="outline-text-4" id="text-org2b4bc03">
<p>
Copied from <a href="http://emacsredux.com/blog/2013/05/22/smarter-navigation-to-the-beginning-of-a-line/">http://emacsredux.com/blog/2013/05/22/smarter-navigation-to-the-beginning-of-a-line/</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/smarter-move-beginning-of-line</span> (arg)
  <span class="org-doc">"Move point back to indentation of beginning of line.</span>

<span class="org-doc">      Move point to the first non-whitespace character on this line.</span>
<span class="org-doc">      If point is already there, move to the beginning of the line.</span>
<span class="org-doc">      Effectively toggle between the first non-whitespace character and</span>
<span class="org-doc">      the beginning of the line.</span>

<span class="org-doc">      If ARG is not nil or 1, move forward ARG - 1 lines first.  If</span>
<span class="org-doc">      point reaches the beginning or end of the buffer, stop there."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"^p"</span>)
  (<span class="org-keyword">setq</span> arg (<span class="org-keyword">or</span> arg 1))

  <span class="org-comment-delimiter">;; </span><span class="org-comment">Move lines first</span>
  (<span class="org-keyword">when</span> (/= arg 1)
    (<span class="org-keyword">let</span> ((line-move-visual nil))
      (forward-line (1- arg))))

  (<span class="org-keyword">let</span> ((orig-point (point)))
    (back-to-indentation)
    (<span class="org-keyword">when</span> (= orig-point (point))
      (move-beginning-of-line 1))))

<span class="org-comment-delimiter">;; </span><span class="org-comment">remap C-a to `</span><span class="org-comment"><span class="org-constant">smarter-move-beginning-of-line</span></span><span class="org-comment">'</span>
(global-set-key [remap move-beginning-of-line]
                'my/smarter-move-beginning-of-line)
</pre>
</div>
</div>
</div>

<div id="outline-container-org56302db" class="outline-4">
<h4 id="org56302db">Recent files</h4>
<div class="outline-text-4" id="text-org56302db">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">require</span> '<span class="org-constant">recentf</span>)
(<span class="org-keyword">setq</span> recentf-max-saved-items 200
      recentf-max-menu-items 15)
(recentf-mode)
</pre>
</div>
</div>
</div>

<div id="outline-container-org24ecd1e" class="outline-4">
<h4 id="org24ecd1e">Copy filename to clipboard</h4>
<div class="outline-text-4" id="text-org24ecd1e">
<p>
<a href="http://emacsredux.com/blog/2013/03/27/copy-filename-to-the-clipboard/">http://emacsredux.com/blog/2013/03/27/copy-filename-to-the-clipboard/</a>
<a href="https://github.com/bbatsov/prelude">https://github.com/bbatsov/prelude</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">prelude-copy-file-name-to-clipboard</span> ()
  <span class="org-doc">"Copy the current buffer file name to the clipboard."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((filename (<span class="org-keyword">if</span> (equal major-mode 'dired-mode)
                      default-directory
                    (buffer-file-name))))
    (<span class="org-keyword">when</span> filename
      (kill-new filename)
      (message <span class="org-string">"Copied buffer file name '%s' to the clipboard."</span> filename))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orga22d4b0" class="outline-4">
<h4 id="orga22d4b0">Open files externally</h4>
<div class="outline-text-4" id="text-orga22d4b0">
<p>
Copied from Prelude: <a href="http://emacsredux.com/blog/2013/03/27/open-file-in-external-program/">http://emacsredux.com/blog/2013/03/27/open-file-in-external-program/</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">prelude-open-with</span> (arg)
  <span class="org-doc">"Open visited file in default external program.</span>

<span class="org-doc">      With a prefix ARG always prompt for command to use."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"P"</span>)
  (<span class="org-keyword">when</span> buffer-file-name
    (shell-command (concat
                    (<span class="org-keyword">cond</span>
                     ((<span class="org-keyword">and</span> (not arg) (eq system-type 'darwin)) <span class="org-string">"open"</span>)
                     ((<span class="org-keyword">and</span> (not arg) (member system-type '(gnu gnu/linux gnu/kfreebsd))) <span class="org-string">"xdg-open"</span>)
                     (t (read-shell-command <span class="org-string">"Open current file with: "</span>)))
                    <span class="org-string">" "</span>
                    (shell-quote-argument buffer-file-name)))))

</pre>
</div>

<p>
Don't use docview for PDFs.
(add-to-list 'org-file-apps '("pdf" . "evince %s"))
</p>
</div>
</div>

<div id="outline-container-org6790a66" class="outline-4">
<h4 id="org6790a66">Toggle</h4>
<div class="outline-text-4" id="text-org6790a66">
<p>
Based on <a href="https://www.reddit.com/r/emacs/comments/l4v1ux/one_of_the_most_useful_small_lisp_functions_in_my/">https://www.reddit.com/r/emacs/comments/l4v1ux/one_of_the_most_useful_small_lisp_functions_in_my/</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/toggle-or-create</span> (buffer-name buffer-create-fn <span class="org-type">&amp;optional</span> switch-cont)
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((target-buf (get-buffer buffer-name)))
    (prin1 target-buf)
    (<span class="org-keyword">cond</span>
     ((equal (current-buffer) target-buf) (switch-to-buffer nil))
     (target-buf
      (switch-to-buffer target-buf)
      (<span class="org-keyword">if</span> switch-cont (funcall switch-cont)))
     (t (funcall buffer-create-fn)
        (<span class="org-keyword">if</span> switch-cont (funcall switch-cont))))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org733442b" class="outline-3">
<h3 id="org733442b">Reading</h3>
<div class="outline-text-3" id="text-org733442b">
<p>
<a href="https://github.com/xahlee/xah_emacs_init/blob/master/xah_emacs_font.el">https://github.com/xahlee/xah_emacs_init/blob/master/xah_emacs_font.el</a>
From Xah Lee:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">xah-toggle-margin-right</span> ()
  <span class="org-doc">"Toggle the right margin between `</span><span class="org-doc"><span class="org-constant">fill-column</span></span><span class="org-doc">' or window width.</span>
<span class="org-doc">     This command is convenient when reading novel, documentation."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">if</span> (eq (cdr (window-margins)) nil)
      (set-window-margins nil 0 (- (window-body-width) fill-column))
    (set-window-margins nil 0 0)))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">pdf-tools</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:config</span>
  (pdf-tools-install)
  (<span class="org-keyword">setq</span> pdf-view-resize-factor 1.1)
  (<span class="org-keyword">setq-default</span> pdf-view-display-size 'fit-page)
  )
</pre>
</div>
</div>
</div>
<div id="outline-container-org5f364a2" class="outline-3">
<h3 id="org5f364a2">Shuffling lines</h3>
<div class="outline-text-3" id="text-org5f364a2">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/shuffle-lines-in-region</span> (beg end)
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">let</span> ((list (split-string (buffer-substring beg end) <span class="org-string">"[\r\n]+"</span>)))
    (delete-region beg end)
    (insert (mapconcat 'identity (shuffle-list list) <span class="org-string">"\n"</span>))))
</pre>
</div>
</div>
</div>


<div id="outline-container-org0841013" class="outline-3">
<h3 id="org0841013">Writing and editing</h3>
<div class="outline-text-3" id="text-org0841013">
</div>
<div id="outline-container-orgec58cc3" class="outline-4">
<h4 id="orgec58cc3">Markdown</h4>
<div class="outline-text-4" id="text-orgec58cc3">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">markdown-mode</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:mode</span> (<span class="org-string">"\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">njk</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">md</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\'"</span> . markdown-mode))
</pre>
</div>
</div>
</div>
<div id="outline-container-org5d24a25" class="outline-4">
<h4 id="org5d24a25">Avoiding weasel words</h4>
<div class="outline-text-4" id="text-org5d24a25">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">artbollocks-mode</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:load-path</span>  <span class="org-string">"~/elisp/artbollocks-mode"</span>
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">progn</span>
    (<span class="org-keyword">setq</span> artbollocks-weasel-words-regex
          (concat <span class="org-string">"\\b"</span> (regexp-opt
                         '(<span class="org-string">"one of the"</span>
                           <span class="org-string">"should"</span>
                           <span class="org-string">"just"</span>
                           <span class="org-string">"sort of"</span>
                           <span class="org-string">"a lot"</span>
                           <span class="org-string">"probably"</span>
                           <span class="org-string">"maybe"</span>
                           <span class="org-string">"perhaps"</span>
                           <span class="org-string">"I think"</span>
                           <span class="org-string">"really"</span>
                           <span class="org-string">"pretty"</span>
                           <span class="org-string">"nice"</span>
                           <span class="org-string">"action"</span>
                           <span class="org-string">"utilize"</span>
                           <span class="org-string">"leverage"</span>) <span class="org-warning">t) </span><span class="org-string"><span class="org-warning">"\\b"</span></span><span class="org-warning">))</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Don't show the art critic words, or at least until I figure</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">out my own jargon</span>
    (<span class="org-keyword">setq</span> artbollocks-jargon nil)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfe5daa7" class="outline-4">
<h4 id="orgfe5daa7">Unfill paragraph</h4>
<div class="outline-text-4" id="text-orgfe5daa7">
<p>
I unfill paragraphs a lot because Wordpress likes adding extra <code>&lt;br&gt;</code> tags if I don't. (I should probably just tweak my Wordpress installation.)
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/unfill-paragraph</span> (<span class="org-type">&amp;optional</span> region)
  <span class="org-doc">"Takes a multi-line paragraph and makes it into a single line of text."</span>
  (<span class="org-keyword">interactive</span> (<span class="org-keyword">progn</span>
                 (barf-if-buffer-read-only)
                 (list t)))
  (<span class="org-keyword">let</span> ((fill-column (point-max)))
    (fill-paragraph nil region)))
(<span class="org-keyword">bind-key</span> <span class="org-string">"M-Q"</span> 'my/unfill-paragraph)
</pre>
</div>

<p>
I never actually justify text, so I might as well change the way
<code>fill-paragraph</code> works. With the code below, <code>M-q</code> will fill the
paragraph normally, and <code>C-u M-q</code> will unfill it.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/fill-or-unfill-paragraph</span> (<span class="org-type">&amp;optional</span> unfill region)
  <span class="org-doc">"Fill paragraph (or REGION).</span>
<span class="org-doc">        With the prefix argument UNFILL, unfill it instead."</span>
  (<span class="org-keyword">interactive</span> (<span class="org-keyword">progn</span>
                 (barf-if-buffer-read-only)
                 (list (<span class="org-keyword">if</span> current-prefix-arg 'unfill) t)))
  (<span class="org-keyword">let</span> ((fill-column (<span class="org-keyword">if</span> unfill (point-max) fill-column)))
    (fill-paragraph nil region)))
(<span class="org-keyword">bind-key</span> <span class="org-string">"M-q"</span> 'my/fill-or-unfill-paragraph)
</pre>
</div>

<p>
Also, <code>visual-line-mode</code> is so much better than <code>auto-fill-mode</code>. It doesn't actually break the text into multiple lines - it only looks that way.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(remove-hook 'text-mode-hook #'turn-on-auto-fill)
(add-hook 'text-mode-hook 'turn-on-visual-line-mode)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc2a6d8f" class="outline-4">
<h4 id="orgc2a6d8f">Unicode</h4>
<div class="outline-text-4" id="text-orgc2a6d8f">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defmacro</span> <span class="org-function-name">my/insert-unicode</span> (unicode-name)
  `(<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>)
     (insert-char (cdr (assoc-string ,unicode-name (ucs-names))))))
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-x 8 s"</span> (<span class="org-keyword">my/insert-unicode</span> <span class="org-string">"ZERO WIDTH SPACE"</span>))
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-x 8 S"</span> (<span class="org-keyword">my/insert-unicode</span> <span class="org-string">"SNOWMAN"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd17e166" class="outline-4">
<h4 id="orgd17e166">Clean up spaces</h4>
<div class="outline-text-4" id="text-orgd17e166">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">bind-key</span> <span class="org-string">"M-SPC"</span> 'cycle-spacing)
</pre>
</div>
</div>
</div>

<div id="outline-container-org2f8c418" class="outline-4">
<h4 id="org2f8c418">Expand</h4>
<div class="outline-text-4" id="text-org2f8c418">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">bind-key</span> <span class="org-string">"M-/"</span> 'hippie-expand)
</pre>
</div>

<p>
From <a href="https://github.com/purcell/emacs.d/blob/master/lisp/init-auto-complete.el">https://github.com/purcell/emacs.d/blob/master/lisp/init-auto-complete.el</a> - Exclude very large buffers from dabbrev
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">sanityinc/dabbrev-friend-buffer</span> (other-buffer)
  (&lt; (buffer-size other-buffer) (* 1 1024 1024)))
(<span class="org-keyword">setq</span> dabbrev-friend-buffer-function 'sanityinc/dabbrev-friend-buffer)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> hippie-expand-try-functions-list
      '(yas-hippie-try-expand
        try-expand-all-abbrevs
        try-complete-file-name-partially
        try-complete-file-name
        try-expand-dabbrev
        try-expand-dabbrev-from-kill
        try-expand-dabbrev-all-buffers
        try-expand-list
        try-expand-line
        try-complete-lisp-symbol-partially
        try-complete-lisp-symbol))
</pre>
</div>
</div>
</div>

<div id="outline-container-subed" class="outline-4">
<h4 id="subed">Subtitles</h4>
<div class="outline-text-4" id="text-subed">
</div>

<div id="outline-container-org593e94d" class="outline-5">
<h5 id="org593e94d">Extract part of a video</h5>
<div class="outline-text-5" id="text-org593e94d">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/subed-get-region-start-stop</span> (beg end)
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (cons (<span class="org-keyword">save-excursion</span>
          (goto-char (min beg end))
          (subed-subtitle-msecs-start))
        (<span class="org-keyword">save-excursion</span>
          (goto-char (max beg end))
          (subed-subtitle-msecs-stop))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/extend-file-name</span> (original name <span class="org-type">&amp;optional</span> extension)
  <span class="org-doc">"Add NAME to the end of ORIGINAL, before the file extension."</span>
  (concat (file-name-sans-extension original) <span class="org-string">" "</span> name <span class="org-string">"."</span>
          (<span class="org-keyword">or</span> extension (file-name-extension original))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/adjust-subtitles</span> (offset)
  <span class="org-doc">"Change all of the start and end times by OFFSET."</span>
  (<span class="org-keyword">interactive</span> (list (subed--string-to-msecs (read-string <span class="org-string">"Time: "</span>))))
  (<span class="org-keyword">subed-for-each-subtitle</span> (point-min) (point-max) nil
    (subed-adjust-subtitle-time-start offset t t)
    (subed-adjust-subtitle-time-stop offset t t))
  (subed-regenerate-ids))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/subed-write-adjusted-subtitles</span> (source-file start-msecs end-msecs dest-file)
  (<span class="org-keyword">let</span> ((s (<span class="org-keyword">with-current-buffer</span> (find-file-noselect source-file)
             (buffer-substring-no-properties
              (subed-jump-to-subtitle-id-at-msecs start-msecs)
              (<span class="org-keyword">progn</span> (subed-jump-to-subtitle-id-at-msecs end-msecs) (subed-jump-to-subtitle-end)))))
        (offset (- start-msecs)))
    (<span class="org-keyword">with-current-buffer</span> (find-file-noselect dest-file)
      (erase-buffer)
      (insert s)
      (my/adjust-subtitles offset)
      (save-buffer)
      (buffer-file-name))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/msecs-to-timestamp</span> (msecs)
  <span class="org-doc">"Convert MSECS to string in the format HH:MM:SS.MS."</span>
  (concat (format-seconds <span class="org-string">"%02h:%02m:%02s"</span> (/ msecs 1000))
          <span class="org-string">"."</span> (format <span class="org-string">"%03d"</span> (mod msecs 1000))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/subed-make-animated-gif</span> (beg end name)
  (<span class="org-keyword">interactive</span> <span class="org-string">"r\nMName: "</span>)
  (<span class="org-keyword">let*</span> ((video-file (subed-guess-video-file))
         (msecs (my/subed-get-region-start-stop beg end))
         (new-file (my/extend-file-name video-file name <span class="org-string">"gif"</span>))
         cmd)
    (<span class="org-keyword">when</span> (&gt; (length name) 0)
      (<span class="org-keyword">setq</span> cmd
            (format <span class="org-string">"ffmpeg -y -i %s -ss %s -t %s -vf subtitles=%s -r 10 -c:a copy -shortest -async 1 %s"</span>
                    (shell-quote-argument video-file)
                    (my/msecs-to-timestamp (car msecs))
                    (my/msecs-to-timestamp (- (cdr msecs) (car msecs)))
                    (shell-quote-argument (my/subed-write-adjusted-subtitles beg end name))                
                    (shell-quote-argument new-file)))
      (message <span class="org-string">"%s"</span> cmd)
      (kill-new cmd)
      (shell-command cmd))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/subed-ffmpeg-make-mute-filter</span> (segments)
  (mapconcat
   (<span class="org-keyword">lambda</span> (s)
     (format <span class="org-string">"volume=enable='between(t,%.3f,%.3f)':volume=0"</span>
             (/ (car s) 1000.0)
             (/ (cdr s) 1000.0)))
   segments <span class="org-string">", "</span>))







(<span class="org-keyword">defun</span> <span class="org-function-name">my/subed-cut-video</span> (beg end name video-file caption-file)
  (<span class="org-keyword">interactive</span>
   (append
    (<span class="org-keyword">if</span> (use-region-p)
        (list (point) (mark))
      (list (<span class="org-keyword">save-excursion</span> (subed-jump-to-subtitle-id))
            (<span class="org-keyword">save-excursion</span> (subed-jump-to-subtitle-end))))
    (list
     (read-string <span class="org-string">"Name: "</span>)
     (read-file-name <span class="org-string">"Video: "</span>)
     (read-file-name <span class="org-string">"Captions: "</span>))))
  (<span class="org-keyword">let*</span>
      ((msecs (my/subed-get-region-start-stop beg end))
       (new-file name)
       (mute (my/subed-get-mute-segments))
       cmd)
    (<span class="org-keyword">when</span> (&gt; (length name) 0)
      (<span class="org-keyword">setq</span> cmd
            (format <span class="org-string">"ffmpeg -y -i %s -i %s -ss %s -t %s %s -c:v copy -c:s copy -shortest -async 1 %s"</span>
                    (shell-quote-argument caption-file)
                    (shell-quote-argument video-file)
                    (my/msecs-to-timestamp
                     (car msecs))
                    (my/msecs-to-timestamp
                     (-
                      (cdr msecs)
                      (car msecs)))
                    (<span class="org-keyword">if</span> mute
                        (format <span class="org-string">"-af %s"</span>
                                (shell-quote-argument
                                 (my/subed-ffmpeg-make-mute-filter mute)))
                      <span class="org-string">"-c:a copy"</span>)
                    (shell-quote-argument new-file)))
      (message <span class="org-string">"%s"</span> cmd)
      (kill-new cmd))))

</pre>
</div>
</div>
</div>
<div id="outline-container-org133ac41" class="outline-5">
<h5 id="org133ac41">Hide IDs and times</h5>
<div class="outline-text-5" id="text-org133ac41">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">define-minor-mode</span> <span class="org-function-name">my/subed-hide-nontext-minor-mode</span>
  <span class="org-doc">"Minor mode for hiding non-text stuff."</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/subed-hide-nontext-overlay</span> (start end)
  (<span class="org-keyword">let</span> ((new-overlay (make-overlay start end)))
    (overlay-put new-overlay 'invisible t)
    (overlay-put new-overlay 'intangible t)
    (overlay-put new-overlay 'evaporate t)
    (overlay-put new-overlay 'read-only t)
    (overlay-put new-overlay 'hide-non-text t)
    (<span class="org-keyword">with-silent-modifications</span>
      (add-text-properties start end '(read-only t)))
    new-overlay))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/subed-hide-nontext</span> ()
  (<span class="org-keyword">interactive</span>)
  (remove-overlays (point-min) (point-max) 'invisible t)
  (<span class="org-keyword">when</span> my/subed-hide-nontext-minor-mode
    (<span class="org-keyword">save-excursion</span>
      (goto-char (point-min))
      (subed-jump-to-subtitle-id)
      (my/subed-hide-nontext-overlay (point-min) (subed-jump-to-subtitle-text))
      (<span class="org-keyword">let</span> (next)
        (<span class="org-keyword">while</span> (<span class="org-keyword">setq</span> next (<span class="org-keyword">save-excursion</span> (subed-forward-subtitle-text)))
          (subed-jump-to-subtitle-end)
          (my/subed-hide-nontext-overlay (1+ (point)) (1- next))
          (subed-forward-subtitle-text))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/subed-show-all</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((inhibit-read-only t))
    (<span class="org-keyword">with-silent-modifications</span>
      (remove-text-properties (point-min) (point-max) '(read-only t))
      (remove-overlays (point-min) (point-max) 'invisible t))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/ignore-read-only</span> (f <span class="org-type">&amp;rest</span> args)
  (<span class="org-keyword">let</span> ((inhibit-read-only t))
    (apply f args)
    (my/subed-hide-nontext)))

(advice-add 'subed-split-and-merge-dwim <span class="org-builtin">:around</span> #'my/ignore-read-only)
(advice-add 'subed-split-subtitle <span class="org-builtin">:around</span> #'my/ignore-read-only)
(advice-add 'subed-merge-with-next <span class="org-builtin">:around</span> #'my/ignore-read-only)
(advice-add 'subed-merge-with-previous <span class="org-builtin">:around</span> #'my/ignore-read-only)
(advice-add 'subed-regenerate-ids <span class="org-builtin">:around</span> #'my/ignore-read-only)
(advice-add 'subed-kill-subtitle <span class="org-builtin">:around</span> #'my/ignore-read-only)
</pre>
</div>
</div>
</div>
<div id="outline-container-org23626f2" class="outline-5">
<h5 id="org23626f2">Other subtitle code</h5>
<div class="outline-text-5" id="text-org23626f2">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/subed-forward-word</span> (<span class="org-type">&amp;optional</span> arg)
  <span class="org-doc">"Skip timestamps."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"^p"</span>)
  (<span class="org-keyword">setq</span> arg (<span class="org-keyword">or</span> arg 1))
  (<span class="org-keyword">let</span> ((end (<span class="org-keyword">or</span> (<span class="org-keyword">save-excursion</span> (subed-jump-to-subtitle-end)) (point))))
    (<span class="org-keyword">loop</span> while (&gt; arg 0)
          do
          (forward-word 1)
          (skip-syntax-forward <span class="org-string">"^\s"</span>)
          (<span class="org-keyword">setq</span> arg (1- arg))
          (<span class="org-keyword">when</span> (&gt; (point) end)
            (subed-jump-to-subtitle-text)
            (forward-word 1)
            (skip-syntax-forward <span class="org-string">"^\s"</span>)
            (<span class="org-keyword">setq</span> end (<span class="org-keyword">or</span> (<span class="org-keyword">save-excursion</span> (subed-jump-to-subtitle-end)) (point)))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/subed-backward-word</span> (<span class="org-type">&amp;optional</span> arg)
  <span class="org-doc">"Skip timestamps."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"^p"</span>)
  (<span class="org-keyword">setq</span> arg (<span class="org-keyword">or</span> arg 1))
  (<span class="org-keyword">let</span> ((end (<span class="org-keyword">or</span> (<span class="org-keyword">save-excursion</span> (subed-jump-to-subtitle-text)) (point))))
    (<span class="org-keyword">loop</span> while (&gt; arg 0)
          do
          (backward-word 1)
          (<span class="org-keyword">setq</span> arg (1- arg))
          (<span class="org-keyword">when</span> (&lt; (point) end)
            (subed-backward-subtitle-text)
            (<span class="org-keyword">setq</span> end (point))
            (subed-jump-to-subtitle-end)
            (backward-word 1)))))

(<span class="org-keyword">defhydra</span> my/subed ()
  <span class="org-doc">"Make it easier to split and merge"</span>
  (<span class="org-string">"e"</span> subed-jump-to-subtitle-end <span class="org-string">"End"</span>)
  (<span class="org-string">"s"</span> subed-jump-to-subtitle-text <span class="org-string">"Start"</span>)
  (<span class="org-string">"f"</span> my/subed-forward-word <span class="org-string">"Forward word"</span>)
  (<span class="org-string">"b"</span> my/subed-backward-word <span class="org-string">"Backward word"</span>)
  (<span class="org-string">"w"</span> avy-goto-word-1-below <span class="org-string">"Jump to word"</span>)
  (<span class="org-string">"n"</span> subed-forward-subtitle-text <span class="org-string">"Forward subtitle"</span>)
  (<span class="org-string">"p"</span> subed-backward-subtitle-text <span class="org-string">"Backward subtitle"</span>)
  (<span class="org-string">".p"</span> (subed-split-and-merge-dwim 'prev) <span class="org-string">"Split and merge with previous"</span>)
  (<span class="org-string">".n"</span> (subed-split-and-merge-dwim 'next) <span class="org-string">"Split and merge with next"</span>)
  (<span class="org-string">"mp"</span> subed-merge-with-previous <span class="org-string">"Merge previous"</span>)
  (<span class="org-string">"mn"</span> subed-merge-with-next <span class="org-string">"Merge next"</span>)
  (<span class="org-string">"j"</span> subed-mpv-jump-to-current-subtitle <span class="org-string">"MPV current"</span>)
  (<span class="org-string">"1"</span> (subed-mpv-playback-speed 1.0) <span class="org-string">"1x speed"</span>)
  (<span class="org-string">"2"</span> (subed-mpv-playback-speed 0.7) <span class="org-string">"0.7x speed"</span>)
  (<span class="org-string">"3"</span> (subed-mpv-playback-speed 0.5) <span class="org-string">"0.5x speed"</span>)
  (<span class="org-string">" "</span> subed-mpv-pause <span class="org-string">"Pause"</span>)
  (<span class="org-string">"["</span> (subed-mpv-seek -1000) <span class="org-string">"-1s"</span>)
  (<span class="org-string">"]"</span> (subed-mpv-seek 1000) <span class="org-string">"-1s"</span>)
  (<span class="org-string">";"</span> (re-search-forward <span class="org-string">"[,\\.;]"</span>) <span class="org-string">"Search for break"</span>)
  (<span class="org-string">"uu"</span> (subed-split-and-merge-dwim 'prev) <span class="org-string">"Split and merge with previous"</span>)
  (<span class="org-string">"hh"</span> (subed-split-and-merge-dwim 'next) <span class="org-string">"Split and merge with next"</span>)
  (<span class="org-string">"hu"</span> subed-merge-with-previous <span class="org-string">"Merge with previous"</span>)
  (<span class="org-string">"uh"</span> subed-merge-with-next <span class="org-string">"Merge with next"</span>)
  (<span class="org-string">"lf"</span> subed-mpv-find-video <span class="org-string">"Find video file"</span>)
  (<span class="org-string">"lu"</span> subed-mpv-play-url <span class="org-string">"Find video at URL"</span>)
  (<span class="org-string">"x"</span> kill-word <span class="org-string">"Kill word"</span>)
  (<span class="org-string">"S"</span> save-buffer <span class="org-string">"Save"</span>)
  (<span class="org-string">"o"</span> (insert <span class="org-string">"\n"</span>) (<span class="org-keyword">let</span> ((fill-column (point-max))) (fill-paragraph))))
(<span class="org-keyword">use-package</span> <span class="org-constant">subed</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/vendor/subed/subed"</span>
  <span class="org-builtin">:mode</span> (<span class="org-string">"\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">vtt</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">srt</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\'"</span> . subed-mode)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> subed-subtitle-spacing 0)
  (key-chord-define subed-mode-map <span class="org-string">"hu"</span> 'my/subed/body)
  (key-chord-define subed-mode-map <span class="org-string">"ht"</span> 'my/subed/body)
  <span class="org-builtin">:bind</span>
  (<span class="org-builtin">:map</span> subed-mode-map
        (<span class="org-string">"M-j"</span> . subed-mpv-jump-to-current-subtitle)
        (<span class="org-string">"M-["</span> . subed-mpv-seek))
  <span class="org-builtin">:hook</span> 
  ((subed-mode . subed-disable-sync-point-to-player)
   (subed-mode . subed-disable-sync-player-to-point)
   (subed-mode . subed-disable-loop-over-current-subtitle)
   (subed-mode . save-place-local-mode)
   (subed-mode . turn-on-auto-fill)
   (subed-mode . (<span class="org-keyword">lambda</span> () (<span class="org-keyword">setq-local</span> fill-column 40)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org1203248" class="outline-5">
<h5 id="org1203248">Using Emacs to fix automatically generated subtitle timestamps&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></h5>
<div class="outline-text-5" id="text-org1203248">
<p>
I like how people are making more and more Emacs-related videos. I
think subtitles, transcripts, and show notes would go a long way to
helping people quickly search, skim, and squeeze these videos into
their day.
</p>

<p>
Youtube's automatically-generated subtitles overlap. I think some
players scroll the subtitles, but the ones I use just display them
in alternating positions. I like to have non-overlapping subtitles,
so here's some code that works with <a href="https://github.com/rndusr/subed">subed.el</a> to fix the timestamps.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/subed-fix-timestamps</span> ()
  <span class="org-doc">"Change all ending timestamps to the start of the next subtitle."</span>
  (goto-char (point-max))
  (<span class="org-keyword">let</span> ((timestamp (subed-subtitle-msecs-start)))
    (<span class="org-keyword">while</span> (subed-backward-subtitle-time-start)
      (subed-set-subtitle-time-stop timestamp)
      (<span class="org-keyword">setq</span> timestamp (subed-subtitle-msecs-start)))))
</pre>
</div>

<p>
Then it's easy to <a href="https://sachachua.com/blog/2020/12/editing-subtitles-in-emacs-with-subed-with-synchronized-video-playback-through-mpv/">edit the subtitles</a> (punctuation, capitalization,
special terms), especially with the shortcuts for splitting and
merging subtitles.
</p>

<p>
For transcripts with starting and ending timestamps per paragraph, I
like using the merge shortcut to merge all the subtitles for a
paragraph together. Here's a sample: <a href="https://emacsconf.org/2020/talks/05/">https://emacsconf.org/2020/talks/05/</a>
</p>

<p>
Tonight I edited automatically-generated subtitles for a screencast
that was about 40 minutes long. The resulting file had 1157
captions, so about 2 seconds each. I finished it in about 80
minutes, pretty much the 2x speed that I've been seeing. I can
probably get a little faster if I figure out good workflows for:
</p>

<ul class="org-ul">
<li>jumping: avy muscle memory, maybe?</li>
<li>splitting things into sentences and phrases</li>
<li><p>
fixing common speech recognition errors (ex: emax -&gt; Emacs, which I handle with regex replaces; maybe a list of them?)
</p>

<p>
I experimented with making a hydra for this before, but thinking
about the keys to use slowed me down a bit and it didn't flow very
well. Might be worth tinkering with.
</p>

<p>
Transcribing from scratch takes me about 4-5x playtime. I haven't
tweaked out my workflow for that one yet because I've only
transcribed one talk with subed.el , and there's a pretty big
backlog of talks that already have automatically generated
subtitles to edit.
</p>

<p>
So that's another thing I (or other people) can occasionally do to
help out even if I don't have enough focused time to think about a
programming challenge or do a podcast myself. And I get to learn
more in the process, too. Fun!
</p></li>
</ul>
</div>
</div>
<div id="outline-container-org0923275" class="outline-5">
<h5 id="org0923275">Using word-level timing information when editing subtitles or captions in Emacs</h5>
<div class="outline-text-5" id="text-org0923275">
<p>
I like to split captions at logical points, such as at the end of a
phrase or sentence. At first, I used subed.el to play the video for
the caption, pausing it at the appropriate point and then calling
<code>subed-split-subtitle</code> to split at the playback position. Then I
modified <code>subed-split-subtitle</code> to split at the video position that's
proportional to the text position, so that it's roughly in the right
spot even if I'm not currently listening. That got me most of the way
to being able to quickly edit subtitles.
</p>

<p>
It turns out that word-level timing is actually available from YouTube
if I download the autogenerated SRV2 file using youtube-dl, which I
can do with the following function:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/caption-download-srv2</span> (id)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MID: "</span>)
  (<span class="org-keyword">when</span> (string-match <span class="org-string">"v=</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&amp;]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> id) (<span class="org-keyword">setq</span> id (match-string 1 id)))
  (call-process <span class="org-string">"youtube-dl"</span> nil nil nil <span class="org-string">"--write-auto-sub"</span> <span class="org-string">"--sub-lang"</span> <span class="org-string">"en"</span> <span class="org-string">"--skip-download"</span> <span class="org-string">"--sub-format"</span> <span class="org-string">"srv2"</span>
                (concat <span class="org-string">"https://youtu.be/"</span> id))
  (my/caption-load-word-data (my/latest-file <span class="org-string">"."</span> <span class="org-string">"\\.srv2\\'"</span>)))
</pre>
</div>

<p>
I started parsing JSON files, but SRV2 seemed to be more reliably
avaliable, so here are the parsing functions for both. I also change
common recognition errors along the way, using the
<code>my/subed-common-edits</code> variable defined in my <a href="https://sachachua.com/dotemacs#subed">config for subtitles</a>.
To change those ones in the VTT file I'm editing, I use
<code>my/subed-fix-common-errors</code>, also defined elsewhere.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar-local</span> <span class="org-variable-name">my/caption-cache</span> nil <span class="org-doc">"Word-level timing in the form ((start . ms) (end . ms) (text . ms))"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/caption-json-time-to-ms</span> (json)
  (+ (* 1000 (string-to-number (alist-get 'seconds json)))
     (/ (alist-get 'nanos json) 1000000)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/caption-extract-words-from-json3</span> ()
  (<span class="org-keyword">let*</span> ((data (<span class="org-keyword">progn</span> (goto-char (point-min)) (json-read)))
         (json3-p (alist-get 'events data))
         (reversed (reverse
                    (<span class="org-keyword">or</span> (alist-get 'events data)
                        (<span class="org-keyword">cl-loop</span> for seg in (car (alist-get 'results data))
                                 nconc (alist-get 'words (car (alist-get 'alternatives seg)))))))
         (last-event (seq-first reversed))
         (last-ms (<span class="org-keyword">if</span> json3-p
                      (+ (alist-get 'tStartMs last-event)
                         (alist-get 'dDurationMs last-event)))))
    (reverse
     (<span class="org-keyword">cl-loop</span> for e across reversed append
              (<span class="org-keyword">if</span> json3-p
                  (mapcar
                   (<span class="org-keyword">lambda</span> (seg)
                     (<span class="org-keyword">let</span> ((rec
                            `((start ,(+ (alist-get 'tStartMs e)
                                         (<span class="org-keyword">or</span> (alist-get 'tOffsetMs seg) 0)))
                              (end ,(min last-ms
                                         (+ (alist-get 'tStartMs e)
                                            (<span class="org-keyword">or</span> (alist-get 'dDurationMs e) 0))))
                              (text ,(alist-get 'utf8 seg)))))
                       (<span class="org-keyword">setq</span> last-ms (alist-get 'start rec))
                       rec))
                   (reverse (alist-get 'segs e)))
                `((start ,(my/caption-json-time-to-ms (alist-get 'startTime seg)))
                  (end ,(my/caption-json-time-to-ms (alist-get 'endTime seg)))
                  (text ,(alist-get 'word seg))))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/caption-extract-words-from-srv2</span> ()
  (<span class="org-keyword">let*</span> ((data (xml-parse-region))
         (text-elements (reverse (dom-by-tag data 'text)))
         (last-start (+ (string-to-number
                         (alist-get 't (xml-node-attributes (car text-elements))))
                        (string-to-number (alist-get 'd (xml-node-attributes (car text-elements)))))))
    (reverse
     (mapcar #'(<span class="org-keyword">lambda</span> (element)
                 (<span class="org-keyword">let</span> ((rec (list (cons 'start (string-to-number (alist-get 't (xml-node-attributes element))))
                                  (cons 'end last-start)
                                  (cons 'text (car (xml-node-children element))))))
                   (<span class="org-keyword">setq</span> last-start (alist-get 'start rec))
                   rec))
             text-elements))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/caption-fix-common-errors</span> (data)
  (mapc (<span class="org-keyword">lambda</span> (o)
          (mapc (<span class="org-keyword">lambda</span> (e)
                  (<span class="org-keyword">when</span> (string-match (concat <span class="org-string">"\\&lt;"</span> (car e) <span class="org-string">"\\&gt;"</span>) (alist-get 'text o))
                    (map-put! o 'text (replace-match (cadr e) t t (alist-get 'text o)))))
                my/subed-common-edits))
        data))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/caption-load-word-data</span> (file)
  <span class="org-doc">"Load word-level timing from FILE."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"fFile: "</span>)
  (<span class="org-keyword">let</span> (data)
    (<span class="org-keyword">with-current-buffer</span> (find-file-noselect file)
      (<span class="org-keyword">cond</span>
       ((string-match <span class="org-string">"\\.json"</span> file)
        (<span class="org-keyword">setq</span> data (my/caption-extract-words-from-json3)))
       ((string-match <span class="org-string">"\\.srv2\\'"</span> file)
        (<span class="org-keyword">setq</span> data (my/caption-extract-words-from-srv2)))
       (t (<span class="org-warning">error</span> <span class="org-string">"Unknown format."</span>))))
    (<span class="org-keyword">setq-local</span> my/caption-cache
                (mapcar (<span class="org-keyword">lambda</span> (entry)
                          (<span class="org-keyword">setf</span> (alist-get 'text entry)
                                (replace-regexp-in-string <span class="org-string">"&amp;#39;"</span> <span class="org-string">"'"</span> (alist-get 'text entry)))
                          entry)
                        (my/caption-fix-common-errors data)))))
</pre>
</div>

<p>
Assuming I start editing from the beginning of the file, then the part
of the captions file after point is mostly unedited. That means I can
match the remainder of the current caption with the word-level timing
to try to figure out the time to use when splitting the subtitle,
falling back to the proportional method if the data is not available.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/caption-look-up-word</span> ()
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">let*</span> ((end (subed-subtitle-msecs-stop))
           (start (subed-subtitle-msecs-start))
           (remaining-words (split-string (buffer-substring (point) (<span class="org-keyword">or</span> (subed-jump-to-subtitle-end) (point)))))
           (words (<span class="org-keyword">if</span> remaining-words
                      (reverse (seq-filter (<span class="org-keyword">lambda</span> (o)
                                             (<span class="org-keyword">and</span> (&lt;= (alist-get 'end o) end)
                                                  (&gt;= (alist-get 'start o) start)
                                                  (not (string-match <span class="org-string">"^\n*$"</span> (alist-get 'text o)))))
                                           my/caption-cache))))
           (offset 0)
           (done (null remaining-words))
           candidate)
      (<span class="org-keyword">while</span> (not done)
        (<span class="org-keyword">setq</span> candidate (elt words (+ (1- (length remaining-words)) offset)))
        (<span class="org-keyword">cond</span>
         ((<span class="org-keyword">and</span> candidate (string-match (concat <span class="org-string">"\\&lt;"</span> (car remaining-words) <span class="org-string">"\\&gt;"</span>) (alist-get 'text candidate)))
          (<span class="org-keyword">setq</span> done t))
         ((&gt; offset (length words)) (<span class="org-keyword">setq</span> done t))
         ((&gt; offset 0) (<span class="org-keyword">setq</span> offset (- offset)))
         (t (<span class="org-keyword">setq</span> offset (1+ (- offset))))))
      candidate)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/caption-unwrap</span> ()
  (<span class="org-keyword">interactive</span>)
  (subed-jump-to-subtitle-text)
  (<span class="org-keyword">let</span> ((limit (<span class="org-keyword">save-excursion</span> (<span class="org-keyword">or</span> (subed-jump-to-subtitle-end) (point)))))
         (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"\n"</span> limit t)
           (replace-match <span class="org-string">" "</span>))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/caption-split</span> ()
  <span class="org-doc">"Split the current subtitle based on word-level timing if available."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">let</span> ((data (my/caption-look-up-word)))
      (prin1 data)
      (subed-split-subtitle (<span class="org-keyword">and</span> data (- (alist-get 'start data) (subed-subtitle-msecs-start)))))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/caption-split-and-merge-with-next</span> ()
  (<span class="org-keyword">interactive</span>)
  (my/caption-split)
  (my/caption-unwrap)
  (subed-forward-subtitle-id)
  (subed-merge-with-next)
  (my/caption-unwrap))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/caption-split-and-merge-with-previous</span> ()
  (<span class="org-keyword">interactive</span>)
  (my/caption-split)
  (subed-merge-with-previous)
  (my/caption-unwrap))
(<span class="org-keyword">use-package</span> <span class="org-constant">subed</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/vendor/subed/subed"</span>
  <span class="org-builtin">:bind</span>
  (<span class="org-builtin">:map</span> subed-mode-map
        (<span class="org-string">"M-'"</span> . my/caption-split)
        (<span class="org-string">"M-,"</span> . my/caption-split-and-merge-with-previous)
        (<span class="org-string">"M-q"</span> . my/caption-unwrap)
        (<span class="org-string">"M-."</span> . my/caption-split-and-merge-with-next)))
</pre>
</div>

<p>
That way, I can use the word-level timing information for most of the
reformatting, but I can easily replay segments of the video if I'm
unsure about a word that needs to be changed.
</p>

<p>
If I want to generate a VTT based on the caption data, breaking it at
certain words, these functions help:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/caption-breaks</span>
  '(<span class="org-string">"the"</span> <span class="org-string">"this"</span> <span class="org-string">"we"</span> <span class="org-string">"we're"</span> <span class="org-string">"I"</span> <span class="org-string">"finally"</span> <span class="org-string">"but"</span> <span class="org-string">"and"</span> <span class="org-string">"when"</span>)
  <span class="org-doc">"List of words to try to break at."</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/caption-make-groups</span> (list)
  (<span class="org-keyword">let</span> (result
        current-item
        done
        (current-length 0)
        (limit 70)
        (lower-limit 30)
        (break-regexp (concat <span class="org-string">"\\&lt;"</span> (regexp-opt my/caption-breaks) <span class="org-string">"\\&gt;"</span>)))
    (<span class="org-keyword">while</span> list
      (<span class="org-keyword">cond</span>
       ((null (car list)))
       ((string-match <span class="org-string">"^\n*$"</span> (alist-get 'text (car list)))
        (<span class="org-keyword">push</span> (cons '(text . <span class="org-string">" "</span>) (car list)) current-item)
        (<span class="org-keyword">setq</span> current-length (1+ current-length)))
       ((&lt; (+ current-length (length (alist-get 'text (car list)))) limit)
        (<span class="org-keyword">setq</span> current-item (cons (car list) current-item)
              current-length (+ current-length (length (alist-get 'text (car list))) 1)))
       (t (<span class="org-keyword">setq</span> done nil)
          (<span class="org-keyword">while</span> (not done)
          (<span class="org-keyword">cond</span>
           ((&lt; current-length lower-limit)
            (<span class="org-keyword">setq</span> done t))
           ((<span class="org-keyword">and</span> (string-match break-regexp (alist-get 'text (car current-item)))
                 (not (string-match break-regexp (alist-get 'text (cadr current-item)))))
            (<span class="org-keyword">setq</span> current-length (- current-length (length (alist-get 'text (car current-item)))))
            (<span class="org-keyword">push</span> (<span class="org-keyword">pop</span> current-item) list)
            (<span class="org-keyword">setq</span> done t))
           (t
            (<span class="org-keyword">setq</span> current-length (- current-length (length (alist-get 'text (car current-item)))))
            (<span class="org-keyword">push</span> (<span class="org-keyword">pop</span> current-item) list))))
          (<span class="org-keyword">push</span> nil list)
          (<span class="org-keyword">setq</span> result (cons (reverse current-item) result) current-item nil current-length 0)))
      (<span class="org-keyword">setq</span> list (cdr list)))
    (reverse result)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/caption-format-as-subtitle</span> (list <span class="org-type">&amp;optional</span> word-timing)
  <span class="org-doc">"Turn a LIST of the form (((start . ms) (end . ms) (text . s)) ...) into VTT.</span>
<span class="org-doc">If WORD-TIMING is non-nil, include word-level timestamps."</span>
  (format <span class="org-string">"%s --&gt; %s\n%s\n\n"</span>
          (subed-vtt--msecs-to-timestamp (alist-get 'start (car list)))
          (subed-vtt--msecs-to-timestamp (alist-get 'end (car (last list))))
          (s-trim (mapconcat (<span class="org-keyword">lambda</span> (entry)
                               (<span class="org-keyword">if</span> word-timing
                                   (format <span class="org-string">" &lt;%s&gt;%s"</span>
                                           (subed-vtt--msecs-to-timestamp (alist-get 'start entry))
                                           (string-trim (alist-get 'text entry)))
                                 (alist-get 'text entry)))
                             list <span class="org-string">""</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/caption-to-vtt</span> (<span class="org-type">&amp;optional</span> data)
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">with-temp-file</span> <span class="org-string">"captions.vtt"</span>
    (insert <span class="org-string">"WEBVTT\n\n"</span>
            (mapconcat
             (<span class="org-keyword">lambda</span> (entry) (my/caption-format-as-subtitle entry))
             (my/caption-make-groups
              (<span class="org-keyword">or</span> data (my/caption-fix-common-errors my/caption-cache)))
             <span class="org-string">""</span>))))
</pre>
</div>
</div>
</div>
<div id="outline-container-org7be4d44" class="outline-5">
<h5 id="org7be4d44">Edit text</h5>
<div class="outline-text-5" id="text-org7be4d44">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/subed-common-edits</span> '((<span class="org-string">"i"</span> <span class="org-string">"I"</span>)
                                (<span class="org-string">"i've"</span> <span class="org-string">"I've"</span>)
                                (<span class="org-string">"i'm"</span> <span class="org-string">"I'm"</span>)
                                (<span class="org-string">"gonna"</span> <span class="org-string">"going to"</span>)
                                (<span class="org-string">"wanna"</span> <span class="org-string">"want to"</span>)
                                (<span class="org-string">"transit"</span> <span class="org-string">"transient"</span>)
                                (<span class="org-string">"uh"</span> <span class="org-string">""</span>)
                                (<span class="org-string">"um"</span> <span class="org-string">""</span>)
                                (<span class="org-string">"maggot"</span> <span class="org-string">"Magit"</span>)
                                (<span class="org-string">"e-max"</span> <span class="org-string">"Emacs"</span>)
                                (<span class="org-string">"emex"</span> <span class="org-string">"Emacs"</span>)
                                (<span class="org-string">"emax"</span> <span class="org-string">"Emacs"</span>)
                                (<span class="org-string">"emacs news"</span> <span class="org-string">"Emacs News"</span>)
                                (<span class="org-string">"iv"</span> <span class="org-string">"ivy"</span>)
                                (<span class="org-string">"ui"</span> <span class="org-string">"UI"</span>)
                                (<span class="org-string">"tico"</span> <span class="org-string">"TECO"</span>)
                                (<span class="org-string">"orgrim"</span> <span class="org-string">"org-roam"</span>)
                                (<span class="org-string">"imax"</span> <span class="org-string">"Emacs"</span>)
                                (<span class="org-string">"non-nail"</span> <span class="org-string">"non-nil"</span>)
                                (<span class="org-string">"comets"</span> <span class="org-string">"commits"</span>)
                                (<span class="org-string">"sql"</span> <span class="org-string">"SQL"</span>)
                                (<span class="org-string">"imaxconf"</span> <span class="org-string">"EmacsConf"</span>)
                                (<span class="org-string">"svg"</span> <span class="org-string">"SVG"</span>)
                                (<span class="org-string">"maggit"</span> <span class="org-string">"magit"</span>)
                                (<span class="org-string">"axwm"</span> <span class="org-string">"EXWM"</span>)
                                (<span class="org-string">"bmx"</span> <span class="org-string">"Emacs"</span>))
  <span class="org-doc">"List of words and replacements."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my/subed-find-next-fix-point</span> ()
  (<span class="org-keyword">when</span> (re-search-forward
         (format <span class="org-string">"\\&lt;%s\\&gt;"</span>
                 (regexp-opt (mapcar 'car my/subed-common-edits)))
         nil t)
    (goto-char (match-beginning 0))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/subed-fix-common-errors</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> (done)
    (<span class="org-keyword">while</span> (<span class="org-keyword">and</span>
            (not done)
            (my/subed-find-next-fix-point))
      (<span class="org-keyword">let*</span> ((entry (cdr (assoc (match-string 0) my/subed-common-edits)))
             (c (<span class="org-keyword">if</span> (elt entry 1)
                    (<span class="org-keyword">and</span> entry (read-char (format <span class="org-string">"%s (yn.): "</span> (car entry))))
                  ?y)))
        (<span class="org-keyword">cond</span>
         ((null entry) (goto-char (match-end 0)))
         ((= c ?y) (replace-match (car entry) t t))
         ((= c ?n) (goto-char (match-end 0)))
         ((= c ?j) (subed-mpv-jump-to-current-subtitle))
         ((= c ?.) (<span class="org-keyword">setq</span> done t)))
      ))))
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbde001e" class="outline-3">
<h3 id="orgbde001e"><span class="todo TOBLOG">TOBLOG</span> Manage photos with geeqie</h3>
<div class="outline-text-3" id="text-orgbde001e">
<p>
Opening images directly in Emacs seems a little slow. Geeqie is pretty
fast (after generating thumbnails) and can be remotely controlled via
the command-line. I wrote a few functions to help me flip through
images, add extra stuff to filenames, change dates, and insert
references.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/scan-directory</span> <span class="org-string">"~/sync/scans"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/portfolio-directory</span> <span class="org-string">"~/sync/portfolio"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/camera-directory</span> <span class="org-string">"~/sync/camera"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/private-sketches-directory</span> <span class="org-string">"~/cloud/private-sketches"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/sketches-directory</span> <span class="org-string">"~/sync/sketches"</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my/geeqie-next</span> ()
  (<span class="org-keyword">interactive</span>)
  (shell-command <span class="org-string">"geeqie --remote -n"</span>))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/geeqie-previous</span> ()
  (<span class="org-keyword">interactive</span>)
  (shell-command <span class="org-string">"geeqie --remote -b"</span>))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/geeqie-filename</span> ()
  (string-trim (shell-command-to-string <span class="org-string">"geeqie --remote --tell"</span>)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/geeqie-view</span> (filenames)
  (<span class="org-keyword">interactive</span> <span class="org-string">"f"</span>)
  (shell-command
   (concat <span class="org-string">"geeqie --remote "</span>
           (mapconcat (<span class="org-keyword">lambda</span> (f)
                        (concat <span class="org-string">"file:"</span> (shell-quote-argument f)))
                      (<span class="org-keyword">cond</span>
                       ((listp filenames) filenames)
                       ((file-directory-p filenames)
                        (list (car (seq-filter #'file-regular-p (directory-files filenames t)))))
                       (t (list filenames)))
                      <span class="org-string">" "</span>)
           <span class="org-string">" &amp;"</span>)))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/rotate-jpeg-using-exiftran</span> nil)

(<span class="org-keyword">defun</span> <span class="org-function-name">my/rotate-image-clockwise</span> (filename)
  (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> my/rotate-jpeg-using-exiftran
           (string-match <span class="org-string">"jpe?g"</span> (file-name-extension filename)))
      (call-process <span class="org-string">"exiftran"</span> nil nil nil <span class="org-string">"-i"</span> <span class="org-string">"-9"</span> filename)
    (call-process <span class="org-string">"mogrify"</span> nil nil nil <span class="org-string">"-rotate"</span> <span class="org-string">"90"</span> filename)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/rotate-image-counterclockwise</span> (filename)
  (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> my/rotate-jpeg-using-exiftran
           (string-match <span class="org-string">"jpe?g"</span> (file-name-extension filename)))
      (call-process <span class="org-string">"exiftran"</span> nil nil nil <span class="org-string">"-i"</span> <span class="org-string">"-2"</span> filename)
    (call-process <span class="org-string">"mogrify"</span> nil nil nil <span class="org-string">"-rotate"</span> <span class="org-string">"270"</span> filename)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/geeqie-rotate-clockwise</span> ()
  (<span class="org-keyword">interactive</span>)
  (my/rotate-image-clockwise (my/geeqie-filename))
  (my/geeqie-view (my/geeqie-filename)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/geeqie-rotate-counterclockwise</span> ()
  (<span class="org-keyword">interactive</span>)
  (my/rotate-image-counterclockwise (my/geeqie-filename))
  (my/geeqie-view (my/geeqie-filename)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/rename-file-based-on-modification-time</span> (filename)
  <span class="org-doc">"Rename files to their modification time."</span>
  (rename-file filename
               (expand-file-name
                (concat
                 (format-time-string <span class="org-string">"%Y-%m-%d_%H%M%S"</span>
                                     (file-attribute-modification-time (file-attributes filename)))
                 <span class="org-string">"."</span>
                 (file-name-extension filename))
                (file-name-directory filename))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/geeqie-change-date</span> (filename new-time)
  (<span class="org-keyword">interactive</span> (list (my/geeqie-filename)
                     (<span class="org-keyword">let</span> ((org-read-date-prefer-future nil))
                       (org-read-date nil t))))
  (<span class="org-keyword">let</span> ((new-file (expand-file-name
                   (replace-regexp-in-string
                    <span class="org-string">"^[0-9]*"</span>
                    (format-time-string
                     <span class="org-string">"%Y%m%d"</span>
                     new-time)
                    (file-name-nondirectory filename))
                   (file-name-directory filename))))
    (rename-file filename new-file)
    (my/geeqie-view new-file)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/geeqie-rename-current</span> (old-filename new-filename)
  (<span class="org-keyword">interactive</span>
   (list (my/geeqie-filename)
         (read-string <span class="org-string">"Filename: "</span> (concat (file-name-base (my/geeqie-filename)) <span class="org-string">" "</span>))))
  (rename-file old-filename
               (expand-file-name
                (concat new-filename <span class="org-string">"."</span> (file-name-extension old-filename))
                (file-name-directory old-filename))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/geeqie-crop-to-rectangle</span> ()
  (<span class="org-keyword">interactive</span>)
  (call-process
   <span class="org-string">"mogrify"</span> nil nil nil <span class="org-string">"-crop"</span>
   (string-trim (shell-command-to-string <span class="org-string">"geeqie --remote --get-rectangle"</span>))
   (my/geeqie-filename))
  (my/geeqie-view (my/geeqie-filename)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/geeqie-scans</span> ()
  <span class="org-doc">"Rename files and open the first one."</span>
  (<span class="org-keyword">interactive</span>)
  (mapc 'my/rename-file-based-on-modification-time (directory-files my/scan-directory t <span class="org-string">"^scan"</span>))
  (call-process <span class="org-string">"geeqie"</span> nil nil nil <span class="org-string">"--remote"</span> (concat <span class="org-string">"file:"</span> (shell-quote-argument (seq-find 'file-regular-p (directory-files <span class="org-string">"~/sync/scans"</span> t <span class="org-string">"^[0-9].*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">gif</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">png</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">jpg</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/geeqie-delete-and-next</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((file (my/geeqie-filename)))
    (my/geeqie-next)
    (delete-file file t)))

(<span class="org-keyword">defhydra</span> my/geeqie ()
  <span class="org-doc">"Manage images with geeqie."</span>
  (<span class="org-string">"op"</span> (my/geeqie-view my/portfolio-directory) <span class="org-string">"Open portfolio"</span>)
  (<span class="org-string">"oc"</span> (my/geeqie-view my/camera-directory) <span class="org-string">"Open camera"</span>)
  (<span class="org-string">"os"</span> my/geeqie-scans <span class="org-string">"Open scans"</span>)
  (<span class="org-string">"["</span> my/geeqie-rotate-counterclockwise <span class="org-string">"CCW"</span>)
  (<span class="org-string">"]"</span> my/geeqie-rotate-clockwise <span class="org-string">"CW"</span>)
  (<span class="org-string">"r"</span> my/geeqie-rename-current <span class="org-string">"Rename"</span>)
  (<span class="org-string">"c"</span> my/geeqie-crop-to-rectangle <span class="org-string">"Crop"</span>)
  (<span class="org-string">"k"</span> (start-process <span class="org-string">"krita"</span> nil <span class="org-string">"krita"</span> (my/geeqie-filename)) <span class="org-string">"krita"</span>)
  (<span class="org-string">"g"</span> (start-process <span class="org-string">"gimp"</span> nil <span class="org-string">"gimp"</span> (my/geeqie-filename)) <span class="org-string">"gimp"</span>)
  (<span class="org-string">"n"</span> my/geeqie-next <span class="org-string">"Next"</span>)
  (<span class="org-string">"p"</span> my/geeqie-previous <span class="org-string">"Previous"</span>)
  (<span class="org-string">"d"</span> my/geeqie-change-date <span class="org-string">"Change date"</span>)
  (<span class="org-string">"x"</span> my/geeqie-delete-and-next <span class="org-string">"Delete"</span>)
  (<span class="org-string">"m"</span> my/move-portfolio-files <span class="org-string">"Move portfolio files"</span>)
  (<span class="org-string">"s"</span> (rename-file (my/geeqie-filename)
                    (expand-file-name (file-name-nondirectory (my/geeqie-filename)) my/sketches-directory))
   <span class="org-string">"Save to sketch directory"</span>)
  (<span class="org-string">"O"</span> (shell-command (format <span class="org-string">"mogrify -auto-orient %s"</span> (shell-quote-argument (my/geeqie-filename)))) <span class="org-string">"Rotate based on EXIF"</span>)
  (<span class="org-string">"&lt;up&gt;"</span> (forward-line -1) <span class="org-builtin">:hint</span> nil)
  (<span class="org-string">"&lt;down&gt;"</span> forward-line <span class="org-builtin">:hint</span> nil)
  (<span class="org-string">"im"</span> (insert (format <span class="org-string">"{{&lt;photo nas=\"1\" src=\"%s\"&gt;}}"</span> (my/geeqie-filename))))
  (<span class="org-string">"if"</span> (insert (my/geeqie-filename) <span class="org-string">"\n"</span>)
   <span class="org-string">"Insert filename"</span>)
  (<span class="org-string">"v"</span> (my/geeqie-view (string-trim (thing-at-point 'line))) <span class="org-string">"View"</span>)
  (<span class="org-string">"il"</span> (insert <span class="org-string">"- "</span> (my/geeqie-filename) <span class="org-string">"\n"</span>) <span class="org-string">"Insert filename as list item"</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/move-portfolio-files</span> ()
  (<span class="org-keyword">interactive</span>)
  (mapc (<span class="org-keyword">lambda</span> (f)
          (<span class="org-keyword">let</span> ((new-dir
                 (<span class="org-keyword">cond</span>
                  ((string-match <span class="org-string">"#private"</span> f) my/private-sketches-directory)
                  ((string-match <span class="org-string">"#me\\&gt;"</span> f) my/sketches-directory)
                  (t my/portfolio-directory))))
            (<span class="org-keyword">when</span> new-dir (rename-file f (expand-file-name (file-name-nondirectory f) new-dir)))))
        (seq-filter
         'file-regular-p
         (directory-files my/scan-directory t <span class="org-string">"^[0-9]+.*#"</span>)))
  (shell-command-to-string <span class="org-string">"make-sketch-thumbnails"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-org9d52d98" class="outline-3">
<h3 id="org9d52d98">Org&#xa0;&#xa0;&#xa0;<span class="tag"><span class="org">org</span></span></h3>
<div class="outline-text-3" id="text-org9d52d98">
<p>
I use <a href="http://www.orgmode.org">Org Mode</a> to take notes, publish my blog, and do all sorts of
stuff.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-export-with-sub-superscripts nil)
</pre>
</div>

<p>
Filling in for obsolete functions
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">org</span>
  <span class="org-builtin">:load-path</span> (<span class="org-string">"~/vendor/org-mode/lisp"</span> <span class="org-string">"~/vendor/org-mode/contrib/lisp"</span>)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">unless</span> (functionp 'org-link-make-string)
    (fset 'org-link-make-string 'org-make-link-string))
  )
</pre>
</div>
</div>

<div id="outline-container-org-files" class="outline-4">
<h4 id="org-files">My files</h4>
<div class="outline-text-4" id="text-org-files">
<p>
#<a id="org29133d0"></a>
</p>

<p>
Here are the Org files I use. I should probably organize them better. =)
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">organizer.org</td>
<td class="org-left">My main Org file. Inbox for M-x org-capture, tasks, weekly reviews, etc.</td>
</tr>

<tr>
<td class="org-left">sewing.org</td>
<td class="org-left">Sewing projects, fabric tracking, etc.</td>
</tr>

<tr>
<td class="org-left">business.org</td>
<td class="org-left">Business-related notes and TODOs</td>
</tr>

<tr>
<td class="org-left">people.org</td>
<td class="org-left">People-related tasks</td>
</tr>

<tr>
<td class="org-left"><a href="http://sachachua.com/evil-plans">evil-plans/index.org</a></td>
<td class="org-left">High-level goals</td>
</tr>

<tr>
<td class="org-left"><a href="http://sachachua.com/outline">sharing/index.org</a></td>
<td class="org-left">Things to write about</td>
</tr>

<tr>
<td class="org-left">decisions.org</td>
<td class="org-left">Pending, current, and reviewed decisions</td>
</tr>

<tr>
<td class="org-left"><a href="http://sachachua.com/blog/index">blog.org</a></td>
<td class="org-left">Topic index for my blog</td>
</tr>

<tr>
<td class="org-left"><a href="http://sachachua.com/my-learning">learning.org</a></td>
<td class="org-left">Learning plan</td>
</tr>

<tr>
<td class="org-left">outline.org</td>
<td class="org-left">Huge outline of notes by category</td>
</tr>

<tr>
<td class="org-left">tracking.org</td>
<td class="org-left">Temporary Org file for tracking various things</td>
</tr>

<tr>
<td class="org-left">delegation.org</td>
<td class="org-left">Templates for assigning tasks - now using Google Docs instead</td>
</tr>

<tr>
<td class="org-left">books.org</td>
<td class="org-left">Huge file with book notes</td>
</tr>

<tr>
<td class="org-left">calendar.org</td>
<td class="org-left">Now using this with org-gcal</td>
</tr>

<tr>
<td class="org-left">ideal.org</td>
<td class="org-left">Planning ideal days</td>
</tr>

<tr>
<td class="org-left">archive.org</td>
<td class="org-left">Archived subtrees</td>
</tr>

<tr>
<td class="org-left">latin.org</td>
<td class="org-left">Latin notes</td>
</tr>

<tr>
<td class="org-left">101things.org</td>
<td class="org-left">Old goals for 101 things in 1001 days</td>
</tr>

<tr>
<td class="org-left">life.org</td>
<td class="org-left">Questions, processes, tools</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><a href="http://stackoverflow.com/questions/8146313/emacs-auto-save-for-org-mode-only">emacs auto save for org-mode only - Stack Overflow</a></li>
</ul>
</div>
</div>

<div id="outline-container-orga676f80" class="outline-4">
<h4 id="orga676f80">Modules</h4>
<div class="outline-text-4" id="text-orga676f80">
<p>
Org has a whole bunch of optional modules. These are the ones I'm
currently experimenting with.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-modules '(org-habit
                    org-mouse
                    org-protocol
                    org-annotate-file
                    org-eval
                    org-expiry
                    org-interactive-query
                    org-collector
                    org-panel
                    org-screen
                    org-toc))
(eval-after-load 'org
  '(org-load-modules-maybe t))
<span class="org-comment-delimiter">;; </span><span class="org-comment">Prepare stuff for org-export-backends</span>
(<span class="org-keyword">setq</span> org-export-backends '(org latex icalendar html ascii))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgae41edc" class="outline-4">
<h4 id="orgae41edc">Keyboard shortcuts</h4>
<div class="outline-text-4" id="text-orgae41edc">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">bind-key</span> <span class="org-string">"C-c r"</span> 'org-capture)
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-c a"</span> 'org-agenda)
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-c l"</span> 'org-store-link)
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-c L"</span> 'org-insert-link-global)
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-c O"</span> 'org-open-at-point-global)
(<span class="org-keyword">bind-key</span> <span class="org-string">"&lt;f9&gt; &lt;f9&gt;"</span> 'org-agenda-list)
(<span class="org-keyword">bind-key</span> <span class="org-string">"&lt;f9&gt; &lt;f8&gt;"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (org-capture nil <span class="org-string">"r"</span>)))
</pre>
</div>

<p>
<code>append-next-kill</code> is more useful to me than <code>org-table-copy-region</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">with-eval-after-load</span> 'org
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-M-w"</span> 'append-next-kill org-mode-map)
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-TAB"</span> 'org-cycle org-mode-map)
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c v"</span> 'org-show-todo-tree org-mode-map)
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c C-r"</span> 'org-refile org-mode-map)
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c R"</span> 'org-reveal org-mode-map)
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c o"</span> 'my/org-follow-entry-link org-mode-map)
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c d"</span> 'my/org-move-line-to-destination org-mode-map)
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c f"</span> 'my/org-file-blog-index-entries org-mode-map)
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c t s"</span>  'my/split-sentence-and-capitalize org-mode-map)
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c t -"</span>  'my/split-sentence-delete-word-and-capitalize org-mode-map)
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c t d"</span>  'my/delete-word-and-capitalize org-mode-map)

  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c C-p C-p"</span> 'my/org-publish-maybe org-mode-map)
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c C-r"</span> 'my/org-refile-and-jump org-mode-map))
</pre>
</div>

<p>
I don't use the diary, but I do use the clock a lot.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">with-eval-after-load</span> 'org-agenda
  (<span class="org-keyword">bind-key</span> <span class="org-string">"i"</span> 'org-agenda-clock-in org-agenda-mode-map))
</pre>
</div>
</div>

<div id="outline-container-orgd5ecdc1" class="outline-5">
<h5 id="orgd5ecdc1">Speed commands</h5>
<div class="outline-text-5" id="text-orgd5ecdc1">
<p>
These are great for quickly acting on tasks.
</p>

<ul class="org-ul">
<li>hello
<ul class="org-ul">
<li>world</li>
<li>this</li>
</ul></li>
<li>world here</li>
</ul>



<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-use-effective-time t)

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-use-speed-commands-for-headings-and-lists</span> ()
  <span class="org-doc">"Activate speed commands on list items too."</span>
  (<span class="org-keyword">or</span> (<span class="org-keyword">and</span> (looking-at org-outline-regexp) (looking-back <span class="org-string">"^</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">**"</span> nil))
      (<span class="org-keyword">save-excursion</span> (<span class="org-keyword">and</span> (looking-at (org-item-re)) (looking-back <span class="org-string">"^[ \t]*"</span> nil)))))
(<span class="org-keyword">setq</span> org-use-speed-commands 'my/org-use-speed-commands-for-headings-and-lists)

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-mark-done-and-add-to-journal</span> (<span class="org-type">&amp;optional</span> note)
  (<span class="org-keyword">interactive</span> (list (read-string <span class="org-string">"Note: "</span> (org-get-heading t t t t))))
  (<span class="org-keyword">my/org-with-current-task</span>
   (org-todo <span class="org-string">"DONE"</span>)
   (org-entry-put (point) <span class="org-string">"ZIDSTRING"</span> (plist-get (my/journal-post (<span class="org-keyword">or</span> note (org-get-heading t t t t))) <span class="org-builtin">:ZIDString</span>))))

(<span class="org-keyword">use-package</span> <span class="org-constant">org</span>
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">progn</span>
    (add-to-list 'org-speed-commands-user '(<span class="org-string">"x"</span> org-todo <span class="org-string">"DONE"</span>))
    (add-to-list 'org-speed-commands-user '(<span class="org-string">"X"</span> call-interactively 'my/org-mark-done-and-add-to-journal))
    (add-to-list 'org-speed-commands-user '(<span class="org-string">"y"</span> org-todo-yesterday <span class="org-string">"DONE"</span>))
    (add-to-list 'org-speed-commands-user '(<span class="org-string">"!"</span> my/org-clock-in-and-track))
    (add-to-list 'org-speed-commands-user '(<span class="org-string">"s"</span> call-interactively 'org-schedule))
    (add-to-list 'org-speed-commands-user '(<span class="org-string">"d"</span> my/org-move-line-to-destination))
    (add-to-list 'org-speed-commands-user '(<span class="org-string">"i"</span> call-interactively 'org-clock-in))
    (add-to-list 'org-speed-commands-user '(<span class="org-string">"P"</span> call-interactively 'org2blog/wp-post-subtree))
    (add-to-list 'org-speed-commands-user '(<span class="org-string">"o"</span> call-interactively 'org-clock-out))
    (add-to-list 'org-speed-commands-user '(<span class="org-string">"$"</span> call-interactively 'org-archive-subtree))
    (<span class="org-keyword">bind-key</span> <span class="org-string">"!"</span> 'my/org-clock-in-and-track org-agenda-mode-map)))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbab32c5" class="outline-4">
<h4 id="orgbab32c5">Navigation</h4>
<div class="outline-text-4" id="text-orgbab32c5">
<p>
From <a href="http://stackoverflow.com/questions/15011703/is-there-an-emacs-org-mode-command-to-jump-to-an-org-heading">http://stackoverflow.com/questions/15011703/is-there-an-emacs-org-mode-command-to-jump-to-an-org-heading</a>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-goto-interface 'outline
      org-goto-max-level 10)
(<span class="org-keyword">require</span> '<span class="org-constant">imenu</span>)
(<span class="org-keyword">setq</span> org-startup-folded nil)
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-c j"</span> 'org-clock-goto) <span class="org-comment-delimiter">;; </span><span class="org-comment">jump to current task from anywhere</span>
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-c C-w"</span> 'org-refile)
(<span class="org-keyword">setq</span> org-cycle-include-plain-lists 'integrate)
(<span class="org-keyword">setq</span> org-catch-invisible-edits 'show-and-error)
</pre>
</div>
</div>

<div id="outline-container-org85d80d6" class="outline-5">
<h5 id="org85d80d6">Link Org subtrees and navigate between them</h5>
<div class="outline-text-5" id="text-org85d80d6">
<p>
The following code makes it easier for me to link trees with entries, as in <a href="http://sachachua.com/evil-plans">http://sachachua.com/evil-plans</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-follow-entry-link</span> ()
  <span class="org-doc">"Follow the defined link for this entry."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">if</span> (org-entry-get (point) <span class="org-string">"LINK"</span>)
      (org-open-link-from-string (org-entry-get (point) <span class="org-string">"LINK"</span>))
    (org-open-at-point)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-link-projects</span> (location)
  <span class="org-doc">"Add link properties between the current subtree and the one specified by LOCATION."</span>
  (<span class="org-keyword">interactive</span>
   (list (<span class="org-keyword">let</span> ((org-refile-use-cache nil))
           (org-refile-get-location <span class="org-string">"Location"</span>))))
  (<span class="org-keyword">let</span> ((link1 (org-store-link nil)) link2)
    (<span class="org-keyword">save-window-excursion</span>
      (org-refile 4 nil location)
      (<span class="org-keyword">setq</span> link2 (org-store-link nil))
      (org-set-property <span class="org-string">"LINK"</span> link1))
    (org-set-property <span class="org-string">"LINK"</span> link2)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org1ff3cfd" class="outline-5">
<h5 id="org1ff3cfd">Viewing, navigating, and editing the Org tree</h5>
<div class="outline-text-5" id="text-org1ff3cfd">
<p>
I often cut and paste subtrees. This makes it easier to cut
something and paste it elsewhere in the hierarchy.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">with-eval-after-load</span> 'org
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c k"</span> 'org-cut-subtree org-mode-map)
  (<span class="org-keyword">setq</span> org-yank-adjusted-subtrees t))
</pre>
</div>
</div>
</div>

<div id="outline-container-org2f272d2" class="outline-5">
<h5 id="org2f272d2">Finding my place on a small mobile screen with org-back-to-heading</h5>
<div class="outline-text-5" id="text-org2f272d2">
<p>
There's probably a better way to do this. I'm surprised
org-back-to-heading isn't interactive yet. It's useful.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-back-to-heading</span> ()
  (<span class="org-keyword">interactive</span>)
  (org-back-to-heading))

(<span class="org-keyword">use-package</span> <span class="org-constant">org</span>
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> org-mode-map 
              (<span class="org-string">"C-c b"</span> . my/org-back-to-heading)
              (<span class="org-string">"C-c p"</span> . org-display-outline-path))) 
</pre>
</div>
</div>
</div>

<div id="outline-container-org04fed81" class="outline-5">
<h5 id="org04fed81">Dealing with big tables</h5>
<div class="outline-text-5" id="text-org04fed81">
<p>
Sometimes I forget where I am in a big table. This would be nice to turn into a minor mode someday.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-show-row-and-column</span> (point)
  (<span class="org-keyword">interactive</span> <span class="org-string">"d"</span>)
  (<span class="org-keyword">save-excursion</span>
    (goto-char point)
    (<span class="org-keyword">let</span> ((row (s-trim (org-table-get nil 1)))
          (col (s-trim (org-table-get 1 nil)))
          (message-log-max nil))
      (message <span class="org-string">"%s - %s"</span> row col))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5148ded" class="outline-4">
<h4 id="org5148ded">Taking notes</h4>
<div class="outline-text-4" id="text-org5148ded">
<p>
My org files are in my <code>personal</code> directory, which is actually a
symlink to a directory in my Dropbox. That way, I can update my
Org files from multiple computers.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-directory <span class="org-string">"~/personal"</span>)
(<span class="org-keyword">setq</span> org-default-notes-file <span class="org-string">"~/orgzly/organizer.org"</span>)
</pre>
</div>

<p>
This makes it easier to add links from outside.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/yank-more</span> ()
  (<span class="org-keyword">interactive</span>)
  (insert <span class="org-string">"[["</span>)
  (yank)
  (insert <span class="org-string">"][more]]"</span>))
(global-set-key (kbd <span class="org-string">"&lt;f6&gt;"</span>) 'my/yank-more)
</pre>
</div>
</div>

<div id="outline-container-org7f30a33" class="outline-5">
<h5 id="org7f30a33">Date trees</h5>
<div class="outline-text-5" id="text-org7f30a33">
<p>
This quickly adds a same-level heading for the succeeding day.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-insert-heading-for-next-day</span> ()
  <span class="org-doc">"Insert a same-level heading for the following day."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((new-date
         (seconds-to-time
          (+ 86400.0
             (float-time
              (org-read-date nil 'to-time (elt (org-heading-components) 4)))))))
    (org-insert-heading-after-current)
    (insert (format-time-string <span class="org-string">"%Y-%m-%d\n\n"</span> new-date))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org2f5944b" class="outline-5">
<h5 id="org2f5944b">Templates</h5>
<div class="outline-text-5" id="text-org2f5944b">
<p>
I use <code>org-capture</code> templates to quickly jot down tasks, ledger
entries, notes, and other semi-structured pieces of information.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-contacts-template-email</span> (<span class="org-type">&amp;optional</span> return-value)
  <span class="org-doc">"Try to return the contact email for a template.</span>
<span class="org-doc">         If not found return RETURN-VALUE or something that would ask the user."</span>
  (<span class="org-keyword">eval-when-compile</span> (<span class="org-keyword">require</span> '<span class="org-constant">gnus-art</span> nil t))
  (<span class="org-keyword">eval-when-compile</span> (<span class="org-keyword">require</span> '<span class="org-constant">org-contacts</span> nil t))
  (<span class="org-keyword">or</span> (cadr (<span class="org-keyword">if</span> (gnus-alive-p)
                (<span class="org-keyword">gnus-with-article-headers</span>
                  (mail-extract-address-components
                   (<span class="org-keyword">or</span> (mail-fetch-field <span class="org-string">"Reply-To"</span>) (mail-fetch-field <span class="org-string">"From"</span>) <span class="org-string">""</span>)))))
      return-value
      (concat <span class="org-string">"%^{"</span> org-contacts-email-property <span class="org-string">"}p"</span>)))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/org-basic-task-template</span> <span class="org-string">"* TODO %^{Task}</span>
<span class="org-string">         :PROPERTIES:</span>
<span class="org-string">         :Effort: %^{effort|1:00|0:05|0:15|0:30|2:00|4:00}</span>
<span class="org-string">         :END:</span>
<span class="org-string">         Captured %&lt;%Y-%m-%d %H:%M&gt;</span>
<span class="org-string">         %?</span>

<span class="org-string">         %i</span>
<span class="org-string">         "</span> <span class="org-doc">"Basic task data"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/org-inbox-file</span> <span class="org-string">"~/orgzly/Inbox.org"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/ledger-file</span> <span class="org-string">"~/cloud/ledger/current.ledger"</span>)
(<span class="org-keyword">setq</span> org-capture-templates
      `((<span class="org-string">"t"</span> <span class="org-string">"Quick task"</span> entry
         (file ,my/org-inbox-file)
         <span class="org-string">"* TODO %^{Task}\n"</span>
         <span class="org-builtin">:immediate-finish</span> t)
        (<span class="org-string">"p"</span> <span class="org-string">"Podcast log - timestamped"</span> item
         (file+olp+datetree <span class="org-string">"~/orgzly/timestamped.org"</span>)
         <span class="org-string">"%&lt;%H:%M:%S,%3N&gt; %^{Note}"</span>
         <span class="org-builtin">:immediate-finish</span> t)
        (<span class="org-string">"T"</span> <span class="org-string">"Task"</span> entry
         (file ,my/org-inbox-file)
         <span class="org-string">"* TODO %^{Task}\n"</span>)
        (<span class="org-string">"."</span> <span class="org-string">"Today"</span> entry
         (file ,my/org-inbox-file)
         <span class="org-string">"* TODO %^{Task}\nSCHEDULED: %t\n"</span>
         <span class="org-builtin">:immediate-finish</span> t)
        (<span class="org-string">"v"</span> <span class="org-string">"Video"</span> entry
         (file ,my/org-inbox-file)
         <span class="org-string">"* TODO %^{Task}  :video:\nSCHEDULED: %t\n"</span>
         <span class="org-builtin">:immediate-finish</span> t)
        (<span class="org-string">"e"</span> <span class="org-string">"Errand"</span> entry
         (file ,my/org-inbox-file)
         <span class="org-string">"* TODO %^{Task}  :errands:\n"</span>
         <span class="org-builtin">:immediate-finish</span> t)
        (<span class="org-string">"n"</span> <span class="org-string">"Note"</span> entry
         (file ,my/org-inbox-file)
         <span class="org-string">"* %^{Note}\n"</span>
         <span class="org-builtin">:immediate-finish</span> t)
        (<span class="org-string">"r"</span> <span class="org-string">"Note"</span> entry
         (file ,my/org-inbox-file)
         <span class="org-string">"* %?\n%U - %a"</span>)
        (<span class="org-string">"N"</span> <span class="org-string">"Note"</span> entry
         (file ,my/org-inbox-file)
         <span class="org-string">"* %^{Note}\n"</span>)
        (<span class="org-string">"i"</span> <span class="org-string">"Interrupting task"</span> entry
         (file ,my/org-inbox-file)
         <span class="org-string">"* STARTED %^{Task}"</span>
         <span class="org-builtin">:clock-in</span> <span class="org-builtin">:clock-resume</span>)
        (<span class="org-string">"b"</span> <span class="org-string">"Business task"</span> entry
         (file+headline <span class="org-string">"~/personal/business.org"</span> <span class="org-string">"Tasks"</span>)
         ,my/org-basic-task-template)
        (<span class="org-string">"j"</span> <span class="org-string">"Journal entry"</span> plain
         (file+olp+datetree <span class="org-string">"~/orgzly/journal.org"</span>)
         <span class="org-string">"%K - %a\n%i\n%?\n"</span>
         <span class="org-builtin">:unnarrowed</span> t)
        (<span class="org-string">"c"</span> <span class="org-string">"Protocol Link"</span> entry (file+headline ,org-default-notes-file <span class="org-string">"Inbox"</span>)
         <span class="org-string">"* [[%:link][%:description]] \n\n#+BEGIN_QUOTE\n%i\n#+END_QUOTE\n\n%?\n\nCaptured: %U"</span>)
        (<span class="org-string">"db"</span> <span class="org-string">"Done - Business"</span> entry
         (file+headline <span class="org-string">"~/personal/business.org"</span> <span class="org-string">"Tasks"</span>)
         <span class="org-string">"* DONE %^{Task}\nSCHEDULED: %^t\n%?"</span>)
        (<span class="org-string">"dp"</span> <span class="org-string">"Done - People"</span> entry
         (file+headline <span class="org-string">"~/personal/people.org"</span> <span class="org-string">"Tasks"</span>)
         <span class="org-string">"* DONE %^{Task}\nSCHEDULED: %^t\n%?"</span>)
        (<span class="org-string">"dt"</span> <span class="org-string">"Done - Task"</span> entry
         (file+headline <span class="org-string">"~/orgzly/organizer.org"</span> <span class="org-string">"Inbox"</span>)
         <span class="org-string">"* DONE %^{Task}\nSCHEDULED: %^t\n%?"</span>)
        (<span class="org-string">"q"</span> <span class="org-string">"Quick note"</span> item
         (file+headline <span class="org-string">"~/orgzly/organizer.org"</span> <span class="org-string">"Quick notes"</span>))
        (<span class="org-string">"l"</span> <span class="org-string">"Ledger"</span>)
        (<span class="org-string">"lc"</span> <span class="org-string">"Cash expense"</span> plain
         (file ,my/ledger-file)
         <span class="org-string">"%(ledger-read-date \"Date: \") * %^{Payee}</span>
<span class="org-string">             Expenses:Cash</span>
<span class="org-string">             Expenses:%^{Account}  %^{Amount}</span>
<span class="org-string">           "</span>)
        (<span class="org-string">"lb"</span> <span class="org-string">"BDO CAD"</span> plain
         (file ,my/ledger-file)
         <span class="org-string">"%(ledger-read-date \"Date: \") * %^{Payee}</span>
<span class="org-string">             Expenses:Play    $ %^{Amount}</span>
<span class="org-string">             Assets:BDO</span>
<span class="org-string">           "</span>)
        (<span class="org-string">"lp"</span> <span class="org-string">"BDO PHP"</span> plain
         (file ,my/ledger-file)
         <span class="org-string">"%(ledger-read-date \"Date: \") * %^{Payee}</span>
<span class="org-string">             Expenses:Play    PHP %^{Amount}</span>
<span class="org-string">             Assets:BDO</span>
<span class="org-string">           "</span>)
        (<span class="org-string">"B"</span> <span class="org-string">"Book"</span> entry
         (file+datetree <span class="org-string">"~/personal/books.org"</span> <span class="org-string">"Inbox"</span>)
         <span class="org-string">"* %^{Title}  %^g</span>
<span class="org-string">           %i</span>
<span class="org-string">           *Author(s):* %^{Author} \\\\</span>
<span class="org-string">           *ISBN:* %^{ISBN}</span>

<span class="org-string">           %?</span>

<span class="org-string">           *Review on:* %^t \\</span>
<span class="org-string">           %a</span>
<span class="org-string">           %U"</span>
         <span class="org-builtin">:clock-in</span> <span class="org-builtin">:clock-resume</span>)
        (<span class="org-string">"C"</span> <span class="org-string">"Contact"</span> entry (file <span class="org-string">"~/personal/contacts.org"</span>)
         <span class="org-string">"* %(org-contacts-template-name)</span>
<span class="org-string">           :PROPERTIES:</span>
<span class="org-string">           :EMAIL: %(my/org-contacts-template-email)</span>
<span class="org-string">           :END:"</span>)))
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-M-r"</span> 'org-capture)



<span class="org-comment-delimiter">;;</span><span class="org-comment">(bind-key (kbd "&lt;f5&gt;") 'org-capture)</span>
</pre>
</div>
</div>

<ul class="org-ul">
<li><a id="org8fcbade"></a>Allow refiling in the middle(ish) of a capture<br />
<div class="outline-text-6" id="text-org8fcbade">
<p>
This lets me use <code>C-c C-r</code> to refile a capture and then jump to the
new location. I wanted to be able to file tasks under projects so that
they could inherit the QUANTIFIED property that I use to track time
(and any Beeminder-related properties too), but I also wanted to be
able to clock in on them.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-refile-and-jump</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">if</span> (derived-mode-p 'org-capture-mode)
      (org-capture-refile)
    (call-interactively 'org-refile))
  (org-refile-goto-last-stored))
(eval-after-load 'org-capture
  '(bind-key <span class="org-string">"C-c C-r"</span> 'my/org-refile-and-jump org-capture-mode-map))

</pre>
</div>
</div>
</li>
</ul>
</div>

<div id="outline-container-org05f9dd8" class="outline-5">
<h5 id="org05f9dd8">Refiling</h5>
<div class="outline-text-5" id="text-org05f9dd8">
<p>
<code>org-refile</code> lets you organize notes by typing in the headline to file them under.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-reverse-note-order nil)
(<span class="org-keyword">setq</span> org-refile-use-outline-path 'file)
(<span class="org-keyword">setq</span> org-outline-path-complete-in-steps nil)
(<span class="org-keyword">setq</span> org-refile-allow-creating-parent-nodes 'confirm)
(<span class="org-keyword">setq</span> org-refile-use-cache nil)
(<span class="org-keyword">setq</span> org-refile-targets '(((<span class="org-string">"~/orgzly/organizer.org"</span>
                             <span class="org-string">"~/code/stream/index.org.org"</span>
                             <span class="org-string">"~/code/stream/notes.org"</span>
                             <span class="org-string">"~/code/.emacs.d/Sacha.org"</span>
                             <span class="org-string">"~/orgzly/routines.org"</span>) <span class="org-warning">. (</span><span class="org-builtin"><span class="org-warning">:maxlevel</span></span><span class="org-warning"> . 5))))</span>
(<span class="org-keyword">setq</span> org-blank-before-new-entry nil)
</pre>
</div>
</div>

<ul class="org-ul">
<li><a id="orge7244b8"></a><span class="todo TEACH">TEACH</span> Jump to Org location by substring<br />
<div class="outline-text-6" id="text-orge7244b8">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">Example: (org-refile 4 nil (my/org-refile-get-location-by-substring "Other Emacs"))</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-refile-get-location-by-substring</span> (regexp <span class="org-type">&amp;optional</span> file)
  <span class="org-doc">"Return the refile location identified by REGEXP."</span>
  (<span class="org-keyword">let</span> ((org-refile-targets org-refile-targets) tbl)
    (<span class="org-keyword">setq</span> org-refile-target-table (org-refile-get-targets)))
  (<span class="org-keyword">unless</span> org-refile-target-table
    (<span class="org-warning">user-error</span> <span class="org-string">"No refile targets"</span>))
  (cl-find regexp org-refile-target-table
           <span class="org-builtin">:test</span>
           (<span class="org-keyword">lambda</span> (a b)
             (<span class="org-keyword">and</span>
              (string-match a (car b))
              (<span class="org-keyword">or</span> (null file)
                  (string-match file (elt b 1)))))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-refile-subtree-to</span> (name)
  (org-refile nil nil (my/org-refile-get-location-exact name)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-refile-get-location-exact</span> (name <span class="org-type">&amp;optional</span> file)
  <span class="org-doc">"Return the refile location identified by NAME."</span>
  (<span class="org-keyword">let</span> ((org-refile-targets org-refile-targets) tbl)
    (<span class="org-keyword">setq</span> org-refile-target-table (org-refile-get-targets)))
  (<span class="org-keyword">unless</span> org-refile-target-table
    (<span class="org-warning">user-error</span> <span class="org-string">"No refile targets"</span>))
  (cl-find name org-refile-target-table
           <span class="org-builtin">:test</span> (<span class="org-keyword">lambda</span> (a b)
                   (<span class="org-keyword">and</span> (string-equal a (car b))
                        (<span class="org-keyword">or</span> (null file)
                            (string-match file (elt b 1)))))))
<span class="org-comment-delimiter">;; </span><span class="org-comment">Example: (my/org-clock-in-refile "Off my computer")</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-clock-in-refile</span> (location <span class="org-type">&amp;optional</span> file)
  <span class="org-doc">"Clocks into LOCATION.</span>
<span class="org-doc">        LOCATION and FILE can also be regular expressions for `</span><span class="org-doc"><span class="org-constant">my/org-refile-get-location-by-substring</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">interactive</span> (list (my/org-refile-get-location)))
  (<span class="org-keyword">save-window-excursion</span>
    (<span class="org-keyword">save-excursion</span>
      (<span class="org-keyword">if</span> (stringp location) (<span class="org-keyword">setq</span> location (my/org-refile-get-location-by-substring location file)))
      (org-refile 4 nil location)
      (org-clock-in))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-finish-previous-task-and-clock-in-new-one</span> (location <span class="org-type">&amp;optional</span> file)
  (<span class="org-keyword">interactive</span> (list (my/org-refile-get-location)))
  (<span class="org-keyword">save-window-excursion</span>
    (org-clock-goto)
    (org-todo 'done))
  (my/org-clock-in-and-track-by-name location file))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-clock-in-and-track-by-name</span> (location <span class="org-type">&amp;optional</span> file)
  (<span class="org-keyword">interactive</span> (list (my/org-refile-get-location)))
  (<span class="org-keyword">save-window-excursion</span>
    (<span class="org-keyword">save-excursion</span>
      (<span class="org-keyword">if</span> (stringp location) (<span class="org-keyword">setq</span> location (my/org-refile-get-location-exact location file)))
      (org-refile 4 nil location)
      (my/org-clock-in-and-track))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-off-my-computer</span> (category)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MCategory: "</span>)
  (<span class="org-keyword">eval-when-compile</span> (<span class="org-keyword">require</span> '<span class="org-constant">quantified</span> nil t))
  (my/org-clock-in-refile <span class="org-string">"Off my computer"</span>)
  (quantified-track category))
</pre>
</div>
</div>
</li>

<li><a id="orgd0f16e5"></a>Quick way to jump<br />
<div class="outline-text-6" id="text-orgd0f16e5">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-jump</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((current-prefix-arg '(4)))
    (call-interactively 'org-refile)))
</pre>
</div>
</div>
</li>
</ul>
</div>


<div id="outline-container-org326c4d9" class="outline-5">
<h5 id="org326c4d9"><span class="todo TODO">TODO</span> Bounce to another file&#xa0;&#xa0;&#xa0;<span class="tag"><span class="computer">computer</span>&#xa0;<span class="phone">phone</span></span></h5>
<div class="outline-text-5" id="text-org326c4d9">
<p>
On my phone, Emacs in Termux is nice for scripting, and Orgzly is nice
for editing long text. Let's see if this function lets me quickly
bounce things around from one place to another.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-bounce-to-file</span> (file)
  <span class="org-doc">"Toggle subtree between its home file and another file.</span>
<span class="org-doc">Limitations: Reinserts entry at bottom of subtree, uses kill ring."</span>
  (<span class="org-keyword">interactive</span> (list (read-file-name <span class="org-string">"File: "</span>)))
  (<span class="org-keyword">if</span> (string= (buffer-file-name) (expand-file-name file))
      <span class="org-comment-delimiter">;; </span><span class="org-comment">Return it</span>
      (<span class="org-keyword">let</span> ((location (org-entry-get (point) <span class="org-string">"BOUNCE"</span>)))
        (<span class="org-keyword">when</span> location
          (<span class="org-keyword">setq</span> location (read location))
          (org-cut-subtree)
          (save-buffer)
          (<span class="org-keyword">with-current-buffer</span> (find-file (car location))
            (<span class="org-keyword">save-restriction</span>
              (widen)
              (goto-char (org-find-olp location))
              (org-end-of-subtree)
              (<span class="org-keyword">unless</span> (bolp) (insert <span class="org-string">"\n"</span>))
              (org-paste-subtree (length location) nil nil t)
              (save-buffer)))))
    (org-entry-put (point) <span class="org-string">"BOUNCE"</span> (prin1-to-string (cons (buffer-file-name) (org-get-outline-path))))
    (org-cut-subtree)
    (save-buffer)
    (<span class="org-keyword">with-current-buffer</span> (find-file file)
      (<span class="org-keyword">save-restriction</span>
        (widen)
        (goto-char (point-max))
        (<span class="org-keyword">unless</span> (bolp) (insert <span class="org-string">"\n"</span>))
        (org-yank)
        (save-buffer)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org166defa" class="outline-5">
<h5 id="org166defa">Estimating WPM</h5>
<div class="outline-text-5" id="text-org166defa">
<p>
I'm curious about how fast I type some things.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">require</span> '<span class="org-constant">org-clock</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-entry-wpm</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-restriction</span>
    (<span class="org-keyword">save-excursion</span>
      (org-narrow-to-subtree)
      (goto-char (point-min))
      (<span class="org-keyword">let*</span> ((words (count-words-region (point-min) (point-max)))
             (minutes (org-clock-sum-current-item))
             (wpm (/ words minutes)))
        (message <span class="org-string">"WPM: %d (words: %d, minutes: %d)"</span> wpm words minutes)
        (kill-new (number-to-string wpm))))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7997d88" class="outline-4">
<h4 id="org7997d88">Tasks</h4>
<div class="outline-text-4" id="text-org7997d88">
</div>
<div id="outline-container-org21bfe07" class="outline-5">
<h5 id="org21bfe07">Managing tasks</h5>
<div class="outline-text-5" id="text-org21bfe07">
</div>
<ul class="org-ul">
<li><a id="todo-keywords"></a>Track TODO state<br />
<div class="outline-text-6" id="text-todo-keywords">
<p>
<a id="orgf1bc449"></a>
</p>

<p>
The parentheses indicate keyboard shortcuts that I can use to set the
task state. <code>@</code> and <code>!</code> toggle logging. <code>@</code> prompts you for a note,
and <code>!</code> automatically logs the timestamp of the state change.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-todo-keywords
      '((sequence
         <span class="org-string">"STARTED(s)"</span>
         <span class="org-string">"TODO(t)"</span>  <span class="org-comment-delimiter">; </span><span class="org-comment">next action</span>
         <span class="org-string">"TOBLOG(b)"</span>  <span class="org-comment-delimiter">; </span><span class="org-comment">next action</span>
         <span class="org-string">"WAITING(w@/!)"</span>
         <span class="org-string">"SOMEDAY(.)"</span> <span class="org-string">"|"</span> <span class="org-string">"DONE(x!)"</span> <span class="org-string">"CANCELLED(c)"</span>)
        (sequence <span class="org-string">"PROJECT"</span> <span class="org-string">"|"</span> <span class="org-string">"DONE(x)"</span>)
        (sequence <span class="org-string">"LEARN"</span> <span class="org-string">"TRY"</span> <span class="org-string">"TEACH"</span> <span class="org-string">"|"</span> <span class="org-string">"COMPLETE(x)"</span>)
        (sequence <span class="org-string">"TOSKETCH"</span> <span class="org-string">"SKETCHED"</span> <span class="org-string">"|"</span> <span class="org-string">"POSTED"</span>)
        (sequence <span class="org-string">"TOBUY"</span> <span class="org-string">"TOSHRINK"</span> <span class="org-string">"TOCUT"</span>  <span class="org-string">"TOSEW"</span> <span class="org-string">"|"</span> <span class="org-string">"DONE(x)"</span>)
        (sequence <span class="org-string">"TODELEGATE(-)"</span> <span class="org-string">"DELEGATED(d)"</span> <span class="org-string">"|"</span> <span class="org-string">"COMPLETE(x)"</span>)))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-todo-keyword-faces
      '((<span class="org-string">"TODO"</span> . (<span class="org-builtin">:foreground</span> <span class="org-string">"green"</span> <span class="org-builtin">:weight</span> bold))
        (<span class="org-string">"DONE"</span> . (<span class="org-builtin">:foreground</span> <span class="org-string">"cyan"</span> <span class="org-builtin">:weight</span> bold))
        (<span class="org-string">"WAITING"</span> . (<span class="org-builtin">:foreground</span> <span class="org-string">"red"</span> <span class="org-builtin">:weight</span> bold))
        (<span class="org-string">"SOMEDAY"</span> . (<span class="org-builtin">:foreground</span> <span class="org-string">"gray"</span> <span class="org-builtin">:weight</span> bold))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-log-done 'time)
</pre>
</div>
</div>
</li>

<li><a id="orgf53dc9a"></a>Projects<br />
<div class="outline-text-6" id="text-orgf53dc9a">
<p>
Projects are headings with the <code>:project:</code> tag, so we generally don't
want that tag inherited, except when we display unscheduled tasks that
don't belong to any projects.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-tags-exclude-from-inheritance '(<span class="org-string">"project"</span>))
</pre>
</div>

<p>
This code makes it easy for me to focus on one project and its tasks.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">org</span>
  <span class="org-builtin">:config</span>
  (add-to-list 'org-speed-commands-user '(<span class="org-string">"N"</span> org-narrow-to-subtree))
  (add-to-list 'org-speed-commands-user '(<span class="org-string">"W"</span> widen))
  (add-to-list 'org-speed-commands-user '(<span class="org-string">"T"</span> my/org-agenda-for-subtree))
  (add-to-list 'org-speed-commands-user '(<span class="org-string">"b"</span> my/org-bounce-to-file)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-agenda-for-subtree</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">when</span> (derived-mode-p 'org-agenda-mode) (org-agenda-switch-to))
  (<span class="org-keyword">my/org-with-current-task</span>
   (<span class="org-keyword">let</span> ((org-agenda-view-columns-initially t))
     (org-agenda nil <span class="org-string">"t"</span> 'subtree))))

</pre>
</div>

<p>
There's probably a proper way to do this, maybe with <code>&lt;</code>. Oh, that would work nicely. <code>&lt; C-c a t</code> too.
</p>

<p>
And sorting:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-to-list 'org-speed-commands-user '(<span class="org-string">"S"</span> call-interactively 'org-sort))
</pre>
</div>
</div>
</li>

<li><a id="org0c04bd2"></a>Tag tasks with GTD-ish contexts<br />
<div class="outline-text-6" id="text-org0c04bd2">
<p>
This defines keyboard shortcuts for those, too.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-tag-alist '((<span class="org-string">"work"</span> . ?b)
                      (<span class="org-string">"home"</span> . ?h)
                      (<span class="org-string">"writing"</span> . ?w)
                      (<span class="org-string">"errands"</span> . ?e)
                      (<span class="org-string">"drawing"</span> . ?d)
                      (<span class="org-string">"coding"</span> . ?c)
                      (<span class="org-string">"video"</span> . ?v)
                      (<span class="org-string">"kaizen"</span> . ?k)
                      (<span class="org-string">"phone"</span> . ?p)
                      (<span class="org-string">"learning"</span> . ?a)
                      (<span class="org-string">"reading"</span> . ?r)
                      (<span class="org-string">"computer"</span> . ?l)
                      (<span class="org-string">"quantified"</span> . ?q)
                      (<span class="org-string">"shopping"</span> .?s)
                      (<span class="org-string">"focus"</span> . ?f)))
</pre>
</div>
</div>
</li>

<li><a id="orgd1f91a7"></a>Enable filtering by effort estimates<br />
<div class="outline-text-6" id="text-orgd1f91a7">
<p>
That way, it's easy to see short tasks that I can finish.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-to-list 'org-global-properties
             '(<span class="org-string">"Effort_ALL"</span>. <span class="org-string">"0:05 0:15 0:30 1:00 2:00 3:00 4:00"</span>))
</pre>
</div>
</div>
</li>

<li><a id="org9d895d1"></a>Track time<br />
<div class="outline-text-6" id="text-org9d895d1">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">org</span>
  <span class="org-builtin">:init</span>
  (<span class="org-keyword">progn</span>
    (<span class="org-keyword">setq</span> org-expiry-inactive-timestamps t)
    (<span class="org-keyword">setq</span> org-clock-idle-time nil)
    (<span class="org-keyword">setq</span> org-log-done 'time)
    (<span class="org-keyword">setq</span> org-clock-auto-clock-resolution nil)
    (<span class="org-keyword">setq</span> org-clock-continuously nil)
    (<span class="org-keyword">setq</span> org-clock-persist t)
    (<span class="org-keyword">setq</span> org-clock-in-switch-to-state <span class="org-string">"STARTED"</span>)
    (<span class="org-keyword">setq</span> org-clock-in-resume nil)
    (<span class="org-keyword">setq</span> org-show-notification-handler 'message)
    (<span class="org-keyword">setq</span> org-clock-report-include-clocking-task t))
  <span class="org-builtin">:config</span>
  (org-clock-persistence-insinuate))
</pre>
</div>

<p>
Too many clock entries clutter up a heading.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-log-into-drawer <span class="org-string">"LOGBOOK"</span>)
(<span class="org-keyword">setq</span> org-clock-into-drawer 1)
</pre>
</div>
</div>
</li>

<li><a id="org55150ec"></a>Habits<br />
<div class="outline-text-6" id="text-org55150ec">
<p>
I like using org-habits to track consistency. My task names tend
to be a bit long, though, so I've configured the graph column to
show a little bit more to the right.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-habit-graph-column 80)
(<span class="org-keyword">setq</span> org-habit-show-habits-only-for-today nil)
</pre>
</div>

<p>
If you want to use habits, be sure to schedule your tasks and add a STYLE property with the value of <code>habit</code> to the tasks you want displayed.
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-subset" class="outline-5">
<h5 id="subset">Estimating tasks</h5>
<div class="outline-text-5" id="text-subset">
<p>
From "Add an effort estimate on the fly when clocking in" on the
<a href="http://orgmode.org/worg/org-hacks.html">Org Hacks</a> page:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-hook 'org-clock-in-prepare-hook
          'my/org-mode-ask-effort)

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-mode-ask-effort</span> ()
  <span class="org-doc">"Ask for an effort estimate when clocking in."</span>
  (<span class="org-keyword">unless</span> (org-entry-get (point) <span class="org-string">"Effort"</span>)
    (<span class="org-keyword">let</span> ((effort
           (completing-read
            <span class="org-string">"Effort: "</span>
            (org-entry-get-multivalued-property (point) <span class="org-string">"Effort"</span>))))
      (<span class="org-keyword">unless</span> (equal effort <span class="org-string">""</span>)
        (org-set-property <span class="org-string">"Effort"</span> effort)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-org876c652" class="outline-5">
<h5 id="org876c652">Flexible scheduling of tasks</h5>
<div class="outline-text-5" id="text-org876c652">
<p>
I (theoretically) want to be able to schedule tasks for dates like the first Saturday
of every month. Fortunately, <a href="http://stackoverflow.com/questions/13555385/org-mode-how-to-schedule-repeating-tasks-for-the-first-saturday-of-every-month">someone else has figured that out!</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">Get this from https://raw.github.com/chenfengyuan/elisp/master/next-spec-day.el</span>
(load <span class="org-string">"~/elisp/next-spec-day.el"</span> t)
</pre>
</div>
</div>
</div>

<div id="outline-container-org5313727" class="outline-5">
<h5 id="org5313727">Task dependencies</h5>
<div class="outline-text-5" id="text-org5313727">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-enforce-todo-dependencies t)
(<span class="org-keyword">setq</span> org-track-ordered-property-with-tag t)
(<span class="org-keyword">setq</span> org-agenda-dim-blocked-tasks t)
</pre>
</div>
</div>
</div>

<div id="outline-container-orge1d5d7c" class="outline-5">
<h5 id="orge1d5d7c">Quick way to archive all DONE from inbox&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="computer">computer</span></span></h5>
<div class="outline-text-5" id="text-orge1d5d7c">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-clean-up-inbox</span> ()
  <span class="org-doc">"Archive all DONE tasks and sort the remainder by TODO order."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">with-current-buffer</span> (find-file my/org-inbox-file)
    (my/org-archive-done-tasks 'file)
    (goto-char (point-min))
    (<span class="org-keyword">if</span> (org-at-heading-p) (<span class="org-keyword">save-excursion</span> (insert <span class="org-string">"\n"</span>)))
    (org-sort-entries nil ?p)
    (goto-char (point-min))
    (org-sort-entries nil ?o)
    (save-buffer)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-archive-done-tasks</span> (<span class="org-type">&amp;optional</span> scope)
  <span class="org-doc">"Archive finished or cancelled tasks.</span>
<span class="org-doc">       SCOPE can be 'file or 'tree."</span>
  (<span class="org-keyword">interactive</span>)
  (org-map-entries
   (<span class="org-keyword">lambda</span> ()
     (org-archive-subtree)
     (<span class="org-keyword">setq</span> org-map-continue-from (outline-previous-heading)))
   <span class="org-string">"TODO=\"DONE\"|TODO=\"CANCELLED\""</span> (<span class="org-keyword">or</span> scope (<span class="org-keyword">if</span> (org-before-first-heading-p) 'file 'tree))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgac10a4a" class="outline-4">
<h4 id="orgac10a4a">Templates</h4>
<div class="outline-text-4" id="text-orgac10a4a">
</div>
<div id="outline-container-org7e83dad" class="outline-5">
<h5 id="org7e83dad">Structure templates</h5>
<div class="outline-text-5" id="text-org7e83dad">
<p>
Org makes it easy to insert blocks by typing <code>&lt;s[TAB]</code>, etc.
I hardly ever use LaTeX, but I insert a lot of Emacs Lisp blocks, so I
redefine <code>&lt;l</code> to insert a Lisp block instead.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-structure-template-alist
      '((<span class="org-string">"a"</span> . <span class="org-string">"export ascii"</span>)
        (<span class="org-string">"c"</span> . <span class="org-string">"center"</span>)
        (<span class="org-string">"C"</span> . <span class="org-string">"comment"</span>)
        (<span class="org-string">"e"</span> . <span class="org-string">"example"</span>)
        (<span class="org-string">"E"</span> . <span class="org-string">"export"</span>)
        (<span class="org-string">"m"</span> . <span class="org-string">"export md"</span>)
        (<span class="org-string">"h"</span> . <span class="org-string">"export html"</span>)
        (<span class="org-string">"l"</span> . <span class="org-string">"src emacs-lisp"</span>)
        (<span class="org-string">"p"</span> . <span class="org-string">"src python"</span>)
        (<span class="org-string">"q"</span> . <span class="org-string">"quote"</span>)
        (<span class="org-string">"s"</span> . <span class="org-string">"src"</span>)
        (<span class="org-string">"v"</span> . <span class="org-string">"verse"</span>)))
</pre>
</div>

<p>
This lets me nest quotes. <a href="http://emacs.stackexchange.com/questions/2404/exporting-org-mode-nested-blocks-to-html">http://emacs.stackexchange.com/questions/2404/exporting-org-mode-nested-blocks-to-html</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-html-quote2</span> (<span class="org-keyword">block</span> backend info)
  (<span class="org-keyword">when</span> (org-export-derived-backend-p backend 'html)
    (<span class="org-keyword">when</span> (string-match <span class="org-string">"\\`&lt;div class=\"quote2\"&gt;"</span> block)
      (<span class="org-keyword">setq</span> block (replace-match <span class="org-string">"&lt;blockquote&gt;"</span> t nil block))
      (string-match <span class="org-string">"&lt;/div&gt;\n\\'"</span> block)
      (<span class="org-keyword">setq</span> block (replace-match <span class="org-string">"&lt;/blockquote&gt;\n"</span> t nil block))
      block)))
(eval-after-load 'ox
  '(add-to-list 'org-export-filter-special-block-functions 'my/org-html-quote2))
</pre>
</div>
</div>
</div>

<div id="outline-container-org0b36541" class="outline-5">
<h5 id="org0b36541">Emacs chats, Emacs hangouts</h5>
<div class="outline-text-5" id="text-org0b36541">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-link-youtube-time</span> (url beg end)
  <span class="org-doc">"Link times of the form h:mm to YouTube video at URL.</span>
<span class="org-doc">       Works on region defined by BEG and END."</span>
  (<span class="org-keyword">interactive</span> (list (read-string <span class="org-string">"URL: "</span> (org-entry-get-with-inheritance <span class="org-string">"YOUTUBE"</span>)) (point) (mark)))
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">save-restriction</span>
      (narrow-to-region beg end)
      (goto-char (point-min))
      (<span class="org-keyword">let</span> ((char (<span class="org-keyword">if</span> (string-match <span class="org-string">"\\?"</span> url) <span class="org-string">"&amp;"</span> <span class="org-string">"?"</span>)))
        (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> ::"</span> nil t)
          (replace-match
           (format <span class="org-string">"[[%s%st=%sh%sm%ss][%s]] "</span>
                   url
                   char
                   (match-string 2)
                   (match-string 3)
                   (<span class="org-keyword">or</span> (match-string 5) <span class="org-string">"0"</span>)
                   (match-string 1)) <span class="org-warning">nil t))))))</span>

(<span class="org-keyword">defun</span> <span class="org-function-name">my/clean-up-google-hangout-chat</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;hr.*?div class=\"Kc-Ma-m\".*?&gt;"</span> nil t)
      (replace-match <span class="org-string">"\n| "</span>)))
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;/div&gt;&lt;div class=\"Kc-yi-m\"&gt;"</span> nil t)
      (replace-match <span class="org-string">" | "</span>)))
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;/div&gt;&lt;/div&gt;&lt;div class=\"Kc-ib\"&gt;"</span> nil t)
      (replace-match <span class="org-string">" | "</span>)))
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;a rel=\"nofollow\" target=\"_blank\" href=\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\"&gt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&lt;/a&gt;"</span> nil t)
      (replace-match <span class="org-string">"[[\\1][\\2]]"</span>)))
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;"</span> nil t)
      (replace-match <span class="org-string">" |"</span>)))
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&amp;nbsp;"</span> nil t)
      (replace-match <span class="org-string">" "</span>)))
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;/div&gt;&lt;div class=\"Kc-ib\"&gt;"</span> nil t)
      (replace-match <span class="org-string">" "</span>)))
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;img.*?&gt;"</span> nil t)
      (replace-match <span class="org-string">""</span>)))
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;wbr&gt;"</span> nil t)
      (replace-match <span class="org-string">""</span>)))
  )
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgfa2f592" class="outline-4">
<h4 id="orgfa2f592">Org agenda</h4>
<div class="outline-text-4" id="text-orgfa2f592">
</div>
<div id="outline-container-project_subtasks" class="outline-5">
<h5 id="project_subtasks">Basic configuration</h5>
<div class="outline-text-5" id="text-project_subtasks">
<p>
I have quite a few Org files, but I keep my agenda items and TODOs in
only a few of them them for faster scanning.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/kid-org-file</span> nil <span class="org-doc">"Defined in secrets"</span>)
(<span class="org-keyword">setq</span> org-agenda-files
      (delq nil
            (mapcar (<span class="org-keyword">lambda</span> (x) (<span class="org-keyword">and</span> x (file-exists-p x) x))
                    `(<span class="org-string">"~/orgzly/organizer.org"</span>
                      <span class="org-string">"~/orgzly/Inbox.org"</span>
                      <span class="org-string">"~/orgzly/computer-inbox.org"</span>
                      <span class="org-string">"~/code/stream/index.org"</span>
                      <span class="org-string">"~/code/stream/notes.org"</span>
                      <span class="org-string">"~/personal/sewing.org"</span>
                      <span class="org-string">"~/orgzly/people.org"</span>
                      <span class="org-string">"~/Dropbox/wsmef/trip.txt"</span>
                      ,my/kid-org-file
                      <span class="org-string">"~/personal/business.org"</span>
                      <span class="org-string">"~/personal/calendar.org"</span>
                      <span class="org-string">"~/Dropbox/tasker/summary.txt"</span>
                      <span class="org-string">"~/Dropbox/public/sharing/index.org"</span>
                      <span class="org-string">"~/dropbox/public/sharing/learning.org"</span>
                      <span class="org-string">"~/code/emacs-notes/tasks.org"</span>
                      <span class="org-string">"~/code/sachac.github.io/evil-plans/index.org"</span>
                      <span class="org-string">"~/orgzly/cooking.org"</span>
                      <span class="org-string">"~/orgzly/routines.org"</span>))))
(add-to-list 'auto-mode-alist '(<span class="org-string">"\\.txt$"</span> . org-mode))
</pre>
</div>


<p>
I like looking at two days at a time when I plan using the Org
agenda. I want to see my log entries, but I don't want to see
scheduled items that I've finished. I like seeing a time grid so that
I can get a sense of how appointments are spread out.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-agenda-span 2)
(<span class="org-keyword">setq</span> org-agenda-tags-column -100) <span class="org-comment-delimiter">; </span><span class="org-comment">take advantage of the screen width</span>
(<span class="org-keyword">setq</span> org-agenda-sticky nil)
(<span class="org-keyword">setq</span> org-agenda-inhibit-startup t)
(<span class="org-keyword">setq</span> org-agenda-use-tag-inheritance t)
(<span class="org-keyword">setq</span> org-agenda-show-log t)
(<span class="org-keyword">setq</span> org-agenda-skip-scheduled-if-done t)
(<span class="org-keyword">setq</span> org-agenda-skip-deadline-if-done t)
(<span class="org-keyword">setq</span> org-agenda-skip-deadline-prewarning-if-scheduled 'pre-scheduled)
(<span class="org-keyword">setq</span> org-agenda-time-grid
      '((daily today require-timed)
        (800 1000 1200 1400 1600 1800 2000)
        <span class="org-string">"......"</span> <span class="org-string">"----------------"</span>))
(<span class="org-keyword">setq</span> org-columns-default-format <span class="org-string">"%14SCHEDULED %Effort{:} %1PRIORITY %TODO %50ITEM %TAGS"</span>)
</pre>
</div>

<p>
Some other keyboard shortcuts:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">bind-key</span> <span class="org-string">"Y"</span> 'org-agenda-todo-yesterday org-agenda-mode-map)
</pre>
</div>
</div>
</div>
<div id="outline-container-org3129eab" class="outline-5">
<h5 id="org3129eab">Starting my weeks on Saturday</h5>
<div class="outline-text-5" id="text-org3129eab">
<p>
I like looking at weekends as <a href="http://sachachua.com/blog/2010/11/week-beginnings/">week beginnings</a> instead, so I want the
Org agenda to start on Saturdays.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-agenda-start-on-weekday 6)
</pre>
</div>
</div>
</div>

<div id="outline-container-agenda_commands" class="outline-5">
<h5 id="agenda_commands">Display projects with associated subtasks</h5>
<div class="outline-text-5" id="text-agenda_commands">
<p>
I wanted a view that showed projects with a few subtasks underneath
them. Here's a sample of the output:
</p>

<pre class="example" id="orgbc4d2c2">
     Headlines with TAGS match: +PROJECT
     Press `C-u r' to search again with new search string
       organizer:  Set up communication processes for Awesome Foundation Toronto
       organizer:  TODO Announce the next pitch night
       organizer:  TODO Follow up with the winner of the previous pitch night for any news to include in the updates

       organizer:  Tidy up the house so that I can find things quickly
       organizer:  TODO Inventory all the things in closets and boxes         :@home:
       organizer:  TODO Drop things off for donation                       :@errands:

       organizer:  Learn how to develop for Android devices
</pre>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-agenda-project-agenda</span> ()
  <span class="org-doc">"Return the project headline and up to `</span><span class="org-doc"><span class="org-constant">org-agenda-max-entries</span></span><span class="org-doc">' tasks."</span>
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">let*</span> ((marker (org-agenda-new-marker))
           (heading
            (org-agenda-format-item <span class="org-string">""</span> (org-get-heading) (org-get-category) nil))
           (org-agenda-restrict t)
           (org-agenda-restrict-begin (point))
           (org-agenda-restrict-end (org-end-of-subtree 'invisible))
           <span class="org-comment-delimiter">;; </span><span class="org-comment">Find the TODO items in this subtree</span>
           (list (org-agenda-get-day-entries (buffer-file-name) (calendar-current-date) <span class="org-builtin">:todo</span>)))
      (org-add-props heading
          (list 'face 'defaults
                'done-face 'org-agenda-done
                'undone-face 'default
                'mouse-face 'highlight
                'org-not-done-regexp org-not-done-regexp
                'org-todo-regexp org-todo-regexp
                'org-complex-heading-regexp org-complex-heading-regexp
                'help-echo
                (format <span class="org-string">"mouse-2 or RET jump to org file %s"</span>
                        (abbreviate-file-name
                         (<span class="org-keyword">or</span> (buffer-file-name (buffer-base-buffer))
                             (buffer-name (buffer-base-buffer))))))
        'org-marker marker
        'org-hd-marker marker
        'org-category (org-get-category)
        'type <span class="org-string">"tagsmatch"</span>)
      (concat heading <span class="org-string">"\n"</span>
              (org-agenda-finalize-entries list)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-agenda-projects-and-tasks</span> (match)
  <span class="org-doc">"Show TODOs for all `</span><span class="org-doc"><span class="org-constant">org-agenda-files</span></span><span class="org-doc">' headlines matching MATCH."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"MString: "</span>)
  (<span class="org-keyword">let</span> ((todo-only nil))
    (<span class="org-keyword">if</span> org-agenda-overriding-arguments
        (<span class="org-keyword">setq</span> todo-only (car org-agenda-overriding-arguments)
              match (nth 1 org-agenda-overriding-arguments)))
    (<span class="org-keyword">let*</span> ((org-tags-match-list-sublevels
            org-tags-match-list-sublevels)
           (completion-ignore-case t)
           rtn rtnall files file pos matcher
           buffer)
      (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (stringp match) (not (string-match <span class="org-string">"\\S-"</span> match)))
        (<span class="org-keyword">setq</span> match nil))
      (<span class="org-keyword">when</span> match
        (<span class="org-keyword">setq</span> matcher (org-make-tags-matcher match)
              match (car matcher) matcher (cdr matcher)))
      (<span class="org-keyword">catch</span> '<span class="org-constant">exit</span>
        (<span class="org-keyword">if</span> org-agenda-sticky
            (<span class="org-keyword">setq</span> org-agenda-buffer-name
                  (<span class="org-keyword">if</span> (stringp match)
                      (format <span class="org-string">"*Org Agenda(%s:%s)*"</span>
                              (<span class="org-keyword">or</span> org-keys (<span class="org-keyword">or</span> (<span class="org-keyword">and</span> todo-only <span class="org-string">"M"</span>) <span class="org-string">"m"</span>)) match)
                    (format <span class="org-string">"*Org Agenda(%s)*"</span> (<span class="org-keyword">or</span> (<span class="org-keyword">and</span> todo-only <span class="org-string">"M"</span>) <span class="org-string">"m"</span>)))))
        (org-agenda-prepare (concat <span class="org-string">"TAGS "</span> match))
        (org-compile-prefix-format 'tags)
        (org-set-sorting-strategy 'tags)
        (<span class="org-keyword">setq</span> org-agenda-query-string match)
        (<span class="org-keyword">setq</span> org-agenda-redo-command
              (list 'org-tags-view `(<span class="org-keyword">quote</span> ,todo-only)
                    (list 'if 'current-prefix-arg nil `(<span class="org-keyword">quote</span> ,org-agenda-query-string))))
        (<span class="org-keyword">setq</span> files (org-agenda-files nil 'ifmode)
              rtnall nil)
        (<span class="org-keyword">while</span> (<span class="org-keyword">setq</span> file (<span class="org-keyword">pop</span> files))
          (<span class="org-keyword">catch</span> '<span class="org-constant">nextfile</span>
            (org-check-agenda-file file)
            (<span class="org-keyword">setq</span> buffer (<span class="org-keyword">if</span> (file-exists-p file)
                             (org-get-agenda-file-buffer file)
                           (<span class="org-warning">error</span> <span class="org-string">"No such file %s"</span> file)))
            (<span class="org-keyword">if</span> (not buffer)
                <span class="org-comment-delimiter">;; </span><span class="org-comment">If file does not exist, error message to agenda</span>
                (<span class="org-keyword">setq</span> rtn (list
                           (format <span class="org-string">"ORG-AGENDA-ERROR: No such org-file %s"</span> file))
                      rtnall (append rtnall rtn))
              (<span class="org-keyword">with-current-buffer</span> buffer
                (<span class="org-keyword">unless</span> (derived-mode-p 'org-mode)
                  (<span class="org-warning">error</span> <span class="org-string">"Agenda file %s is not in `</span><span class="org-string"><span class="org-constant">org-mode</span></span><span class="org-string">'"</span> file))
                (<span class="org-keyword">save-excursion</span>
                  (<span class="org-keyword">save-restriction</span>
                    (<span class="org-keyword">if</span> org-agenda-restrict
                        (narrow-to-region org-agenda-restrict-begin
                                          org-agenda-restrict-end)
                      (widen))
                    (<span class="org-keyword">setq</span> rtn (org-scan-tags 'my/org-agenda-project-agenda matcher todo-only))
                    (<span class="org-keyword">setq</span> rtnall (append rtnall rtn))))))))
        (<span class="org-keyword">if</span> org-agenda-overriding-header
            (insert (org-add-props (copy-sequence org-agenda-overriding-header)
                        nil 'face 'org-agenda-structure) <span class="org-string"><span class="org-warning">"\n"</span></span><span class="org-warning">)</span>
          (insert <span class="org-string">"Headlines with TAGS match: "</span>)
          (add-text-properties (point-min) (1- (point))
                               (list 'face 'org-agenda-structure
                                     'short-heading
                                     (concat <span class="org-string">"Match: "</span> match)))
          (<span class="org-keyword">setq</span> pos (point))
          (insert match <span class="org-string">"\n"</span>)
          (add-text-properties pos (1- (point)) (list 'face 'org-warning))
          (<span class="org-keyword">setq</span> pos (point))
          (<span class="org-keyword">unless</span> org-agenda-multi
            (insert <span class="org-string">"Press `C-u r' to search again with new search string\n"</span>))
          (add-text-properties pos (1- (point)) (list 'face 'org-agenda-structure)))
        (org-agenda-mark-header-line (point-min))
        (<span class="org-keyword">when</span> rtnall
          (insert (mapconcat 'identity rtnall <span class="org-string">"\n"</span>) <span class="org-string">""</span>))
        (goto-char (point-min))
        (<span class="org-keyword">or</span> org-agenda-multi (org-agenda-fit-window-to-buffer))
        (add-text-properties (point-min) (point-max)
                             `(org-agenda-type tags
                                               org-last-args (,todo-only ,match)
                                               org-redo-cmd ,org-agenda-redo-command
                                               org-series-cmd ,org-cmd))
        (org-agenda-finalize)
        (<span class="org-keyword">setq</span> buffer-read-only t)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgddd660b" class="outline-5">
<h5 id="orgddd660b">Org agenda custom commands</h5>
<div class="outline-text-5" id="text-orgddd660b">
<p>
There are quite a few custom commands here, and I often forget to use
them. =) But it's good to define them, and over time, I'll get the
hang of using these more!
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Key</td>
<td class="org-left">Description</td>
</tr>

<tr>
<td class="org-left">.</td>
<td class="org-left">What am I waiting for?</td>
</tr>

<tr>
<td class="org-left">T</td>
<td class="org-left">Not really an agenda command - shows the to-do tree in the current file</td>
</tr>

<tr>
<td class="org-left">b</td>
<td class="org-left">Shows business-related tasks</td>
</tr>

<tr>
<td class="org-left">o</td>
<td class="org-left">Shows personal tasks and miscellaneous tasks (o: organizer)</td>
</tr>

<tr>
<td class="org-left">w</td>
<td class="org-left">Show all tasks for the upcoming week</td>
</tr>

<tr>
<td class="org-left">W</td>
<td class="org-left">Show all tasks for the upcoming week, aside from the routine ones</td>
</tr>

<tr>
<td class="org-left">g &#x2026;</td>
<td class="org-left">Show tasks by context: b - business; c - coding; w - writing; p - phone; d - drawing, h - home</td>
</tr>

<tr>
<td class="org-left">0</td>
<td class="org-left">Show common contexts with up to 3 tasks each, so that I can choose what I feel like working on</td>
</tr>

<tr>
<td class="org-left">) (shift-0)</td>
<td class="org-left">Show common contexts with all the tasks associated with them</td>
</tr>

<tr>
<td class="org-left">9</td>
<td class="org-left">Show common contexts with up to 3 unscheduled tasks each</td>
</tr>

<tr>
<td class="org-left">( (shift-9)</td>
<td class="org-left">Show common contexts with all the unscheduled tasks associated with them</td>
</tr>

<tr>
<td class="org-left">d</td>
<td class="org-left">Timeline for today (agenda, clock summary)</td>
</tr>

<tr>
<td class="org-left">u</td>
<td class="org-left">Unscheduled tasks to do if I have free time</td>
</tr>

<tr>
<td class="org-left">U</td>
<td class="org-left">Unscheduled tasks that are not part of projects</td>
</tr>

<tr>
<td class="org-left">P</td>
<td class="org-left">Tasks by priority</td>
</tr>

<tr>
<td class="org-left">p</td>
<td class="org-left">My projects</td>
</tr>

<tr>
<td class="org-left">2</td>
<td class="org-left">Projects with tasks</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">bind-key</span> <span class="org-string">"&lt;apps&gt; a"</span> 'org-agenda)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/org-agenda-contexts</span>
  '((tags-todo <span class="org-string">"phone"</span>)
    (tags-todo <span class="org-string">"work"</span>)
    (tags-todo <span class="org-string">"drawing"</span>)
    (tags-todo <span class="org-string">"coding"</span>)
    (tags-todo <span class="org-string">"writing"</span>)
    (tags-todo <span class="org-string">"computer"</span>)
    (tags-todo <span class="org-string">"home"</span>)
    (tags-todo <span class="org-string">"errands"</span>))
  <span class="org-doc">"Usual list of contexts."</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-agenda-skip-scheduled</span> ()
  (org-agenda-skip-entry-if 'scheduled 'deadline 'regexp <span class="org-string">"\n]+&gt;"</span>))

(<span class="org-keyword">setq</span> org-agenda-custom-commands
      `((<span class="org-string">"a"</span> <span class="org-string">"Agenda"</span>
         ((agenda <span class="org-string">""</span> ((org-agenda-span 2)))
          <span class="org-comment-delimiter">;; </span><span class="org-comment">Projects</span>
          (tags <span class="org-string">"+project-someday-TODO=\"DONE\"-TODO=\"SOMEDAY\"-inactive-evilplans"</span>
                ((org-tags-exclude-from-inheritance '(<span class="org-string">"project"</span>))
                 (org-agenda-prefix-format <span class="org-string">"  "</span>)
                 (org-agenda-overriding-header <span class="org-string">"Projects: "</span>)
                 (org-agenda-sorting-strategy '(priority-down tag-up category-keep effort-down))))
          <span class="org-comment-delimiter">;; </span><span class="org-comment">Inbox</span>
          (alltodo <span class="org-string">""</span>
                   ((org-agenda-files '(<span class="org-string">"~/orgzly/Inbox.org"</span> <span class="org-string">"~/orgzly/computer-inbox.org"</span>))
                    (org-agenda-prefix-format <span class="org-string">"%-6e "</span>)
                    (org-agenda-overriding-header <span class="org-string">"Inbox: "</span>)))
          <span class="org-comment-delimiter">;; </span><span class="org-comment">Unscheduled</span>
          (tags-todo <span class="org-string">"TODO=\"TODO\"-project-cooking-routine-errands-shopping-video-evilplans"</span> 
                     ((org-agenda-skip-function 'my/org-agenda-skip-scheduled)
                      (org-agenda-prefix-format <span class="org-string">"%-6e "</span>)
                      (org-agenda-overriding-header <span class="org-string">"Unscheduled TODO entries: "</span>)
                      (org-agenda-sorting-strategy '(priority-down effort-up tag-up category-keep))))
          ))
        (<span class="org-string">"e"</span> <span class="org-string">"Emacs"</span> (tags <span class="org-string">"emacs"</span>))
        (<span class="org-string">"i"</span> <span class="org-string">"Inbox"</span> alltodo <span class="org-string">""</span>
         ((org-agenda-files '(<span class="org-string">"~/orgzly/Inbox.org"</span> <span class="org-string">"~/orgzly/computer-inbox.org"</span>))))
        (<span class="org-string">"t"</span> tags-todo <span class="org-string">"-cooking"</span>
         ((org-agenda-sorting-strategy '(todo-state-up priority-down effort-up))))
        (<span class="org-string">"T"</span> tags-todo <span class="org-string">"TODO=\"TODO\"-goal-routine-cooking-SCHEDULED={.+}"</span> nil <span class="org-string">"~/cloud/agenda/nonroutine.html"</span>)
        (<span class="org-string">"f"</span> tags-todo <span class="org-string">"focus-TODO=\"DONE\"-TODO=\"CANCELLED\""</span>)
        (<span class="org-string">"b"</span> todo <span class="org-string">""</span>
         ((org-agenda-files '(<span class="org-string">"~/personal/business.org"</span>))))
        (<span class="org-string">"B"</span> todo <span class="org-string">""</span>
         ((org-agenda-files '(<span class="org-string">"~/Dropbox/books"</span>))))
        (<span class="org-string">"x"</span> <span class="org-string">"Column view"</span> todo <span class="org-string">""</span>  <span class="org-comment-delimiter">; </span><span class="org-comment">Column view</span>
         ((org-agenda-prefix-format <span class="org-string">""</span>)
          (org-agenda-cmp-user-defined 'my/org-sort-agenda-items-todo)
          (org-agenda-view-columns-initially t)
          ))
        <span class="org-comment-delimiter">;; </span><span class="org-comment">Weekly review</span>
        (<span class="org-string">"w"</span> <span class="org-string">"Weekly review"</span> agenda <span class="org-string">""</span>
         ((org-agenda-span 7)
          (org-agenda-log-mode 1)) <span class="org-string"><span class="org-warning">"~/cloud/agenda/this-week.html"</span></span><span class="org-warning">)</span>
        (<span class="org-string">"W"</span> <span class="org-string">"Weekly review sans routines"</span> agenda <span class="org-string">""</span>
         ((org-agenda-span 7)
          (org-agenda-log-mode 1)
          (org-agenda-tag-filter-preset '(<span class="org-string">"-routine"</span>))) <span class="org-string"><span class="org-warning">"~/cloud/agenda/this-week-nonroutine.html"</span></span><span class="org-warning">)</span>
        (<span class="org-string">"2"</span> <span class="org-string">"Bi-weekly review"</span> agenda <span class="org-string">""</span> ((org-agenda-span 14) (org-agenda-log-mode 1)))
        (<span class="org-string">"5"</span> <span class="org-string">"Quick tasks"</span> tags-todo <span class="org-string">"EFFORT&gt;=\"0:05\"&amp;EFFORT&lt;=\"0:15\""</span>)
        (<span class="org-string">"0"</span> <span class="org-string">"Unestimated tasks"</span> tags-todo <span class="org-string">"EFFORT=\"\""</span>)
        (<span class="org-string">"gb"</span> <span class="org-string">"Business"</span> todo <span class="org-string">""</span>
         ((org-agenda-files '(<span class="org-string">"~/personal/business.org"</span>))
          (org-agenda-view-columns-initially t)))
        (<span class="org-string">"gc"</span> <span class="org-string">"Coding"</span> tags-todo <span class="org-string">"@coding"</span>
         ((org-agenda-view-columns-initially t)))
        (<span class="org-string">"gw"</span> <span class="org-string">"Writing"</span> tags-todo <span class="org-string">"@writing"</span>
         ((org-agenda-view-columns-initially t)))
        (<span class="org-string">"gp"</span> <span class="org-string">"Phone"</span> tags-todo <span class="org-string">"@phone"</span>
         ((org-agenda-view-columns-initially t)))
        (<span class="org-string">"gd"</span> <span class="org-string">"Drawing"</span> tags-todo <span class="org-string">"@drawing"</span>
         ((org-agenda-view-columns-initially t)))
        (<span class="org-string">"gh"</span> <span class="org-string">"Home"</span> tags-todo <span class="org-string">"@home"</span>
         ((org-agenda-view-columns-initially t)))
        (<span class="org-string">"gk"</span> <span class="org-string">"Kaizen"</span> tags-todo <span class="org-string">"kaizen"</span>
         ((org-agenda-view-columns-initially t))
         (<span class="org-string">"~/cloud/agenda/kaizen.html"</span>))
        (<span class="org-string">"ge"</span> <span class="org-string">"Errands"</span> tags-todo <span class="org-string">"errands"</span>
         ((org-agenda-view-columns-initially t))
         (<span class="org-string">"~/cloud/agenda/errands.html"</span>))
        (<span class="org-string">"c"</span> <span class="org-string">"Top 3 by context"</span>
         ,my/org-agenda-contexts
         ((org-agenda-sorting-strategy '(priority-up effort-down))
          (org-agenda-max-entries 3)))
        (<span class="org-string">"C"</span> <span class="org-string">"All by context"</span>
         ,my/org-agenda-contexts
         ((org-agenda-sorting-strategy '(priority-down effort-down))
          (org-agenda-max-entries nil)))
        (<span class="org-string">"9"</span> <span class="org-string">"Unscheduled top 3 by context"</span>
         ,my/org-agenda-contexts
         ((org-agenda-skip-function 'my/org-agenda-skip-scheduled)
          (org-agenda-sorting-strategy '(priority-down effort-down))
          (org-agenda-max-entries 3)))
        (<span class="org-string">"("</span> <span class="org-string">"All unscheduled by context"</span>
         ,my/org-agenda-contexts
         ((org-agenda-skip-function 'my/org-agenda-skip-scheduled)
          (org-agenda-sorting-strategy '(priority-down effort-down))
          ))
        (<span class="org-string">"d"</span> <span class="org-string">"Timeline for today"</span> ((agenda <span class="org-string">""</span> ))
         ((org-agenda-ndays 1)
          (org-agenda-show-log t)
          (org-agenda-log-mode-items '(clock closed))
          (org-agenda-clockreport-mode t)
          (org-agenda-entry-types '())))
        (<span class="org-string">"."</span> <span class="org-string">"Waiting for"</span> todo <span class="org-string">"WAITING"</span>)
        (<span class="org-string">"u"</span> <span class="org-string">"Unscheduled tasks"</span> tags-todo <span class="org-string">"-someday-TODO=\"SOMEDAY\"-TODO=\"DELEGATED\"-TODO=\"WAITING\"-project-cooking-routine"</span>
         ((org-agenda-skip-function 'my/org-agenda-skip-scheduled)
          (org-agenda-view-columns-initially nil)
          (org-tags-exclude-from-inheritance '(<span class="org-string">"project"</span>))
          (org-agenda-overriding-header <span class="org-string">"Unscheduled TODO entries: "</span>)
          (org-columns-default-format <span class="org-string">"%50ITEM %TODO %3PRIORITY %Effort{:} %TAGS"</span>)
          (org-agenda-sorting-strategy '(todo-state-up priority-down effort-up tag-up category-keep))))
        (<span class="org-string">"r"</span> <span class="org-string">"Unscheduled, untagged tasks"</span> tags-todo <span class="org-string">"-someday-TODO=\"SOMEDAY\"-TODO=\"DELEGATED\"-TODO=\"WAITING\"-project-cooking-routine-evilplans-computer-writing-phone-sewing-home-errands-shopping"</span>
         ((org-agenda-skip-function 'my/org-agenda-skip-scheduled)
          (org-agenda-view-columns-initially nil)
          (org-tags-exclude-from-inheritance '(<span class="org-string">"project"</span>))
          (org-agenda-overriding-header <span class="org-string">"Unscheduled TODO entries: "</span>)
          (org-columns-default-format <span class="org-string">"%50ITEM %TODO %3PRIORITY %Effort{:} %TAGS"</span>)
          (org-agenda-sorting-strategy '(todo-state-up priority-down effort-up tag-up category-keep))))
        (<span class="org-string">"s"</span> <span class="org-string">"Someday"</span> tags-todo <span class="org-string">"TODO=\"SOMEDAY\""</span>
         ((org-agenda-skip-function 'my/org-agenda-skip-scheduled)
          (org-agenda-view-columns-initially nil)
          (org-tags-exclude-from-inheritance '(<span class="org-string">"project"</span>))
          (org-agenda-overriding-header <span class="org-string">"Someday: "</span>)
          (org-columns-default-format <span class="org-string">"%50ITEM %TODO %3PRIORITY %Effort{:} %TAGS"</span>)
          (org-agenda-sorting-strategy '(todo-state-up priority-down effort-up tag-up category-keep))))
        (<span class="org-string">"U"</span> <span class="org-string">"Unscheduled tasks outside projects"</span> tags-todo <span class="org-string">"-project-cooking-routine"</span>
         ((org-agenda-skip-function 'my/org-agenda-skip-scheduled)
          (org-tags-exclude-from-inheritance nil)
          (org-agenda-view-columns-initially nil)
          (org-agenda-overriding-header <span class="org-string">"Unscheduled TODO entries outside projects: "</span>)
          (org-agenda-sorting-strategy '(todo-state-up priority-down tag-up category-keep effort-down))))
        (<span class="org-string">"P"</span> <span class="org-string">"By priority"</span>
         ((tags-todo <span class="org-string">"+PRIORITY=\"A\""</span>)
          (tags-todo <span class="org-string">"+PRIORITY=\"B\""</span>)
          (tags-todo <span class="org-string">"+PRIORITY=\"\""</span>)
          (tags-todo <span class="org-string">"+PRIORITY=\"C\""</span>))
         ((org-agenda-prefix-format <span class="org-string">"%-10c %-10T %e "</span>)
          (org-agenda-sorting-strategy '(priority-down tag-up category-keep effort-down))))
        (<span class="org-string">"pp"</span> tags <span class="org-string">"+project-someday-TODO=\"DONE\"-TODO=\"SOMEDAY\"-inactive"</span>
         ((org-tags-exclude-from-inheritance '(<span class="org-string">"project"</span>))
          (org-agenda-sorting-strategy '(priority-down tag-up category-keep effort-down))))
        (<span class="org-string">"p."</span> tags <span class="org-string">"+project-TODO=\"DONE\""</span>
         ((org-tags-exclude-from-inheritance '(<span class="org-string">"project"</span>))
          (org-agenda-sorting-strategy '(priority-down tag-up category-keep effort-down))))
        (<span class="org-string">"S"</span> tags-todo <span class="org-string">"TODO=\"STARTED\""</span>)
        (<span class="org-string">"C"</span> <span class="org-string">"Cooking"</span>
         ((tags <span class="org-string">"vegetables"</span>)
          (tags <span class="org-string">"chicken"</span>)
          (tags <span class="org-string">"beef"</span>)
          (tags <span class="org-string">"pork"</span>)
          (tags <span class="org-string">"other"</span>))
         ((org-agenda-files '(<span class="org-string">"~/orgzly/cooking.org"</span>))
          (org-agenda-view-columns-initially t)
          (org-agenda-sorting-strategy '(scheduled-up time-down todo-state-up)))
         )
        (<span class="org-string">"8"</span> <span class="org-string">"List projects with tasks"</span> my/org-agenda-projects-and-tasks
         <span class="org-string">"+PROJECT"</span>
         ((org-agenda-max-entries 3)))))

</pre>
</div>
</div>
</div>
<div id="outline-container-org70dabe4" class="outline-5">
<h5 id="org70dabe4">Making it easier to tag inbox items</h5>
<div class="outline-text-5" id="text-org70dabe4">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-complete-tags-always-offer-all-agenda-tags t)
(<span class="org-keyword">setq</span> org-use-fast-tag-selection nil)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcb90d4c" class="outline-5">
<h5 id="orgcb90d4c">Make it easy to mark a task as done</h5>
<div class="outline-text-5" id="text-orgcb90d4c">
<p>
Great for quickly going through the to-do list. Gets rid of one
extra keystroke. ;)
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-agenda-done</span> (<span class="org-type">&amp;optional</span> arg)
  <span class="org-doc">"Mark current TODO as done.</span>
<span class="org-doc">       This changes the line at point, all other lines in the agenda referring to</span>
<span class="org-doc">       the same tree node, and the headline of the tree node in the Org-mode file."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"P"</span>)
  (org-agenda-todo <span class="org-string">"DONE"</span>))
<span class="org-comment-delimiter">;; </span><span class="org-comment">Override the key definition for org-exit</span>
(define-key org-agenda-mode-map <span class="org-string">"x"</span> 'my/org-agenda-done)
</pre>
</div>
</div>
</div>

<div id="outline-container-org92807da" class="outline-5">
<h5 id="org92807da">Make it easy to mark a task as done and create a follow-up task</h5>
<div class="outline-text-5" id="text-org92807da">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-agenda-mark-done-and-add-followup</span> ()
  <span class="org-doc">"Mark the current TODO as done and add another task after it.</span>
<span class="org-doc">       Creates it at the same level as the previous task, so it's better to use</span>
<span class="org-doc">       this with to-do items than with projects or headings."</span>
  (<span class="org-keyword">interactive</span>)
  (org-agenda-todo <span class="org-string">"DONE"</span>)
  (org-agenda-switch-to)
  (org-capture 0 <span class="org-string">"t"</span>))
<span class="org-comment-delimiter">;; </span><span class="org-comment">Override the key definition</span>
(define-key org-agenda-mode-map <span class="org-string">"F"</span> 'my/org-agenda-mark-done-and-add-followup)
</pre>
</div>
</div>
</div>

<div id="outline-container-org1cfafec" class="outline-5">
<h5 id="org1cfafec">Capture something based on the agenda</h5>
<div class="outline-text-5" id="text-org1cfafec">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-agenda-new</span> ()
  <span class="org-doc">"Create a new note or task at the current agenda item.</span>
<span class="org-doc">       Creates it at the same level as the previous task, so it's better to use</span>
<span class="org-doc">       this with to-do items than with projects or headings."</span>
  (<span class="org-keyword">interactive</span>)
  (org-agenda-switch-to)
  (org-capture 0))
<span class="org-comment-delimiter">;; </span><span class="org-comment">New key assignment</span>
(define-key org-agenda-mode-map <span class="org-string">"N"</span> 'my/org-agenda-new)
</pre>
</div>
</div>
</div>

<div id="outline-container-org061eaec" class="outline-5">
<h5 id="org061eaec">Sorting by date and priority</h5>
<div class="outline-text-5" id="text-org061eaec">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-agenda-sorting-strategy
      '((agenda time-up priority-down tag-up category-keep effort-up)
        <span class="org-comment-delimiter">;; </span><span class="org-comment">(todo user-defined-up todo-state-up priority-down effort-up)</span>
        (todo todo-state-up priority-down effort-up) 
        (tags user-defined-up)
        (search category-keep)))
(<span class="org-keyword">setq</span> org-agenda-cmp-user-defined 'my/org-sort-agenda-items-user-defined)
(<span class="org-keyword">require</span> '<span class="org-constant">cl</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-get-context</span> (txt)
  <span class="org-doc">"Find the context."</span>
  (car (member-if
        (<span class="org-keyword">lambda</span> (item) (string-match <span class="org-string">"@"</span> item))
        (get-text-property 1 'tags txt))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-compare-dates</span> (a b)
  <span class="org-doc">"Return 1 if A should go after B, -1 if B should go after A, or 0 if a = b."</span>
  (<span class="org-keyword">cond</span>
   ((<span class="org-keyword">and</span> (= a 0) (= b 0)) nil)
   ((= a 0) 1)
   ((= b 0) -1)
   ((&gt; a b) 1)
   ((&lt; a b) -1)
   (t nil)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-complete-cmp</span> (a b)
  (<span class="org-keyword">let*</span> ((state-a (<span class="org-keyword">or</span> (get-text-property 1 'todo-state a) <span class="org-string">""</span>))
         (state-b (<span class="org-keyword">or</span> (get-text-property 1 'todo-state b) <span class="org-string">""</span>)))
    (<span class="org-keyword">or</span>
     (<span class="org-keyword">if</span> (member state-a org-done-keywords-for-agenda) 1)
     (<span class="org-keyword">if</span> (member state-b org-done-keywords-for-agenda) -1))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-date-cmp</span> (a b)
  (<span class="org-keyword">let*</span> ((sched-a (<span class="org-keyword">or</span> (get-text-property 1 'org-scheduled a) 0))
         (sched-b (<span class="org-keyword">or</span> (get-text-property 1 'org-scheduled b) 0))
         (deadline-a (<span class="org-keyword">or</span> (get-text-property 1 'org-deadline a) 0))
         (deadline-b (<span class="org-keyword">or</span> (get-text-property 1 'org-deadline b) 0)))
    (<span class="org-keyword">or</span>
     (my/org-compare-dates
      (my/org-min-date sched-a deadline-a)
      (my/org-min-date sched-b deadline-b)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-min-date</span> (a b)
  <span class="org-doc">"Return the smaller of A or B, except for 0."</span>
  (funcall (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (&gt; a 0) (&gt; b 0)) 'min 'max) a b))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-sort-agenda-items-user-defined</span> (a b)
  <span class="org-comment-delimiter">;; </span><span class="org-comment">compare by deadline, then scheduled date; done tasks are listed at the very bottom</span>
  (<span class="org-keyword">or</span>
   (my/org-complete-cmp a b)
   (my/org-date-cmp a b)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-context-cmp</span> (a b)
  <span class="org-doc">"Compare CONTEXT-A and CONTEXT-B."</span>
  (<span class="org-keyword">let</span> ((context-a (my/org-get-context a))
        (context-b (my/org-get-context b)))
    (<span class="org-keyword">cond</span>
     ((null context-a) +1)
     ((null context-b) -1)
     ((string&lt; context-a context-b) -1)
     ((string&lt; context-b context-a) +1)
     (t nil))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-sort-agenda-items-todo</span> (a b)
  (<span class="org-keyword">or</span>
   (org-cmp-time a b)
   (my/org-complete-cmp a b)
   (my/org-context-cmp a b)
   (my/org-date-cmp a b)
   (org-cmp-todo-state a b)
   (org-cmp-priority a b)
   (org-cmp-effort a b)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orged667fa" class="outline-5">
<h5 id="orged667fa">Preventing things from falling through the cracks</h5>
<div class="outline-text-5" id="text-orged667fa">
<p>
This helps me keep track of unscheduled tasks, because I sometimes
forget to assign tasks a date. I also want to keep track of stuck projects.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-agenda-list-unscheduled</span> (<span class="org-type">&amp;rest</span> ignore)
  <span class="org-doc">"Create agenda view for tasks that are unscheduled and not done."</span>
  (<span class="org-keyword">let*</span> ((org-agenda-todo-ignore-with-date t)
         (org-agenda-overriding-header <span class="org-string">"List of unscheduled tasks: "</span>))
    (org-agenda-get-todos)))
(<span class="org-keyword">setq</span> org-stuck-projects
      '(<span class="org-string">"+PROJECT-MAYBE-DONE"</span>
        (<span class="org-string">"TODO"</span>)
        nil
        <span class="org-string">"\\&lt;IGNORE\\&gt;"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-org7e86e98" class="outline-5">
<h5 id="org7e86e98">Synchronizing with Google Calendar</h5>
<div class="outline-text-5" id="text-org7e86e98">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-gcal-notify</span> (title mes)
  (message <span class="org-string">"%s - %s"</span> title mes))
(<span class="org-keyword">use-package</span> <span class="org-constant">org-gcal</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/elisp/org-gcal.el"</span>
  <span class="org-builtin">:init</span> (fset 'org-gcal-notify 'my/org-gcal-notify))
</pre>
</div>
</div>
</div>
<div id="outline-container-org2f037d5" class="outline-5">
<h5 id="org2f037d5">Projects</h5>
<div class="outline-text-5" id="text-org2f037d5">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-show-active-projects</span> ()
  <span class="org-doc">"Show my current projects."</span>
  (<span class="org-keyword">interactive</span>)
  (org-tags-view nil <span class="org-string">"project-inactive-someday"</span>))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org20c31c1" class="outline-4">
<h4 id="org20c31c1">Reviews</h4>
<div class="outline-text-4" id="text-org20c31c1">
</div>
<div id="outline-container-weekly-review" class="outline-5">
<h5 id="weekly-review">Weekly review</h5>
<div class="outline-text-5" id="text-weekly-review">
<p>
<a id="orga14985f"></a>
</p>

<p>
I regularly post <a href="http://sachachua.com/blog/category/weekly">weekly reviews</a> to keep track of what I'm done,
remind me to plan for the upcoming week, and list blog posts,
sketches, and links. I want to try out grouping tasks by topic first,
then breaking it down into previous/next week.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">quantified</span> <span class="org-builtin">:ensure</span> nil <span class="org-builtin">:load-path</span> <span class="org-string">"~/sync/cloud/elisp"</span> <span class="org-builtin">:unless</span> my/phone-p)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/weekly-review-line-regexp</span>
  <span class="org-string">"^  </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">:]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">: +</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">Sched[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">:]+: +</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?TODO </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">[      ]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">:[[:alnum:]_@#%:]+:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?[        ]*$"</span>
  <span class="org-doc">"Regular expression matching lines to include."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/weekly-done-line-regexp</span>
  <span class="org-string">"^  </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">:]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">: +.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">Clocked</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">Closed</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">:.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">TODO</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">DONE</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">[       ]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">:[[:alnum:]_@#%:]+:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?[        ]*$"</span>
  <span class="org-doc">"Regular expression matching lines to include as completed tasks."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my/quantified-get-hours</span> (category time-summary)
  <span class="org-doc">"Return the number of hours based on the time summary."</span>
  (<span class="org-keyword">if</span> (stringp category)
      (<span class="org-keyword">if</span> (assoc category time-summary) (/ (cdr (assoc category time-summary)) 3600.0) 0)
    (apply '+ (mapcar (<span class="org-keyword">lambda</span> (x) (my/quantified-get-hours x time-summary)) category))))

(<span class="org-keyword">defun</span> <span class="org-function-name">_my/extract-tasks-from-agenda</span> (string matchers prefix line-re)
  (<span class="org-keyword">with-temp-buffer</span>
    (insert string)
    (goto-char (point-min))
    (<span class="org-keyword">while</span> (re-search-forward line-re nil t)
      (<span class="org-keyword">let</span> ((temp-list matchers))
        (<span class="org-keyword">while</span> temp-list
          (<span class="org-keyword">if</span> (<span class="org-keyword">save-match-data</span>
                (string-match (car (car temp-list)) (match-string 1)))
              (<span class="org-keyword">progn</span>
                (add-to-list (cdr (car temp-list)) (concat prefix (match-string 3)) t)
                (<span class="org-keyword">setq</span> temp-list nil)))
          (<span class="org-keyword">setq</span> temp-list (cdr temp-list)))))))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">_my/extract-tasks-from-agenda</span> ()
  (<span class="org-keyword">let</span> (list-a list-b (line-re <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">:]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"> </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>))
    (_my/extract-tasks-from-agenda
     <span class="org-string">"listA: Task 1\nother: Task 2\nlistA: Task 3"</span>
     '((<span class="org-string">"listA"</span> . list-a)
       (<span class="org-string">"."</span> . list-b))
     <span class="org-string">"- [ ] "</span>
     line-re)
    (<span class="org-keyword">should</span> (equal list-a '(<span class="org-string">"- [ ] Task 1"</span> <span class="org-string">"- [ ] Task 3"</span>)))
    (<span class="org-keyword">should</span> (equal list-b '(<span class="org-string">"- [ ] Task 2"</span>)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">_my/get-upcoming-tasks</span> ()
  (<span class="org-keyword">save-window-excursion</span>
    (org-agenda nil <span class="org-string">"W"</span>)
    (_my/extract-tasks-from-agenda (buffer-string)
                                   '((<span class="org-string">"routines"</span> . ignore)
                                     (<span class="org-string">"business"</span> . business-next)
                                     (<span class="org-string">"people"</span> . relationships-next)
                                     (<span class="org-string">"tasks"</span> . emacs-next)
                                     (<span class="org-string">"."</span> . life-next))
                                   <span class="org-string">"  - [ ] "</span>
                                   my/weekly-review-line-regexp)))
(<span class="org-keyword">defun</span> <span class="org-function-name">_my/get-previous-tasks</span> ()
  (<span class="org-keyword">let</span> (string)
    (<span class="org-keyword">save-window-excursion</span>
      (org-agenda nil <span class="org-string">"W"</span>)
      (org-agenda-later -1)
      (org-agenda-log-mode 16)
      (<span class="org-keyword">setq</span> string (buffer-string))
      <span class="org-comment-delimiter">;; </span><span class="org-comment">Get any completed tasks from the current week as well</span>
      (org-agenda-later 1)
      (org-agenda-log-mode 16)
      (<span class="org-keyword">setq</span> string (concat string <span class="org-string">"\n"</span> (buffer-string)))
      (_my/extract-tasks-from-agenda string
                                     '((<span class="org-string">"routines"</span> . ignore)
                                       (<span class="org-string">"business"</span> . business)
                                       (<span class="org-string">"people"</span> . relationships)
                                       (<span class="org-string">"tasks"</span> . emacs)
                                       (<span class="org-string">"."</span> . life))
                                     <span class="org-string">"  - [X] "</span>
                                     my/weekly-done-line-regexp))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-summarize-focus-areas</span> (date)
  <span class="org-doc">"Summarize previous and upcoming tasks as a list."</span>
  (<span class="org-keyword">interactive</span> (list (org-read-date-analyze (<span class="org-keyword">if</span> current-prefix-arg (org-read-date) <span class="org-string">"-fri"</span>) nil '(0 0 0))))
  (<span class="org-keyword">let</span> (business relationships life business-next relationships-next life-next string emacs emacs-next
                 start end time-summary biz-time ignore base-date)
    (<span class="org-keyword">setq</span> base-date (apply 'encode-time date))
    (<span class="org-keyword">setq</span> start (format-time-string <span class="org-string">"%Y-%m-%d"</span> (days-to-time (- (time-to-number-of-days base-date) 6))))
    (<span class="org-keyword">setq</span> end (format-time-string <span class="org-string">"%Y-%m-%d"</span> (days-to-time (1+ (time-to-number-of-days base-date)))))
    (<span class="org-keyword">setq</span> time-summary (quantified-summarize-time start end))
    (<span class="org-keyword">setq</span> biz-time (my/quantified-get-hours <span class="org-string">"Business"</span> time-summary))
    (_my/get-upcoming-tasks)
    (_my/get-previous-tasks)
    (<span class="org-keyword">setq</span> string
          (concat
           (format <span class="org-string">"- *A- (Childcare)* (%.1fh - %d%% of total)\n"</span>
                   (my/quantified-get-hours '(<span class="org-string">"A-"</span>) time-summary)
                   (/ (my/quantified-get-hours '(<span class="org-string">"A-"</span>) time-summary) 1.68))
           (format <span class="org-string">"- *Business* (%.1fh - %d%%)\n"</span> biz-time (/ biz-time 1.68))
           (mapconcat 'identity business <span class="org-string">"\n"</span>) <span class="org-string">"\n"</span>
           (mapconcat 'identity business-next <span class="org-string">"\n"</span>)
           <span class="org-string">"\n"</span>
           (format <span class="org-string">"  - *Earn* (%.1fh - %d%% of Business)\n"</span>
                   (my/quantified-get-hours <span class="org-string">"Business - Earn"</span> time-summary)
                   (/ (my/quantified-get-hours <span class="org-string">"Business - Earn"</span> time-summary) (* 0.01 biz-time)))
           (format <span class="org-string">"  - *Build* (%.1fh - %d%% of Business)\n"</span>
                   (my/quantified-get-hours <span class="org-string">"Business - Build"</span> time-summary)
                   (/ (my/quantified-get-hours <span class="org-string">"Business - Build"</span> time-summary) (* 0.01 biz-time)))
           (format <span class="org-string">"  - *Connect* (%.1fh - %d%% of Business)\n"</span>
                   (my/quantified-get-hours <span class="org-string">"Business - Connect"</span> time-summary)
                   (/ (my/quantified-get-hours <span class="org-string">"Business - Connect"</span> time-summary) (* 0.01 biz-time)))
           (format <span class="org-string">"- *Relationships* (%.1fh - %d%%)\n"</span>
                   (my/quantified-get-hours '(<span class="org-string">"Discretionary - Social"</span>
                                              <span class="org-string">"Discretionary - Family"</span>) <span class="org-warning">time-summary)</span>
                   (/ (my/quantified-get-hours '(<span class="org-string">"Discretionary - Social"</span>
                                                 <span class="org-string">"Discretionary - Family"</span>) <span class="org-warning">time-summary) 1.68))</span>
           (mapconcat 'identity relationships <span class="org-string">"\n"</span>) <span class="org-string">"\n"</span>
           (mapconcat 'identity relationships-next <span class="org-string">"\n"</span>) <span class="org-string">"\n"</span>
           <span class="org-string">"\n"</span>
           (format <span class="org-string">"- *Discretionary - Productive* (%.1fh - %d%%)\n"</span>
                   (my/quantified-get-hours <span class="org-string">"Discretionary - Productive"</span> time-summary)
                   (/ (my/quantified-get-hours <span class="org-string">"Discretionary - Productive"</span> time-summary) 1.68))
           (format <span class="org-string">"  - *Drawing* (%.1fh)\n"</span>
                   (my/quantified-get-hours '(<span class="org-string">"Discretionary - Productive - Drawing"</span>)  time-summary))
           (format <span class="org-string">"  - *Emacs* (%.1fh)\n"</span>
                   (my/quantified-get-hours <span class="org-string">"Discretionary - Productive - Emacs"</span> time-summary))
           (mapconcat 'identity emacs <span class="org-string">"\n"</span>) <span class="org-string">"\n"</span>
           (mapconcat 'identity emacs-next <span class="org-string">"\n"</span>) <span class="org-string">"\n"</span>
           (format <span class="org-string">"  - *Coding* (%.1fh)\n"</span>
                   (my/quantified-get-hours <span class="org-string">"Discretionary - Productive - Coding"</span> time-summary))
           (mapconcat 'identity life <span class="org-string">"\n"</span>) <span class="org-string">"\n"</span>
           (mapconcat 'identity life-next <span class="org-string">"\n"</span>) <span class="org-string">"\n"</span>
           (format <span class="org-string">"  - *Sewing* (%.1fh)\n"</span>
                   (my/quantified-get-hours <span class="org-string">"Discretionary - Productive - Sewing"</span> time-summary))
           (format <span class="org-string">"  - *Writing* (%.1fh)\n"</span>
                   (my/quantified-get-hours <span class="org-string">"Discretionary - Productive - Writing"</span> time-summary))
           (format <span class="org-string">"- *Discretionary - Play* (%.1fh - %d%%)\n"</span>
                   (my/quantified-get-hours <span class="org-string">"Discretionary - Play"</span> time-summary)
                   (/ (my/quantified-get-hours <span class="org-string">"Discretionary - Play"</span> time-summary) 1.68))
           (format <span class="org-string">"- *Personal routines* (%.1fh - %d%%)\n"</span>
                   (my/quantified-get-hours <span class="org-string">"Personal"</span> time-summary)
                   (/ (my/quantified-get-hours <span class="org-string">"Personal"</span> time-summary) 1.68))
           (format <span class="org-string">"- *Unpaid work* (%.1fh - %d%%)\n"</span>
                   (my/quantified-get-hours <span class="org-string">"Unpaid work"</span> time-summary)
                   (/ (my/quantified-get-hours <span class="org-string">"Unpaid work"</span> time-summary) 1.68))
           (format <span class="org-string">"- *Sleep* (%.1fh - %d%% - average of %.1f per day)\n"</span>
                   (my/quantified-get-hours <span class="org-string">"Sleep"</span> time-summary)
                   (/ (my/quantified-get-hours <span class="org-string">"Sleep"</span> time-summary) 1.68)
                   (/ (my/quantified-get-hours <span class="org-string">"Sleep"</span> time-summary) 7)
                   )))
    (<span class="org-keyword">if</span> (called-interactively-p 'any)
        (insert string)
      string)))
</pre>
</div>

<p>
I use this to put together a quick summary of how I spent my time.
</p>

<p>
The following code makes it easy to add a line:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-add-line-item-task</span> (task)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MTask: "</span>)
  (org-insert-heading)
  (insert <span class="org-string">"[ ] "</span> task)
  (<span class="org-keyword">let</span> ((org-capture-entry '(<span class="org-string">"t"</span> <span class="org-string">"Tasks"</span> entry
                             (file+headline <span class="org-string">"~/sync/orgzly/organizer.org"</span> <span class="org-string">"Tasks"</span>)
                             <span class="org-string">""</span>)))
    (org-capture nil <span class="org-string">"t"</span>)
    (insert <span class="org-string">"TODO "</span> task <span class="org-string">"\nSCHEDULED: &lt;"</span> (org-read-date) <span class="org-string">"&gt;"</span>)))
                                        <span class="org-comment-delimiter">;</span><span class="org-comment">(define-key org-mode-map (kbd "C-c t") 'my/org-add-line-item-task)</span>

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-list-from-rss</span> (url from-date <span class="org-type">&amp;optional</span> to-date)
    <span class="org-doc">"Convert URL to an Org list"</span>
    (<span class="org-keyword">with-current-buffer</span> (url-retrieve-synchronously url)
      (goto-char (point-min))  
      (re-search-forward <span class="org-string">"&lt;\\?xml"</span>)
      (goto-char (match-beginning 0))
      (<span class="org-keyword">let*</span> ((feed (xml-parse-region (point) (point-max)))
            (from-time (org-read-date nil t from-date))
            (to-time (<span class="org-keyword">if</span> to-date (org-read-date nil t to-date)))
            (is-rss (&gt; (length (xml-get-children (car feed) 'entry)) 0)))
        (mapconcat (<span class="org-keyword">lambda</span> (link)
                     (format <span class="org-string">"- %s\n"</span> 
                             (org-link-make-string (car link) (cdr link))))
                   (<span class="org-keyword">if</span> is-rss
                       (mapcar
                        (<span class="org-keyword">lambda</span> (entry)
                          (cons
                           (xml-get-attribute (car
                                               (<span class="org-keyword">or</span>
                                                (seq-filter (<span class="org-keyword">lambda</span> (x) (string= (xml-get-attribute x 'rel) <span class="org-string">"alternate"</span>))
                                                            (xml-get-children entry 'link))
                                                (xml-get-children entry 'link))) <span class="org-warning">'href)</span>
                           (elt (car (xml-get-children entry 'title)) 2)))
                        (-filter (<span class="org-keyword">lambda</span> (entry)
                                   (<span class="org-keyword">let</span> ((entry-date (elt (car (xml-get-children entry 'updated)) 2)))
                                     (<span class="org-keyword">and</span>
                                      (org-string&lt;= from-date entry-date)
                                      (<span class="org-keyword">or</span> (null to-date) (string&lt; entry-date to-date)))))
                                 (xml-get-children (car feed) 'entry)))
                     (mapcar (<span class="org-keyword">lambda</span> (entry)
                               (cons
                                (caddr (car (xml-get-children entry 'link)))
                                (caddr (car (xml-get-children entry 'title)))))
                             (-filter (<span class="org-keyword">lambda</span> (entry)
                                        (<span class="org-keyword">let</span> ((entry-time (date-to-time (elt (car (xml-get-children entry 'pubDate)) 2))))
                                          (<span class="org-keyword">and</span>
                                           (not (time-less-p entry-time from-time))
                                           (<span class="org-keyword">or</span> (null to-time) (time-less-p entry-time to-time)))))
                                      (xml-get-children (car (xml-get-children (car feed) 'channel)) 'item))))
                   <span class="org-string">""</span>))))

</pre>
</div>

<p>
Now we put it all together&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-prepare-weekly-review</span> (<span class="org-type">&amp;optional</span> date skip-urls)
  <span class="org-doc">"Prepare weekly review template."</span>
  (<span class="org-keyword">interactive</span> (list (org-read-date))) 
  (<span class="org-keyword">let</span> ((base-date (apply 'encode-time (org-read-date-analyze date nil '(0 0 0))))
        start end links prev)
    (<span class="org-keyword">setq</span> start (format-time-string <span class="org-string">"%Y-%m-%d 0:00"</span> (days-to-time (- (time-to-number-of-days base-date) 6)) (current-time-zone)))
    (<span class="org-keyword">setq</span> end (format-time-string <span class="org-string">"%Y-%m-%d 0:00"</span> (days-to-time (1+ (time-to-number-of-days base-date))) (current-time-zone)))
    (<span class="org-keyword">setq</span> prev (format-time-string <span class="org-string">"%Y-%m-%d 0:00"</span> (days-to-time (- (time-to-number-of-days base-date) 7 6)) (current-time-zone)))
    (outline-next-heading)
    (insert
     <span class="org-string">"** Weekly review: Week ending "</span> (format-time-string <span class="org-string">"%B %e, %Y"</span> base-date) <span class="org-string">"  :weekly:\n"</span>
     (my/org-summarize-journal-csv start end nil my/journal-category-map my/journal-categories)
     <span class="org-string">"\n\n*Blog posts*\n\n"</span>
     (my/org-list-from-rss <span class="org-string">"https://sachachua.com/blog/feed"</span> start end)
     <span class="org-string">"\n\n*Sketches*\n\n"</span>
     (my/sketches-export-and-extract start end) <span class="org-string">"\n"</span>
     <span class="org-string">"\n\n*Time*\n\n"</span>
     (orgtbl-to-orgtbl
      (my/quantified-compare prev start start end
                             '(<span class="org-string">"A-"</span>
                               <span class="org-string">"Business"</span>
                               <span class="org-string">"Discretionary - Play"</span>
                               <span class="org-string">"Unpaid work"</span>
                               <span class="org-string">"Discretionary - Social"</span>
                               <span class="org-string">"Discretionary - Family"</span>
                               <span class="org-string">"Sleep"</span>
                               <span class="org-string">"Discretionary - Productive"</span>
                               <span class="org-string">"Personal"</span>)
                             <span class="org-string">"The other week %"</span> <span class="org-string">"Last week %"</span>)
      nil)
     <span class="org-string">"\n\n"</span>)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/prepare-missing-weekly-reviews</span> ()
  <span class="org-doc">"Prepare missing weekly reviews based on LAST_REVIEW property."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((today (substring (org-read-date nil nil <span class="org-string">"."</span>) 0 10))
        (date (org-entry-get (point) <span class="org-string">"LAST_REVIEW"</span>)))
    (<span class="org-keyword">while</span> (string&lt; date today)
      (<span class="org-keyword">setq</span> date (substring (org-read-date nil nil <span class="org-string">"++1w"</span> nil (org-time-string-to-time date)) 0 10))
      (<span class="org-keyword">unless</span> (string&lt; today date)
        (<span class="org-keyword">save-excursion</span>
          (my/org-prepare-weekly-review date))
        (org-entry-put (point) <span class="org-string">"LAST_REVIEW"</span> date)))))
</pre>
</div>
</div>

<ul class="org-ul">
<li><a id="org745f72a"></a>Flickr extract<br />
<div class="outline-text-6" id="text-org745f72a">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">_my/clean-up-flickr-list</span> (list)
  (<span class="org-keyword">setq</span> list
        (replace-regexp-in-string <span class="org-string">"\\[\""</span> <span class="org-string">"["</span> list))
  (<span class="org-keyword">setq</span> list
        (replace-regexp-in-string <span class="org-string">"&lt;a href=\"\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">\"]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">.*?&gt;.*?&lt;/a&gt;"</span>
                                  <span class="org-string">"[[\\1][\\2]]"</span> list))
  (<span class="org-keyword">setq</span> list
        (replace-regexp-in-string <span class="org-string">"\"</span>
<span class="org-string">        "</span> <span class="org-string">""</span> (replace-regexp-in-string <span class="org-string">"\"\\]"</span> <span class="org-string">"]"</span> list))))

(<span class="org-keyword">defun</span> <span class="org-function-name">_my/format-flickr-link-for-org</span> (x)
  (<span class="org-keyword">let</span> ((title (assoc-default <span class="org-string">"FileName"</span> x)))
    (format
     <span class="org-string">"- %s %s"</span>
     (org-link-make-string
      (assoc-default <span class="org-string">"URL"</span> x)
      title)
     (<span class="org-keyword">if</span> (string= (assoc-default <span class="org-string">"Description"</span> x) <span class="org-string">""</span>)
         <span class="org-string">""</span>
       (concat <span class="org-string">"- "</span>
               (replace-regexp-in-string
                <span class="org-string">"&lt;a href=\"\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\"\".*?&gt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&lt;/a&gt;"</span>
                (<span class="org-keyword">lambda</span> (string)
                  (org-link-make-string
                   (match-string 1 string)
                   (match-string 2 string)))
                (assoc-default <span class="org-string">"Description"</span> x)))))))


(<span class="org-keyword">defun</span> <span class="org-function-name">_my/parse-and-filter-flickr-csv-buffer</span> (start end)
  (sort
   (delq nil
         (mapcar (<span class="org-keyword">lambda</span> (x)
                   (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (string&lt; (assoc-default <span class="org-string">"FileName"</span> x) end)
                            (org-string&lt;= start (assoc-default <span class="org-string">"FileName"</span> x)))
                       x))
                 (csv-parse-buffer t)))
   (<span class="org-keyword">lambda</span> (a b)
     (string&lt; (assoc-default <span class="org-string">"FileName"</span> a)
              (assoc-default <span class="org-string">"FileName"</span> b)))))


(<span class="org-keyword">defun</span> <span class="org-function-name">my/sketches-export-and-extract</span> (start end <span class="org-type">&amp;optional</span> do-insert update-db filter)
  <span class="org-doc">"Create a list of links to sketches."</span>
  (<span class="org-keyword">interactive</span> (list (org-read-date) (org-read-date) t current-prefix-arg (read-string <span class="org-string">"Filter: "</span>)))
  (<span class="org-keyword">let</span> ((value
         (mapconcat
          (<span class="org-keyword">lambda</span> (filename)
            (<span class="org-keyword">let</span> ((base (file-name-nondirectory filename)))
              (format <span class="org-string">"- %s\n"</span>
                      (org-link-make-string
                       (replace-regexp-in-string <span class="org-string">"#"</span> <span class="org-string">"%23"</span>
                                                 (concat <span class="org-string">"https://sketches.sachachua.com/"</span>
                                                         (<span class="org-keyword">if</span> (string-match <span class="org-string">"^[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9][a-z]"</span> base)
                                                             (concat <span class="org-string">"id/"</span> (match-string 0 base))
                                                           (concat <span class="org-string">"filename/"</span> base))))
                       base))))
          (<span class="org-keyword">let</span> ((my/sketch-directories '(<span class="org-string">"~/sync/sketches"</span>))) (my/get-sketch-filenames-between-dates start end filter))
          <span class="org-string">""</span>)))
    (<span class="org-keyword">if</span> do-insert
        (insert value)
      value)))
</pre>
</div>
</div>
</li>

<li><a id="org3cce0b1"></a>Link-related convenience functions<br />
<div class="outline-text-6" id="text-org3cce0b1">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">kensanata/resolve-redirect</span> (url)
  <span class="org-doc">"Resolve shortened URL by launching `curl --head' and parsing the result."</span>
  (<span class="org-keyword">let*</span> ((curl (shell-command-to-string
                (format <span class="org-string">"curl --silent --head %s"</span> url)))
         (location (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (string-match <span class="org-string">"^HTTP/1</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">.1 301"</span> curl)
                              (string-match <span class="org-string">"^Location: </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> curl))
                     (match-string 1 curl))))
    (<span class="org-keyword">or</span> location url)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/resolve-urls-in-region</span> (beg end)
  <span class="org-doc">"Expand URLs between BEG and END."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">save-restriction</span>
      (narrow-to-region beg end)
      (goto-char (point-min))
      (<span class="org-keyword">while</span> (re-search-forward org-bracket-link-regexp nil t)
        (replace-match (<span class="org-keyword">save-match-data</span> (kensanata/resolve-redirect
                                         (match-string 1))) <span class="org-warning">t t nil 1))</span>
      (goto-char (point-min))
      (<span class="org-keyword">while</span> (re-search-forward org-link-re-with-space nil t)
        (replace-match (<span class="org-keyword">save-match-data</span> (kensanata/resolve-redirect
                                         (match-string 0))) <span class="org-warning">t t nil)))))</span>

(<span class="org-keyword">defun</span> <span class="org-function-name">my/open-urls-in-region</span> (beg end)
  <span class="org-doc">"Open URLs between BEG and END.</span>
<span class="org-doc">        TODO: Get better at detecting and opening all URLs"</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">save-restriction</span>
      (narrow-to-region beg end)
      (goto-char (point-min))
      (<span class="org-keyword">while</span> (re-search-forward org-any-link-re nil t)
        (<span class="org-keyword">save-excursion</span>
          (backward-char)
          (org-open-at-point))))))
</pre>
</div>
</div>
</li>
</ul>
</div>

<div id="outline-container-monthly-reviews" class="outline-5">
<h5 id="monthly-reviews">Monthly reviews</h5>
<div class="outline-text-5" id="text-monthly-reviews">
<p>
<a id="org48b1aad"></a>
</p>

<p>
I want to be able to see what I worked on in a month so that I can write my <a href="http://sachachua.com/blog/category/monthly">monthly reviews</a>. This code makes it easy to display a month's clocked tasks and time. I haven't been particularly thorough in tracking time before, but now that I have a shortcut that logs in Quantified Awesome as well as in Org, I should end up clocking more.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-review-month</span> (start-date)
  <span class="org-doc">"Review the month's clocked tasks and time."</span>
  (<span class="org-keyword">interactive</span> (list (org-read-date)))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Set to the beginning of the month</span>
  (<span class="org-keyword">setq</span> start-date (concat (substring start-date 0 8) <span class="org-string">"01"</span>))
  (<span class="org-keyword">let</span> ((org-agenda-show-log t)
        (org-agenda-start-with-log-mode t)
        (org-agenda-start-with-clockreport-mode t)
        (org-agenda-clockreport-parameter-plist '(<span class="org-builtin">:link</span> t <span class="org-builtin">:maxlevel</span> 3)))
    (org-agenda-list nil start-date 'month)))
</pre>
</div>

<p>
Here's a function like <code>my/org-prepare-weekly-review</code>:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">
(<span class="org-keyword">defun</span> <span class="org-function-name">_my/extract-posts-from-webpage</span> (url)
  (<span class="org-keyword">with-current-buffer</span> (url-retrieve-synchronously url)
    (goto-char (point-min))
    (re-search-forward <span class="org-string">"&lt;pre&gt;"</span>)
    (buffer-substring
     (point)
     (<span class="org-keyword">progn</span> (re-search-forward <span class="org-string">"&lt;/pre&gt;"</span>) (match-beginning 0)))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-get-last-week</span> ()
  <span class="org-doc">"Return dates for filtering last week."</span>
  (<span class="org-keyword">if</span> (string= (format-time-string <span class="org-string">"%u"</span>) <span class="org-string">"6"</span>) <span class="org-comment-delimiter">;; </span><span class="org-comment">my week starts on Saturday</span>
      (cons (org-read-date nil nil <span class="org-string">"-1w"</span>) (org-read-date nil nil <span class="org-string">"."</span>))
    (cons (org-read-date nil nil <span class="org-string">"-2sat"</span>) (org-read-date nil nil <span class="org-string">"-sat"</span>))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-get-month</span> (<span class="org-type">&amp;optional</span> date-string)
  <span class="org-doc">"Return start of month containing DATE and start of following month.</span>
<span class="org-doc">       Result is (START . NEXT)."</span>
  (<span class="org-keyword">let*</span> ((date (decode-time (<span class="org-keyword">if</span> (stringp date-string) (org-read-date nil t date-string) date-string)))
         (month (elt date 4))
         (year (elt date 5))
         start-date
         end-date)
    (<span class="org-keyword">calendar-increment-month</span> month year 1)
    (cons 
     (format <span class="org-string">"%4d-%02d-01"</span> (elt date 5) (elt date 4))
     (format <span class="org-string">"%4d-%02d-01"</span> year month))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-prepare-monthly-review</span> (time)
  (<span class="org-keyword">interactive</span> (list (org-read-date nil t)))
  (<span class="org-keyword">let*</span> ((date (decode-time time))
         (month (elt date 4))
         (year (elt date 5))
         title
         start-date
         end-date
         previous-date
         posts
         sketches
         org-date
         time)
    (<span class="org-keyword">calendar-increment-month</span> month year -1)
    (<span class="org-keyword">setq</span> start-date (format <span class="org-string">"%4d-%02d-01 0:00"</span> year month)
          end-date (format <span class="org-string">"%4d-%02d-01 0:00"</span> (elt date 5) (elt date 4))
          title (format-time-string <span class="org-string">"%B %Y"</span> (encode-time 0 0 0 1 month year))
          posts (_my/extract-posts-from-webpage
                 (format <span class="org-string">"https://sachachua.com/blog/%4d/%d?org=1"</span>
                         year month))
          sketches (my/sketches-export-and-extract (substring start-date 0 10) (substring end-date 0 10) nil t))
    (<span class="org-keyword">calendar-increment-month</span> month year -1)
    (<span class="org-keyword">setq</span> previous-date (format <span class="org-string">"%4d-%02d-01 0:00"</span> year month))
    (<span class="org-keyword">setq</span> time (my/quantified-compare previous-date start-date start-date end-date '(<span class="org-string">"Business"</span> <span class="org-string">"Discretionary - Play"</span> <span class="org-string">"Unpaid work"</span> <span class="org-string">"A-"</span> <span class="org-string">"Discretionary - Family"</span> <span class="org-string">"Discretionary - Social"</span> <span class="org-string">"Sleep"</span> <span class="org-string">"Discretionary - Productive"</span> <span class="org-string">"Personal"</span>) <span class="org-string">"Previous month %"</span> <span class="org-string">"This month %"</span>))
    (goto-char (line-end-position))
    (insert
     <span class="org-string">"\n\n** Monthly review: "</span>
     title
     <span class="org-string">"  :monthly:review:\n\n"</span>
     (my/org-summarize-journal-csv start-date end-date nil my/journal-category-map my/journal-categories '(zid)) <span class="org-string">"\n\n"</span>
     <span class="org-string">"*Blog posts*\n"</span>
     posts <span class="org-string">"\n\n"</span>
     <span class="org-string">"*Sketches*\n\n"</span>
     sketches
     <span class="org-string">"*Time*\n\n"</span>
     (orgtbl-to-orgtbl time nil))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgea4b41a" class="outline-4">
<h4 id="orgea4b41a">Filing</h4>
<div class="outline-text-4" id="text-orgea4b41a">
</div>
<div id="outline-container-destination" class="outline-5">
<h5 id="destination">Moving lines around</h5>
<div class="outline-text-5" id="text-destination">
<p>
This makes it easier to reorganize lines in my weekly review.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-move-line-to-destination</span> ()
  <span class="org-doc">"Moves the current list item to DESTINATION in the current buffer.</span>
<span class="org-doc">If no DESTINATION is found, move it to the end of the list</span>
<span class="org-doc">and indent it one level."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-window-excursion</span>
    (<span class="org-keyword">save-excursion</span>
      (<span class="org-keyword">let</span> ((string
             (buffer-substring-no-properties
              (line-beginning-position) (line-end-position)))
            (case-fold-search nil)
            found)
        (delete-region (line-beginning-position) (1+ (line-end-position)))
        (<span class="org-keyword">save-excursion</span>
          (goto-char (point-min))
          (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"DESTINATION"</span> nil t)
            (insert <span class="org-string">"\n"</span> (make-string (- (match-beginning 0) (line-beginning-position)) ?\ ) (s-trim string))
            (<span class="org-keyword">setq</span> found t)))
        (<span class="org-keyword">unless</span> found
          (org-end-of-item-list)
          (insert string <span class="org-string">"\n"</span>))))))

</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-move-line-to-end-of-list</span> ()
  <span class="org-doc">"Move the current list item to the end of the list."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">let</span> ((string (buffer-substring-no-properties (line-beginning-position)
                                                  (line-end-position))))
      (delete-region (line-beginning-position) (1+ (line-end-position)))
      (org-end-of-item-list)
      (insert string))))

</pre>
</div>
</div>
</div>

<div id="outline-container-org593b3ab" class="outline-5">
<h5 id="org593b3ab">Organizing my blog index</h5>
<div class="outline-text-5" id="text-org593b3ab">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-file-blog-index-entries</span> ()
  <span class="org-doc">"Keep filing until I press `</span><span class="org-doc"><span class="org-constant">C-g</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">while</span> t
    (my/org-file-blog-index-entry
     (line-beginning-position) (1+ (line-end-position))
     (<span class="org-keyword">let</span> ((org-refile-targets
            '((<span class="org-string">"~/code/sharing/blog.org"</span> . (<span class="org-builtin">:maxlevel</span> . 3)))))
       (<span class="org-keyword">save-excursion</span> (org-refile-get-location <span class="org-string">"Location"</span>))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-file-blog-index-entry</span> (beg end location)
  <span class="org-doc">"Copy entries into blog.org."</span>
  (<span class="org-keyword">interactive</span>
   (list
    (<span class="org-keyword">if</span> (region-active-p) (point) (line-beginning-position))
    (<span class="org-keyword">if</span> (region-active-p) (mark) (1+ (line-end-position)))
    (<span class="org-keyword">let</span> ((org-refile-targets
           '((<span class="org-string">"~/code/sharing/blog.org"</span> . (<span class="org-builtin">:maxlevel</span> . 3)))))
      (<span class="org-keyword">save-excursion</span> (org-refile-get-location <span class="org-string">"Location"</span>)))))
  (<span class="org-keyword">let</span> ((s
         (replace-regexp-in-string
          <span class="org-string">"^[ \t]*- </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\[</span><span class="org-string"><span class="org-constant">X\\</span></span><span class="org-string">] </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?"</span>
          <span class="org-string">"- [X] "</span>
          (buffer-substring-no-properties beg end))))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">if we're already in blog.org, delete the previous entry</span>
    (<span class="org-keyword">if</span> (string= buffer-file-name (expand-file-name <span class="org-string">"~/code/sharing/blog.org"</span>))
        (delete-region beg end))
    (<span class="org-keyword">save-window-excursion</span>
      (<span class="org-keyword">save-excursion</span>
        (find-file (nth 1 location))
        (<span class="org-keyword">save-excursion</span>
          (<span class="org-keyword">save-restriction</span>
            (widen)
            (goto-char (nth 3 location))
            (re-search-forward org-list-full-item-re nil t)
            (goto-char (line-beginning-position))
            (insert s)
            (org-update-statistics-cookies nil)))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org2ae0801" class="outline-5">
<h5 id="org2ae0801">Quickly refiling Org Mode notes to headings in the same file</h5>
<div class="outline-text-5" id="text-org2ae0801">
<p>
I wanted a quick way to organize random notes from my inbox into an
outline, organizing from the bottom up instead of starting with a
top-down hierarchy. My old code for refiling to an Org heading in the
current buffer didn't work any more, but <code>helm-org-in-buffer-headings</code>
seems to be promising. I made it a speed command (see the value of
<code>org-use-speed-commands</code> elsewhere in my config) so that I can easily
refile. 
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/org-last-refile-marker</span> nil <span class="org-doc">"Marker for last refile"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-refile-in-file</span> (<span class="org-type">&amp;optional</span> prefix)
  <span class="org-doc">"Refile to a target within the current file."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((helm-org-headings-actions
         '((<span class="org-string">"Refile to this heading"</span> . helm-org-heading-refile))))
    (<span class="org-keyword">save-excursion</span>
      (helm-org-in-buffer-headings)
      (org-end-of-subtree t)
      (<span class="org-keyword">setq</span> my/org-last-refile-marker (point-marker)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-refile-to-previous</span> ()
  <span class="org-doc">"Refile subtree to last position from `</span><span class="org-doc"><span class="org-constant">my/org-refile-in-file</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-selected-window</span>
    (<span class="org-keyword">when</span> (eq major-mode 'org-agenda-mode)
      (org-agenda-switch-to))
    (org-cut-subtree)
    (<span class="org-keyword">save-excursion</span>
      (<span class="org-keyword">let*</span> ((marker my/org-last-refile-marker)
             (target-level
              (<span class="org-keyword">with-current-buffer</span> (marker-buffer marker)
                (goto-char (marker-position marker))
                (org-current-level))))
        (helm-org-goto-marker marker)
        (org-end-of-subtree t t)
        (org-paste-subtree target-level)))))

(add-to-list 'org-speed-commands-user '(<span class="org-string">"w"</span> call-interactively 'org-refile))
(add-to-list 'org-speed-commands-user '(<span class="org-string">"W"</span> call-interactively 'my/org-refile-in-file))
(add-to-list 'org-speed-commands-user '(<span class="org-string">"."</span> call-interactively 'my/org-refile-to-previous))
</pre>
</div>

<p>
TODO: Figure out why I'm getting duplicates. Next step might be to fiddle with <code>helm-org-in-buffer-headings</code> so that it preselects the previous candidate, but that can happen later.
</p>

<p>
Tech note: helm-org doesn't use the usual org-refile mechanism. Instead, it
cuts the subtree, goes to the marker, and pastes it in at the
appropriate level.
</p>
</div>
</div>
</div>

<div id="outline-container-orgc04653c" class="outline-4">
<h4 id="orgc04653c">Inserting code</h4>
<div class="outline-text-4" id="text-orgc04653c">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-insert-defun</span> (<span class="org-keyword">function</span>)
  <span class="org-doc">"Inserts an Org source block with the definition for FUNCTION."</span>
  (<span class="org-keyword">interactive</span> (find-function-read))
  (<span class="org-keyword">let*</span> ((buffer-point (<span class="org-keyword">condition-case</span> nil (find-definition-noselect function nil) (<span class="org-warning">error</span> nil)))
         (new-buf (car buffer-point))
         (new-point (cdr buffer-point))
         definition)
    (<span class="org-keyword">if</span> buffer-point        
        (<span class="org-keyword">with-current-buffer</span> new-buf <span class="org-comment-delimiter">;; </span><span class="org-comment">Try to get original definition</span>
          (<span class="org-keyword">save-excursion</span>
            (goto-char new-point)
            (<span class="org-keyword">setq</span> definition (buffer-substring-no-properties (point) (<span class="org-keyword">save-excursion</span> (end-of-defun) (point))))))
      <span class="org-comment-delimiter">;; </span><span class="org-comment">Fallback: Print function definition</span>
      (<span class="org-keyword">setq</span> definition (concat (prin1-to-string (symbol-function function)) <span class="org-string">"\n"</span>)))
    (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span> definition <span class="org-string">"#+end_src\n"</span>)))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">org</span>
  <span class="org-builtin">:config</span>
  (org-indent-mode 1)
  (<span class="org-keyword">setq</span> org-indent-indentation-per-level 2)
  (<span class="org-keyword">setq</span> org-edit-src-content-indentation 0)
  (<span class="org-keyword">setq</span> org-src-preserve-indentation t))
</pre>
</div>
</div>
</div>
<div id="outline-container-org40ecb67" class="outline-4">
<h4 id="org40ecb67">Org Babel</h4>
<div class="outline-text-4" id="text-org40ecb67">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-babel-default-header-args
      '((<span class="org-builtin">:session</span> . <span class="org-string">"none"</span>)
        (<span class="org-builtin">:results</span> . <span class="org-string">"drawer replace"</span>)
        (<span class="org-builtin">:exports</span> . <span class="org-string">"code"</span>)
        (<span class="org-builtin">:cache</span> . <span class="org-string">"no"</span>)
        (<span class="org-builtin">:eval</span> . <span class="org-string">"never-export"</span>)
        (<span class="org-builtin">:hlines</span> . <span class="org-string">"no"</span>)
        (<span class="org-builtin">:tangle</span> . <span class="org-string">"no"</span>)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org9229486" class="outline-4">
<h4 id="org9229486">Publishing</h4>
<div class="outline-text-4" id="text-org9229486">
</div>
<div id="outline-container-org8a08c3a" class="outline-5">
<h5 id="org8a08c3a">Cleaning up export</h5>
<div class="outline-text-5" id="text-org8a08c3a">
<p>
Timestamps and section numbers make my published files look more
complicated than they are. Let's turn them off by default.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-export-with-section-numbers nil)
(<span class="org-keyword">setq</span> org-html-include-timestamps nil)
(<span class="org-keyword">setq</span> org-export-with-sub-superscripts nil)
(<span class="org-keyword">setq</span> org-export-with-toc nil)
(<span class="org-keyword">setq</span> org-html-toplevel-hlevel 2)
(<span class="org-keyword">setq</span> org-export-htmlize-output-type 'css)
</pre>
</div>

<p>
Sometimes I have broken or local links, and that's okay.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-export-with-broken-links t)
</pre>
</div>

<p>
Don't wrap ASCII exports.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-ascii-text-width 10000)
</pre>
</div>

<p>
This makes it easier to publish my files:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-publish-project-alist
      '((<span class="org-string">"stream"</span>
         <span class="org-builtin">:base-directory</span> <span class="org-string">"~/code/stream"</span>
         )
        (<span class="org-string">"emacs-config"</span>
         <span class="org-builtin">:base-directory</span> <span class="org-string">"~/.config/emacs"</span>
         <span class="org-builtin">:publishing-directory</span> <span class="org-string">"~/.config/emacs"</span>
         <span class="org-builtin">:publishing-function</span> my/org-html-publish-to-html-trustingly
         )
        (<span class="org-string">"book-notes"</span>
         <span class="org-builtin">:base-directory</span> <span class="org-string">"c:/sacha/Dropbox/books"</span>
         <span class="org-builtin">:publishing-directory</span> <span class="org-string">"c:/sacha/Dropbox/books/html"</span>
         <span class="org-builtin">:publishing-function</span> my/org-html-publish-to-html-trustingly
         <span class="org-builtin">:makeindex</span> t)))
<span class="org-comment-delimiter">;</span><span class="org-comment">(load "~/code/dev/emacs-chats/build-site.el" t)</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">(load "~/code/dev/emacs-notes/build-site.el" t)</span>
</pre>
</div>

<p>
If a file is in a publishing project, publish it.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-publish-maybe</span> ()
  (<span class="org-keyword">require</span> '<span class="org-constant">ox-publish</span>)
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">if</span> (org-publish-get-project-from-filename
         (buffer-file-name (buffer-base-buffer)) 'up)
        (org-publish-current-file t)
      (my/org-html-export-trustingly))))
</pre>
</div>

<p>
Make it easy to publish and browse a file.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-publish-and-browse</span> ()
  (<span class="org-keyword">interactive</span>)
  (save-buffer)
  (my/org-publish-maybe)
  (browse-url (org-export-output-file-name <span class="org-string">".html"</span> nil default-directory)))
(<span class="org-keyword">bind-key</span> <span class="org-string">"&lt;apps&gt; b"</span> 'my/org-publish-and-browse)
</pre>
</div>
</div>
</div>
<div id="outline-container-org6aadea7" class="outline-5">
<h5 id="org6aadea7">Org2blog</h5>
<div class="outline-text-5" id="text-org6aadea7">
<p>
I use org2blog to post to my blog, which is Wordpress-based. I used to
use punchagan's org2blog, but there's a completely different one in
ELPA, so I figured I'd give that a try. UPDATE 2014-10-29: Overriding
it with the Git version (see the first section of this config) so that
I can use thumbnail support for now&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">org2blog</span>
  <span class="org-builtin">:commands</span> 'org2blog/wp-post-subtree
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">progn</span>
    (<span class="org-keyword">setq</span> org2blog/wp-track-posts nil)
    (<span class="org-keyword">setq</span> org2blog/wp-use-tags-as-categories t)
    (<span class="org-keyword">defadvice</span> <span class="org-function-name">org2blog/wp-post-buffer</span> (around sacha activate)
      (<span class="org-keyword">let</span> ((org-confirm-babel-evaluate nil)
            (org-html-toplevel-hlevel 3))
        ad-do-it))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org2blog-subtree</span> ()
  <span class="org-doc">"Post to my blog and get files ready."</span>
  (<span class="org-keyword">interactive</span>)
  (org2blog/wp-post-subtree)
  (my/org-stage-image-files-in-subtree)
  (shell-command <span class="org-string">"start c:\\sacha\\dropbox\\inbox\\selection"</span>)
  (browse-url <span class="org-string">"http://sachachua.com/blog/wp-admin/edit.php?page=cal"</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org2blog-edit-post</span> ()
  <span class="org-doc">"Browse to the edit page."</span>
  (<span class="org-keyword">interactive</span>)
  (browse-url (concat <span class="org-string">"https://sachachua.com/blog/wp-admin/post.php?action=edit&amp;post="</span> (org-entry-get (point) <span class="org-string">"POSTID"</span>))))
(<span class="org-keyword">use-package</span> <span class="org-constant">htmlize</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org3ab3083" class="outline-5">
<h5 id="org3ab3083">Publish without prompting</h5>
<div class="outline-text-5" id="text-org3ab3083">
<p>
I want to be able to export without having to say yes to code blocks all the time.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-html-export-trustingly</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((org-confirm-babel-evaluate nil))
    (org-html-export-to-html)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-html-publish-to-html-trustingly</span> (plist filename pub-dir)
  (<span class="org-keyword">let</span> ((org-confirm-babel-evaluate nil))
    (org-html-publish-to-html plist filename pub-dir)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org6230f43" class="outline-5">
<h5 id="org6230f43">Stylesheet / header</h5>
<div class="outline-text-5" id="text-org6230f43">
<p>
Might as well take advantage of my stylesheet:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-html-head <span class="org-string">"&lt;link rel=\"stylesheet\" type=\"text/css\"</span>
<span class="org-string">       href=\"https://sachachua.com/blog/wp-content/themes/sacha-v3/foundation/css/foundation.min.css\"&gt;&lt;/link&gt;</span>
<span class="org-string">       &lt;link rel=\"stylesheet\" type=\"text/css\" href=\"https://sachachua.com/org-export.css\"&gt;&lt;/link&gt;</span>
<span class="org-string">       &lt;link rel=\"stylesheet\" type=\"text/css\" href=\"https://sachachua.com/blog/wp-content/themes/sacha-v3/style.css\"&gt;&lt;/link&gt;</span>
<span class="org-string">       &lt;script src=\"https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js\"&gt;&lt;/script&gt;</span>
<span class="org-string">       &lt;script src=\"https://sachachua.com/blog/wp-content/themes/sacha-v3/misc.js\"&gt;&lt;/script&gt;"</span>)
(<span class="org-keyword">setq</span> org-html-htmlize-output-type 'css)
(<span class="org-keyword">setq</span> org-src-fontify-natively t)
</pre>
</div>
</div>
</div>

<div id="outline-container-org186f6a2" class="outline-5">
<h5 id="org186f6a2">Footer</h5>
<div class="outline-text-5" id="text-org186f6a2">
<p>
Make it easy to scroll to the top:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-html-preamble <span class="org-string">"&lt;a name=\"top\" id=\"top\"&gt;&lt;/a&gt;"</span>)
(<span class="org-keyword">setq</span> org-html-postamble <span class="org-string">"</span>
<span class="org-string">       &lt;style type=\"text/css\"&gt;</span>
<span class="org-string">       .back-to-top {</span>
<span class="org-string">           position: fixed;</span>
<span class="org-string">           bottom: 2em;</span>
<span class="org-string">           right: 0px;</span>
<span class="org-string">           text-decoration: none;</span>
<span class="org-string">           color: #000000;</span>
<span class="org-string">           background-color: rgba(235, 235, 235, 0.80);</span>
<span class="org-string">           font-size: 12px;</span>
<span class="org-string">           padding: 1em;</span>
<span class="org-string">           display: none;</span>
<span class="org-string">       }</span>

<span class="org-string">       .back-to-top:hover {</span>
<span class="org-string">           background-color: rgba(135, 135, 135, 0.50);</span>
<span class="org-string">       }</span>
<span class="org-string">       &lt;/style&gt;</span>

<span class="org-string">       &lt;div class=\"back-to-top\"&gt;</span>
<span class="org-string">       &lt;a href=\"#top\"&gt;Back to top&lt;/a&gt; | &lt;a href=\"mailto:sacha@sachachua.com\"&gt;E-mail me&lt;/a&gt;</span>
<span class="org-string">       &lt;/div&gt;</span>

<span class="org-string">       &lt;script type=\"text/javascript\"&gt;</span>
<span class="org-string">           var offset = 220;</span>
<span class="org-string">           var duration = 500;</span>
<span class="org-string">           jQuery(window).scroll(function() {</span>
<span class="org-string">               if (jQuery(this).scrollTop() &gt; offset) {</span>
<span class="org-string">                   jQuery('.back-to-top').fadeIn(duration);</span>
<span class="org-string">               } else {</span>
<span class="org-string">                   jQuery('.back-to-top').fadeOut(duration);</span>
<span class="org-string">               }</span>
<span class="org-string">           });</span>
<span class="org-string">       &lt;/script&gt;"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc914931" class="outline-5">
<h5 id="orgc914931">Copy region</h5>
<div class="outline-text-5" id="text-orgc914931">
<p>
Sometimes I want a region's HTML in my kill-ring/clipboard without any of the extra fluff:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-copy-region-as-html</span> (beg end <span class="org-type">&amp;optional</span> level)
  <span class="org-doc">"Make it easier to copy code for Wordpress posts and other things."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"r\np"</span>)
  (<span class="org-keyword">let</span> ((org-export-html-preamble nil)
        (org-html-toplevel-hlevel (<span class="org-keyword">or</span> level 3)))
    (kill-new
     (org-export-string-as (buffer-substring beg end) 'html t))))
</pre>
</div>

<p>
Sometimes I want a subtree:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-copy-subtree-as-html</span> ()
  (<span class="org-keyword">interactive</span>)
  (my/org-copy-region-as-html
   (org-back-to-heading)
   (org-end-of-subtree)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd6df06d" class="outline-5">
<h5 id="orgd6df06d">UTF-8 checkboxes</h5>
<div class="outline-text-5" id="text-orgd6df06d">
<p>
This snippet turns <code>- [X]</code> into ☑ and <code>- [ ]</code> into ☐, but leaves <code>[-]</code> alone.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-html-checkbox-type 'unicode)
(<span class="org-keyword">setq</span> org-html-checkbox-types
      '((unicode (on . <span class="org-string">"&lt;span class=\"task-done\"&gt;&amp;#x2611;&lt;/span&gt;"</span>)
                 (off . <span class="org-string">"&lt;span class=\"task-todo\"&gt;&amp;#x2610;&lt;/span&gt;"</span>)
                 (trans . <span class="org-string">"&lt;span class=\"task-in-progress\"&gt;[-]&lt;/span&gt;"</span>))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orge2db266" class="outline-5">
<h5 id="orge2db266">Share my Emacs configuration</h5>
<div class="outline-text-5" id="text-orge2db266">
<p>
This code gets around the fact that my config is called Sacha.org, but
I want it to export as sacha-emacs.org in my Dropbox's public
directory. Although now that I'm shifting to Github Pages, maybe I
don't need this any more&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-share-emacs</span> ()
  <span class="org-doc">"Share my Emacs configuration."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let*</span> ((destination-dir <span class="org-string">"~/Dropbox/Public/"</span>)
         (destination-filename <span class="org-string">"sacha-emacs.org"</span>))
    (my/save-new-packages)
    (<span class="org-keyword">with-current-buffer</span> (find-file <span class="org-string">"~/.config/emacs/Sacha.org"</span>)
      (<span class="org-keyword">save-restriction</span>
        (<span class="org-keyword">save-excursion</span>
          (widen)
          (write-region (point-min) (point-max)
                        (expand-file-name destination-filename destination-dir))
          (<span class="org-keyword">with-current-buffer</span> (find-file-noselect (expand-file-name
                                                    destination-filename destination-dir))
            (org-babel-tangle-file buffer-file-name
                                   (expand-file-name
                                    <span class="org-string">"sacha-emacs.el"</span> destination-dir) <span class="org-string"><span class="org-warning">"emacs-lisp"</span></span><span class="org-warning">)</span>
            (org-html-export-to-html)))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org3a467b8" class="outline-5">
<h5 id="org3a467b8">Beamer</h5>
<div class="outline-text-5" id="text-org3a467b8">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">with-eval-after-load</span> 'org
  (<span class="org-keyword">require</span> '<span class="org-constant">ox-latex</span>)
  (add-to-list 'org-latex-classes
               '(<span class="org-string">"beamer"</span>
                 <span class="org-string">"\\documentclass</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">[presentation</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">]</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{beamer</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span>
                 (<span class="org-string">"\\section</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span> . <span class="org-string">"\\section*</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span>)
                 (<span class="org-string">"\\subsection</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span> . <span class="org-string">"\\subsection*</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span>)
                 (<span class="org-string">"\\subsubsection</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span> . <span class="org-string">"\\subsubsection*</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span>)))
  (add-to-list 'org-latex-classes
               '(<span class="org-string">"memoir"</span>
                 <span class="org-string">"\\documentclass</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{memoir</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span>
                 (<span class="org-string">"\\section</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span> . <span class="org-string">"\\section*</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span>)
                 (<span class="org-string">"\\subsection</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span> . <span class="org-string">"\\subsection*</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span>)
                 (<span class="org-string">"\\subsubsection</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span> . <span class="org-string">"\\subsubsection*</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span>))))
</pre>
</div>
</div>
</div>
<div id="outline-container-org580d1c9" class="outline-5">
<h5 id="org580d1c9">PlantUML</h5>
<div class="outline-text-5" id="text-org580d1c9">
<div class="org-src-container">
<pre class="src src-emacs-lisp">     (<span class="org-keyword">setq</span> org-plantuml-jar-path (expand-file-name <span class="org-string">"/usr/share/plantuml/plantuml.jar"</span>))
(add-to-list 'org-src-lang-modes '(<span class="org-string">"plantuml"</span> . plantuml))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb964644" class="outline-5">
<h5 id="orgb964644">ox-hugo</h5>
<div class="outline-text-5" id="text-orgb964644">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">ox-hugo</span>
  <span class="org-builtin">:ensure</span> t            <span class="org-comment-delimiter">;</span><span class="org-comment">Auto-install the package from Melpa (optional)</span>
  <span class="org-builtin">:after</span> ox)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org70ab446" class="outline-4">
<h4 id="org70ab446">Org roam</h4>
<div class="outline-text-4" id="text-org70ab446">
<div class="org-src-container">
<pre class="src src-emacs-lisp">    (<span class="org-keyword">use-package</span> <span class="org-constant">org-roam</span>
      <span class="org-builtin">:if</span> my/laptop-p
      <span class="org-builtin">:ensure</span> t
      <span class="org-builtin">:hook</span>
      (after-init . org-roam-mode)
      <span class="org-builtin">:custom</span>
      (org-roam-directory <span class="org-string">"/home/sacha/sync/org-roam"</span>)
      <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> org-roam-mode-map
              ((<span class="org-string">"C-c n l"</span> . org-roam)
               (<span class="org-string">"C-c n f"</span> . org-roam-find-file)
               (<span class="org-string">"C-c n g"</span> . org-roam-graph))
              <span class="org-builtin">:map</span> org-mode-map
              ((<span class="org-string">"C-c n i"</span> . org-roam-insert))
              ((<span class="org-string">"C-c n I"</span> . org-roam-insert-immediate))))
</pre>
</div>
</div>
</div>
<div id="outline-container-org56353ea" class="outline-4">
<h4 id="org56353ea">Fix incompatible changes from Org 8 to Org 9</h4>
<div class="outline-text-4" id="text-org56353ea">
<p>
<a href="http://orgmode.org/cgit.cgi/org-mode.git/plain/etc/ORG-NEWS">http://orgmode.org/cgit.cgi/org-mode.git/plain/etc/ORG-NEWS</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">org-repair-export-blocks</span> ()
  <span class="org-doc">"Repair export blocks and INCLUDE keywords in current buffer."</span>
  (<span class="org-keyword">when</span> (eq major-mode 'org-mode)
    (<span class="org-keyword">let</span> ((case-fold-search t)
          (back-end-re (regexp-opt
                        '(<span class="org-string">"HTML"</span> <span class="org-string">"ASCII"</span> <span class="org-string">"LATEX"</span> <span class="org-string">"ODT"</span> <span class="org-string">"MARKDOWN"</span> <span class="org-string">"MD"</span> <span class="org-string">"ORG"</span>
                          <span class="org-string">"MAN"</span> <span class="org-string">"BEAMER"</span> <span class="org-string">"TEXINFO"</span> <span class="org-string">"GROFF"</span> <span class="org-string">"KOMA-LETTER"</span>)
                        t)))
      (<span class="org-keyword">org-with-wide-buffer</span>
       (goto-char (point-min))
       (<span class="org-keyword">let</span> ((block-re (concat <span class="org-string">"^[ \t]*#\\+BEGIN_"</span> back-end-re)))
         (<span class="org-keyword">save-excursion</span>
           (<span class="org-keyword">while</span> (re-search-forward block-re nil t)
             (<span class="org-keyword">let</span> ((element (<span class="org-keyword">save-match-data</span> (org-element-at-point))))
               (<span class="org-keyword">when</span> (eq (org-element-type element) 'special-block)
                 (<span class="org-keyword">save-excursion</span>
                   (goto-char (org-element-property <span class="org-builtin">:end</span> element))
                   (<span class="org-keyword">save-match-data</span> (search-backward <span class="org-string">"_"</span>))
                   (forward-char)
                   (insert <span class="org-string">"EXPORT"</span>)
                   (delete-region (point) (line-end-position)))
                 (replace-match <span class="org-string">"EXPORT \\1"</span> nil nil nil 1))))))
       (<span class="org-keyword">let</span> ((include-re
              (format <span class="org-string">"^[ \t]*#\\+INCLUDE: .*?%s[ \t]*$"</span> back-end-re)))
         (<span class="org-keyword">while</span> (re-search-forward include-re nil t)
           (<span class="org-keyword">let</span> ((element (<span class="org-keyword">save-match-data</span> (org-element-at-point))))
             (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (eq (org-element-type element) 'keyword)
                        (string= (org-element-property <span class="org-builtin">:key</span> element) <span class="org-string">"INCLUDE"</span>))
               (replace-match <span class="org-string">"EXPORT \\1"</span> nil nil nil 1)))))))))
(<span class="org-keyword">with-eval-after-load</span> 'org
  (add-to-list 'org-mode-hook 'org-repair-export-blocks))
</pre>
</div>
</div>
</div>

<div id="outline-container-org17dc98c" class="outline-4">
<h4 id="org17dc98c">Links</h4>
<div class="outline-text-4" id="text-org17dc98c">
</div>
<div id="outline-container-org28afa70" class="outline-5">
<h5 id="org28afa70">Quick links</h5>
<div class="outline-text-5" id="text-org28afa70">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-link-abbrev-alist
      '((<span class="org-string">"google"</span> . <span class="org-string">"http://www.google.com/search?q="</span>)
        (<span class="org-string">"gmap"</span> . <span class="org-string">"http://maps.google.com/maps?q=%s"</span>)
        (<span class="org-string">"blog"</span> . <span class="org-string">"http://sachachua.com/blog/p/"</span>)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orga2ad39d" class="outline-5">
<h5 id="orga2ad39d">Custom links</h5>
<div class="outline-text-5" id="text-orga2ad39d">
<p>
From <a href="http://endlessparentheses.com/use-org-mode-links-for-absolutely-anything.html?source=rss">http://endlessparentheses.com/use-org-mode-links-for-absolutely-anything.html?source=rss</a>
</p>

<blockquote>
<p>
(org-add-link-type
"tag" 'endless/follow-tag-link)
</p>

<p>
(defun endless/follow-tag-link (tag)
"Display a list of TODO headlines with tag TAG.
With prefix argument, also display headlines without a TODO keyword."
(org-tags-view (null current-prefix-arg) tag))
</p>
</blockquote>

<p>
<a href="https://endlessparentheses.com/embedding-youtube-videos-with-org-mode-links.html">https://endlessparentheses.com/embedding-youtube-videos-with-org-mode-links.html</a>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">yt-iframe-format</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">You may want to change your width and height.</span>
  (concat <span class="org-string">"&lt;iframe width=\"440\""</span>
          <span class="org-string">" height=\"335\""</span>
          <span class="org-string">" src=\"https://www.youtube.com/embed/%s\""</span>
          <span class="org-string">" frameborder=\"0\""</span>
          <span class="org-string">" allowfullscreen&gt;%s&lt;/iframe&gt;"</span>))

(org-add-link-type
 <span class="org-string">"yt"</span>
 (<span class="org-keyword">lambda</span> (handle)
   (browse-url
    (concat <span class="org-string">"https://www.youtube.com/embed/"</span>
            handle)))
 (<span class="org-keyword">lambda</span> (path desc backend)
   (<span class="org-keyword">cl-case</span> backend
     (html (format yt-iframe-format
                   path (<span class="org-keyword">or</span> desc <span class="org-string">""</span>)))
     (latex (format <span class="org-string">"</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">href{%s}{%s}"</span>
                    path (<span class="org-keyword">or</span> desc <span class="org-string">"video"</span>))))))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd3e6bc5" class="outline-5">
<h5 id="orgd3e6bc5">Links from org-protocol</h5>
<div class="outline-text-5" id="text-orgd3e6bc5">
<p>
So that I can easily add links at point. Formatted as an Org list for now.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-protocol-insert-link</span> (info) 
  <span class="org-doc">"Store and insert the link at point based on INFO."</span>
  (org-protocol-store-link info)
  (<span class="org-keyword">with-current-buffer</span> (window-buffer (selected-window))
    (insert <span class="org-string">"- "</span>)
    (org-insert-last-stored-link 1)
    (insert <span class="org-string">"\n"</span>)))
(eval-after-load 'org-protocol
  '(add-to-list 'org-protocol-protocol-alist
                '(<span class="org-string">"insert-link"</span> <span class="org-builtin">:protocol</span> <span class="org-string">"insert-link"</span> <span class="org-builtin">:function</span> my/org-protocol-insert-link)))

<span class="org-comment-delimiter">;; </span><span class="org-comment">javascript:location.href = 'org-protocol://copy-thumbnail?thumbnail=' + encodeURIComponent(document.querySelector('meta[property=\"og:image\"]') ? document.querySelector('meta[property=\"og:image\"]').getAttribute('content') : '') + '&amp;title=' + encodeURIComponent(document.title) + '&amp;url=' + encodeURIComponent(location.href) + '&amp;videoId=' + ((typeof(videoId) !== 'undefined' ? videoId : (document.querySelector('meta[itemprop=\"videoId\"]') ? document.querySelector('meta[itemprop=\"videoId\"]').getAttribute('content') : '')) || '')</span>

(<span class="org-keyword">defun</span> <span class="org-function-name">my/get-youtube-info</span> (url)
  (<span class="org-keyword">with-current-buffer</span> (url-retrieve-synchronously url)
    (goto-char (point-min))
    (<span class="org-keyword">prog1</span> 
        (list
         <span class="org-builtin">:url</span>
         url
         <span class="org-builtin">:title</span>
         (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"&lt;title&gt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&lt;/title&gt;"</span> nil t)
           (match-string 1))
         <span class="org-builtin">:duration</span>
         (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"approxDurationMs\":\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\""</span> nil t)
           (my/msecs-to-timestamp (string-to-number (match-string 1)))))
      (kill-buffer))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/link-video</span> (list)
  (<span class="org-keyword">when</span> (stringp list) (<span class="org-keyword">setq</span> list (list <span class="org-builtin">:url</span> list)))
  (<span class="org-keyword">with-current-buffer</span> (url-retrieve-synchronously (concat <span class="org-string">"https://video.link/bookmarklet?url="</span> (url-encode-url (plist-get list <span class="org-builtin">:url</span>))))
    (<span class="org-keyword">save-excursion</span>
      (<span class="org-keyword">if</span> (re-search-forward <span class="org-string">"&lt;input type=\"text\" id=\"safeURL\" readonly=\"readonly\" value=\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\""</span> nil t)
          (plist-put list <span class="org-builtin">:url</span> (match-string-no-properties 1))
        (plist-put list <span class="org-builtin">:url</span> (replace-regexp-in-string <span class="org-string">"watch"</span> <span class="org-string">"watch_popup"</span> (plist-get list <span class="org-builtin">:url</span>)))))
    (<span class="org-keyword">when</span> (string= (<span class="org-keyword">or</span> (plist-get list <span class="org-builtin">:thumbnail</span>) <span class="org-string">""</span>) <span class="org-string">""</span>)
      (<span class="org-keyword">save-excursion</span>
        (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"&lt;img id=\"videoThumb\" src=\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\""</span> nil t)
          (plist-put list <span class="org-builtin">:thumbnail</span> (match-string-no-properties 1)))))
    list))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-protocol-copy-thumbnail</span> (info) 
  <span class="org-doc">"Store and insert the link at point based on INFO."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"MURL: "</span>)
  (<span class="org-keyword">when</span> (stringp info) (<span class="org-keyword">setq</span> info (list <span class="org-builtin">:url</span> info)))
  (<span class="org-keyword">when</span> (string-match <span class="org-string">"youtube\\.com"</span> (plist-get info <span class="org-builtin">:url</span>))
    (<span class="org-keyword">setq</span> info (my/link-video info)))
  (<span class="org-keyword">let</span> ((date (format-time-string <span class="org-string">"%Y-%m-%d"</span>)))
    (kill-new
     (<span class="org-keyword">if</span> (string= (plist-get info <span class="org-builtin">:videoId</span>) <span class="org-string">""</span>)
         (format <span class="org-string">"{{&lt;thumbnail image=\"%s\" title=\"%s\" link=\"%s\" date=\"%s\"&gt;}}\n"</span>
                 (plist-get info <span class="org-builtin">:thumbnail</span>)
                 (plist-get info <span class="org-builtin">:title</span>)
                 (plist-get info <span class="org-builtin">:url</span>)
                 date
                 )
       (format <span class="org-string">"{{&lt;youtube id=\"%s\" title=\"%s\" link=\"%s\" date=\"%s\"&gt;}}\n"</span>
               (plist-get info <span class="org-builtin">:videoId</span>)
               (plist-get info <span class="org-builtin">:title</span>)
               (plist-get info <span class="org-builtin">:url</span>)
               date))))
  nil)
(eval-after-load 'org-protocol
  '(add-to-list 'org-protocol-protocol-alist
                '(<span class="org-string">"copy-thumbnail"</span> <span class="org-builtin">:protocol</span> <span class="org-string">"copy-thumbnail"</span> <span class="org-builtin">:function</span> my/org-protocol-copy-thumbnail)))

</pre>
</div>
</div>
</div>


<div id="outline-container-orga70cfba" class="outline-5">
<h5 id="orga70cfba">Fix elisp links</h5>
<div class="outline-text-5" id="text-orga70cfba">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-elisp-link-export</span> (link description format)
  (<span class="org-keyword">cond</span>
   ((eq format 'html) (format <span class="org-string">"&lt;span title=\"%s\"&gt;%s&lt;/span&gt;"</span> (replace-regexp-in-string <span class="org-string">"\""</span> <span class="org-string">"&amp;quot;"</span> link) description))
   ((eq format 'text) description)
   ))
(org-link-set-parameters
 <span class="org-string">"elisp"</span>
 <span class="org-builtin">:export</span> 'my/org-elisp-link-export)
</pre>
</div>
</div>
</div>
<div id="outline-container-org-dired" class="outline-5">
<h5 id="org-dired">Dired</h5>
<div class="outline-text-5" id="text-org-dired">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-get-links-in-region</span> (beg end)
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">let</span> (results)
      (goto-char (min beg end))
      (<span class="org-keyword">while</span> (re-search-forward org-any-link-re (max beg end) t)
        (add-to-list 'results (org-element-context)))
      results)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-dired-file-links-in-region</span> (beg end)
  <span class="org-doc">"Display a Dired buffer for the file links in the selected region."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">let</span> ((files
         (-map
          (<span class="org-keyword">lambda</span> (x)
            (expand-file-name (org-link-unescape (plist-get (cadr x) <span class="org-builtin">:path</span>))))
          (-filter
           (<span class="org-keyword">lambda</span> (x)
             (string= (plist-get (cadr x) <span class="org-builtin">:type</span>) <span class="org-string">"file"</span>))
           (my/org-get-links-in-region beg end)))))
    (<span class="org-keyword">with-current-buffer</span> (get-buffer-create <span class="org-string">"*Files*"</span>)
      (<span class="org-keyword">let</span> ((inhibit-read-only t))
        (erase-buffer)
        (apply 'call-process <span class="org-string">"ls"</span> nil t nil <span class="org-string">"-lR"</span> files))
      (dired-virtual <span class="org-string">"/"</span>)
      (switch-to-buffer (current-buffer)))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc89c673" class="outline-4">
<h4 id="orgc89c673">Journal</h4>
<div class="outline-text-4" id="text-orgc89c673">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/journal-category-map</span>
  '((<span class="org-string">"Gross"</span> . <span class="org-string">"Gross motor"</span>)
    (<span class="org-string">"Fine"</span> . <span class="org-string">"Fine motor"</span>)
    (<span class="org-string">"8 - Kaizen"</span> . <span class="org-string">"Kaizen"</span>)
    (<span class="org-string">"9 - Us"</span> . <span class="org-string">"Us"</span>)
    (<span class="org-string">"Self-care"</span> . <span class="org-string">"Self-care and independence"</span>))
  <span class="org-doc">"Alist of string replacements for journal categories."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/journal-categories</span>
  '(<span class="org-string">"Kaizen"</span> <span class="org-string">"Us"</span> <span class="org-string">"Field trip"</span> <span class="org-string">"Gross motor"</span> <span class="org-string">"Fine motor"</span>
    <span class="org-string">"Sensory"</span> <span class="org-string">"Language"</span> <span class="org-string">"Music"</span> <span class="org-string">"Art"</span>
    <span class="org-string">"Self-care and independence"</span> <span class="org-string">"Eating"</span> <span class="org-string">"Sleep"</span> <span class="org-string">"Emotion"</span>
    <span class="org-string">"Household"</span> <span class="org-string">"Social"</span> <span class="org-string">"Pretend"</span> <span class="org-string">"Cognition"</span> <span class="org-string">"World"</span> <span class="org-string">"Other"</span> <span class="org-string">"Oops"</span> <span class="org-string">"Thoughts"</span> <span class="org-string">"Uncategorized"</span>)
  <span class="org-doc">"List of categories to display. </span>
<span class="org-doc">      Unknown categories will be added to the end."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-date</span> (o) (elt o 3))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-note</span> (o) (car o))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-week-highlight</span> (o) (elt o 4))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-category</span> (o) (elt o 1))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-pictures</span> (o) (<span class="org-keyword">when</span> (string&gt; (elt o 2) <span class="org-string">""</span>) (split-string (elt o 2) <span class="org-string">","</span>)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-id</span> (o) (elt o 7))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-status</span> (o) (elt o 8))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-other</span> (o) (elt o 9))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-zidstring</span> (o) (elt o 11))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-group-journal-entries</span> (filtered <span class="org-type">&amp;optional</span> category-map categories)
  (<span class="org-keyword">setq</span> category-map (<span class="org-keyword">or</span> category-map (my/journal-category-map)))
  (<span class="org-keyword">setq</span> categories (<span class="org-keyword">or</span> categories (my/journal-categories)))
  (<span class="org-keyword">let*</span> ((grouped (-group-by 'my/journal-category filtered))    
         (mapped-list
          (mapcar 
           (<span class="org-keyword">lambda</span> (o)
             (cons (<span class="org-keyword">or</span> (assoc-default (car o) category-map) (car o))
                   (cdr o)))
           grouped))
         (sorted-list
          (delq nil
                (append
                 (mapcar (<span class="org-keyword">lambda</span> (cat)
                           (<span class="org-keyword">when</span> (assoc-default cat mapped-list)
                             (cons cat (assoc-default cat mapped-list))))
                         categories)
                 (-remove (<span class="org-keyword">lambda</span> (o) (member (car o) categories)) mapped-list)))))
    sorted-list))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-date-to-string</span> (date <span class="org-type">&amp;optional</span> base-date)
  <span class="org-doc">"Return the Org date specified by DATE.</span>
<span class="org-doc">      This is relative to BASE-DATE if specified."</span>
  (org-read-date nil nil date nil (<span class="org-keyword">when</span> base-date (org-read-date nil t base-date))))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my/org-date-to-string</span> ()
  (<span class="org-keyword">should</span> (string= (my/org-date-to-string <span class="org-string">"++1"</span> <span class="org-string">"2018-08-01"</span>) <span class="org-string">"2018-08-02"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-filter-journal-csv</span> (filename <span class="org-type">&amp;optional</span> from to highlight base-date)
  <span class="org-doc">"Return a list of matching entries."</span>
  (<span class="org-keyword">setq</span> from (<span class="org-keyword">and</span> from (substring (my/org-date-to-string from base-date) 0 10))
        to (<span class="org-keyword">and</span> to (substring (my/org-date-to-string to base-date) 0 10)))
  (<span class="org-keyword">let*</span> ((data (pcsv-parse-file filename))
         (filtered
          (-filter
           (<span class="org-keyword">lambda</span> (o)
             (<span class="org-keyword">let</span> ((date (my/journal-date o)))
               (<span class="org-keyword">and</span> (<span class="org-keyword">or</span> (null from) (not (string&lt; date from)))
                    (<span class="org-keyword">or</span> (null to) (string&lt; date to))
                    (<span class="org-keyword">and</span> (not (string= (my/journal-status o) <span class="org-string">"Deleted"</span>)))
                    (not (string-match <span class="org-string">"^!"</span> (my/journal-note o)))
                    (string-equal
                     <span class="org-string">"true"</span>
                     (<span class="org-keyword">cond</span>
                      ((null highlight) <span class="org-string">"true"</span>)
                      ((string-equal highlight <span class="org-string">"week"</span>) (my/journal-week-highlight o))
                      (t <span class="org-string">"true"</span>))))))
           data)))
    filtered))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-read-category</span> (<span class="org-type">&amp;optional</span> initial)
  (completing-read <span class="org-string">"Category: "</span> my/journal-categories nil nil initial))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-post</span> (note <span class="org-type">&amp;rest</span> plist)
  (<span class="org-keyword">interactive</span> (list (read-string <span class="org-string">"Note: "</span>)
                     <span class="org-builtin">:Category</span> (my/journal-read-category)
                     <span class="org-builtin">:Other</span> (read-string <span class="org-string">"Other: "</span>)))
  (<span class="org-keyword">setq</span> plist (append `(<span class="org-builtin">:Note</span> ,note) plist))
  (<span class="org-keyword">let</span> ((url-request-method <span class="org-string">"POST"</span>)
        (url-request-extra-headers '((<span class="org-string">"Content-Type"</span> . <span class="org-string">"application/json"</span>)))
        (json-object-type 'plist)
        (url-request-data (json-encode-plist plist)))
    (<span class="org-keyword">with-current-buffer</span> (url-retrieve-synchronously <span class="org-string">"https://journal.sachachua.com/api/entries"</span>)
      (goto-char (point-min))
      (re-search-forward <span class="org-string">"^$"</span>)
      (json-read))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-get-by-zidstring</span> (zidstring)
  (my/json-request (concat <span class="org-string">"https://journal.sachachua.com/api/entries/"</span> zidstring)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-edit</span> (zidstring)
  (<span class="org-keyword">interactive</span> (list (my/journal-completing-read)))
  (<span class="org-keyword">let*</span> ((id (my/journal-id-from-string zidstring))
         (entry (<span class="org-keyword">and</span> id (my/journal-get-by-zidstring id))))
    (<span class="org-keyword">if</span> (null id)
        (my/journal-post zidstring
                         <span class="org-builtin">:Category</span> (my/journal-read-category (plist-get entry <span class="org-builtin">:Category</span>))
                         <span class="org-builtin">:Other</span> (read-string <span class="org-string">"Other: "</span> (plist-get entry <span class="org-builtin">:Other</span>)))
      (plist-put entry <span class="org-builtin">:Note</span> (read-string <span class="org-string">"Note: "</span> (plist-get entry <span class="org-builtin">:Note</span>)))
      (plist-put entry <span class="org-builtin">:Category</span> (my/journal-read-category (plist-get entry <span class="org-builtin">:Category</span>)))
      (plist-put entry <span class="org-builtin">:Other</span> (read-string <span class="org-string">"Other: "</span> (plist-get entry <span class="org-builtin">:Other</span>)))
      (apply 'my/journal-update entry))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-update</span> (<span class="org-type">&amp;rest</span> plist)
  <span class="org-doc">"Update journal entry using PLIST."</span>
  (<span class="org-keyword">let</span> ((url-request-method <span class="org-string">"PUT"</span>)
        (url-request-data (json-encode-plist plist)))
    (my/json-request (concat <span class="org-string">"https://journal.sachachua.com/api/entries/"</span> (plist-get plist <span class="org-builtin">:ZIDString</span>)))))
<span class="org-comment-delimiter">;; </span><span class="org-comment">(my/journal-post "Hello, world")</span>
  
(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-get-entries</span> (from to <span class="org-type">&amp;optional</span> search)
  <span class="org-doc">"Return parsed CSV of entries limited by FROM, TO, and SEARCH."</span>
  (<span class="org-keyword">with-current-buffer</span>
      (url-retrieve-synchronously (format <span class="org-string">"https://journal.sachachua.com/api/entries.csv?from=%s&amp;to=%s&amp;q=%s"</span> from to (<span class="org-keyword">or</span> search <span class="org-string">""</span>)))
    (goto-char (point-min))
    (delete-region (point-min) (search-forward <span class="org-string">"\n\n"</span>))
    (cdr (pcsv-parse-buffer))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-get</span> (url) (my/json-request (format <span class="org-string">"https://journal.sachachua.com/%s"</span> url)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-get-entry</span> (zid) (my/journal-get (format <span class="org-string">"api/entries/zid/%s"</span> zid)))
</pre>
</div>

<p>
The following code creates a Helm source that allows me to quickly
search through my journal and insert links, a list of entries with
links, a list of plain entries, or plain entries. I can also easily view the entries.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org412c97a">(<span class="org-keyword">defun</span> <span class="org-function-name">my/json-request</span> (url)
  (<span class="org-keyword">let</span> ((json-object-type 'plist)
        (url-request-extra-headers (cons '(<span class="org-string">"Content-Type"</span> . <span class="org-string">"application/json"</span>) url-request-extra-headers)))
    (<span class="org-keyword">with-current-buffer</span> (url-retrieve-synchronously url)
      (goto-char (point-min))
      (re-search-forward <span class="org-string">"^$"</span> nil t)
      (json-read))))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/journal-search-cache</span> nil <span class="org-doc">"List of search results."</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-search-query</span> (query-str)
  (<span class="org-keyword">let*</span> ((url-request-method <span class="org-string">"GET"</span>)
         (json-response (my/json-request (format <span class="org-string">"https://journal.sachachua.com/api/entries?q=%s&amp;limit=50"</span>
                                                 query-str))))
    (<span class="org-keyword">setq</span> my/journal-search-cache (mapcar (<span class="org-keyword">lambda</span> (o)
              (cons
               (format <span class="org-string">"%s %s"</span>
                       (plist-get o <span class="org-builtin">:ZIDString</span>)
                       (plist-get o <span class="org-builtin">:Note</span>))
               o))
            json-response))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-completing-read</span> ()
  (completing-read <span class="org-string">"Journal entry: "</span>
                   (<span class="org-keyword">lambda</span> (string predicate flag)
                     (<span class="org-keyword">if</span> (eq flag 'metadata)
                         `(metadata
                           (display-sort-function . ,#'identity)
                           (category . journal))
                       (<span class="org-keyword">let</span> ((list (my/journal-search-query string)))
                         (mapcar 'car
                                 (<span class="org-keyword">if</span> predicate
                                     (seq-filter predicate list)
                                   list)))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-id-from-string</span> (s)
  (<span class="org-keyword">when</span> (string-match <span class="org-string">"^[-0-9]+"</span> s) (match-string 0 s)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-view</span> (s)
  (<span class="org-keyword">interactive</span> (list (my/journal-completing-read)))
  (my/org-journal-open (my/journal-id-from-string s)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-sketch-large</span> (zid)
  <span class="org-doc">"Create a large sketch based on ZID."</span>
  (<span class="org-keyword">interactive</span> (list (my/journal-completing-read)))
  (<span class="org-keyword">let</span> ((filename (expand-file-name (format <span class="org-string">"%s.psd"</span>
                                             (my/journal-id-from-string zid))
                                    my/sketch-inbox-directory)))
    (<span class="org-keyword">unless</span> (file-exists-p filename)
      (copy-file my/sketch-large-template-file filename))
    (my/org-sketch-open filename)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/helm-journal-search</span> (<span class="org-type">&amp;optional</span> values predicate ignore)
  (<span class="org-keyword">if</span> (&gt; (length helm-pattern) 2)
      (my/journal-search-query helm-pattern)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-format-entry</span> (type o)
  (<span class="org-keyword">cond</span>
   ((eq type 'org-link-zid-only)
    (org-link-make-string (format <span class="org-string">"journal:%s"</span> (cdr (assoc 'ZIDString o)))))
   ((eq type 'list-item-with-zid)
    (format <span class="org-string">"- %s (%s)\n"</span>
            (assoc-default 'Note o)
            (org-link-make-string
             (format <span class="org-string">"journal:%s"</span> (assoc-default 'ZIDString o)))))
   ((eq type 'list-item)
    (format <span class="org-string">"- %s\n"</span> (assoc-default 'Note o)))
   ((eq type 'text)
    (assoc-default 'Note o))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/journal-format-entries</span> (type list)
  (mapconcat
   (<span class="org-keyword">lambda</span> (o) (my/journal-format-entry type o))
   (reverse list)
   (<span class="org-keyword">cond</span>
    ((eq type 'org-link-zid-only) <span class="org-string">", "</span>)
    ((eq type 'list-item-with-zid) <span class="org-string">""</span>)
    ((eq type 'list-item) <span class="org-string">""</span>)
    ((eq type 'text) <span class="org-string">" "</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/helm-journal</span> ()
  (<span class="org-keyword">interactive</span>)
  (helm <span class="org-builtin">:sources</span>
        (list
         (<span class="org-keyword">helm-build-dummy-source</span> <span class="org-string">"Create post"</span>
           <span class="org-builtin">:action</span> (<span class="org-keyword">lambda</span> (cand) (my/journal-post cand)))
         (<span class="org-keyword">helm-build-sync-source</span> <span class="org-string">"Journal"</span>
           <span class="org-builtin">:volatile</span> t
           <span class="org-builtin">:candidates</span> 'my/helm-journal-search
           <span class="org-builtin">:action</span>
           (append
            (mapcar (<span class="org-keyword">lambda</span> (o)
                      (cons (car o)
                            `(<span class="org-keyword">lambda</span> (candidate)
                               (insert (my/journal-format-entries ,(cdr o) (helm-marked-candidates))))))
                    '((<span class="org-string">"Insert as link"</span> . 'org-link-zid-only)
                      (<span class="org-string">"Insert as list with links"</span> . 'list-item-with-zid)
                      (<span class="org-string">"Insert as list"</span> . 'list-item)
                      (<span class="org-string">"Insert as text"</span> . 'text)))
            (helm-make-actions
             <span class="org-string">"View"</span>
             (<span class="org-keyword">lambda</span> (candidate)
               (browse-url (format <span class="org-string">"https://journal.sachachua.com/zids/%s"</span> 
                                   (mapconcat (<span class="org-keyword">lambda</span> (o) (assoc-default 'ZIDString o))
                                              (helm-marked-candidates) <span class="org-string">","</span>))))))))))

</pre>
</div>

<p>
This lets me define a custom link type.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-journal-open</span> (id <span class="org-type">&amp;optional</span> arg)
  (browse-url (format <span class="org-string">"https://journal.sachachua.com/zid/%s"</span> id)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-journal-export</span> (link description format)
  (<span class="org-keyword">let*</span> ((path (concat <span class="org-string">"https://journal.sachachua.com/zid/"</span> link))
         (image (concat <span class="org-string">"https://journal.sachacuha.com/zid/"</span> link))
         (desc (<span class="org-keyword">or</span> description link)))
    (<span class="org-keyword">cond</span>
     ((<span class="org-keyword">or</span> (eq format 'html) (eq format 'wp))
      (<span class="org-keyword">if</span> description
          (format <span class="org-string">"&lt;a target=\"_blank\" href=\"%s\"&gt;%s&lt;/a&gt;"</span> path desc)
        (format <span class="org-string">"&lt;a target=\"_blank\" href=\"%s\"&gt;&lt;img src=\"%s\"&gt;&lt;br /&gt;%s&lt;/a&gt;"</span> path image desc)))
     ((eq format 'latex) (format <span class="org-string">"\\href{%s}{%s}"</span> path desc))
     ((eq format 'texinfo) (format <span class="org-string">"@uref{%s,%s}"</span> path desc))
     ((eq format 'ascii) (format <span class="org-string">"%s &lt;%s&gt;"</span> desc path))
     (t path))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-journal-complete</span> (<span class="org-type">&amp;optional</span> prefix)
  (cdr (assoc 'ZIDString (helm-comp-read <span class="org-string">"Entry: "</span> 'my/helm-journal-search <span class="org-builtin">:volatile</span> t))))

(<span class="org-keyword">use-package</span> <span class="org-constant">org</span>
  <span class="org-builtin">:config</span>
  (org-link-set-parameters
   <span class="org-string">"journal"</span>
   <span class="org-builtin">:follow</span> 'my/org-journal-open
   <span class="org-builtin">:export</span> 'my/org-journal-export
   <span class="org-builtin">:complete</span> 'my/org-journal-complete))
</pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-journal-summarize</span> (from to <span class="org-type">&amp;optional</span> search category-map categories)
  (my/org-group-journal-entries (my/journal-get-entries from to search) category-map categories))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-journal-format-tree</span> (groups <span class="org-type">&amp;optional</span> include)
  (mapconcat
   (<span class="org-keyword">lambda</span> (o)
     (concat <span class="org-string">"- *"</span> (car o) <span class="org-string">"*\n"</span>
             (mapconcat
              (<span class="org-keyword">lambda</span> (i)
                (concat <span class="org-string">"  - "</span>
                        (<span class="org-keyword">if</span> (member 'date include) (concat (my/journal-date i) <span class="org-string">" "</span>) <span class="org-string">""</span>)
                        (replace-regexp-in-string <span class="org-string">"\\\""</span> <span class="org-string">"\""</span> (my/journal-note i))
                        (<span class="org-keyword">if</span> (member 'zid include) (concat <span class="org-string">" "</span> (my/journal-zidstring i)) <span class="org-string">""</span>)
                        <span class="org-comment-delimiter">;; </span><span class="org-comment">(if (string= "" (my/journal-category i))</span>
                        <span class="org-comment-delimiter">;;     </span><span class="org-comment">""</span>
                        <span class="org-comment-delimiter">;;   </span><span class="org-comment">(format " (%s)" (my/journal-category i)))</span>
                        <span class="org-string">"\n"</span>))
              (reverse (cdr o)) <span class="org-string">""</span>)))
   groups <span class="org-string">""</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-summarize-journal-csv</span> (from to <span class="org-type">&amp;optional</span> search category-map categories include)
  (<span class="org-keyword">interactive</span>
   (list (org-read-date nil nil nil <span class="org-string">"From: "</span>)
         (org-read-date nil nil nil <span class="org-string">"To: "</span>)
         (read-string <span class="org-string">"Search: "</span>)
         my/journal-category-map
         my/journal-categories
         nil))
  (<span class="org-keyword">let</span> ((list (my/org-journal-format-tree
               (my/org-group-journal-entries
                (my/journal-get-entries from to search) 
                category-map categories)
               include)))    
    (<span class="org-keyword">if</span> (called-interactively-p 'any) (insert list) list)))

</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/read-journal-category</span> ()
  (completing-read <span class="org-string">"Category: "</span> my/journal-categories))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/update-journal-entry</span> (old-text new-text category)
  (<span class="org-keyword">interactive</span> (list (read-string <span class="org-string">"Old: "</span>)
                     (read-string <span class="org-string">"New: "</span>)
                     (my/read-journal-category)))
  (my/send-intent <span class="org-string">"com.sachachua.journal.categorize"</span>
                  (list (cons <span class="org-string">"text"</span> old-text)
                        (cons <span class="org-string">"newtext"</span> (<span class="org-keyword">or</span> new-text old-text))
                        (cons <span class="org-string">"category"</span> (<span class="org-keyword">or</span> category <span class="org-string">"Uncategorized"</span>)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/create-journal-entry</span> (new-text category)
  (<span class="org-keyword">interactive</span> (list (read-string <span class="org-string">"Text: "</span>)
                     (my/read-journal-category)))
  (my/update-journal-entry new-text new-text category))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/export-journal-entries</span> ()
  <span class="org-doc">"Trigger task to export. Phone must be unlocked."</span>
  (<span class="org-keyword">interactive</span>)
  (my/send-intent <span class="org-string">"com.sachachua.journal.export"</span> '((<span class="org-string">"a"</span> . <span class="org-string">"b"</span>))))

(<span class="org-keyword">use-package</span> <span class="org-constant">csv</span>
  <span class="org-builtin">:commands</span> csv--read-line)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/prompt-for-uncategorized-entries</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((key-list '(<span class="org-string">"Note"</span> <span class="org-string">"Date"</span> <span class="org-string">"highlight week"</span> <span class="org-string">"Category"</span> <span class="org-string">"month"</span> <span class="org-string">"Time"</span> <span class="org-string">"Link"</span> <span class="org-string">"ELECT"</span>))
        x new-text category done)
    (<span class="org-keyword">while</span> (<span class="org-keyword">and</span> (not (eobp)) (not done))
      (forward-char 1)
      (<span class="org-keyword">setq</span> x (csv--read-line key-list))
      (<span class="org-keyword">when</span> (string= (assoc-default <span class="org-string">"Category"</span> x nil <span class="org-string">""</span>) <span class="org-string">""</span>)
        (<span class="org-keyword">setq</span> text (read-string <span class="org-string">"Text: "</span> (assoc-default <span class="org-string">"Note"</span> x nil <span class="org-string">""</span>)))
        (<span class="org-keyword">setq</span> category (completing-read <span class="org-string">"Category: "</span> (cons <span class="org-string">"."</span> my/journal-categories)))
        (<span class="org-keyword">if</span> (string= category <span class="org-string">"."</span>)
            (<span class="org-keyword">setq</span> done t)
          (my/update-journal-entry (assoc-default <span class="org-string">"Note"</span> x nil <span class="org-string">""</span>) text category))))))
</pre>
</div>
</div>

<div id="outline-container-orgfe15035" class="outline-5">
<h5 id="orgfe15035">Working with journal entries</h5>
<div class="outline-text-5" id="text-orgfe15035">
<p>
(defun my/completing-read-journal ()
  (completing-read "Journal entry: "
  )
</p>
</div>
</div>
<div id="outline-container-org606b392" class="outline-5">
<h5 id="org606b392">Photos</h5>
<div class="outline-text-5" id="text-org606b392">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/get-image-caption</span> (file)
  (<span class="org-keyword">let</span> ((caption (shell-command-to-string (format <span class="org-string">"exiftool -s -s -s -ImageDescription %s"</span> (shell-quote-argument file)))))
    (<span class="org-keyword">when</span> (&gt; (length caption) 0) (format <span class="org-string">"#+CAPTION: %s"</span> caption))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/insert-image-link-with-caption</span> (file)
  (<span class="org-keyword">let</span> ((caption (my/get-image-caption file)))
    (insert (<span class="org-keyword">or</span> caption <span class="org-string">""</span>) (org-link-make-string file) <span class="org-string">"\n"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/caption-current-image</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((link (org-element-link-parser)) caption)
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> link (org-element-property <span class="org-builtin">:path</span> link))
      (<span class="org-keyword">setq</span> caption (my/get-image-caption (org-element-property <span class="org-builtin">:path</span> link)))
      (<span class="org-keyword">when</span> caption (insert caption)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/set-image-caption</span> (file caption)
  (<span class="org-keyword">interactive</span> (list (<span class="org-keyword">if</span> (derived-mode-p 'dired-mode) (dired-get-filename) (buffer-file-name))
                     (read-string <span class="org-string">"Caption: "</span>)))
  (shell-command (format <span class="org-string">"exiftool -ImageDescription=\"%s\" %s"</span> (shell-quote-argument caption) (shell-quote-argument file))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/photo-directory</span> <span class="org-string">"/mnt/nfs/photos/inbox"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/get-photo-rating</span> (file)
  (<span class="org-keyword">let</span> ((rating (shell-command-to-string (concat <span class="org-string">"exiftool -s -s -s -Rating "</span> (shell-quote-argument file)))))
    (string-to-number rating)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/make-photo-list</span> (start end <span class="org-type">&amp;optional</span> rating require-description)
  (<span class="org-keyword">interactive</span> (list (org-read-date <span class="org-string">"Start: "</span>) (org-read-date <span class="org-string">"End: "</span>)))
  (-filter
   (<span class="org-keyword">lambda</span> (filename)
     (<span class="org-keyword">and</span> (string&gt; (file-name-nondirectory filename) start)
          (string&gt; end (file-name-nondirectory filename))
          (<span class="org-keyword">if</span> rating (&gt;= (my/get-photo-rating filename) rating) t)
          (<span class="org-keyword">if</span> require-description (my/get-image-caption filename) t)))
   (directory-files my/photo-directory t <span class="org-string">".*\\.jpg$"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-get-photo</span> (id)
  <span class="org-doc">"Open the photo identified by ID."</span>
  (car (directory-files my/photo-directory t (concat id <span class="org-string">".*\\.jpg"</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-open-photo</span> (id)
  (find-file (my/org-get-photo id)))

                                        <span class="org-comment-delimiter">;</span><span class="org-comment">(my/make-photo-list "2018-06-10" "2018-06-15" nil t)</span>
                                        <span class="org-comment-delimiter">;</span><span class="org-comment">(my/get-photo-rating  (my/org-get-photo "2018-06-10-18-16-31"))</span>

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-significant-moments</span> (start end <span class="org-type">&amp;optional</span> rating)
  (<span class="org-keyword">interactive</span> (list (org-read-date <span class="org-string">"Start: "</span>) (org-read-date <span class="org-string">"End: "</span>) 3))
  (<span class="org-keyword">let</span> ((result
         (mapconcat (<span class="org-keyword">lambda</span> (file)
                      (<span class="org-keyword">let</span> ((caption (my/get-image-caption file)))
                        (<span class="org-keyword">if</span> caption
                            (concat caption (org-link-make-string file) <span class="org-string">"\n"</span>)
                          (concat (org-link-make-string file) <span class="org-string">"\n"</span>))))
                    (my/make-photo-list start end 3)
                    <span class="org-string">"\n"</span>)))
    (<span class="org-keyword">if</span> (called-interactively-p 'any) (insert result) result)))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbdc0769" class="outline-4">
<h4 id="orgbdc0769">Attachments</h4>
<div class="outline-text-4" id="text-orgbdc0769">
<p>
Org lets you attach files to an Org file. Haven't gotten the hang of this yet, but looks interesting.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-attach-store-link-p 'attached)
(<span class="org-keyword">setq</span> org-attach-auto-tag nil)
</pre>
</div>
</div>
</div>

<div id="outline-container-org638d2f7" class="outline-4">
<h4 id="org638d2f7">HTTP</h4>
<div class="outline-text-4" id="text-org638d2f7">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">ob-http</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org2f4d020" class="outline-4">
<h4 id="org2f4d020">Lilypond</h4>
<div class="outline-text-4" id="text-org2f4d020">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">lilypond-init</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/vendor/lilypond/elisp"</span>
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> org-babel-lilypond-arrange-mode t
        org-babel-lilypond-commands '(<span class="org-string">"lilypond"</span> <span class="org-string">"timidity"</span> <span class="org-string">"timidity"</span>)
        org-babel-lilypond-gen-pdf nil
        org-babel-lilypond-display-pdf-post-tangle nil)
  <span class="org-builtin">:mode</span> (<span class="org-string">"\\.ly\\'"</span> . LilyPond-mode))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbb5ca5d" class="outline-4">
<h4 id="orgbb5ca5d">Diagrams and graphics</h4>
<div class="outline-text-4" id="text-orgbb5ca5d">
<p>
Ooooh. Graphviz and Ditaa make it easier to create diagrams from Emacs. See <a href="http://sachachua.com/evil-plans">http://sachachua.com/evil-plans</a> for examples and source.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-ditaa-jar-path <span class="org-string">"c:/sacha/Dropbox/bin/ditaa.jar"</span>)
(<span class="org-keyword">setq</span> org-startup-with-inline-images t)
(<span class="org-keyword">use-package</span> <span class="org-constant">org</span>
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">progn</span>
    (add-hook 'org-babel-after-execute-hook 'org-display-inline-images)
    (<span class="org-keyword">setq</span> org-confirm-babel-evaluate nil)
    (<span class="org-keyword">setq</span> org-link-elisp-confirm-function
          (<span class="org-keyword">lambda</span> (prompt)
            (<span class="org-keyword">if</span> (string-match <span class="org-string">"vendor"</span> (buffer-file-name))
                (y-or-n-p prompt)
              t)))
    (org-babel-do-load-languages
     'org-babel-load-languages
     '((dot . t)
       (ditaa . t)
       (emacs-lisp . t)
       (plantuml . t)
       (lilypond . t)
       (python . t)
       (shell . t)
       (calc . t)
       (sqlite . t)
       (http . t)
       (ledger . t)
       (shell . t)
       (R . t)))
    (<span class="org-keyword">setq</span> org-babel-python-command <span class="org-string">"python3"</span>)
    (<span class="org-keyword">setq</span> python-shell-interpreter <span class="org-string">"python3"</span>)
    (add-to-list 'org-src-lang-modes '(<span class="org-string">"dot"</span> . graphviz-dot))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org0df4830" class="outline-4">
<h4 id="org0df4830">Counting</h4>
<div class="outline-text-4" id="text-org0df4830">
<p>
Good way to remind myself that I have lots of STARTED tasks.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-summarize-task-status</span> ()
  <span class="org-doc">"Count number of tasks by status.</span>
<span class="org-doc">      Probably should make this a dblock someday."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> (result)
    (org-map-entries
     (<span class="org-keyword">lambda</span> ()
       (<span class="org-keyword">let</span> ((todo (elt (org-heading-components) 2)))
         (<span class="org-keyword">if</span> todo
             (<span class="org-keyword">if</span> (assoc todo result)
                 (setcdr (assoc todo result)
                         (1+ (cdr (assoc todo result))))
               (<span class="org-keyword">setq</span> result (cons (cons todo 1) result)))))))
    (message <span class="org-string">"%s"</span> (mapconcat (<span class="org-keyword">lambda</span> (x) (format <span class="org-string">"%s: %d"</span> (car x) (cdr x)))
                             result <span class="org-string">"\n"</span>))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org692c123" class="outline-4">
<h4 id="org692c123">Spreadsheets</h4>
<div class="outline-text-4" id="text-org692c123">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-days-between</span> (start end)
  <span class="org-doc">"Number of days between START and END (exclusive).</span>
<span class="org-doc">      This includes START but not END."</span>
  (- (calendar-absolute-from-gregorian (org-date-to-gregorian end))
     (calendar-absolute-from-gregorian (org-date-to-gregorian start))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdd5ed39" class="outline-4">
<h4 id="orgdd5ed39">Literate programming</h4>
<div class="outline-text-4" id="text-orgdd5ed39">
</div>
<div id="outline-container-orgd6a5abf" class="outline-5">
<h5 id="orgd6a5abf">Editing source code</h5>
<div class="outline-text-5" id="text-orgd6a5abf">
<p>
I don't want to get distracted by the same code in the other window, so I want org src to use the current window.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-src-window-setup 'current-window)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc860ead" class="outline-5">
<h5 id="orgc860ead">Copying and sharing code</h5>
<div class="outline-text-5" id="text-orgc860ead">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/copy-code-as-org-block-and-gist</span> (beg end)
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">let</span> ((filename (file-name-base))
        (mode (symbol-name major-mode))
        (contents
         (<span class="org-keyword">if</span> (use-region-p) (buffer-substring beg end) (buffer-string)))
        (gist (<span class="org-keyword">if</span> (use-region-p) (gist-region beg end) (gist-buffer))))
    (kill-new
     (format <span class="org-string">"\n%s\n#+begin_src %s\n%s\n#+end_src\n"</span>
             (org-link-make-string (<span class="org-keyword">oref</span> (<span class="org-keyword">oref</span> gist <span class="org-builtin">:data</span>) <span class="org-builtin">:html-url</span>) filename)
             (replace-regexp-in-string <span class="org-string">"-mode$"</span> <span class="org-string">""</span> mode)
             contents))))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf8db126" class="outline-5">
<h5 id="orgf8db126">Tables</h5>
<div class="outline-text-5" id="text-orgf8db126">
<p>
Requires dash.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-table-as-alist</span> (table)
  <span class="org-doc">"Convert TABLE to an alist. Remember to set :colnames no."</span>
  (<span class="org-keyword">let</span> ((headers (seq-map 'intern (car table))))
    (<span class="org-keyword">cl-loop</span> for x in (cdr table) collect (-zip headers x))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb4d3555" class="outline-4">
<h4 id="orgb4d3555">Invoices</h4>
<div class="outline-text-4" id="text-orgb4d3555">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> calendar-week-start-day 6) <span class="org-comment-delimiter">;; </span><span class="org-comment">My weeks start on Saturday</span>

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-get-invoice-range-based-on-date</span> (date)
  (<span class="org-keyword">let*</span> ((invoice-date (org-date-to-gregorian date))
         (start (list (1- (car invoice-date)) 1 (elt invoice-date 2)))
         (end (list (car invoice-date) 1 (elt invoice-date 2))))
    (mapcar (<span class="org-keyword">lambda</span> (date)
              (format-time-string <span class="org-string">"%F %H:%M"</span> (encode-time 0 0 0 1 (elt date 0) (elt date 2))))
            (list start end))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-quantified-get-hours-based-on-range</span> (category start end)
  <span class="org-doc">"Return the number of hours for the specified category."</span>
  (/ (assoc-default category
                    (quantified-summarize-time start end)) <span class="org-warning">3600.0))</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">TODO: paginate</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-quantified-get-detailed-hours-based-on-range</span> (category start end)
  <span class="org-doc">"Return a list of (date week-ending-date dow seconds) for CATEGORY from START to END."</span>
  (<span class="org-keyword">let</span> ((entries
         (gethash <span class="org-string">"entries"</span>
                  (quantified-parse-json
                   (quantified-request (format <span class="org-string">"records.json?start=%s&amp;end=%s&amp;filter_string=%s&amp;per_page=1000&amp;split=split"</span> start end (url-encode-url category))
                                       nil <span class="org-string">"GET"</span>)))))
    (mapcar
     (<span class="org-keyword">lambda</span> (entry)
       (<span class="org-keyword">let</span> ((time (date-to-time (gethash <span class="org-string">"timestamp"</span> entry))))
         (list
          (format-time-string <span class="org-string">"%F"</span> time)
          (format-time-string <span class="org-string">"%F"</span> (my/get-week-end-for-time time))
          (format-time-string <span class="org-string">"%a"</span> time)
          (gethash <span class="org-string">"duration"</span> entry))))
     entries)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/get-week-end-for-time</span> (time <span class="org-type">&amp;optional</span> week-ends-on-day)
  <span class="org-doc">"WEEK-ENDS-ON-DAY: 0 is Sunday"</span>
  (<span class="org-keyword">let*</span> ((decoded (decode-time time))
         (dow (elt decoded 6))
         (end-week (<span class="org-keyword">or</span> week-ends-on-day (% (+ 6 calendar-week-start-day) 7))))
    (encode-time
     (elt decoded 0)
     (elt decoded 1)
     (elt decoded 2)
     (+ (elt decoded 3)
        (% (+ 7 (- end-week dow)) 7))
     (elt decoded 4)
     (elt decoded 5))))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my/org-get-week-ending-date</span> ()
  (<span class="org-keyword">let</span> ((calendar-week-start-day 6)
        (tests '(
                 (<span class="org-string">"2015-09-03"</span> . <span class="org-string">"2015-09-04"</span>)
                 (<span class="org-string">"2015-12-01"</span> . <span class="org-string">"2015-12-04"</span>)
                 (<span class="org-string">"2015-12-03"</span> . <span class="org-string">"2015-12-04"</span>)
                 (<span class="org-string">"2015-12-04"</span> . <span class="org-string">"2015-12-04"</span>)
                 (<span class="org-string">"2015-12-05"</span> . <span class="org-string">"2015-12-11"</span>))))
    (<span class="org-keyword">dolist</span> (test tests)
      (<span class="org-keyword">should</span> (string=
               (format-time-string
                <span class="org-string">"%F"</span>
                (my/get-week-end-for-time (org-time-string-to-time (car test))))
               (cdr test)))
      (<span class="org-keyword">should</span> (string=
               (format-time-string
                <span class="org-string">"%F"</span>
                (my/get-week-end-for-time (org-time-string-to-time (car test)) 5))
               (cdr test))))))



(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-quantified-format-detailed-hours-as-table</span> (list)
  <span class="org-doc">"Return a table with rows for LIST.</span>
<span class="org-doc">        | Week ending ____ | Sat | Sun | Mon | Tue | Wed | Thu | Fri | Total |</span>
<span class="org-doc">        LIST elements should be in the form (date week-end-date dow seconds).</span>
<span class="org-doc">        See `</span><span class="org-doc"><span class="org-constant">my/org-quantified-get-detailed-hours-based-on-range</span></span><span class="org-doc">'."</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Group by week ending date</span>
  (<span class="org-keyword">let</span> ((days '(<span class="org-string">"Sat"</span> <span class="org-string">"Sun"</span> <span class="org-string">"Mon"</span> <span class="org-string">"Tue"</span> <span class="org-string">"Wed"</span> <span class="org-string">"Thu"</span> <span class="org-string">"Fri"</span>)))
    (append
     (list (append '(<span class="org-string">"Week ending"</span>) days '(<span class="org-string">"Total"</span>)))
     (mapcar
      (<span class="org-keyword">lambda</span> (row)
        (<span class="org-keyword">let</span> ((day-values (-group-by (<span class="org-keyword">lambda</span> (x) (elt x 2)) (cdr row)))
              (week-total 0))
          (append
           (list (format <span class="org-string">"Week ending %s"</span> (format-time-string <span class="org-string">"%b %-e"</span> (org-time-string-to-time (car row)))))
           (mapcar (<span class="org-keyword">lambda</span> (day)
                     (<span class="org-keyword">if</span> (assoc-default day day-values)
                         (format <span class="org-string">"%.1f"</span>
                                 (apply '+
                                        (mapcar
                                         (<span class="org-keyword">lambda</span> (day-val) (/ (elt day-val 3) 3600.0))
                                         (assoc-default day day-values))))
                       <span class="org-string">""</span>))
                   days)
           (list (format <span class="org-string">"%.1f"</span>
                         (apply '+ (mapcar (<span class="org-keyword">lambda</span> (day-val) (/ (elt day-val 3) 3600.0)) (cdr row)))))
           ))
        )
      (-sort (<span class="org-keyword">lambda</span> (a b) (string&lt; (car a) (car b))) (-group-by (<span class="org-keyword">lambda</span> (x) (elt x 1)) list))))))


(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-quantified-hours-table</span> ()
  (my/org-quantified-format-detailed-hours-as-table
   (apply 'my/org-quantified-get-detailed-hours-based-on-range 
          (org-entry-get-with-inheritance <span class="org-string">"QUANTIFIED_CATEGORY"</span>)
          (my/org-get-invoice-range-based-on-date (org-entry-get-with-inheritance <span class="org-string">"INVOICE_DATE"</span>)))))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my/org-get-invoice-range-based-on-date</span> ()
  <span class="org-doc">"Check if invoice range is sane."</span>
  (<span class="org-keyword">should</span> (equal (my/org-get-invoice-range-based-on-date <span class="org-string">"2015-12-05"</span>)
                 '(<span class="org-string">"2015-11-01 00:00"</span> <span class="org-string">"2015-12-01 00:00"</span>))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org99ff594" class="outline-4">
<h4 id="org99ff594">Archiving</h4>
<div class="outline-text-4" id="text-org99ff594">
<p>
Don't ask me for confirmation:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-to-list 'org-speed-commands-user '(<span class="org-string">"a"</span> call-interactively 'org-archive-subtree-default))
</pre>
</div>
</div>
</div>

<div id="outline-container-org01b8065" class="outline-4">
<h4 id="org01b8065">Presentations</h4>
<div class="outline-text-4" id="text-org01b8065">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">ox-reveal</span> <span class="org-builtin">:disabled</span> t)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc181a4e" class="outline-4">
<h4 id="orgc181a4e">Allow dashes in tags</h4>
<div class="outline-text-4" id="text-orgc181a4e">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-add-dashes-to-tag-regexps</span> ()
  (<span class="org-keyword">setq</span> org-complex-heading-regexp
        (concat <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\*+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string"> +"</span> org-todo-regexp <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string"> +</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\[#.\\]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string"> +</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">??"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">[ \t]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">:[-[:alnum:]_@#%:]+:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?"</span>
                <span class="org-string">"[ \t]*$"</span>)
        org-complex-heading-regexp-format
        (concat <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\*+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string"> +"</span> org-todo-regexp <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string"> +</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\[#.\\]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string"> +"</span>
                <span class="org-comment-delimiter">;; </span><span class="org-comment">Stats cookies can be stuck to body.</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">\\[[0-9%%/]+\\] *</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">*"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">%s</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string"> *\\[[0-9%%/]+\\]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">*"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">[ \t]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">:[-[:alnum:]_@#%%:]+:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?"</span>
                <span class="org-string">"[ \t]*$"</span>)
        org-todo-line-tags-regexp
        (concat <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\*+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string"> +"</span> org-todo-regexp <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string"> +</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">??"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">[ \t]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">:[-[:alnum:]:_@#%]+:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?"</span>
                <span class="org-string">"[ \t]*$"</span>)))
(<span class="org-keyword">use-package</span> <span class="org-constant">org</span> <span class="org-builtin">:hook</span> (org-mode-hook . my/org-add-dashes-to-tag-regexps))
</pre>
</div>
</div>
</div>


<div id="outline-container-org3ad5524" class="outline-4">
<h4 id="org3ad5524">Copying information from my phone</h4>
<div class="outline-text-4" id="text-org3ad5524">
<p>
I have a tiny Tasker script that makes it easy to log timestamped
entries as files in a directory that I synchronize with Dropbox. This
code pulls that information into my ~/Dropbox/tasker/
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/read-phone-entries</span> ()
  <span class="org-doc">"Copy phone data to a summary Org file."</span>
  (<span class="org-keyword">interactive</span>)
  (mapc
   (<span class="org-keyword">lambda</span> (filename)
     (<span class="org-keyword">let</span> ((base (file-name-base filename)) contents timestamp category encoded-time date)
       (<span class="org-keyword">when</span> (string-match <span class="org-string">"^[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string"> ]+ [</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string"> ]+ </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string"> ]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> - </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> base)
         (<span class="org-keyword">setq</span> time (seconds-to-time (/ (string-to-number (match-string 1 base)) 1000))
               encoded-time (decode-time time)
               date (list (elt encoded-time 4) (elt encoded-time 3) (elt encoded-time 5))
               category (match-string 2 base))
         (<span class="org-keyword">with-temp-buffer</span>
           (insert-file-contents filename)
           (<span class="org-keyword">setq</span> contents (s-trim (buffer-string))))
         (<span class="org-keyword">with-current-buffer</span>
             (find-file <span class="org-string">"~/dropbox/tasker/summary.txt"</span>)
           (org-datetree-find-date-create date)
           (<span class="org-keyword">unless</span> (<span class="org-keyword">save-excursion</span> (re-search-forward (regexp-quote base) nil t))
             (goto-char (line-end-position))
             (insert <span class="org-string">"\n"</span>)
             (insert <span class="org-string">"**** "</span> contents <span class="org-string">"  :"</span> category <span class="org-string">":\n"</span> base <span class="org-string">"\n"</span>)
             (insert (format-time-string <span class="org-string">"[%Y-%m-%d %a %H:%M]\n"</span> time))

             (<span class="org-keyword">if</span> (member category '(<span class="org-string">"Think"</span> <span class="org-string">"Do"</span>))
                 (<span class="org-keyword">save-excursion</span>
                   (org-back-to-heading t)
                   (<span class="org-keyword">if</span> (looking-at org-outline-regexp) (goto-char (1- (match-end 0))))
                   (<span class="org-keyword">unless</span> (looking-at org-todo-regexp)
                     (org-todo <span class="org-string">"TODO"</span>))))
             (<span class="org-keyword">if</span> (string-match <span class="org-string">"^Energy </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> contents)
                 (org-set-property <span class="org-string">"ENERGY"</span> (match-string 1 contents)))))
         (delete-file filename))))
   (directory-files <span class="org-string">"~/dropbox/tasker/data"</span> t <span class="org-string">"\\.txt$"</span>)))
</pre>
</div>
</div>
</div>

<div id="outline-container-emacs-news" class="outline-4">
<h4 id="emacs-news">Emacs packages, other settings for easy Emacs News generation</h4>
<div class="outline-text-4" id="text-emacs-news">
</div>

<div id="outline-container-orgf1d722c" class="outline-5">
<h5 id="orgf1d722c">Package links</h5>
<div class="outline-text-5" id="text-orgf1d722c">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-package-open</span> (package-name)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MPackage name: "</span>)
  (describe-package (intern package-name)))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my/org-package-export</span> ()
  (<span class="org-keyword">should</span>
   (string=
    (my/org-package-export <span class="org-string">"transcribe"</span> <span class="org-string">"transcribe"</span> 'html)
    <span class="org-string">"&lt;a target=\"_blank\" href=\"https://elpa.gnu.org/packages/transcribe.html\"&gt;transcribe&lt;/a&gt;"</span>
    ))
  (<span class="org-keyword">should</span>
   (string=
    (my/org-package-export <span class="org-string">"fireplace"</span> <span class="org-string">"fireplace"</span> 'html)
    <span class="org-string">"&lt;a target=\"_blank\" href=\"http://melpa.org/#/fireplace\"&gt;fireplace&lt;/a&gt;"</span>
    )))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-package-export</span> (link description format)
  (<span class="org-keyword">let*</span> ((package-info (car (assoc-default (intern link) package-archive-contents)))
         (package-source (package-desc-archive package-info))
         (path (format
                (<span class="org-keyword">cond</span>
                 ((string= package-source <span class="org-string">"gnu"</span>) <span class="org-string">"https://elpa.gnu.org/packages/%s.html"</span>)
                 ((string= package-source <span class="org-string">"melpa"</span>) <span class="org-string">"http://melpa.org/#/%s"</span>)
                 (t (<span class="org-keyword">throw</span> '<span class="org-constant">unknown-source</span>)))
                link))
         (desc (<span class="org-keyword">or</span> description link)))
    (<span class="org-keyword">cond</span>
     ((eq format 'html) (format <span class="org-string">"&lt;a target=\"_blank\" href=\"%s\"&gt;%s&lt;/a&gt;"</span> path desc))
     ((eq format 'wp) (format <span class="org-string">"&lt;a target=\"_blank\" href=\"%s\"&gt;%s&lt;/a&gt;"</span> path desc))
     ((eq format 'latex) (format <span class="org-string">"\\href{%s}{%s}"</span> path desc))
     ((eq format 'texinfo) (format <span class="org-string">"@uref{%s,%s}"</span> path desc))
     ((eq format 'ascii) (format <span class="org-string">"%s &lt;%s&gt;"</span> desc path))
     (t path))))

(org-link-set-parameters <span class="org-string">"package"</span> <span class="org-builtin">:follow</span> 'my/org-package-open <span class="org-builtin">:export</span> 'my/org-package-export)
</pre>
</div>
</div>
</div>

<div id="outline-container-org68a5e35" class="outline-5">
<h5 id="org68a5e35">ASCII export</h5>
<div class="outline-text-5" id="text-org68a5e35">
<p>
This setting puts Org ASCII export links right after the text instead of in a separate section:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-ascii-links-to-notes nil)
</pre>
</div>
</div>
</div>

<div id="outline-container-org41d5efa" class="outline-5">
<h5 id="org41d5efa">Reddit</h5>
<div class="outline-text-5" id="text-org41d5efa">
<p>
This one exports links from my secret <code>my/reddit-upvoted-json</code>. You
can get your Reddit upvoted JSON URL at
<a href="https://www.reddit.com/prefs/feeds/">https://www.reddit.com/prefs/feeds/</a> .
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/reddit-list-upvoted</span> (date)
  (<span class="org-keyword">interactive</span> (list (org-read-date)))
  (<span class="org-keyword">let</span> ((threshold (org-read-date nil t (concat (substring date 0 (min (length date) 10)) <span class="org-string">" 0:00"</span>)))
        (url my/reddit-upvoted-json)
        results)
    (<span class="org-keyword">while</span> url
      (<span class="org-keyword">with-current-buffer</span> (url-retrieve-synchronously url)
        (goto-char (point-min))
        (re-search-forward <span class="org-string">"^$"</span>)
        (<span class="org-keyword">let*</span> ((data (json-read))
               (items (assoc-default 'children (assoc-default 'data data)))
               (after (assoc-default 'after (assoc-default 'data data)))
               (result
                (mapconcat
                 (<span class="org-keyword">lambda</span> (item)
                   (<span class="org-keyword">let*</span> ((o (assoc-default 'data item))
                          (title (assoc-default 'title o))
                          (url (helm-html-decode-entities-string (assoc-default 'url o)))
                          (date (seconds-to-time (assoc-default 'created_utc o)))
                          (permalink (concat <span class="org-string">"https://reddit.com"</span> (assoc-default 'permalink o)))
                          (num-comments (assoc-default 'num_comments o 'eq 0)))
                     (<span class="org-keyword">when</span> (time-less-p threshold date)
                       (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (&gt; num-comments 0) (not (string-match <span class="org-string">"reddit\\.com"</span> url)))
                           (format <span class="org-string">"- %s (%s)\n"</span>
                                   (org-link-make-string (url-unhex-string url) title)
                                   (org-link-make-string (url-unhex-string permalink) <span class="org-string">"Reddit"</span>))
                         (format <span class="org-string">"- %s\n"</span> (org-link-make-string (url-unhex-string url) title))))))
                 items <span class="org-string">""</span>)))

          (<span class="org-keyword">setq</span> results (concat result <span class="org-string">"\n"</span> results))
          (<span class="org-keyword">setq</span> url
                (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> after (&gt; (length result) 0))
                    (concat my/reddit-upvoted-json <span class="org-string">"&amp;after="</span> after)
                  nil)))))
    results))
<span class="org-comment-delimiter">;;  </span><span class="org-comment">(my/reddit-list-upvoted "-mon")</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc75328a" class="outline-5">
<h5 id="orgc75328a">Sorting Org Mode lists using a sequence of regular expressions&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="org">org</span></span></h5>
<div class="outline-text-5" id="text-orgc75328a">
<p>
I manually categorize Emacs News links into an Org unordered list, and
then I reorganize the list by using M-S-up (org-shiftmetaup) and
M-S-down (org-shiftmetadown). I decide to combine or split categories
depending on the number of links. I have a pretty consistent order.
John Wiegley suggested promoting Emacs Lisp and Emacs development
links at the top of the list. I like to sort the rest of the list
roughly by interest: general links first, then Org, then coding, then
other links at the bottom. 
</p>

<p>
Here's some code that sorts Org lists in a custom sequence, with
unknown items at the bottom for easy re-ordering. It will take a list like:
</p>

<pre class="example" id="orgd23874c">
     - Other:
       - Link A
       - Link B
     - Emacs development:
       - Link A
       - Link B
     - Emacs Lisp:
       - Link A
       - Link B
</pre>

<p>
and turn it into:
</p>

<pre class="example" id="org3a4bea0">
     - Emacs Lisp:
       - Link A
       - Link B
     - Emacs development:
       - Link A
       - Link B
     - Other:
       - Link A
       - Link B
</pre>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-sort-list-in-custom-order</span> (order)
  <span class="org-doc">"Sort the current Org list so that items are in the specified order.</span>
<span class="org-doc">       ORDER is a list of regexps."</span>
  (org-sort-list
   nil ?f
   (<span class="org-keyword">lambda</span> ()
     (<span class="org-keyword">let</span> ((case-fold-search t)
           (item
            (<span class="org-keyword">when</span> (looking-at <span class="org-string">"[ \t]*[-+*0-9.)]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[ \t]+\\[[- X]\\]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?[ \t]+"</span>)
              (org-sort-remove-invisible (buffer-substring (match-end 0) (point-at-eol))))))
       (<span class="org-keyword">or</span> (cl-position item order <span class="org-builtin">:test</span> (<span class="org-keyword">lambda</span> (a b) (string-match b a))) (1+ (length order)))))
   '&lt;))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org6f26e60" class="outline-4">
<h4 id="org6f26e60">Save when Emacs loses focus</h4>
<div class="outline-text-4" id="text-org6f26e60">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-save-all-org-buffers</span> () (<span class="org-keyword">let</span> ((my/unfocusing t)) (org-save-all-org-buffers)))
(<span class="org-keyword">use-package</span> <span class="org-constant">org</span>
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">add-function</span> <span class="org-builtin">:after</span> after-focus-change-function 'my/org-save-all-org-buffers))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org2788607" class="outline-3">
<h3 id="org2788607">Coding</h3>
<div class="outline-text-3" id="text-org2788607">
</div>
<div id="outline-container-orgbdb7ad3" class="outline-4">
<h4 id="orgbdb7ad3">Web development</h4>
<div class="outline-text-4" id="text-orgbdb7ad3">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">from FAQ at http://web-mode.org/ for smartparens</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my/web-mode-hook</span> ()
  (<span class="org-keyword">setq</span> web-mode-enable-auto-pairing nil))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/sp-web-mode-is-code-context</span> (id action context)
  (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (eq action 'insert)
             (not (<span class="org-keyword">or</span> (get-text-property (point) 'part-side)
                      (get-text-property (point) 'block-side))))
    t))

(<span class="org-keyword">use-package</span> <span class="org-constant">web-mode</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:mode</span> <span class="org-string">"\\.html?\\'"</span>
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">progn</span>
    (<span class="org-keyword">setq</span> web-mode-markup-indent-offset 2)
    (<span class="org-keyword">setq</span> web-mode-code-indent-offset 2)
    (<span class="org-keyword">setq</span> web-mode-enable-current-element-highlight t)
    (<span class="org-keyword">setq</span> web-mode-ac-sources-alist
          '((<span class="org-string">"css"</span> . (ac-source-css-property))
            (<span class="org-string">"html"</span> . (ac-source-words-in-buffer ac-source-abbrev)))
          )))

</pre>
</div>
</div>
</div>

<div id="outline-container-org00d072b" class="outline-4">
<h4 id="org00d072b">LSP</h4>
<div class="outline-text-4" id="text-org00d072b">
<p>
<a href="https://emacs-lsp.github.io/lsp-mode/tutorials/reactjs-tutorial/">https://emacs-lsp.github.io/lsp-mode/tutorials/reactjs-tutorial/</a>
<a href="https://www.mattduck.com/lsp-python-getting-started.html">https://www.mattduck.com/lsp-python-getting-started.html</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">lsp-mode</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> lsp-headerline-breadcrumb-enable t
        gc-cons-threshold (* 100 1024 1024)
        read-process-output-max (* 1024 1024)
        company-idle-delay 0.0
        company-minimum-prefix-length 1
        create-lockfiles nil <span class="org-comment-delimiter">;; </span><span class="org-comment">lock files will kill `npm start'</span>
        )
  (lsp-register-custom-settings
   '((<span class="org-string">"pyls.plugins.pyls_mypy.enabled"</span> t t)
     (<span class="org-string">"pyls.plugins.pyls_mypy.live_mode"</span> nil t)
     (<span class="org-string">"pyls.plugins.pyls_black.enabled"</span> t t)
     (<span class="org-string">"pyls.plugins.pyls_isort.enabled"</span> t t)))
  <span class="org-builtin">:hook</span> ((prog-mode-hook . lsp)
         (python-mode . lsp)
         (lsp-mode-hook . lsp-enable-which-key-integration)))
(<span class="org-keyword">use-package</span> <span class="org-constant">lsp-ui</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:commands</span> lsp-ui-mode
  <span class="org-builtin">:after</span> lsp-mode)
(<span class="org-keyword">use-package</span> <span class="org-constant">dap-mode</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:after</span> lsp-mode)
</pre>
</div>
</div>
</div>
<div id="outline-container-org8931e6a" class="outline-4">
<h4 id="org8931e6a">Tab width of 2 is compact and readable</h4>
<div class="outline-text-4" id="text-org8931e6a">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq-default</span> tab-width 2)
</pre>
</div>
</div>
</div>

<div id="outline-container-org289d442" class="outline-4">
<h4 id="org289d442">More indentation things</h4>
<div class="outline-text-4" id="text-org289d442">
<p>
From <a href="https://github.com/purcell/emacs.d/blob/master/lisp/init-editing-utils.el">https://github.com/purcell/emacs.d/blob/master/lisp/init-editing-utils.el</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">sanityinc/kill-back-to-indentation</span> ()
  <span class="org-doc">"Kill from point back to the first non-whitespace character on the line."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((prev-pos (point)))
    (back-to-indentation)
    (kill-region (point) prev-pos)))
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-M-&lt;backspace&gt;"</span> 'sanityinc/kill-back-to-indentation)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc2ce225" class="outline-4">
<h4 id="orgc2ce225">Adapt to being on Windows</h4>
<div class="outline-text-4" id="text-orgc2ce225">
<p>
I'm on Windows, so I use Cygwin to add Unix-y tools to make my life easier.
These config snippets seem to help too.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">when</span> (eq system-type 'windows-nt)
  (setenv <span class="org-string">"CYGWIN"</span> <span class="org-string">"nodosfilewarning"</span>)
  (<span class="org-keyword">setq</span> shell-file-name <span class="org-string">"C:/emacs/libexec/emacs/24.4/i686-pc-mingw32/cmdproxy.exe"</span>)
  (add-hook 'comint-output-filter-functions 'shell-strip-ctrl-m nil t)
  (add-hook 'comint-output-filter-functions 'comint-watch-for-password-prompt nil t))
</pre>
</div>
</div>
</div>

<div id="outline-container-org315e934" class="outline-4">
<h4 id="org315e934">Expand region</h4>
<div class="outline-text-4" id="text-org315e934">
<p>
This is something I have to get the hang of too. It gradually expands the selection. Handy for Emacs Lisp.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">expand-region</span>
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:bind</span> (<span class="org-string">"C-="</span> . er/expand-region)
  (<span class="org-string">"C-&lt;prior&gt;"</span> . er/expand-region)
  (<span class="org-string">"C-&lt;next&gt;"</span> . er/contract-region))
</pre>
</div>
</div>
</div>

<div id="outline-container-org442fa53" class="outline-4">
<h4 id="org442fa53">Compilation</h4>
<div class="outline-text-4" id="text-org442fa53">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(eval-after-load 'python-mode
  '(bind-key <span class="org-string">"C-c C-c"</span> 'compile python-mode-map))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb9b5618" class="outline-4">
<h4 id="orgb9b5618">Emacs Lisp</h4>
<div class="outline-text-4" id="text-orgb9b5618">
</div>
<div id="outline-container-org5808c46" class="outline-5">
<h5 id="org5808c46">Eldoc</h5>
<div class="outline-text-5" id="text-org5808c46">
<p>
Eldoc provides minibuffer hints when working with Emacs Lisp.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-string">"eldoc"</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:diminish</span> eldoc-mode
  <span class="org-builtin">:commands</span> turn-on-eldoc-mode
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:init</span>
  (<span class="org-keyword">progn</span>
    (add-hook 'emacs-lisp-mode-hook 'turn-on-eldoc-mode)
    (add-hook 'lisp-interaction-mode-hook 'turn-on-eldoc-mode)
    (add-hook 'ielm-mode-hook 'turn-on-eldoc-mode)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org10cd4dd" class="outline-5">
<h5 id="org10cd4dd">Refactoring&#xa0;&#xa0;&#xa0;<span class="tag"><span class="drill">drill</span></span></h5>
<div class="outline-text-5" id="text-org10cd4dd">
<p>
More things that I need to get used to&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">C-c C-v l : elint current buffer in clean environment.</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">C-c C-v L : elint current buffer by multiple emacs binaries.</span>
<span class="org-comment-delimiter">;;             </span><span class="org-comment">See `</span><span class="org-comment"><span class="org-constant">erefactor-lint-emacsen</span></span><span class="org-comment">'</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">C-c C-v r : Rename symbol in current buffer.</span>
<span class="org-comment-delimiter">;;             </span><span class="org-comment">Resolve `</span><span class="org-comment"><span class="org-constant">let</span></span><span class="org-comment">' binding as long as i can.</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">C-c C-v R : Rename symbol in requiring modules and current buffer.</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">C-c C-v h : Highlight current symbol in this buffer</span>
<span class="org-comment-delimiter">;;             </span><span class="org-comment">and suppress `</span><span class="org-comment"><span class="org-constant">erefacthr-highlight-mode</span></span><span class="org-comment">'.</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">C-c C-v d : Dehighlight all by above command.</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">C-c C-v c : Switch prefix bunch of symbols.</span>
<span class="org-comment-delimiter">;;             </span><span class="org-comment">ex: '(hoge-var hoge-func) -&gt; '(foo-var foo-func)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">C-c C-v ? : Display flymake elint warnings/errors</span>

(<span class="org-keyword">use-package</span> <span class="org-constant">erefactor</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> emacs-lisp-mode-map (<span class="org-string">"C-c C-v"</span> . erefactor-map)))

(<span class="org-keyword">use-package</span> <span class="org-constant">paredit</span> 
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:hook</span> (emacs-lisp-mode . paredit-mode))
(<span class="org-keyword">use-package</span> <span class="org-constant">redshank</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:disabled</span> t
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:init</span> (add-hook 'emacs-lisp-mode-hook 'redshank-mode))

</pre>
</div>
</div>
</div>

<div id="outline-container-org4638c6a" class="outline-5">
<h5 id="org4638c6a">Jumping to code</h5>
<div class="outline-text-5" id="text-org4638c6a">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(define-key emacs-lisp-mode-map (kbd <span class="org-string">"C-c ."</span>) 'find-function-at-point)
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-c f"</span> 'find-function)
</pre>
</div>
</div>
</div>

<div id="outline-container-org0941808" class="outline-5">
<h5 id="org0941808">Sorting</h5>
<div class="outline-text-5" id="text-org0941808">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/sort-sexps-in-region</span> (beg end)
  <span class="org-doc">"Can be handy for sorting out duplicates.</span>
<span class="org-doc">       Sorts the sexps from BEG to END. Leaves the point at where it</span>
<span class="org-doc">       couldn't figure things out (ex: syntax errors)."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">let</span> ((input (buffer-substring beg end))
        list last-point form result)
    (<span class="org-keyword">save-restriction</span>
      (<span class="org-keyword">save-excursion</span>
        (narrow-to-region beg end)
        (goto-char (point-min))
        (<span class="org-keyword">setq</span> last-point (point-min))
        (<span class="org-keyword">setq</span> form t)
        (<span class="org-keyword">while</span> (<span class="org-keyword">and</span> form (not (eobp)))
          (<span class="org-keyword">setq</span> form (<span class="org-keyword">ignore-errors</span> (read (current-buffer))))
          (<span class="org-keyword">when</span> form
            (add-to-list
             'list
             (cons
              (prin1-to-string form)
              (buffer-substring last-point (point))))
            (<span class="org-keyword">setq</span> last-point (point))))
        (<span class="org-keyword">setq</span> list (sort list (<span class="org-keyword">lambda</span> (a b) (string&lt; (car a) (car b)))))
        (delete-region (point-min) (point))
        (insert (mapconcat 'cdr list <span class="org-string">"\n"</span>))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org6c2d485" class="outline-5">
<h5 id="org6c2d485">Evaluation</h5>
<div class="outline-text-5" id="text-org6c2d485">
<p>
Borrowed from Steve Purcell's config. This pretty-prints the results.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">bind-key</span> <span class="org-string">"M-:"</span> 'pp-eval-expression)

(<span class="org-keyword">defun</span> <span class="org-function-name">sanityinc/eval-last-sexp-or-region</span> (prefix)
  <span class="org-doc">"Eval region from BEG to END if active, otherwise the last sexp."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"P"</span>)
  (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (mark) (use-region-p))
      (eval-region (min (point) (mark)) (max (point) (mark)))
    (pp-eval-last-sexp prefix)))

(<span class="org-keyword">bind-key</span> <span class="org-string">"C-x C-e"</span> 'sanityinc/eval-last-sexp-or-region emacs-lisp-mode-map)
</pre>
</div>
</div>
</div>

<div id="outline-container-org1f25502" class="outline-5">
<h5 id="org1f25502">Stubbing</h5>
<div class="outline-text-5" id="text-org1f25502">
<p>
From <a href="https://ag91.github.io/blog/2020/12/31/top-down-elisping-a-simple-snippet-to-stub-a-function-while-your-are-designing-your-code/">https://ag91.github.io/blog/2020/12/31/top-down-elisping-a-simple-snippet-to-stub-a-function-while-your-are-designing-your-code/</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/stub-elisp-defun</span> ()
  <span class="org-doc">"Stub an elisp function from symbol at point."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let*</span> ((fun (thing-at-point 'list 'no-properties)))
    (<span class="org-keyword">when</span> fun
      (<span class="org-keyword">let*</span> ((fun-list (car (read-from-string fun)))
             (name (symbol-name (nth 0 fun-list)))
             (args (cdr fun-list)))
        (<span class="org-keyword">save-excursion</span>
          (<span class="org-keyword">or</span> (search-backward <span class="org-string">"(defun"</span> nil 't) (goto-char (point-min)))
          (insert
           (s-concat
            <span class="org-string">"(defun "</span>
            name
            <span class="org-string">" "</span>
            (format <span class="org-string">"%s"</span> (<span class="org-keyword">--map</span> (s-concat <span class="org-string">"arg"</span> (number-to-string it)) (number-sequence 1 (length args))))
            <span class="org-string">"\n  \"SomeDocs\"\n  nil)\n\n"</span>)))))))

(<span class="org-keyword">bind-key</span> <span class="org-string">"C-:"</span> #'my/stub-elisp-defun emacs-lisp-mode-map)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orga359a03" class="outline-4">
<h4 id="orga359a03">Snippets</h4>
<div class="outline-text-4" id="text-orga359a03">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">yasnippet</span>
  <span class="org-builtin">:diminish</span> yas-minor-mode
  <span class="org-builtin">:init</span> (yas-global-mode)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">progn</span>
    (yas-global-mode)
    (add-hook 'hippie-expand-try-functions-list 'yas-hippie-try-expand)
    (<span class="org-keyword">setq</span> yas-key-syntaxes '(<span class="org-string">"w_"</span> <span class="org-string">"w_."</span> <span class="org-string">"^ "</span>))
    (<span class="org-keyword">setq</span> yas-installed-snippets-dir <span class="org-string">"~/elisp/yasnippet-snippets"</span>)
    (<span class="org-keyword">setq</span> yas-expand-only-for-last-commands nil)
    (yas-global-mode 1)
    (<span class="org-keyword">bind-key</span> <span class="org-string">"\t"</span> 'hippie-expand yas-minor-mode-map)
    (add-to-list 'yas-prompt-functions 'shk-yas/helm-prompt)))
<span class="org-comment-delimiter">;;        </span><span class="org-comment">(global-set-key (kbd "C-c y") (lambda () (interactive)</span>
<span class="org-comment-delimiter">;;                                         </span><span class="org-comment">(yas/load-directory "~/elisp/snippets")))</span>
</pre>
</div>

<p>
From <a href="http://emacswiki.org/emacs/Yasnippet">http://emacswiki.org/emacs/Yasnippet</a>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">shk-yas/helm-prompt</span> (prompt choices <span class="org-type">&amp;optional</span> display-fn)
  <span class="org-doc">"Use helm to select a snippet. Put this into `</span><span class="org-doc"><span class="org-constant">yas/prompt-functions.</span></span><span class="org-doc">'"</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">setq</span> display-fn (<span class="org-keyword">or</span> display-fn 'identity))
  (<span class="org-keyword">if</span> (<span class="org-keyword">require</span> '<span class="org-constant">helm-config</span>)
      (<span class="org-keyword">let</span> (tmpsource cands result rmap)
        (<span class="org-keyword">setq</span> cands (mapcar (<span class="org-keyword">lambda</span> (x) (funcall display-fn x)) choices))
        (<span class="org-keyword">setq</span> rmap (mapcar (<span class="org-keyword">lambda</span> (x) (cons (funcall display-fn x) x)) choices))
        (<span class="org-keyword">setq</span> tmpsource
              (list
               (cons 'name prompt)
               (cons 'candidates cands)
               '(action . ((<span class="org-string">"Expand"</span> . (<span class="org-keyword">lambda</span> (selection) selection))))
               ))
        (<span class="org-keyword">setq</span> result (helm-other-buffer '(tmpsource) <span class="org-string">"*helm-select-yasnippet"</span>))
        (<span class="org-keyword">if</span> (null result)
            (<span class="org-warning">signal</span> 'quit <span class="org-string">"user quit!"</span>)
          (cdr (assoc result rmap))))
    nil))
</pre>
</div>

<p>
From <a href="https://github.com/pcmantz/elisp/blob/master/my-bindings.el">https://github.com/pcmantz/elisp/blob/master/my-bindings.el</a>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> default-cursor-color <span class="org-string">"gray"</span>)
(<span class="org-keyword">setq</span> yasnippet-can-fire-cursor-color <span class="org-string">"purple"</span>)

<span class="org-comment-delimiter">;; </span><span class="org-comment">It will test whether it can expand, if yes, cursor color -&gt; green.</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">yasnippet-can-fire-p</span> (<span class="org-type">&amp;optional</span> field)
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">setq</span> yas--condition-cache-timestamp (current-time))
  (<span class="org-keyword">let</span> (templates-and-pos)
    (<span class="org-keyword">unless</span> (<span class="org-keyword">and</span> yas-expand-only-for-last-commands
                 (not (member last-command yas-expand-only-for-last-commands)))
      (<span class="org-keyword">setq</span> templates-and-pos (<span class="org-keyword">if</span> field
                                  (<span class="org-keyword">save-restriction</span>
                                    (narrow-to-region (yas--field-start field)
                                                      (yas--field-end field))
                                    (yas--templates-for-key-at-point))
                                (yas--templates-for-key-at-point))))
    (<span class="org-keyword">and</span> templates-and-pos (first templates-and-pos))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/change-cursor-color-when-can-expand</span> (<span class="org-type">&amp;optional</span> field)
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">when</span> (eq last-command 'self-insert-command)
    (set-cursor-color (<span class="org-keyword">if</span> (my/can-expand)
                          yasnippet-can-fire-cursor-color
                        default-cursor-color))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/can-expand</span> ()
  <span class="org-doc">"Return true if right after an expandable thing."</span>
  (<span class="org-keyword">or</span> (abbrev--before-point) (yasnippet-can-fire-p)))

                                        <span class="org-comment-delimiter">; </span><span class="org-comment">As pointed out by Dmitri, this will make sure it will update color when needed.</span>
(remove-hook 'post-command-hook 'my/change-cursor-color-when-can-expand)

(<span class="org-keyword">defun</span> <span class="org-function-name">my/insert-space-or-expand</span> ()
  <span class="org-doc">"For binding to the SPC SPC keychord."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">condition-case</span> nil (<span class="org-keyword">or</span> (my/hippie-expand-maybe nil) (insert <span class="org-string">"  "</span>))))
</pre>
</div>

<p>
This requires me to modify the behaviour of hippie-expand so that it doesn't ding so much.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/hippie-expand-maybe</span> (arg)
  <span class="org-doc">"Try to expand text before point, using multiple methods.</span>
<span class="org-doc">      The expansion functions in `</span><span class="org-doc"><span class="org-constant">hippie-expand-try-functions-list</span></span><span class="org-doc">' are</span>
<span class="org-doc">      tried in order, until a possible expansion is found.  Repeated</span>
<span class="org-doc">      application of `</span><span class="org-doc"><span class="org-constant">hippie-expand</span></span><span class="org-doc">' inserts successively possible</span>
<span class="org-doc">      expansions.</span>
<span class="org-doc">      With a positive numeric argument, jumps directly to the ARG next</span>
<span class="org-doc">      function in this list.  With a negative argument or just \\[</span><span class="org-doc"><span class="org-constant">universal-argument</span></span><span class="org-doc">],</span>
<span class="org-doc">      undoes the expansion."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"P"</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">hippie-exp</span>)
  (<span class="org-keyword">if</span> (<span class="org-keyword">or</span> (not arg)
          (<span class="org-keyword">and</span> (integerp arg) (&gt; arg 0)))
      (<span class="org-keyword">let</span> ((first (<span class="org-keyword">or</span> (= he-num -1)
                       (not (equal this-command last-command)))))
        (<span class="org-keyword">if</span> first
            (<span class="org-keyword">progn</span>
              (<span class="org-keyword">setq</span> he-num -1)
              (<span class="org-keyword">setq</span> he-tried-table nil)))
        (<span class="org-keyword">if</span> arg
            (<span class="org-keyword">if</span> (not first) (he-reset-string))
          (<span class="org-keyword">setq</span> arg 0))
        (<span class="org-keyword">let</span> ((i (max (+ he-num arg) 0)))
          (<span class="org-keyword">while</span> (not (<span class="org-keyword">or</span> (&gt;= i (length hippie-expand-try-functions-list))
                          (apply (nth i hippie-expand-try-functions-list)
                                 (list (= he-num i)))))
            (<span class="org-keyword">setq</span> i (1+ i)))
          (<span class="org-keyword">setq</span> he-num i))
        (<span class="org-keyword">if</span> (&gt;= he-num (length hippie-expand-try-functions-list))
            (<span class="org-keyword">progn</span> (<span class="org-keyword">setq</span> he-num -1) nil)
          (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> hippie-expand-verbose
                   (not (window-minibuffer-p)))
              (message <span class="org-string">"Using %s"</span>
                       (nth he-num hippie-expand-try-functions-list)))))
    (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (&gt;= he-num 0)
             (eq (marker-buffer he-string-beg) (current-buffer)))
        (<span class="org-keyword">progn</span>
          (<span class="org-keyword">setq</span> he-num -1)
          (he-reset-string)
          (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> hippie-expand-verbose
                   (not (window-minibuffer-p)))
              (message <span class="org-string">"Undoing expansions"</span>))))))

</pre>
</div>

<p>
yas/expand
yas-expand
</p>

<p>
because
because
Because
</p>
</div>
</div>

<div id="outline-container-org2c8f56d" class="outline-4">
<h4 id="org2c8f56d">Show column number</h4>
<div class="outline-text-4" id="text-org2c8f56d">
<p>
I sometimes need to know where I am in a line.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(column-number-mode 1)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdc5d08d" class="outline-4">
<h4 id="orgdc5d08d">Don't show whitespace in diff, but show context</h4>
<div class="outline-text-4" id="text-orgdc5d08d">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> vc-diff-switches '(<span class="org-string">"-b"</span> <span class="org-string">"-B"</span> <span class="org-string">"-u"</span>))
(<span class="org-keyword">setq</span> vc-git-diff-switches nil)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcc4c7bd" class="outline-4">
<h4 id="orgcc4c7bd">Javascript</h4>
<div class="outline-text-4" id="text-orgcc4c7bd">
<p>
I like js2-mode.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-to-list 'auto-mode-alist '(<span class="org-string">"\\.js\\'</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">\\.json\\'"</span> . js2-mode))
</pre>
</div>

<p>
Handy shortcuts:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">js2-mode</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:mode</span> <span class="org-string">"\\.js\\'"</span>
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> js2-mode-map (<span class="org-string">"C-c C-c"</span> . projectile-compile-project)))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">coffee-mode</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:mode</span> <span class="org-string">"\\.coffee\\'"</span>
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> coffee-mode-map (<span class="org-string">"C-c C-c"</span> . compile)))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">jasminejs-mode</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:after</span> js2-mode
  <span class="org-builtin">:hook</span> ((js2-mode . jasminejs-mode)
         (jasminejs-mode-hook . jasminejs-add-snippets-to-yas-snippet-dirs)))
</pre>
</div>

<p>
This makes script blocks easier to copy:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/javascript-test-regexp</span> (concat (regexp-quote <span class="org-string">"/** Testing **/"</span>) <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*\n</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">*"</span>)
  <span class="org-doc">"Regular expression matching testing-related code to remove.</span>
<span class="org-doc">      See `</span><span class="org-doc"><span class="org-constant">my/copy-javascript-region-or-buffer</span></span><span class="org-doc">'."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my/copy-javascript-region-or-buffer</span> (beg end)
  <span class="org-doc">"Copy the active region or the buffer, wrapping it in script tags.</span>
<span class="org-doc">      Add a comment with the current filename and skip test-related</span>
<span class="org-doc">      code. See `</span><span class="org-doc"><span class="org-constant">my/javascript-test-regexp</span></span><span class="org-doc">' to change the way</span>
<span class="org-doc">      test-related code is detected."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">unless</span> (region-active-p)
    (<span class="org-keyword">setq</span> beg (point-min) end (point-max)))
  (kill-new
   (concat
    <span class="org-string">"&lt;script type=\"text/javascript\"&gt;\n"</span>
    (<span class="org-keyword">if</span> (buffer-file-name) (concat <span class="org-string">"// "</span> (file-name-nondirectory (buffer-file-name)) <span class="org-string">"\n"</span>) <span class="org-string">""</span>)
    (replace-regexp-in-string
     my/javascript-test-regexp
     <span class="org-string">""</span>
     (buffer-substring (point-min) (point-max))
     nil)
    <span class="org-string">"\n&lt;/script&gt;"</span>)))
</pre>
</div>

<p>
This makes it easier to debug:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/debug-counter</span> 1)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/insert-or-flush-debug</span> (<span class="org-type">&amp;optional</span> reset beg end)
  (<span class="org-keyword">interactive</span> <span class="org-string">"pr"</span>)
  (<span class="org-keyword">cond</span>
   ((= reset 4)
    (<span class="org-keyword">save-excursion</span>
      (flush-lines <span class="org-string">"console.log('DEBUG: [0-9]+"</span> (point-min) (point-max))
      (<span class="org-keyword">setq</span> my/debug-counter 1)))
   ((region-active-p)
    (<span class="org-keyword">save-excursion</span>
      (goto-char end)
      (insert <span class="org-string">");\n"</span>)
      (goto-char beg)
      (insert (format <span class="org-string">"console.log('DEBUG: %d', "</span> my/debug-counter))
      (<span class="org-keyword">setq</span> my/debug-counter (1+ my/debug-counter))
      (js2-indent-line)))
   (t
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Wrap the region in the debug</span>
    (insert (format <span class="org-string">"console.log('DEBUG: %d');\n"</span> my/debug-counter))
    (<span class="org-keyword">setq</span> my/debug-counter (1+ my/debug-counter))
    (backward-char 3)
    (js2-indent-line))))
</pre>
</div>

<p>
And the rest of the js2 config:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">js2-mode</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:commands</span> js2-mode
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:interpreter</span> <span class="org-string">"node"</span>
  <span class="org-builtin">:init</span> (<span class="org-keyword">setq</span> js2-basic-offset 2)
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> js2-mode-map
              (<span class="org-string">"C-x C-e"</span> . js-send-last-sexp)
              (<span class="org-string">"C-M-x"</span> . js-send-last-sexp-and-go)
              (<span class="org-string">"C-c b"</span> . js-send-buffer)
              (<span class="org-string">"C-c d"</span> . my/insert-or-flush-debug)
              (<span class="org-string">"C-c C-b"</span> . js-send-buffer-and-go)
              (<span class="org-string">"C-c w"</span> . my/copy-javascript-region-or-buffer))
  <span class="org-builtin">:config</span> (js2-imenu-extras-setup))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">coffee-mode</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:config</span> (<span class="org-keyword">setq-default</span> coffee-js-mode 'js2-mode coffee-tab-width 2))
</pre>
</div>
</div>

<div id="outline-container-org28c05cc" class="outline-5">
<h5 id="org28c05cc">React</h5>
<div class="outline-text-5" id="text-org28c05cc">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">rjsx-mode</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-comment-delimiter">;</span><span class="org-comment">:mode "\\.js\\'"</span>
  <span class="org-builtin">:config</span> (<span class="org-keyword">setq</span> js2-basic-offset 2))

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7b89afb" class="outline-4">
<h4 id="org7b89afb">HTML</h4>
<div class="outline-text-4" id="text-org7b89afb">
<p>
Convenience function for getting rid of annoying spans
offby1 says there's (setq nxml-sexp-element-flag t)
</p>

<p>
&lt;span&gt;&lt;span&gt;Hello world&lt;/span&gt;&lt;/span&gt;
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/clean-up-spans-in-region</span> (beg end)
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">let</span> ((changed t))
      (<span class="org-keyword">while</span> changed
        (<span class="org-keyword">setq</span> changed nil)
        (goto-char beg)
        (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;span&gt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&lt;]*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&lt;/span&gt;"</span> end t)
          (replace-match <span class="org-string">"\\1"</span>)
          (<span class="org-keyword">setq</span> changed t)))
      (<span class="org-keyword">setq</span> changed t)
      (<span class="org-keyword">while</span> changed
        (<span class="org-keyword">setq</span> changed nil)
        (goto-char beg)
        (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;span&gt;*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">&lt;a[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&lt;]+&gt;[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&lt;]*&lt;/a&gt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&lt;/span&gt;"</span> end t)
          (replace-match <span class="org-string">"\\1"</span>)
          (<span class="org-keyword">setq</span> changed t))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/clean-up-spans-in-string</span> (string)
  (<span class="org-keyword">with-temp-buffer</span>
    (insert string)
    (my/clean-up-spans-in-region (point-min) (point-max))
    (buffer-string)))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my/clean-up-spans-in-string</span> ()
  (<span class="org-keyword">should</span> (string= (my/clean-up-spans-in-string <span class="org-string">"&lt;span&gt;&lt;span&gt;Hello world&lt;/span&gt;&lt;/span&gt;"</span>)
                   <span class="org-string">"Hello world"</span>))
  (<span class="org-keyword">should</span> (string= (my/clean-up-spans-in-string <span class="org-string">"&lt;span&gt;&lt;span&gt;&lt;a href=\"http://example.com\"&gt;Hello another world&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;"</span>)
                   <span class="org-string">"&lt;a href=\"http://example.com\"&gt;Hello another world&lt;/a&gt;"</span>))
  (<span class="org-keyword">should</span> (string= (my/clean-up-spans-in-string <span class="org-string">"&lt;span&gt;&lt;h1&gt;Leave alone&lt;/h1&gt;&lt;/span&gt;"</span>) <span class="org-string">"&lt;span&gt;&lt;h1&gt;Leave alone&lt;/h1&gt;&lt;/span&gt;"</span>))
  (<span class="org-keyword">should</span> (string= (my/clean-up-spans-in-string <span class="org-string">"&lt;span&gt;&lt;a href=\"http://example.com\"&gt;Leave&lt;/a&gt; alone&lt;/span&gt;"</span>)
                   <span class="org-string">"&lt;span&gt;&lt;a href=\"http://example.com\"&gt;Leave&lt;/a&gt; alone&lt;/span&gt;"</span>)))

<span class="org-comment-delimiter">;; </span><span class="org-comment">(ert "my/clean-up-spans-in-string")</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-magit" class="outline-4">
<h4 id="magit">Magit - nice git interface</h4>
<div class="outline-text-4" id="text-magit">
<p>
<a id="org34196ff"></a>
</p>

<p>
Thanks to sheijk for hints on tweaking magit to limit it to the current directory!
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/magit-stage-all-and-commit</span> (message)
  (<span class="org-keyword">interactive</span> (list (<span class="org-keyword">progn</span> (magit-diff-unstaged) (read-string <span class="org-string">"Commit Message: "</span>))))
  (magit-stage-modified)
  (magit-commit-create (list <span class="org-string">"-m"</span> message))
  (call-interactively #'magit-push-current-to-pushremote))
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/magit-limit-to-directory</span> nil <span class="org-doc">"Limit magit status to a specific directory."</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/magit-status-in-directory</span> (directory)
  <span class="org-doc">"Displays magit status limited to DIRECTORY.</span>
<span class="org-doc">Uses the current `</span><span class="org-doc"><span class="org-constant">default-directory</span></span><span class="org-doc">', or prompts for a directory</span>
<span class="org-doc">if called with a prefix argument. Sets `</span><span class="org-doc"><span class="org-constant">my/magit-limit-to-directory</span></span><span class="org-doc">'</span>
<span class="org-doc">so that it's still active even after you stage a change. Very experimental."</span>
  (<span class="org-keyword">interactive</span> (list (expand-file-name
                        (<span class="org-keyword">if</span> current-prefix-arg
                            (read-directory-name <span class="org-string">"Directory: "</span>)
                          default-directory))))
    (<span class="org-keyword">setq</span> my/magit-limit-to-directory directory)
    (magit-status directory))
(<span class="org-keyword">use-package</span> <span class="org-constant">magit</span>
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> magit-diff-options '(<span class="org-string">"-b"</span>)) <span class="org-comment-delimiter">; </span><span class="org-comment">ignore whitespace</span>
  (<span class="org-keyword">defadvice</span> <span class="org-function-name">magit-insert-untracked-files</span> (around sacha activate)
    (<span class="org-keyword">if</span> my/magit-limit-to-directory
        (magit-with-section (section untracked 'untracked <span class="org-string">"Untracked files:"</span> t)
                            (<span class="org-keyword">let</span> ((files (cl-mapcan
                                          (<span class="org-keyword">lambda</span> (f)
                                            (<span class="org-keyword">when</span> (eq (aref f 0) ??) (list f)))
                                          (magit-git-lines
                                           <span class="org-string">"status"</span> <span class="org-string">"--porcelain"</span> <span class="org-string">"--"</span> my/magit-limit-to-directory))))
                              (<span class="org-keyword">if</span> (not files)
                                  (<span class="org-keyword">setq</span> section nil)
                                (<span class="org-keyword">dolist</span> (file files)
                                  (<span class="org-keyword">setq</span> file (magit-decode-git-path (substring file 3)))
                                  (magit-with-section (section file file)
                                                      (insert <span class="org-string">"\t"</span> file <span class="org-string">"\n"</span>)))
                                (insert <span class="org-string">"\n"</span>))))
      ad-do-it))

  (<span class="org-keyword">defadvice</span> <span class="org-function-name">magit-insert-unstaged-changes</span> (around sacha activate)
    (<span class="org-keyword">if</span> my/magit-limit-to-directory
        (<span class="org-keyword">let</span> ((magit-current-diff-range (cons 'index 'working))
              (magit-diff-options (copy-sequence magit-diff-options)))
          (magit-git-insert-section (unstaged <span class="org-string">"Unstaged changes:"</span>)
                                    #'magit-wash-raw-diffs
                                    <span class="org-string">"diff-files"</span>
                                    <span class="org-string">"--"</span> my/magit-limit-to-directory
                                    ))
      ad-do-it))

  (<span class="org-keyword">defadvice</span> <span class="org-function-name">magit-insert-staged-changes</span> (around sacha activate)
    <span class="org-doc">"Limit to `</span><span class="org-doc"><span class="org-constant">my/magit-limit-to-directory</span></span><span class="org-doc">' if specified."</span>
    (<span class="org-keyword">if</span> my/magit-limit-to-directory
        (<span class="org-keyword">let</span> ((no-commit (not (magit-git-success <span class="org-string">"log"</span> <span class="org-string">"-1"</span> <span class="org-string">"HEAD"</span>))))
          (<span class="org-keyword">when</span> (<span class="org-keyword">or</span> no-commit (magit-anything-staged-p))
            (<span class="org-keyword">let</span> ((magit-current-diff-range (cons <span class="org-string">"HEAD"</span> 'index))
                  (base (<span class="org-keyword">if</span> no-commit
                            (magit-git-string <span class="org-string">"mktree"</span>)
                          <span class="org-string">"HEAD"</span>))
                  (magit-diff-options (append '(<span class="org-string">"--cached"</span>) magit-diff-options)))
              (magit-git-insert-section (staged <span class="org-string">"Staged changes:"</span>)
                                        (apply-partially #'magit-wash-raw-diffs t)
                                        <span class="org-string">"diff-index"</span> <span class="org-string">"--cached"</span> base <span class="org-string">"--"</span> my/magit-limit-to-directory))))
      ad-do-it))
  <span class="org-builtin">:bind</span> ((<span class="org-string">"C-x v C-d"</span> . my/magit-status-in-directory)
         (<span class="org-string">"C-c g"</span> . magit-file-dispatch)
         (<span class="org-string">"C-x g"</span> . magit-status)
         (<span class="org-string">"C-x v p"</span> . magit-push)
         (<span class="org-string">"C-x v c"</span> . my/magit-stage-all-and-commit)))

<span class="org-comment-delimiter">;; </span><span class="org-comment">;; From http://endlessparentheses.com/merging-github-pull-requests-from-emacs.html</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">(defun endless/load-gh-pulls-mode ()</span>
<span class="org-comment-delimiter">;;   </span><span class="org-comment">"Start `</span><span class="org-comment"><span class="org-constant">magit-gh-pulls-mode</span></span><span class="org-comment">' only after a manual request."</span>
<span class="org-comment-delimiter">;;   </span><span class="org-comment">(interactive)</span>
<span class="org-comment-delimiter">;;   </span><span class="org-comment">(require 'magit-gh-pulls)</span>
<span class="org-comment-delimiter">;;   </span><span class="org-comment">(add-hook 'magit-mode-hook 'turn-on-magit-gh-pulls)</span>
<span class="org-comment-delimiter">;;   </span><span class="org-comment">(magit-gh-pulls-mode 1)</span>
<span class="org-comment-delimiter">;;   </span><span class="org-comment">(magit-gh-pulls-reload))</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">(use-package magit-gh-pulls)</span>
</pre>
</div>

<p>
The proper way to implement this is probably to patch or override the
definition of magit-git-insert-section so that it takes a list of
options to add at the end of the command, but that can wait for another time (or braver souls).
</p>
</div>

<div id="outline-container-org4e260e9" class="outline-5">
<h5 id="org4e260e9"><span class="todo TODO">TODO</span> Make this better by adding a post command options variable</h5>
</div>
</div>
<div id="outline-container-org369b372" class="outline-4">
<h4 id="org369b372">Checking things out</h4>
<div class="outline-text-4" id="text-org369b372">
<p>
Based on <a href="http://xenodium.com/emacs-clone-git-repo-from-clipboard/">http://xenodium.com/emacs-clone-git-repo-from-clipboard/</a> :
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/git-clone-destination</span> <span class="org-string">"~/vendor"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/git-clone-clipboard-url</span> ()
  <span class="org-doc">"Clone git URL in clipboard asynchronously and open in dired when finished."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-warning">cl-assert</span> (string-match-p <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">http</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">https</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">ssh</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">://"</span> (current-kill 0)) nil <span class="org-string">"No URL in clipboard"</span>)
  (<span class="org-keyword">let*</span> ((url (current-kill 0))
         (download-dir (expand-file-name my/git-clone-destination))
         (project-dir (concat (file-name-as-directory download-dir)
                              (file-name-base url)))
         (default-directory download-dir)
         (command (format <span class="org-string">"git clone %s"</span> url))
         (buffer (generate-new-buffer (format <span class="org-string">"*%s*"</span> command)))
         (proc))
    (<span class="org-keyword">when</span> (file-exists-p project-dir)
      (<span class="org-keyword">if</span> (y-or-n-p (format <span class="org-string">"%s exists. delete?"</span> (file-name-base url)))
          (delete-directory project-dir t)
        (<span class="org-warning">user-error</span> <span class="org-string">"Bailed"</span>)))
    (switch-to-buffer buffer)
    (<span class="org-keyword">setq</span> proc (start-process-shell-command (nth 0 (split-string command)) buffer command))
    (<span class="org-keyword">with-current-buffer</span> buffer
      (<span class="org-keyword">setq</span> default-directory download-dir)
      (shell-command-save-pos-or-erase)
      (<span class="org-keyword">require</span> '<span class="org-constant">shell</span>)
      (shell-mode)
      (view-mode +1))
    (set-process-sentinel proc (<span class="org-keyword">lambda</span> (process state)
                                 (<span class="org-keyword">let</span> ((output (<span class="org-keyword">with-current-buffer</span> (process-buffer process)
                                                 (buffer-string))))
                                   (kill-buffer (process-buffer process))
                                   (<span class="org-keyword">if</span> (= (process-exit-status process) 0)
                                       (<span class="org-keyword">progn</span>
                                         (message <span class="org-string">"finished: %s"</span> command)
                                         (dired project-dir))
                                     (<span class="org-warning">user-error</span> (format <span class="org-string">"%s\n%s"</span> command output))))))
    (set-process-filter proc #'comint-output-filter)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org68a971b" class="outline-4">
<h4 id="org68a971b">git-messenger - shows commit message</h4>
<div class="outline-text-4" id="text-org68a971b">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">git-messenger</span>
  <span class="org-builtin">:bind</span> ((<span class="org-string">"C-x v m"</span> . git-messenger:popup-message)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgff1c16c" class="outline-4">
<h4 id="orgff1c16c">Tag files</h4>
<div class="outline-text-4" id="text-orgff1c16c">
<p>
I don't often use a TAGS file, but when I do, I don't want to have
to set my tags file per project. I search for it in the directory
tree instead.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/recursive-find-file</span> (file <span class="org-type">&amp;optional</span> directory)
  <span class="org-doc">"Find the first FILE in DIRECTORY or its parents."</span>
  (<span class="org-keyword">setq</span> directory (<span class="org-keyword">or</span> directory (file-name-directory (buffer-file-name)) (pwd)))
  (<span class="org-keyword">if</span> (file-exists-p (expand-file-name file directory))
      (expand-file-name file directory)
    (<span class="org-keyword">unless</span> (string= directory <span class="org-string">"/"</span>)
      (my/recursive-find-file file (expand-file-name <span class="org-string">".."</span> directory)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/find-tags</span> ()
  <span class="org-doc">"Set the TAGS file."</span>
  (set (make-variable-buffer-local 'tags-table-list) nil)
  (set (make-variable-buffer-local 'tags-file-name)
       (my/recursive-find-file <span class="org-string">"TAGS"</span>)))

(eval-after-load 'drupal-mode
  '(<span class="org-keyword">progn</span>
     (add-hook 'drupal-mode-hook 'my/find-tags)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd78f760" class="outline-4">
<h4 id="orgd78f760">Projects</h4>
<div class="outline-text-4" id="text-orgd78f760">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">projectile</span>
  <span class="org-builtin">:diminish</span> projectile-mode
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">progn</span>
    (define-key projectile-mode-map (kbd <span class="org-string">"C-c p"</span>) 'projectile-command-map)
    (projectile-mode +1)
    (<span class="org-keyword">setq</span> projectile-completion-system 'default)
    (<span class="org-keyword">setq</span> projectile-enable-caching t)
    (<span class="org-keyword">setq</span> projectile-indexing-method 'alien)
    (add-to-list 'projectile-globally-ignored-files <span class="org-string">"node-modules"</span>)))
(<span class="org-keyword">use-package</span> <span class="org-constant">helm-projectile</span>
  <span class="org-builtin">:if</span> my/laptop-p)
</pre>
</div>
</div>
</div>

<div id="outline-container-org6150eb2" class="outline-4">
<h4 id="org6150eb2">Exploring MELPA recipes</h4>
<div class="outline-text-4" id="text-org6150eb2">
<div class="org-src-container">
<pre class="src src-emacs-lisp">
</pre>
</div>
</div>
</div>

<div id="outline-container-org46e09d4" class="outline-4">
<h4 id="org46e09d4">Ruby</h4>
<div class="outline-text-4" id="text-org46e09d4">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">rinari</span> <span class="org-builtin">:if</span> my/laptop-p)
(<span class="org-keyword">use-package</span> <span class="org-constant">bundler</span> <span class="org-builtin">:if</span> my/laptop-p)
(<span class="org-keyword">use-package</span> <span class="org-constant">robe</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:hook</span>
  ((ruby-mode-hook . robe-mode)
   (robe-mode-hook . ac-robe-setup)
   (ruby-mode-hook . auto-complete-mode)))
(<span class="org-keyword">use-package</span> <span class="org-constant">haml-mode</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:mode</span> <span class="org-string">"\\.haml\\'"</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/rspec-verify-single</span> ()
  <span class="org-doc">"Runs the specified example at the point of the current buffer."</span>
  (<span class="org-keyword">interactive</span>)
  (rspec-run-single-file
   (concat
    (rspec-spec-file-for (buffer-file-name))
    <span class="org-string">":"</span>
    (<span class="org-keyword">save-restriction</span>
      (widen)
      (number-to-string (line-number-at-pos))))
   (rspec-core-options)))

(<span class="org-keyword">use-package</span> <span class="org-constant">rspec-mode</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">progn</span>
    (<span class="org-keyword">setq</span> rspec-command-options <span class="org-string">"--fail-fast --format documentation"</span>)
    (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c , ,"</span> 'rspec-rerun rspec-mode-map)
    (fset 'rspec-verify-single 'my/rspec-verify-single)))

</pre>
</div>

<p>
SASS
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">sass-mode</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:hook</span> (sass-mode-hook . (<span class="org-keyword">lambda</span> () (<span class="org-keyword">setq</span> indent-tabs-mode nil))))
(<span class="org-keyword">setq-default</span> indent-tabs-mode nil)
</pre>
</div>
</div>
</div>

<div id="outline-container-org9e986b3" class="outline-4">
<h4 id="org9e986b3">Skewer</h4>
<div class="outline-text-4" id="text-org9e986b3">
<p>
This lets you send HTML, CSS, and Javascript fragments to Google
Chrome. You may need to start Chrome with <code>chrome
--allow-running-insecure-content</code>, if you're using the user script
with HTTPS sites.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">skewer-mode</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:hook</span> 
  ((js2-mode-hook . skewer-mode)
   (css-mode-hook . skewer-css-mode)
   (html-mode-hook . skewer-html-mode)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org9571225" class="outline-4">
<h4 id="org9571225">Autocomplete</h4>
<div class="outline-text-4" id="text-org9571225">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">company</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:config</span> (add-hook 'prog-mode-hook 'company-mode))
(<span class="org-keyword">use-package</span> <span class="org-constant">company-posframe</span> <span class="org-builtin">:if</span> my/laptop-p <span class="org-builtin">:init</span> (company-posframe-mode 1) <span class="org-builtin">:diminish</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org00c9ace" class="outline-4">
<h4 id="org00c9ace">Tern - for Javascript</h4>
<div class="outline-text-4" id="text-org00c9ace">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">tern</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> tern-mode-keymap (<span class="org-string">"C-c C-c"</span> . compile))
  <span class="org-builtin">:hook</span> (js2-mode-hook . tern-mode)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">when</span> (eq system-type 'windows-nt) (<span class="org-keyword">setq</span> tern-command '(<span class="org-string">"cmd"</span> <span class="org-string">"/c"</span> <span class="org-string">"tern"</span>))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org9c81b2d" class="outline-4">
<h4 id="org9c81b2d">Docker</h4>
<div class="outline-text-4" id="text-org9c81b2d">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">dockerfile-mode</span>
  <span class="org-builtin">:mode</span> (<span class="org-string">"Dockerfile\\'"</span> . dockerfile-mode))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org232c964" class="outline-3">
<h3 id="org232c964">Internet Relay Chat</h3>
<div class="outline-text-3" id="text-org232c964">
<p>
IRC is a great way to hang out with other Emacs geeks.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">erc</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> erc-hide-list '(<span class="org-string">"PART"</span> <span class="org-string">"QUIT"</span> <span class="org-string">"JOIN"</span>))
  (<span class="org-keyword">setq</span> erc-autojoin-channels-alist '((<span class="org-string">"freenode.net"</span>
                                       <span class="org-string">"#org-mode"</span>
                                       <span class="org-string">"#emacs"</span>
                                       <span class="org-string">"#emacs-beginners"</span>
                                       <span class="org-string">"#emacs-ops"</span>)
                                      (<span class="org-string">"irc.chat.twitch.tv"</span>
                                       <span class="org-string">"#sachachua"</span>))
        erc-server <span class="org-string">"irc.freenode.net"</span>
        erc-nick <span class="org-string">"sachac"</span>
        erc-track '(<span class="org-string">"NICK"</span> <span class="org-string">"333"</span> <span class="org-string">"353"</span> <span class="org-string">"JOIN"</span> <span class="org-string">"PART"</span> <span class="org-string">"AWAY"</span>))
  (<span class="org-keyword">defun</span> <span class="org-function-name">erc-cmd-OPME</span> ()
    <span class="org-doc">"Request chanserv to op me."</span>
    (erc-message <span class="org-string">"PRIVMSG"</span>
                 (format <span class="org-string">"chanserv op %s %s"</span>
                         (erc-default-target)
                         (erc-current-nick)) <span class="org-warning">nil))</span>

  (<span class="org-keyword">defun</span> <span class="org-function-name">erc-cmd-DEOPME</span> ()
    <span class="org-doc">"Deop myself from current channel."</span>
    (erc-cmd-DEOP (format <span class="org-string">"%s"</span> (erc-current-nick))))
  (<span class="org-keyword">defun</span> <span class="org-function-name">erc-cmd-BAN</span> (nick)
    (<span class="org-keyword">let*</span> ((chan (erc-default-target))
           (who (erc-get-server-user nick))
           (host (erc-server-user-host who))
           (user (erc-server-user-login who)))
      (erc-server-send (format <span class="org-string">"MODE %s +b *!%s@%s"</span> chan user host))))

  (<span class="org-keyword">defun</span> <span class="org-function-name">erc-cmd-KICKBAN</span> (nick <span class="org-type">&amp;rest</span> reason)
    (<span class="org-keyword">setq</span> reason (mapconcat #'identity reason <span class="org-string">" "</span>))
    (<span class="org-keyword">and</span> (string= reason <span class="org-string">""</span>)
         (<span class="org-keyword">setq</span> reason nil))
    (erc-cmd-BAN nick)
    (erc-server-send (format <span class="org-string">"KICK %s %s %s"</span>
                             (erc-default-target)
                             nick
                             (<span class="org-keyword">or</span> reason
                                 <span class="org-string">"Kicked (kickban)"</span>))))
  )
</pre>
</div>
</div>
</div>



<div id="outline-container-orgb548069" class="outline-3">
<h3 id="orgb548069">Self-tracking, statistics, and other data transformations</h3>
<div class="outline-text-3" id="text-orgb548069">
</div>
<div id="outline-container-clock-in" class="outline-4">
<h4 id="clock-in">Quantified Awesome</h4>
<div class="outline-text-4" id="text-clock-in">
<p>
<a id="org6a0ee90"></a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defmacro</span> <span class="org-function-name">my/org-with-current-task</span> (<span class="org-type">&amp;rest</span> body)
  <span class="org-doc">"Execute BODY with the point at the subtree of the current task."</span>
  `(<span class="org-keyword">if</span> (derived-mode-p 'org-agenda-mode)
       (<span class="org-keyword">save-window-excursion</span>
         (org-agenda-switch-to)
         ,@body)
     ,@body))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-clock-in-and-track</span> ()
  <span class="org-doc">"Start the clock running. Clock into Quantified Awesome."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">my/org-with-current-task</span>
   (org-clock-in)
   (call-interactively 'my/org-quantified-track)
   (<span class="org-keyword">when</span> (websocket-openp obs-websocket)  (my/stream-message (org-get-heading t t t t)))
   (<span class="org-keyword">cond</span>
    ((org-entry-get (point) <span class="org-string">"AUTO"</span>)
     (org-link-open-from-string (org-entry-get (point) <span class="org-string">"AUTO"</span>)))
    (t
     (<span class="org-keyword">save-restriction</span>
       (org-narrow-to-subtree)
       (org-next-link)
       (<span class="org-keyword">when</span> (looking-at org-link-any-re)
         (org-open-at-point)))))))
(<span class="org-keyword">bind-key</span> <span class="org-string">"!"</span> 'my/org-clock-in-and-track org-agenda-mode-map)

(<span class="org-keyword">defmacro</span> <span class="org-function-name">my/with-org-task</span> (<span class="org-type">&amp;rest</span> body)
  <span class="org-doc">"Run BODY within the current agenda task, clocked task, or cursor task."</span>
  `(<span class="org-keyword">cond</span>
    ((derived-mode-p 'org-agenda-mode)
     (<span class="org-keyword">let*</span> ((marker (org-get-at-bol 'org-marker))
            (buffer (marker-buffer marker))
            (pos (marker-position marker)))
       (<span class="org-keyword">with-current-buffer</span> buffer
         (<span class="org-keyword">save-excursion</span>
           (<span class="org-keyword">save-restriction</span>
             (widen)
             (goto-char pos)
             ,@body)))))
    ((<span class="org-keyword">and</span> (derived-mode-p 'org-mode) (org-at-heading-p)) (<span class="org-keyword">save-excursion</span> ,@body))
    ((org-clocking-p) (<span class="org-keyword">save-excursion</span> (org-clock-goto) ,@body))
    ((derived-mode-p 'org-mode) ,@body)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-quantified-track</span> (<span class="org-type">&amp;optional</span> category note)
  <span class="org-doc">"Create a tracking record using CATEGORY and NOTE.</span>
<span class="org-doc">      Default to the current task in the agenda, the currently-clocked</span>
<span class="org-doc">      entry, or the current subtree in Org."</span>
  (<span class="org-keyword">interactive</span> (list nil nil))
  (<span class="org-keyword">unless</span> (<span class="org-keyword">and</span> category note)
    (<span class="org-keyword">my/with-org-task</span>
     (<span class="org-keyword">setq</span> category (<span class="org-keyword">or</span> category
                        (org-entry-get-with-inheritance <span class="org-string">"QUANTIFIED"</span>)))
     (<span class="org-keyword">cond</span>
      ((null category)
       (<span class="org-keyword">setq</span> category (read-string <span class="org-string">"Category: "</span>))
       (org-set-property <span class="org-string">"QUANTIFIED"</span> category))
      ((string= category <span class="org-string">"ask"</span>)
       (<span class="org-keyword">setq</span> category (read-string <span class="org-string">"Category: "</span>))))
     (<span class="org-keyword">setq</span> note
           (concat
            (<span class="org-keyword">if</span> (string= (<span class="org-keyword">or</span> (org-entry-get-with-inheritance <span class="org-string">"QUANTIFIEDQUIET"</span>) <span class="org-string">""</span>) <span class="org-string">"t"</span>)
                <span class="org-string">"!private "</span>
              <span class="org-string">""</span>)
            (<span class="org-keyword">or</span> note (elt (org-heading-components) 4) (read-string <span class="org-string">"Note: "</span>))))))
  (quantified-track (concat category <span class="org-string">" | "</span> note)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-quick-clock-in-task</span> (location jump)
  <span class="org-doc">"Track and clock in on the specified task.</span>
<span class="org-doc">      If JUMP is non-nil or the function is called with the prefix argument, jump to that location afterwards."</span>
  (<span class="org-keyword">interactive</span> (list (<span class="org-keyword">save-excursion</span> (my/org-refile-get-location <span class="org-string">"Location"</span>)) current-prefix-arg))
  (<span class="org-keyword">when</span> location
    (<span class="org-keyword">if</span> jump
        (<span class="org-keyword">progn</span> (org-refile 4 nil location) (my/org-clock-in-and-track))
      (<span class="org-keyword">save-window-excursion</span>
        (org-refile 4 nil location)
        (my/org-clock-in-and-track)))))
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-c q"</span> 'my/org-quick-clock-in-task)

(<span class="org-keyword">require</span> '<span class="org-constant">quantified</span> nil t)
</pre>
</div>
</div>
</div>

<div id="outline-container-compare-time" class="outline-4">
<h4 id="compare-time">Compare times and effort estimates</h4>
<div class="outline-text-4" id="text-compare-time">
<p>
<a id="org5d8b695"></a>
</p>

<p>
This is for comparing times in column view and in tables.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/compare-times</span> (clocked estimated)
  (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (&gt; (length clocked) 0) estimated)
      (format <span class="org-string">"%.2f"</span>
              (/ (* 1.0 (org-hh:mm-string-to-minutes clocked))
                 (org-hh:mm-string-to-minutes estimated)))
    <span class="org-string">""</span>))
</pre>
</div>

<p>
Use with <code>#+COLUMNS: %40ITEM %17Effort(Estimated){:} %CLOCKSUM</code>, <code>#+BEGIN: columnview :hlines 1</code> &#x2026; <code>#+END:</code>, and
</p>

<pre class="example" id="orgdb77c0f">
    #+TBLFM: $4='(my/compare-times $3 $2)
</pre>
</div>
</div>

<div id="outline-container-org81edd2e" class="outline-4">
<h4 id="org81edd2e">Workrave</h4>
<div class="outline-text-4" id="text-org81edd2e">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/workrave-file</span> (expand-file-name <span class="org-string">".\\Workrave\\historystats"</span> (getenv <span class="org-string">"AppData"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/workrave-transform-statistics</span> (<span class="org-type">&amp;optional</span> file)
  (<span class="org-keyword">interactive</span> (list my/workrave-file))
  (<span class="org-keyword">with-current-buffer</span> (find-file-noselect file)
    <span class="org-comment-delimiter">;; </span><span class="org-comment">D day month-1 year hour min day month-1 year hour min</span>
    (<span class="org-keyword">let</span> ((result <span class="org-string">"Date\tStart\tEnd\tClicks\tKeystrokes\n"</span>))
      (goto-char (point-min))
      (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"^D </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> nil t)
        (<span class="org-keyword">let</span> ((dates (split-string (match-string 1))))
          (<span class="org-keyword">if</span> (re-search-forward <span class="org-string">"^m </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> nil t)
              (<span class="org-keyword">let</span> ((info (split-string (match-string 1))))
                (<span class="org-keyword">setq</span> result
                      (concat result
                              (format <span class="org-string">"%d-%d-%s\t%s:%02d\t%s:%02d\t%s\t%s\n"</span>
                                      (+ 1900 (string-to-number (elt dates 2))) <span class="org-comment-delimiter">; </span><span class="org-comment">year</span>
                                      (1+ (string-to-number (elt dates 1))) <span class="org-comment-delimiter">; </span><span class="org-comment">month</span>
                                      (elt dates 0) <span class="org-comment-delimiter">; </span><span class="org-comment">day</span>
                                      (elt dates 3) <span class="org-comment-delimiter">; </span><span class="org-comment">start hour</span>
                                      (string-to-number (elt dates 4)) <span class="org-comment-delimiter">; </span><span class="org-comment">start min</span>
                                      (elt dates 8) <span class="org-comment-delimiter">; </span><span class="org-comment">end hour</span>
                                      (string-to-number (elt dates 9)) <span class="org-comment-delimiter">; </span><span class="org-comment">end min</span>
                                      (elt info 5) <span class="org-comment-delimiter">; </span><span class="org-comment">clicks</span>
                                      (elt info 6) <span class="org-comment-delimiter">; </span><span class="org-comment">keystrokes</span>
                                      )))))))
      (<span class="org-keyword">if</span> (interactive-p)
          (kill-new result)
        result))))
</pre>
</div>
</div>
</div>
<div id="outline-container-org203f439" class="outline-4">
<h4 id="org203f439">Blog</h4>
<div class="outline-text-4" id="text-org203f439">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/strip-blog-share</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> (base)
    (<span class="org-keyword">save-excursion</span>
      (goto-char (point-min))
      (<span class="org-keyword">while</span> (re-search-forward
              <span class="org-string">"&lt;div class=\"sharedaddy sd-sharing-enabled\"&gt;.*?&lt;div class=\"sharing-clear\"&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;"</span> nil t)
        (replace-match <span class="org-string">""</span>)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-org5d3e837" class="outline-4">
<h4 id="org5d3e837">Artrage</h4>
<div class="outline-text-4" id="text-org5d3e837">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/artrage-export-png</span> (directory <span class="org-type">&amp;optional</span> prefix)
  <span class="org-doc">"Change an Artrage script file (arscript) to export images to DIRECTORY.</span>
<span class="org-doc">          If PREFIX is specified, use that instead of image-."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"MPath: "</span>)
  (<span class="org-keyword">unless</span> (file-directory-p directory)
    (make-directory directory t))
  (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"[0-9\\.]+s"</span> nil t)
    (replace-match <span class="org-string">"0.000s"</span>))
  (goto-char (point-min))
  (<span class="org-keyword">while</span> (search-forward <span class="org-string">"&lt;StrokeEvent&gt;"</span> nil t)
    (replace-match (concat
                    <span class="org-string">"EvType: Command    CommandID: ExportLayer    Idx: -1    Channels: NO    Path: \""</span>
                    directory
                    <span class="org-string">"/"</span> (<span class="org-keyword">or</span> prefix <span class="org-string">"image-"</span>)
                    <span class="org-string">".png\"</span>
<span class="org-string">      &lt;StrokeEvent&gt;"</span>) t t)))

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orga202465" class="outline-3">
<h3 id="orga202465">Workarounds</h3>
<div class="outline-text-3" id="text-orga202465">
</div>
<div id="outline-container-orgf39a9fd" class="outline-4">
<h4 id="orgf39a9fd">GnuTLS on Windows</h4>
<div class="outline-text-4" id="text-orgf39a9fd">
<p>
<a href="http://xn--9dbdkw.se/diary/how_to_enable_GnuTLS_for_Emacs_24_on_Windows/index.en.html">http://xn--9dbdkw.se/diary/how_to_enable_GnuTLS_for_Emacs_24_on_Windows/index.en.html</a> has lots of tips.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> gnutls-trustfiles '(<span class="org-string">"c:/sacha/cacert.pem.txt"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-org3de8d36" class="outline-4">
<h4 id="org3de8d36">color-theme sometimes comes across lists. Odd!</h4>
<div class="outline-text-4" id="text-org3de8d36">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice</span> <span class="org-function-name">face-attribute</span> (around sacha activate)
  (<span class="org-keyword">if</span> (symbolp (ad-get-arg 0))
      ad-do-it))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc745dd7" class="outline-4">
<h4 id="orgc745dd7">ido-sort-mtime stopped working when I upgraded to Windows 8</h4>
<div class="outline-text-4" id="text-orgc745dd7">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice</span> <span class="org-function-name">ido-sort-mtime</span> (around sacha activate)
  (<span class="org-keyword">setq</span> ido-temp-list
        (sort ido-temp-list
              (<span class="org-keyword">lambda</span> (a b)
                (<span class="org-keyword">let</span> ((ta (<span class="org-keyword">or</span> (nth 5 (file-attributes (concat ido-current-directory a))) '(0 0)))
                      (tb (<span class="org-keyword">or</span> (nth 5 (file-attributes (concat ido-current-directory b))) '(0 0))))
                  (<span class="org-keyword">if</span> (= (nth 0 ta) (nth 0 tb))
                      (&gt; (nth 1 ta) (nth 1 tb))
                    (&gt; (nth 0 ta) (nth 0 tb)))))))
  (<span class="org-keyword">setq</span> ad-return-value
        (ido-to-end  <span class="org-comment-delimiter">;; </span><span class="org-comment">move . files to end (again)</span>
         (delq nil (mapcar
                    (<span class="org-keyword">lambda</span> (x) (<span class="org-keyword">if</span> (string-equal (substring x 0 1) <span class="org-string">"."</span>) x))
                    ido-temp-list)))))

</pre>
</div>
</div>
</div>
<div id="outline-container-orga944b14" class="outline-4">
<h4 id="orga944b14">Cygwin mogrify doesn't work for me, but ImageMagick does</h4>
<div class="outline-text-4" id="text-orga944b14">
<div class="org-src-container">
<pre class="src src-emacs-lisp">                                        <span class="org-comment-delimiter">;</span><span class="org-comment">(setq eimp-mogrify-program "c:/Program Files/ImageMagick-6.8.3-Q16/mogrify.exe")</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd1ee171" class="outline-4">
<h4 id="orgd1ee171">SSH and &#x2013;daemon</h4>
<div class="outline-text-4" id="text-orgd1ee171">
<p>
From <a href="https://github.com/nhoffman/.emacs.d/blob/master/init.org">https://github.com/nhoffman/.emacs.d/blob/master/init.org</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/ssh-refresh</span> ()
  <span class="org-doc">"Reset the environment variable SSH_AUTH_SOCK"</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> (ssh-auth-sock-old (getenv <span class="org-string">"SSH_AUTH_SOCK"</span>))
    (setenv <span class="org-string">"SSH_AUTH_SOCK"</span>
            (car (split-string
                  (shell-command-to-string
                   <span class="org-string">"ls -t $(find /tmp/ssh-* -user $USER -name 'agent.*' 2&gt; /dev/null)"</span>))))
    (message
     (format <span class="org-string">"SSH_AUTH_SOCK %s --&gt; %s"</span>
             ssh-auth-sock-old (getenv <span class="org-string">"SSH_AUTH_SOCK"</span>)))))
(my/ssh-refresh)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3052a45" class="outline-3">
<h3 id="org3052a45">Display</h3>
<div class="outline-text-3" id="text-org3052a45">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">sanityinc/adjust-opacity</span> (frame incr)
  (<span class="org-keyword">let*</span> ((oldalpha (<span class="org-keyword">or</span> (frame-parameter frame 'alpha) 100))
         (newalpha (+ incr oldalpha)))
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (&lt;= frame-alpha-lower-limit newalpha) (&gt;= 100 newalpha))
      (modify-frame-parameters frame (list (cons 'alpha newalpha))))))
(global-set-key (kbd <span class="org-string">"M-C-8"</span>) (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (sanityinc/adjust-opacity nil -2)))
(global-set-key (kbd <span class="org-string">"M-C-9"</span>) (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (sanityinc/adjust-opacity nil 2)))
(global-set-key (kbd <span class="org-string">"M-C-0"</span>) (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (modify-frame-parameters nil `((alpha . 100)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org2ba0485" class="outline-3">
<h3 id="org2ba0485">On my phone</h3>
<div class="outline-text-3" id="text-org2ba0485">
<p>
I use Orgzly on an Android phone, synchronizing my files with
Syncthing. (See <code>my/resolve-orgzly-syncthing</code> elsewhere in this
cnofig.) Sometimes I use Termux, too.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> browse-url-browser-function 'browse-url-xdg-open)
(<span class="org-keyword">unless</span> window-system
  (xterm-mouse-mode 1)
  (global-set-key [mouse-4] (<span class="org-keyword">lambda</span> ()
                              (<span class="org-keyword">interactive</span>)
                              (scroll-down 1)))
  (global-set-key [mouse-5] (<span class="org-keyword">lambda</span> ()
                              (<span class="org-keyword">interactive</span>)
                              (scroll-up 1))))
(<span class="org-keyword">use-package</span> <span class="org-constant">org</span>
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">when</span> my/phone-p
    (add-to-list 'org-file-apps '(<span class="org-string">"\\.png\\'"</span> . default))
    (add-to-list 'org-file-apps '(<span class="org-string">"\\.jpg\\'"</span> . default))
    (add-to-list 'org-file-apps '(<span class="org-string">"\\.jpeg\\'"</span> . default)))
  )

(<span class="org-keyword">defun</span> <span class="org-function-name">my/format-intent</span> (intent <span class="org-type">&amp;optional</span> params)
  <span class="org-doc">"Return a command string for sending INTENT with PARAMS.</span>
<span class="org-doc">      PARAMS is an alist of (\"key\" . \"value\") pairs."</span>
  (format <span class="org-string">"am broadcast --user 0 -a %s %s"</span>
          intent
          (mapconcat
           (<span class="org-keyword">lambda</span> (o)
             (format
              <span class="org-string">"-e %s %s"</span>
              (shell-quote-argument (car o))
              (shell-quote-argument (cdr o))))
           params
           <span class="org-string">" "</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/send-intent</span> (intent <span class="org-type">&amp;optional</span> params)
  <span class="org-doc">"Send broadcast INTENT to my phone.</span>
<span class="org-doc">      PARAMS is a plist of :key value pairs."</span>
  (<span class="org-keyword">let</span> ((command (my/format-intent intent params)))
    (<span class="org-keyword">if</span> my/phone-p
        (shell-command command)
      (shell-command (format <span class="org-string">"ssh phone %s"</span> (shell-quote-argument command))))))

</pre>
</div>
</div>
</div>

<div id="outline-container-orgd9ad1a0" class="outline-3">
<h3 id="orgd9ad1a0">Clipboard</h3>
<div class="outline-text-3" id="text-orgd9ad1a0">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">clipmon</span>
  <span class="org-builtin">:disabled</span> t
  <span class="org-builtin">:init</span> (<span class="org-keyword">progn</span> (<span class="org-keyword">setq</span> clipmon-action 'kill-new clipmon-timeout nil clipmon-sound nil clipmon-cursor-color nil clipmon-suffix nil) (clipmon-mode)))
</pre>
</div>

<p>
On my phone:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">xclip</span> <span class="org-builtin">:if</span> my/phone-p) <span class="org-comment-delimiter">; </span><span class="org-comment">Turn on with xclip-mode</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org3f00582" class="outline-3">
<h3 id="org3f00582">Search</h3>
<div class="outline-text-3" id="text-org3f00582">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">engine-mode</span>
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">progn</span>
    (<span class="org-keyword">defengine</span> my-blog <span class="org-string">"https://www.google.ca/search?q=site:sachachua.com+%s"</span> <span class="org-builtin">:keybinding</span> <span class="org-string">"b"</span>)
    (<span class="org-keyword">defengine</span> mail <span class="org-string">"https://mail.google.com/mail/u/0/#search/%s"</span> <span class="org-builtin">:keybinding</span> <span class="org-string">"m"</span>)
    (<span class="org-keyword">defengine</span> google <span class="org-string">"http://google.com/search?q=%s"</span> <span class="org-builtin">:keybinding</span> <span class="org-string">"g"</span>)
    (<span class="org-keyword">defengine</span> emacswiki <span class="org-string">"http://google.com/search?q=site:emacswiki.org+%s"</span> <span class="org-builtin">:keybinding</span> <span class="org-string">"e"</span>)
    (<span class="org-keyword">bind-key*</span> <span class="org-string">"C-c s"</span> 'my/engine-mode-hydra/body)
    (engine-mode)))
</pre>
</div>
</div>
</div>
<div id="outline-container-org8a126f1" class="outline-3">
<h3 id="org8a126f1">Mail</h3>
<div class="outline-text-3" id="text-org8a126f1">
</div>
<div id="outline-container-org7e51dad" class="outline-4">
<h4 id="org7e51dad">Gnus</h4>
<div class="outline-text-4" id="text-org7e51dad">
<p>
I use Gmail for my mail because it:
</p>
<ul class="org-ul">
<li>synchronizes with my phone, which is handy for notifications and quick replies</li>
<li>filters most of the spam for me</li>
<li><p>
works with a few interesting extensions such as Boomerang for Gmail
</p>

<p>
However, I like the way the Gnus mail/news client in Emacs gives me a
much more keyboard-friendly way to manage lots of mail, and I can even
write code to partially automate some of my common operations.
</p>

<p>
I used to have my config in in <code>~/.gnus</code>, but people might find it
handy, so I've added it to my public <a href="http://sachacuha.com/dotemacs">Emacs configuration</a>.
</p>

<p>
I like using <a href="http://gmane.org">Gmane</a> to read mailing lists, and I use IMAP to read my Gmail.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> gnus-select-method '(nnnil <span class="org-string">""</span>))
(<span class="org-keyword">setq</span> gnus-secondary-select-methods
      '((nntp <span class="org-string">"news.gmane.io"</span>)
        <span class="org-comment-delimiter">;; </span><span class="org-comment">(nnmaildir "mail"</span>
        <span class="org-comment-delimiter">;;            </span><span class="org-comment">(directory "~/Maildir")</span>
        <span class="org-comment-delimiter">;;            </span><span class="org-comment">(directory-files nnheader-directory-files-safe) </span>
        <span class="org-comment-delimiter">;;            </span><span class="org-comment">(get-new-mail nil))</span>
        (nnimap <span class="org-string">"imap.googlemail.com"</span>
                (nnimap-address <span class="org-string">"imap.googlemail.com"</span>)
                (nnimap-server-port 993)
                (nnimap-stream ssl)
                (nnimap-authenticator login))
        <span class="org-comment-delimiter">;; </span><span class="org-comment">(nnimap "localhost" </span>
        <span class="org-comment-delimiter">;;   </span><span class="org-comment">(nnimap-address "localhost")</span>
        <span class="org-comment-delimiter">;;   </span><span class="org-comment">(nnimap-stream network)</span>
        <span class="org-comment-delimiter">;;   </span><span class="org-comment">(nnimap-user "sacha")</span>
        <span class="org-comment-delimiter">;;   </span><span class="org-comment">(nnimap-authenticator login)</span>
        <span class="org-comment-delimiter">;;   </span><span class="org-comment">(nnimap-authinfo-file "~/.authinfo.gpg"))</span>
        ))
(<span class="org-keyword">setq</span> smtpmail-smtp-server <span class="org-string">"smtp.googlemail.com"</span>
      smtpmail-smtp-service 587
      gnus-check-new-newsgroups nil
      gnus-activate-level 2
      gnus-ignored-newsgroups <span class="org-string">"^to\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">^[0-9. ]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"> </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">$</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">^[\"]\"[#'()]"</span>)
</pre>
</div>

<p>
I now use Dovecot with OfflineIMAP for local IMAP access to my mail
and synchronization with Gmail, but you can see the commented-out
information for Gmail in case you prefer that. I have two-factor
authentication enabled for Gmail, so I set up an app-specific password
for Gnus. I have GPG set up for encryption, and an <code>~/.authinfo.gpg</code>
file set up with something like:
</p>

<pre class="example" id="org2779403">
      machine imap.gmail.com login sacha@sachachua.com password mysecretapppassword
      machine imap.gmail.com login sacha@sachachua.com password mysecretapppassword port 993
      machine smtp.gmail.com login sacha@sachachua.com password mysecretapppassword port 587
      machine localhost login sacha password mysecretlocalpassword port 993
      machine localhost login sacha password mysecretlocalpassword port 143
</pre>

<p>
If you don't have GPG set up and you don't mind saving your passwords
in the clear, you can set up an <code>~/.authinfo</code> file instead.
</p>

<p>
Sending e-mail on Windows was a bit of a pain. Fortunately, I
eventually found something that works. I've configured <a href="http://emailrelay.sourceforge.net/">emailrelay</a> to
accept the mail and forward it to Gmail. The server starts with this
batch file:
</p>

<pre class="example" id="org3209362">
      start "emailrelay" "C:\Program Files (x86)\emailrelay\emailrelay.exe" --as-proxy smtp.gmail.com:25 --client-auth "C:/sacha/.emailrelay" --client-tls --log --pid-file "C:\Program Files (x86)\emailrelay\emailrelay.pid" --spool-dir C:\sacha\tmp\emailrelay
</pre>

<p>
Sending queued mail works with this batch file:
</p>

<pre class="example" id="orgf790ce4">
      "c:\Program Files (x86)\emailrelay\emailrelay.exe" --as-client smtp.gmail.com:587 --client-auth c:\sacha\.emailrelay --client-tls --spool-dir c:\sacha\tmp\emailrelay
</pre>

<p>
I should probably get around to using <code>--as-proxy</code> properly, since it still seems to hold mail until I explicitly send it.
</p>

<p>
On Linux, it's simply a matter of setting up a mail server such as
<a href="https://easyengine.io/tutorials/linux/ubuntu-postfix-gmail-smtp/">Postfix</a>.
</p>

<p>
Some more config. Not sure how much of this is needed.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> message-send-mail-function 'smtpmail-send-it
      smtpmail-starttls-credentials '((<span class="org-string">"localhost"</span> 25 <span class="org-string">"sacha@local.sachachua.com"</span> nil))
      smtpmail-auth-credentials '((<span class="org-string">"localhost"</span> 25 <span class="org-string">"sacha@local.sachachua.com"</span> nil))
      smtpmail-default-smtp-server <span class="org-string">"localhost"</span>
      smtpmail-smtp-server <span class="org-string">"localhost"</span>
      smtpmail-smtp-service 25
      smtpmail-local-domain <span class="org-string">"local.sachachua.com"</span>)
(<span class="org-keyword">setq</span> send-mail-function 'smtpmail-send-it)
(<span class="org-keyword">setq</span> smtpmail-smtp-server <span class="org-string">"127.0.0.1"</span>)
(<span class="org-keyword">setq</span> smtpmail-smtp-service 25)
(<span class="org-keyword">setq</span> user-mail-address <span class="org-string">"sacha@sachachua.com"</span>)
</pre>
</div>

<p>
Hide HTML mail. I need to fiddle with this some more, since Gnus still
tries to display them. Sometimes my Gnus crashes when it tries to
display HTML mail.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">gnus</span>
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">require</span> '<span class="org-constant">mm-decode</span>)
  (<span class="org-keyword">setq</span> mm-discouraged-alternatives
        '(<span class="org-string">"text/html"</span> <span class="org-string">"text/richtext"</span>)
        mm-automatic-display
        (-difference mm-automatic-display '(<span class="org-string">"text/html"</span> <span class="org-string">"text/enriched"</span> <span class="org-string">"text/richtext"</span>))))
</pre>
</div>

<p>
Hide quoted text.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> gnus-treat-hide-citation t)
</pre>
</div>

<p>
Get smarter about filtering depending on what I reed or mark. I use <code>!</code> (tick) for marking threads as something that interests me.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> gnus-use-adaptive-scoring t)
(<span class="org-keyword">setq</span> gnus-default-adaptive-score-alist
      '((gnus-unread-mark)
        (gnus-ticked-mark (subject 10))
        (gnus-killed-mark (subject -5))
        (gnus-catchup-mark (subject -1))))
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgcf68201" class="outline-4">
<h4 id="orgcf68201">Notmuch</h4>
<div class="outline-text-4" id="text-orgcf68201">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> notmuch-message-headers '(<span class="org-string">"Subject"</span> <span class="org-string">"To"</span> <span class="org-string">"Cc"</span> <span class="org-string">"Date"</span> <span class="org-string">"Reply-To"</span>))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgd4ac4dd" class="outline-3">
<h3 id="orgd4ac4dd">Ledger (personal finance)</h3>
<div class="outline-text-3" id="text-orgd4ac4dd">
<p>
Make it easier to review my credit card transactions
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">ledger-mode</span>
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/vendor/ledger-mode"</span>
  <span class="org-builtin">:mode</span> <span class="org-string">"\\.ledger$"</span> 
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> ledger-mode-map
              (<span class="org-string">"C-c C-n"</span> . my/ledger-change-account)
              (<span class="org-string">"C-c a"</span> . my/ledger-set-unknown-account)
              (<span class="org-string">"C-c f"</span> . (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (find-file (my/latest-file <span class="org-string">"~/Downloads"</span>))))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/open-latest-download</span> ()
  (<span class="org-keyword">interactive</span>)
  (find-file (my/latest-file <span class="org-string">"~/Downloads"</span>)))
</pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/ledger-account-list-cache</span> nil)
(make-variable-buffer-local 'my/ledger-account-list-cache)
(<span class="org-keyword">defadvice</span> <span class="org-function-name">ledger-accounts-list</span> (around sacha activate)
  <span class="org-doc">"Cache"</span>
  (<span class="org-keyword">setq</span> ad-return-value (<span class="org-keyword">or</span> my/ledger-account-list-cache
                            (<span class="org-keyword">setq</span> my/ledger-account-list-cache ad-do-it))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/ledger-set-unknown-account</span> (account point)
  (<span class="org-keyword">interactive</span> (list (ledger-read-account-with-prompt <span class="org-string">"Account"</span>) (point)))
  (<span class="org-keyword">let</span> ((extents (ledger-navigate-find-xact-extents point)))
    (<span class="org-keyword">save-excursion</span>
      (goto-char (car extents))
      (<span class="org-keyword">if</span> (re-search-forward <span class="org-string">"Expenses:Unknown"</span> (cadr extents) t)
          (replace-match account t t)
        (goto-char point)
        (beginning-of-line)
        (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string"> \t]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">  "</span> (line-end-position) nil)
          (replace-match account t t nil 1))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/ledger-go-to-beginning-of-entry</span> ()
  <span class="org-doc">"Move to the beginning of the current entry."</span>
  (<span class="org-keyword">while</span> (<span class="org-keyword">and</span> (not (bobp))
              (eq (ledger-context-line-type (ledger-context-at-point))
                  'acct-transaction))
    (forward-line -1)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/ledger-entry-date</span> ()
  <span class="org-doc">"Returns the date of the entry containing point or nil."</span>
  (<span class="org-keyword">save-excursion</span>
    (my/ledger-go-to-beginning-of-entry)
    (<span class="org-keyword">let</span> ((context-info (ledger-context-other-line 0)))
      (<span class="org-keyword">when</span> (eq (ledger-context-line-type context-info) 'entry)
        (goto-char (line-beginning-position))
        (<span class="org-keyword">if</span> (looking-at <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[-0-9\\./]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>)
            (match-string-no-properties 1))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/ledger-guess-mbna</span> ()
  <span class="org-doc">"Adds a sub-account for the dates for my credit card transactions."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-excursion</span>
    (my/ledger-go-to-beginning-of-entry)
    (forward-line 1)
    (<span class="org-keyword">let</span> ((amount 0) (date (my/ledger-entry-date)) month)
      (<span class="org-keyword">if</span> (string-match <span class="org-string">"[0-9]+[-\\.]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">[-\\.]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> date)
          (<span class="org-keyword">setq</span> month (string-to-number (match-string 1 date))))
      <span class="org-comment-delimiter">;; </span><span class="org-comment">Is this a payment or a charge?</span>
      (<span class="org-keyword">save-excursion</span>
        (<span class="org-keyword">while</span> (<span class="org-keyword">and</span> (eq (ledger-context-line-type (ledger-context-at-point))
                        'acct-transaction)
                    (not (eobp)))
          (<span class="org-keyword">let</span> ((context (ledger-context-at-point)))
            (<span class="org-keyword">if</span> (ledger-context-field-value context 'amount)
                (<span class="org-keyword">if</span> (string-match <span class="org-string">"MBNA"</span> (ledger-context-field-value context 'account))
                    (<span class="org-keyword">setq</span> amount (string-to-number (ledger-context-field-value context 'amount)))
                  (<span class="org-keyword">setq</span> amount (- (string-to-number (ledger-context-field-value context 'amount)))))))
          (forward-line 1)))
      (<span class="org-keyword">save-excursion</span>
        (<span class="org-keyword">while</span> (<span class="org-keyword">and</span> (eq (ledger-context-line-type (ledger-context-at-point))
                        'acct-transaction)
                    (not (eobp)))
          (<span class="org-keyword">let</span> ((context (ledger-context-at-point)))
            (<span class="org-keyword">if</span> (string-match <span class="org-string">"MBNA"</span> (ledger-context-field-value context 'account))
                (<span class="org-keyword">if</span> (re-search-forward <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">MBNA</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">[ \t]*[-$</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">.0-9]*[ \t]*$"</span> (line-end-position) t)
                    (replace-match
                     (concat <span class="org-string">"MBNA:"</span>
                             (elt
                              '(<span class="org-string">"January"</span> <span class="org-string">"February"</span> <span class="org-string">"March"</span> <span class="org-string">"April"</span> <span class="org-string">"May"</span> <span class="org-string">"June"</span> <span class="org-string">"July"</span> <span class="org-string">"August"</span> <span class="org-string">"September"</span> <span class="org-string">"October"</span> <span class="org-string">"November"</span> <span class="org-string">"December"</span>)
                              (% (+ (<span class="org-keyword">if</span> (&gt; amount 0) 10 11) month) 12)))
                     t t nil 1))))
          (forward-line 1))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/latest-file</span> (path <span class="org-type">&amp;optional</span> filter)
  <span class="org-doc">"Return the newest file in PATH. Optionally filter by FILTER."</span>
  (car (sort (seq-remove #'file-directory-p (directory-files path 'full filter t)) #'file-newer-than-file-p)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/ledger-change-account</span> (account)
  (<span class="org-keyword">interactive</span> (list (ledger-read-account-with-prompt (concat (ledger-xact-payee) <span class="org-string">": "</span>))))
  (beginning-of-line)
  (re-search-forward ledger-account-name-regex)
  (replace-match account t t))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/ledger-fix-unknown</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"Expenses:Unknown.*$ </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> nil t)
    (my/ledger-change-account (ledger-read-account-with-prompt
                               (format <span class="org-string">"%s %s: "</span> (s-trim (<span class="org-keyword">save-match-data</span> (ledger-xact-payee)))
                                       (match-string 1))))))

</pre>
</div>
</div>
</div>

<div id="outline-container-orga421655" class="outline-3">
<h3 id="orga421655">Emacs server</h3>
<div class="outline-text-3" id="text-orga421655">
<p>
<code>(server-start)</code> permits the use of <code>emacsclient</code>, <code>emacsclientw</code>, and
<code>org-protocol</code>. I used to start a server as part of my config. Now I'm
switching to using <code>emacs --daemon</code>, which starts a server
automatically. Anyway, with <code>--daemon</code>, Emacs doesn't start off in a
graphical environment, so the frames that <code>emacsclient -c</code> creates
don't get the theme applied. This fixes that:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-hook 'after-make-frame-functions
          (<span class="org-keyword">lambda</span> (frame)
            (select-frame frame)
            (my/setup-color-theme)))
</pre>
</div>
</div>
</div>
<div id="outline-container-org92a8fb3" class="outline-3">
<h3 id="org92a8fb3">Collaboration</h3>
<div class="outline-text-3" id="text-org92a8fb3">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">crdt</span> <span class="org-builtin">:load-path</span> <span class="org-string">"~/vendor/crdt.el"</span> <span class="org-builtin">:ensure</span> nil <span class="org-builtin">:if</span> my/laptop-p)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc27b51f" class="outline-3">
<h3 id="orgc27b51f">Menus</h3>
<div class="outline-text-3" id="text-orgc27b51f">
<p>
Handy when I'm in tablet mode.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(define-key-after global-map [menu-bar my-menu] (cons <span class="org-string">"Shortcuts"</span> (make-sparse-keymap <span class="org-string">"Custom shortcuts"</span>)) 'tools)
(define-key global-map [menu-bar my-menu journal] '(<span class="org-string">"Show journal entries"</span> . my/show-missing-journal-entries))
(define-key global-map [menu-bar my-menu agenda] '(<span class="org-string">"Org agenda"</span> . (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (org-agenda nil <span class="org-string">"a"</span>))))
(define-key global-map [menu-bar my-menu audio] '(<span class="org-string">"Process audio"</span> . (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (shell-command <span class="org-string">"~/bin/process-audio &amp;"</span>))))
(define-key global-map [menu-bar my-menu new-index-card] '(<span class="org-string">"New index card"</span> . (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>)
                                                                                (my/org-sketch-open (my/prepare-index-card-template)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb8d718d" class="outline-3">
<h3 id="orgb8d718d">CSVs</h3>
<div class="outline-text-3" id="text-orgb8d718d">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">pcsv</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-org5ab1db8" class="outline-3">
<h3 id="org5ab1db8">Advanced stuff / things I tend to forget about</h3>
<div class="outline-text-3" id="text-org5ab1db8">
</div>
<div id="outline-container-org6b7e46e" class="outline-4">
<h4 id="org6b7e46e">Editing multiple things</h4>
<div class="outline-text-4" id="text-org6b7e46e">
</div>
<div id="outline-container-org7c913ae" class="outline-5">
<h5 id="org7c913ae">Multiple cursors mode&#xa0;&#xa0;&#xa0;<span class="tag"><span class="drill">drill</span></span></h5>
<div class="outline-text-5" id="text-org7c913ae">
<p>
I often define keyboard macros to process multiple lines in a region.
Maybe <code>multiple-cursors</code> will be an even better way. Looks promising!
<a href="http://emacsrocks.com/e13.html">See Emacs Rocks episode 13 (multiple-cursors) for a great demo</a>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">multiple-cursors</span>
  <span class="org-builtin">:bind</span>
  ((<span class="org-string">"C-c m t"</span> . mc/mark-all-like-this)
   (<span class="org-string">"C-c m m"</span> . mc/mark-all-like-this-dwim)
   (<span class="org-string">"C-c m l"</span> . mc/edit-lines)
   (<span class="org-string">"C-c m e"</span> . mc/edit-ends-of-lines)
   (<span class="org-string">"C-c m a"</span> . mc/edit-beginnings-of-lines)
   (<span class="org-string">"C-c m n"</span> . mc/mark-next-like-this)
   (<span class="org-string">"C-c m p"</span> . mc/mark-previous-like-this)
   (<span class="org-string">"C-c m s"</span> . mc/mark-sgml-tag-pair)
   (<span class="org-string">"C-c m d"</span> . mc/mark-all-like-this-in-defun)))
(<span class="org-keyword">use-package</span> <span class="org-constant">phi-search</span>)
(<span class="org-keyword">use-package</span> <span class="org-constant">phi-search-mc</span> <span class="org-builtin">:config</span> (phi-search-mc/setup-keys))
(<span class="org-keyword">use-package</span> <span class="org-constant">mc-extras</span> <span class="org-builtin">:config</span> (define-key mc/keymap (kbd <span class="org-string">"C-. ="</span>) 'mc/compare-chars))
</pre>
</div>

<p>
Thanks to <a href="http://irreal.org/blog/?p=1733">Irreal</a> and <a href="http://planet.emacsen.org/">Planet Emacsen</a> for the link!
</p>
</div>
</div>
</div>

<div id="outline-container-org1369861" class="outline-4">
<h4 id="org1369861">Edit list&#xa0;&#xa0;&#xa0;<span class="tag"><span class="drill">drill</span></span></h4>
<div class="outline-text-4" id="text-org1369861">
<p>
M-x edit-list makes it easier to edit an Emacs Lisp list.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">edit-list</span> <span class="org-builtin">:commands</span> edit-list)
</pre>
</div>
</div>
</div>

<div id="outline-container-org18dd32c" class="outline-4">
<h4 id="org18dd32c">Quickly jump to positions</h4>
<div class="outline-text-4" id="text-org18dd32c">
<p>
Quickly jump to a position in the current view.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">avy</span>
  <span class="org-builtin">:if</span> my/laptop-p)
(<span class="org-keyword">use-package</span> <span class="org-constant">avy-zap</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:bind</span>
  ((<span class="org-string">"M-z"</span> . avy-zap-up-to-char-dwim)
   (<span class="org-string">"M-Z"</span> . avy-zap-to-char-dwim)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org3a666e6" class="outline-4">
<h4 id="org3a666e6">Deleting things</h4>
<div class="outline-text-4" id="text-org3a666e6">
<p>
From Steve Purcell, who linked to <a href="http://www.emacswiki.org/emacs/ZapToISearch">http://www.emacswiki.org/emacs/ZapToISearch</a>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">zap-to-isearch</span> (rbeg rend)
  <span class="org-doc">"Kill the region between the mark and the closest portion of</span>
<span class="org-doc">      the isearch match string. The behaviour is meant to be analogous</span>
<span class="org-doc">      to zap-to-char; let's call it zap-to-isearch. The deleted region</span>
<span class="org-doc">      does not include the isearch word. This is meant to be bound only</span>
<span class="org-doc">      in isearch mode.  The point of this function is that oftentimes</span>
<span class="org-doc">      you want to delete some portion of text, one end of which happens</span>
<span class="org-doc">      to be an active isearch word. The observation to make is that if</span>
<span class="org-doc">      you use isearch a lot to move the cursor around (as you should,</span>
<span class="org-doc">      it is much more efficient than using the arrows), it happens a</span>
<span class="org-doc">      lot that you could just delete the active region between the mark</span>
<span class="org-doc">      and the point, not include the isearch word."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">when</span> (not mark-active)
    (<span class="org-warning">error</span> <span class="org-string">"Mark is not active"</span>))
  (<span class="org-keyword">let*</span> ((isearch-bounds (list isearch-other-end (point)))
         (ismin (apply 'min isearch-bounds))
         (ismax (apply 'max isearch-bounds))
         )
    (<span class="org-keyword">if</span> (&lt; (mark) ismin)
        (kill-region (mark) ismin)
      (<span class="org-keyword">if</span> (&gt; (mark) ismax)
          (kill-region ismax (mark))
        (<span class="org-warning">error</span> <span class="org-string">"Internal error in isearch kill function."</span>)))
    (isearch-exit)
    ))

(define-key isearch-mode-map [(meta z)] 'zap-to-isearch)
</pre>
</div>
</div>
<div id="outline-container-orgf6799ef" class="outline-5">
<h5 id="orgf6799ef"><span class="todo TODO">TODO</span> Get zap-to-isearch to work with helm-swoop</h5>
</div>
</div>
<div id="outline-container-org934647f" class="outline-4">
<h4 id="org934647f">Network: TRAMP and editing files over SSH</h4>
<div class="outline-text-4" id="text-org934647f">
<p>
Emacs lets you edit files on remote servers, which is pretty darn
cool. On Windows, these things help a little.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">when</span> (eq system-type 'windows-nt)
  (<span class="org-keyword">setq</span> tramp-default-method <span class="org-string">"plink"</span>)
  (<span class="org-keyword">setq</span> tramp-auto-save-directory <span class="org-string">"c:\\sacha\\tmp"</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-org32fd7ac" class="outline-4">
<h4 id="org32fd7ac">Checking URLs</h4>
<div class="outline-text-4" id="text-org32fd7ac">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/test-urls</span> (urls)
  <span class="org-doc">"Given a list of URLs, return a list of any URLS that don't result in an OK value."</span>
  (delq nil
        (mapcar (<span class="org-keyword">lambda</span> (url)
                  (<span class="org-keyword">let</span> ((url-request-method <span class="org-string">"HEAD"</span>))
                    (<span class="org-keyword">with-current-buffer</span> (url-retrieve-synchronously url)
                      (goto-char (point-min))
                      (<span class="org-keyword">unless</span> (looking-at <span class="org-string">"HTTP/1.1 200 OK"</span>) url))))
                urls)))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-streaming" class="outline-3">
<h3 id="streaming">Streaming</h3>
<div class="outline-text-3" id="text-streaming">
</div>

<div id="outline-container-org6ad2a79" class="outline-4">
<h4 id="org6ad2a79">Setting up</h4>
<div class="outline-text-4" id="text-org6ad2a79">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">https://emacs.stackexchange.com/questions/19035/finding-frames-by-name</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my/get-frame-by-name</span> (fname)
  <span class="org-doc">"If there is a frame named FNAME, return it, else nil."</span>
  (seq-find (<span class="org-keyword">lambda</span> (frame)
              (<span class="org-keyword">when</span> (equal fname (frame-parameter frame 'name))
             frame))
            (frame-list)))
<span class="org-comment-delimiter">;; </span><span class="org-comment">(obs-websocket-send "GetSourceSettings" :sourceName "Command log" :callback (lambda  (frame payload) (prin1 payload)))</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my/wmctl-get-id</span> (window-name)
  (string-to-number (replace-regexp-in-string <span class="org-string">"^0x</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">\n"</span> <span class="org-string">""</span> (shell-command-to-string (format <span class="org-string">"wmctrl -l | grep %s | head -1 | awk '{print $1}'"</span> (shell-quote-argument window-name)))) 16))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/stream-ffmpeg-multicast</span> nil <span class="org-doc">"Process for multicasting the stream"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/stream-ffmpeg-multicast</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">unless</span> (process-live-p my/stream-ffmpeg-multicast)
    (<span class="org-keyword">setq</span> my/stream-ffmpeg-multicast (start-process <span class="org-string">"FFmpeg multicast"</span> <span class="org-string">"*ffmpeg multicast*"</span> <span class="org-string">"~/bin/ffmpeg-multicast"</span>))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-builtin">source</span> ~/.profile
ffmpeg -v quiet -f flv -listen 1 -i rtmp://127.0.0.1:5555 -c copy -f flv $<span class="org-variable-name">YOUTUBE</span> -c copy -f flv $<span class="org-variable-name">TWITCH</span> 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/stream-fix-sources</span> ()
  (<span class="org-keyword">interactive</span>)
  (obs-websocket-send <span class="org-string">"SetVolume"</span> <span class="org-builtin">:source</span> <span class="org-string">"Mic/Aux"</span> <span class="org-builtin">:volume</span> 1)
  (mapc (<span class="org-keyword">lambda</span> (buf)
          (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (buffer-file-name buf) (string-match <span class="org-string">"secret"</span> (buffer-file-name buf)))
            (kill-buffer-ask buf)))
        (buffer-list)) 
  (obs-websocket-send
   <span class="org-string">"SetSourceSettings"</span>
   <span class="org-builtin">:sourceName</span> <span class="org-string">"Gstreamer - command log"</span>
   <span class="org-builtin">:sourceSettings</span>
   `(<span class="org-builtin">:pipeline</span> ,(format <span class="org-string">"ximagesrc xid=0x%x use-damage=0 ! queue max-size-buffers=0 max-size-time=0 max-size-bytes=0  min-threshold-time=4000000000 ! video."</span> (my/wmctl-get-id <span class="org-string">"command-log"</span>)) <span class="org-builtin">:use_timestamps_audio</span> t <span class="org-builtin">:use_timestamps_video</span> t) <span class="org-builtin">:sourceType</span> <span class="org-string">"gstreamer-source"</span>)
  (obs-websocket-send <span class="org-string">"SetSourceSettings"</span> <span class="org-builtin">:sourceName</span> <span class="org-string">"Command log"</span>
                      <span class="org-builtin">:sourceSettings</span>
                      `(<span class="org-builtin">:capture_window</span>
                        ,(format <span class="org-string">"%d\n%s\n%s"</span>
                                 (my/wmctl-get-id <span class="org-string">"command-log"</span>)
                                 <span class="org-string">" *command-log*"</span>
                                 <span class="org-string">"emacs"</span>))))

(<span class="org-keyword">use-package</span> <span class="org-constant">command-log-mode</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:commands</span>
  command-log-mode
  clm/open-command-log-buffer
  global-command-log-mode
  <span class="org-builtin">:defines</span>
  clm/command-log-buffer
  )
(<span class="org-keyword">defun</span> <span class="org-function-name">my/stream-set-up-frames</span> ()
  (<span class="org-keyword">interactive</span>)
  (global-command-log-mode 1)
  (<span class="org-keyword">unless</span> (my/get-frame-by-name (buffer-name clm/command-log-buffer))
    (switch-to-buffer-other-frame clm/command-log-buffer))
  (<span class="org-keyword">clm/with-command-log-buffer</span>
    (text-scale-set 3))
  (call-process <span class="org-string">"wmctrl"</span> nil 0 nil <span class="org-string">"-r"</span> (number-to-string (my/wmctl-get-id <span class="org-string">"command-log"</span>)) <span class="org-string">"-e"</span> <span class="org-string">"0,0,100,1366,100"</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/stream-set-up</span> ()
  (<span class="org-keyword">interactive</span>)
  (my/stream-ffmpeg-multicast)
  (obs-websocket-connect)
  (my/stream-toggle-background-music)
  (selectric-mode 1)
  (my/stream-set-up-frames)
  (my/stream-fix-sources)
  (obs-websocket-minor-mode 1)
  (<span class="org-keyword">unless</span> (<span class="org-keyword">and</span> (erc-get-buffer <span class="org-string">"#sachachua"</span>)
               (<span class="org-keyword">with-current-buffer</span> (erc-get-buffer <span class="org-string">"#sachachua"</span>)
                 (erc-server-process-alive)))
    (my/twitch-irc)))
</pre>
</div>
</div>
</div>


<div id="outline-container-org9d9db40" class="outline-4">
<h4 id="org9d9db40">Controlling my stream audio from Emacs: background music, typing sounds, and push to talk&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></h4>
<div class="outline-text-4" id="text-org9d9db40">
<p>
Update: 2021-02-11: Parsed <code>pacmd list-sources</code> so that I can mute/unmute devices by regular expression.
Update: 2021-02-07: Made it work with my USB microphone.
</p>

<p>
I was experimenting with streaming Emacs geeking around on <a href="https://twitch.tv/sachachua">twitch.tv</a>.
Someone asked me to have soft background music and typing sounds.
Since I'm a little clueless about music and don't want to bother with
hunting down nice royalty-free music, I figured I could just use the
<a href="https://en.wikipedia.org/wiki/Musikalisches_W%C3%BCrfelspiel#:~:text=The%20most%20well%2Dknown%20was,to%20create%20a%20musical%20piece.">Mozart dice game</a> to programmatically generate music.
</p>

<p>
I installed the <a href="https://developer.aliyun.com/mirror/npm/package/mozart-dice-game">mozart-dice-game</a> NPM package and used this bit of
Javascript to generate a hundred MIDI files.
</p>

<div class="org-src-container">
<pre class="src src-sh">const <span class="org-variable-name">x</span> = require(<span class="org-string">'mozart-dice-game'</span>)
<span class="org-keyword">for</span> (<span class="org-builtin">let</span> <span class="org-variable-name">i</span> = 0; i &lt; 100; i++) { x.saveMinuet(<span class="org-string">'minuet'</span> + String(i).padStart(<span class="org-string">'3'</span>, <span class="org-string">'0'</span>) + <span class="org-string">'.mid'</span>); }
</pre>
</div>

<p>
Then I wrote this Emacs Lisp function to turn it on and off.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/background-music-process</span> nil <span class="org-doc">"Process for playing background music"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/stream-toggle-background-music</span> (<span class="org-type">&amp;optional</span> enable)
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">if</span> (<span class="org-keyword">or</span> my/background-music-process
          (<span class="org-keyword">and</span> (numberp enable) (&lt; enable 0)))
      (<span class="org-keyword">progn</span>
        (<span class="org-keyword">when</span> (process-live-p my/background-music-process)
          (kill-process my/background-music-process))
        (<span class="org-keyword">setq</span> my/background-music-process nil))
    (<span class="org-keyword">let</span> ((files (directory-files <span class="org-string">"~/code/music"</span> t <span class="org-string">"mid\\'"</span>)))
      (<span class="org-keyword">setq</span> my/background-music-process
            (apply
             'start-process
             <span class="org-string">"*Music*"</span>
             nil
             (append (list <span class="org-string">"timidity"</span> <span class="org-string">"-idlr"</span> <span class="org-string">"--volume=10"</span>) files))))))
</pre>
</div>

<p>
People also suggested typing sounds. I guess that's a good way to get
a sense of activity. The default selectric sound was a little too loud
for me, so we'll use the move sound for now. It would be nice to make
this more random-sounding someday.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/selectric-type-sound</span> ()
  <span class="org-doc">"Make the sound of typing."</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Someday, randomize this or something</span>
  (selectric-make-sound (expand-file-name <span class="org-string">"selectric-move.wav"</span> selectric-files-path)))

(<span class="org-keyword">use-package</span> <span class="org-constant">selectric-mode</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:diminish</span> <span class="org-string">""</span>
  <span class="org-builtin">:config</span>
  (fset #'selectric-type-sound #'my/selectric-type-sound))
</pre>
</div>

<p>
I was having a hard time remembering to go back on mute during
meetings, since the LED on the mute button wasn't working at the time
and the system tray icon was a little hard to notice. The LED has
mysteriously decided to start working again, but push-to-talk is handy
anyway. I want to be able to tap a key to toggle my microphone on and
off, and hold it down in order to make it push-to-talk. It looks like
my key repeat is less than 0.5 seconds, so I can set a timer that will
turn things off after a little while. This code doesn't pick up any
changes that happen outside Emacs, but it'll do for now. I used <code>pacmd list-sources</code> to list the sources and get the IDs.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/pacmd-set-device</span> (regexp status)
  (<span class="org-keyword">with-current-buffer</span> (get-buffer-create <span class="org-string">"*pacmd*"</span>)
    (erase-buffer)
    (shell-command <span class="org-string">"pacmd list-sources"</span> (current-buffer))
    (goto-char (point-max))
    (<span class="org-keyword">let</span> (results)
      (<span class="org-keyword">while</span> (re-search-backward regexp nil t)
        (<span class="org-keyword">when</span> (re-search-backward <span class="org-string">"index: </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[[:digit:]]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> nil t)
          (<span class="org-keyword">setq</span> results (cons (match-string 1) results))
          (shell-command-to-string (format <span class="org-string">"pacmd set-source-mute %s %d"</span>
                                           (match-string 1)
                                           (<span class="org-keyword">if</span> (equal status 'on) 0 1)))))
      results)))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/mic-p</span> nil <span class="org-doc">"Non-nil means microphone is on"</span>)
(add-to-list 'mode-line-front-space '(<span class="org-builtin">:eval</span> (<span class="org-keyword">if</span> my/mic-p <span class="org-string">"*MIC*"</span> <span class="org-string">""</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/mic-off</span> ()
  (<span class="org-keyword">interactive</span>)
  (my/pacmd-set-device <span class="org-string">"Yeti"</span> 'off)
  (my/pacmd-set-device <span class="org-string">"Internal Microphone"</span> 'off)
  (<span class="org-keyword">setq</span> my/mic-p nil))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/mic-on</span> ()
  (<span class="org-keyword">interactive</span>)
  (my/pacmd-set-device <span class="org-string">"Yeti"</span> 'on)
  (my/pacmd-set-device <span class="org-string">"Internal Microphone"</span> 'on)
  (<span class="org-keyword">setq</span> my/mic-p t))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/mic-toggle</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">if</span> my/mic-p (my/mic-off) (my/mic-on)))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/push-to-talk-mute-timer</span> nil <span class="org-doc">"Timer to mute things again."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/push-to-talk-last-time</span> nil <span class="org-doc">"Last time my/push-to-talk was run"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/push-to-talk-threshold</span> 0.5 <span class="org-doc">"Number of seconds"</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my/push-to-talk-mute</span> ()
  (<span class="org-keyword">interactive</span>)
  (message <span class="org-string">"Muting."</span>)
  (my/mic-off)
  (force-mode-line-update)
  (<span class="org-keyword">when</span> obs-websocket-recording-p (my/obs-websocket-add-caption <span class="org-string">"[Microphone off]"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/push-to-talk</span> ()
  <span class="org-doc">"Tap to toggle microphone on and off, or repeat the command to make it push to talk."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">cond</span>
   ((null my/mic-p) <span class="org-comment-delimiter">;; </span><span class="org-comment">It's off, so turn it on</span>
    (<span class="org-keyword">when</span> (timerp my/push-to-talk-mute-timer)
      (cancel-timer my/push-to-talk-mute-timer)) 
    (my/mic-on)
    (<span class="org-keyword">when</span> obs-websocket-recording-p (my/obs-websocket-add-caption <span class="org-string">"[Microphone on]"</span>))
    (<span class="org-keyword">setq</span> my/push-to-talk-last-time (current-time)))
   ((timerp my/push-to-talk-mute-timer) <span class="org-comment-delimiter">;; </span><span class="org-comment">Push-to-talk mode</span>
    (cancel-timer my/push-to-talk-mute-timer)
    (<span class="org-keyword">setq</span> my/push-to-talk-mute-timer
          (run-at-time my/push-to-talk-threshold nil #'my/push-to-talk-mute)))
   <span class="org-comment-delimiter">;; </span><span class="org-comment">Might be push to talk, if we're within the key repeating time</span>
   ((&lt; (- (time-to-seconds (current-time)) (time-to-seconds my/push-to-talk-last-time)) 
       my/push-to-talk-threshold)
    (<span class="org-keyword">setq</span> my/push-to-talk-mute-timer
          (run-at-time my/push-to-talk-threshold nil #'my/push-to-talk-mute)))
   <span class="org-comment-delimiter">;; </span><span class="org-comment">It's been a while since I turned the mic on.</span>
   (t (my/push-to-talk-mute))))

(global-set-key (kbd <span class="org-string">"&lt;f12&gt;"</span>) #'my/push-to-talk)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf400784" class="outline-4">
<h4 id="orgf400784">Messages</h4>
<div class="outline-text-4" id="text-orgf400784">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/stream-message</span> (text)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MText: "</span>)
  (obs-websocket-send <span class="org-string">"SetSourceSettings"</span> <span class="org-builtin">:sourceName</span> <span class="org-string">"OBSMessage"</span> <span class="org-builtin">:sourceSettings</span> 
                      (list <span class="org-builtin">:text</span>
                            (concat <span class="org-string">"Notes at stream.sachachua.com\n"</span>
                                    (mapconcat 'identity (org-wrap text 80) <span class="org-string">"\n"</span>))))
  (my/obs-websocket-add-caption text)
  (<span class="org-keyword">when</span> obs-websocket-streaming-p
    (<span class="org-keyword">with-current-buffer</span> (find-file-noselect <span class="org-string">"~/code/stream/index.org"</span>)
      (org-link-search <span class="org-string">"Timestamps"</span>)
      (forward-line 1)
      (insert (format <span class="org-string">"- (%s) %s\n"</span>
                      (format-seconds <span class="org-string">"%h:%.2m:%.2s%z"</span> (floor (my/obs-websocket-stream-time-secs)))
                      text))))
  (<span class="org-keyword">when</span> (erc-get-buffer <span class="org-string">"#sachachua"</span>)
    (<span class="org-keyword">with-current-buffer</span> (erc-get-buffer <span class="org-string">"#sachachua"</span>)
      (erc-send-message text))))
</pre>
</div>

<p>
It looks like neither <a href="https://github.com/Palakis/obs-websocket/releases/tag/4.6.1">SendCaptions</a> nor <a href="https://www.reddit.com/r/Twitch/comments/9znvi6/help_with_chatbot_and_markers_please/">/marker (via TwitchIRC)</a>
work on Linux, so maybe I'll just save timestamped notes
somewhere. I should make this work with recording timecodes, too.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/obs-websocket-last-stream-timecode</span> nil <span class="org-doc">"(timecode-string . system-time)"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/obs-websocket-last-recording-timecode</span> nil <span class="org-doc">"(timecode-string . system-time)"</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my/obs-websocket-message-handler</span> (payload)
  <span class="org-doc">"Save the current streaming timecode."</span>
  (<span class="org-keyword">pcase</span> (plist-get payload <span class="org-builtin">:update-type</span>)
    (<span class="org-string">"RecordingStarted"</span> (my/obs-websocket-check-recording-timecode))
    (<span class="org-string">"StreamStatus"</span>
     (<span class="org-keyword">setq</span> my/obs-websocket-last-stream-timecode (cons (plist-get payload <span class="org-builtin">:stream-timecode</span>) (current-time))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/obs-websocket-check-recording-timecode</span> ()
  (obs-websocket-send <span class="org-string">"GetRecordingStatus"</span>
                      <span class="org-builtin">:callback</span>
                      (<span class="org-keyword">lambda</span> (frame payload)
                        (<span class="org-keyword">setq</span> my/obs-websocket-last-recording-timecode
                              (cons (plist-get payload <span class="org-builtin">:recordTimecode</span>) (current-time))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/obs-websocket-timecode-to-msecs</span> (time-string)
  <span class="org-doc">"Find HH:MM:SS.MS pattern in TIME-CODE and convert it to milliseconds.</span>
<span class="org-doc">Return nil if TIME-CODE doesn't match the pattern."</span>
  (<span class="org-keyword">save-match-data</span>
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> time-string (string-match <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> time-string))
      (<span class="org-keyword">let</span> ((hours (string-to-number (match-string 1 time-string)))
            (mins  (string-to-number (match-string 2 time-string)))
            (secs  (string-to-number (match-string 3 time-string)))
            (msecs (string-to-number (match-string 4 time-string))))
        (+ (* (truncate hours) 3600000)
           (* (truncate mins) 60000)
           (* (truncate secs) 1000)
           (truncate msecs))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/obs-websocket-adjust-timecode</span> (timecode-time)
  <span class="org-doc">"Returns the current adjusted time in milliseconds based on TIMECODE-TIME. </span>
<span class="org-doc">TIMECODE-TIME is an alist of (timecode-string . elisp-time)."</span>
  (<span class="org-keyword">when</span> timecode-time
    (+ 
     (my/obs-websocket-timecode-to-msecs (car timecode-time))
     (* 1000.0
        (- (time-to-seconds (current-time)) 
           (time-to-seconds (cdr timecode-time)))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/obs-websocket-stream-time-secs</span> ()
  <span class="org-doc">"Return current stream time in seconds."</span>
  (/ (my/obs-websocket-adjust-timecode my/obs-websocket-last-stream-timecode) 1000.0))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/obs-websocket-stream-time-msecs</span> ()
  <span class="org-doc">"Return current stream time in milliseconds."</span>
  (my/obs-websocket-adjust-timecode my/obs-websocket-last-stream-timecode))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/obs-websocket-recording-time-secs</span> ()
  <span class="org-doc">"Return current recording time in seconds."</span>
  (/ (my/obs-websocket-adjust-timecode my/obs-websocket-last-recording-timecode) 1000.0))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/obs-websocket-recording-time-msecs</span> ()
  <span class="org-doc">"Return current recording time in milliseconds."</span>
  (my/obs-websocket-adjust-timecode my/obs-websocket-last-recording-timecode))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/obs-websocket-caption-file</span> (<span class="org-type">&amp;optional</span> filename)
  <span class="org-doc">"Return the caption file for the current video."</span>
  (<span class="org-keyword">setq</span> filename (<span class="org-keyword">or</span> filename obs-websocket-recording-filename))
  (<span class="org-keyword">when</span> filename
    (expand-file-name (concat (file-name-sans-extension filename) <span class="org-string">".vtt"</span>)
                      (file-name-directory filename))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/obs-websocket-add-caption</span> (text <span class="org-type">&amp;optional</span> ms)
  (<span class="org-keyword">interactive</span> (list (read-string <span class="org-string">"Text: "</span>)))
 (<span class="org-keyword">when</span> (websocket-openp obs-websocket) (obs-websocket-send <span class="org-string">"SendCaptions"</span> <span class="org-builtin">:text</span> text))
  (<span class="org-keyword">setq</span> ms (<span class="org-keyword">or</span> ms (my/obs-websocket-recording-time-msecs)))
  (<span class="org-keyword">when</span> obs-websocket-recording-filename
    (<span class="org-keyword">with-current-buffer</span> (find-file-noselect (my/obs-websocket-caption-file))
      (goto-char (point-max))
      (<span class="org-keyword">when</span> (bobp) (insert <span class="org-string">"WEBVTT\n\n"</span>))
      (subed-append-subtitle nil ms nil text)
      (<span class="org-keyword">save-excursion</span>
        (<span class="org-keyword">when</span> (subed-backward-subtitle-text)
          (subed-set-subtitle-time-stop ms)))
      (save-buffer))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/stream-intermission</span> (text)
  <span class="org-doc">"Start an intermission and prompt me for a message."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"MText: "</span>)
  (set-background-color <span class="org-string">"#330000"</span>)
  (obs-websocket-send <span class="org-string">"SetCurrentScene"</span> <span class="org-builtin">:scene-name</span> <span class="org-string">"Intermission"</span>)
  (my/stream-message text))
</pre>
</div>
</div>
</div>

<div id="outline-container-org876bdc3" class="outline-4">
<h4 id="org876bdc3">Show Emacs-related tasks</h4>
<div class="outline-text-4" id="text-org876bdc3">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/show-emacs-tasks</span> ()
  (<span class="org-keyword">interactive</span>)
  (org-ql-search (org-agenda-files)
    '(<span class="org-keyword">and</span> (todo)
          (parent (<span class="org-keyword">and</span> (tags <span class="org-string">"project"</span>) (tags <span class="org-string">"emacs"</span>) (not (tags <span class="org-string">"inactive"</span>)))))
    <span class="org-builtin">:title</span> <span class="org-string">"Emacs-related project tasks"</span>
    <span class="org-builtin">:sort</span> '(date priority todo)
    <span class="org-builtin">:super-groups</span> '((<span class="org-builtin">:auto-parent</span> t))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc693024" class="outline-4">
<h4 id="orgc693024">General streaming configuration</h4>
<div class="outline-text-4" id="text-orgc693024">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">obs-websocket</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:after</span> pretty-hydra
  <span class="org-builtin">:config</span>
  (add-to-list 'obs-websocket-on-message-payload-functions #'my/obs-websocket-message-handler)
  (<span class="org-keyword">defhydra</span> my/stream-recording (<span class="org-builtin">:exit</span> t)
           <span class="org-doc">"Recording"</span>
           (<span class="org-string">"b"</span> (obs-websocket-send <span class="org-string">"StartRecording"</span>) <span class="org-string">"Begin"</span>)
           (<span class="org-string">"r"</span> (obs-websocket-send <span class="org-string">"StartStopRecording"</span>) <span class="org-string">"Toggle"</span>)
           (<span class="org-string">" "</span> (obs-websocket-send <span class="org-string">"PauseRecording"</span>) <span class="org-string">"Pause"</span>)
           (<span class="org-string">"p"</span> (my/play-latest-recording) <span class="org-string">"Play last"</span>)
           (<span class="org-string">"c"</span> (obs-websocket-send <span class="org-string">"ResumeRecording"</span>) <span class="org-string">"Continue"</span>)
           (<span class="org-string">"e"</span> (obs-websocket-send <span class="org-string">"StopRecording"</span>) <span class="org-string">"End"</span>))
  (<span class="org-keyword">defvaralias</span> '<span class="org-variable-name">my/mic-toggle</span> 'my/mic-p)
  (<span class="org-keyword">defun</span> <span class="org-function-name">my/stream-toggle-streaming</span> () (<span class="org-keyword">interactive</span>)  (obs-websocket-send <span class="org-string">"StartStopStreaming"</span>))
  (<span class="org-keyword">defun</span> <span class="org-function-name">my/stream-toggle-recording</span> () (<span class="org-keyword">interactive</span>) (obs-websocket-send <span class="org-string">"StartStopRecording"</span>))
  (<span class="org-keyword">defvaralias</span> '<span class="org-variable-name">my/stream-toggle-streaming</span> 'obs-websocket-streaming-p)
  (<span class="org-keyword">defvaralias</span> '<span class="org-variable-name">my/stream-toggle-recording</span> 'obs-websocket-recording-p)
  (<span class="org-keyword">pretty-hydra-define</span> my/stream (<span class="org-builtin">:quit-key</span> <span class="org-string">"q"</span>)
    (<span class="org-string">"Setup"</span>
     ((<span class="org-string">"w"</span> (org-open-link-from-string <span class="org-string">"[[file:~/code/stream/notes.org::#streaming-workflow][Streaming]]"</span>) <span class="org-string">"Workflow"</span>)
      (<span class="org-string">"o"</span> (org-open-link-from-string <span class="org-string">"[[file:~/code/stream/index.org::#plans]]"</span>) <span class="org-string">"Notes"</span>)
      (<span class="org-string">"a"</span> my/show-emacs-tasks <span class="org-string">"Agenda"</span>)
      (<span class="org-string">"bt"</span> selectric-mode <span class="org-string">"Typing sounds"</span>)
      (<span class="org-string">"bm"</span> my/stream-toggle-background-music <span class="org-string">"Background music"</span>)
      (<span class="org-string">"I"</span> my/stream-captions-insert <span class="org-string">"Insert caption"</span> <span class="org-builtin">:toggle</span> t)
      (<span class="org-string">"us"</span> (browse-url <span class="org-string">"https://twitch.tv/sachachua"</span>) <span class="org-string">"View stream"</span>)
      (<span class="org-string">"uv"</span> (browse-url <span class="org-string">"https://dashboard.twitch.tv/u/sachachua/stream-manager"</span>) <span class="org-string">"View manager"</span>)
      (<span class="org-string">"uy"</span> (browse-url <span class="org-string">"https://studio.youtube.com/channel/UClT2UAbC6j7TqOWurVhkuHQ/livestreaming/dashboard"</span>) <span class="org-string">"Youtube"</span>)
      (<span class="org-string">"m"</span> my/mic-toggle <span class="org-string">"Toggle mic"</span> <span class="org-builtin">:toggle</span> t))
     <span class="org-string">"Streaming/recording"</span>
     ((<span class="org-string">"s"</span> my/stream-toggle-streaming <span class="org-string">"Streaming - toggle"</span> <span class="org-builtin">:toggle</span> t <span class="org-builtin">:exit</span> t)
      (<span class="org-string">"r"</span> my/stream-toggle-recording <span class="org-string">"Recording - toggle"</span> <span class="org-builtin">:toggle</span> t <span class="org-builtin">:exit</span> t)
      (<span class="org-string">"v"</span> (my/play-latest-recording) <span class="org-string">"Play last"</span>))
     <span class="org-string">"Scenes"</span>
     ((<span class="org-string">"d"</span> (<span class="org-keyword">progn</span> (set-background-color <span class="org-string">"black"</span>) (obs-websocket-send <span class="org-string">"SetCurrentScene"</span> <span class="org-builtin">:scene-name</span> <span class="org-string">"Desktop"</span>)) <span class="org-string">"Desktop"</span> <span class="org-builtin">:exit</span> t)
      (<span class="org-string">"e"</span> (obs-websocket-send <span class="org-string">"SetCurrentScene"</span> <span class="org-builtin">:scene-name</span> <span class="org-string">"Emacs"</span>) <span class="org-string">"Emacs"</span> <span class="org-builtin">:exit</span> t)
      (<span class="org-string">"i"</span> my/stream-intermission <span class="org-string">"Intermission"</span> <span class="org-builtin">:exit</span> t))
     <span class="org-string">"Captions"</span>
     ((<span class="org-string">"n"</span> my/obs-websocket-add-caption <span class="org-string">"Add caption"</span> <span class="org-builtin">:exit</span> t)
      (<span class="org-string">"c"</span> (find-file (my/obs-websocket-caption-file)) <span class="org-string">"View captions"</span> <span class="org-builtin">:exit</span> t)
      (<span class="org-string">"t"</span> my/stream-message <span class="org-string">"Message"</span> <span class="org-builtin">:hint</span> nil <span class="org-builtin">:exit</span> t)
      (<span class="org-string">"&lt;f8&gt;"</span> my/stream-message <span class="org-string">"Message"</span> <span class="org-builtin">:hint</span> nil <span class="org-builtin">:exit</span> t)))) 
  (global-set-key (kbd <span class="org-string">"&lt;f8&gt;"</span>) #'my/stream/body)
  (add-to-list 'obs-websocket-on-message-payload-functions #'my/obs-websocket-message-handler)
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/code/obs-websocket-el"</span> <span class="org-builtin">:ensure</span> nil)
</pre>
</div>
</div>
</div>

<div id="outline-container-org8ab4a1a" class="outline-4">
<h4 id="org8ab4a1a">Playing recordings</h4>
<div class="outline-text-4" id="text-org8ab4a1a">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">mpv</span> <span class="org-builtin">:if</span> my/laptop-p)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/recordings-dir</span> <span class="org-string">"~/videos/"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/play-latest-recording</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((latest (my/latest-file my/recordings-dir)))
    (<span class="org-keyword">if</span> (file-exists-p (my/obs-websocket-caption-file latest))
        (<span class="org-keyword">with-current-buffer</span> (find-file-noselect (my/obs-websocket-caption-file (my/latest-file my/recordings-dir)))
          (goto-char (point-min))
          (subed-mpv-find-video latest)
          (pop-to-buffer (current-buffer)))
      (mpv-play (my/latest-file my/recordings-dir)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-org49a0c18" class="outline-4">
<h4 id="org49a0c18">Live captions</h4>
</div>

<div id="outline-container-org283b87e" class="outline-4">
<h4 id="org283b87e">Stream notes</h4>
<div class="outline-text-4" id="text-org283b87e">
<div class="org-src-container">
<pre class="src src-emacs-lisp"> (<span class="org-keyword">setq</span> imp-default-user-filters '((org-mode . my/imp-htmlize-filter)
                                  (mhtml-mode . nil)
                                  (html-mode . nil)
                                  (web-mode  . nil)))
  (<span class="org-keyword">defun</span> <span class="org-function-name">my/imp-htmlize-filter</span> (buffer)
  <span class="org-doc">"Alternate htmlization of BUFFER before sending to clients."</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">leave the result in the current-buffer</span>
  (<span class="org-keyword">let</span> ((noninteractive t)
        (org-export-use-babel nil)
        (m (<span class="org-keyword">with-current-buffer</span> buffer major-mode)))
    (<span class="org-keyword">case</span> m
      (org-mode
       (insert
        (<span class="org-keyword">with-current-buffer</span> buffer
          (org-export-as 'html))))
      (t
       (<span class="org-keyword">let</span> ((html-buffer (<span class="org-keyword">save-match-data</span> (htmlize-buffer buffer))))
         (insert-buffer-substring html-buffer)
         (kill-buffer html-buffer))))))
(<span class="org-keyword">use-package</span> <span class="org-constant">impatient-mode</span>
  <span class="org-builtin">:config</span> (<span class="org-keyword">setq</span> impatient-mode-delay 1))
</pre>
</div>
</div>
</div>
<div id="outline-container-speech-to-text" class="outline-4">
<h4 id="speech-to-text"><span class="todo TODO">TODO</span> Try continuous streaming and the Google Speech Recognition API</h4>
<div class="outline-text-4" id="text-speech-to-text">
<p>
With data logging $0.004 USD / 15 seconds
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/stream-captions-websocket</span> nil)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/stream-captions-history</span> nil)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/stream-captions-last-caption</span> nil)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/stream-captions-insert</span> nil <span class="org-doc">"Non-nil means insert into the current buffer."</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/stream-captions-insert</span> () (<span class="org-keyword">interactive</span>) (<span class="org-keyword">setq</span> my/stream-captions-insert (not my/stream-captions-insert)))

(<span class="org-keyword">define-minor-mode</span> <span class="org-function-name">my/stream-captions-minor-mode</span> <span class="org-doc">"Toggle the captions server."</span>
  <span class="org-builtin">:lighter</span> <span class="org-string">"CAP"</span>
  <span class="org-builtin">:global</span> t)

(<span class="org-keyword">defun</span> <span class="org-function-name">my/get-last-n-chars</span> (text limit)
  (<span class="org-keyword">if</span> (&lt; (length text) limit)
      text
    (substring text (- (length text) limit))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/stream-captions-on-message</span> (websocket frame)
  (<span class="org-keyword">let*</span> ((payload (json-parse-string (websocket-frame-payload frame) <span class="org-builtin">:object-type</span> 'plist <span class="org-builtin">:array-type</span> 'list))
         (type (plist-get payload <span class="org-builtin">:type</span>))
         (caption (string-trim (plist-get (car (plist-get (car (plist-get (plist-get payload <span class="org-builtin">:stream</span>) <span class="org-builtin">:results</span>)) <span class="org-builtin">:alternatives</span>)) <span class="org-builtin">:transcript</span>))))
    
    (<span class="org-keyword">if</span> (string= type <span class="org-string">"interim"</span>)
        (<span class="org-keyword">when</span> (websocket-openp obs-websocket) (obs-websocket-send <span class="org-string">"SendCaptions"</span> <span class="org-builtin">:text</span> (my/get-last-n-chars caption 80)))
      (<span class="org-keyword">setq</span> my/stream-captions-last-caption caption)
      (call-process <span class="org-string">"notify-send"</span> nil nil nil caption)
      (my/obs-websocket-add-caption caption)
      (<span class="org-keyword">when</span> my/stream-captions-insert (insert caption))
      (<span class="org-keyword">setq</span> my/stream-captions-history (cons caption my/stream-captions-history)))))


(<span class="org-keyword">defun</span> <span class="org-function-name">my/stream-captions-edit-last</span> (caption)
  (<span class="org-keyword">interactive</span> (list (read-string <span class="org-string">"Caption: "</span> my/stream-captions-last-caption 'my/stream-captions-history my/stream-captions-last-caption)))
  (<span class="org-keyword">when</span> (&gt; (length caption) 0)
    (my/obs-websocket-add-caption caption)))
(global-set-key (kbd <span class="org-string">"&lt;f11&gt;"</span>) 'my/stream-captions-edit-last)
    
(<span class="org-keyword">defun</span> <span class="org-function-name">my/stream-captions-on-close</span> (<span class="org-type">&amp;rest</span> args)
  (message <span class="org-string">"Captions websocket closed."</span>)
  (my/stream-captions-minor-mode 0)
  (<span class="org-keyword">setq</span> my/stream-captions-websocket nil))
 
(<span class="org-keyword">defun</span> <span class="org-function-name">my/stream-captions-websocket-connect</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">setq</span> my/stream-captions-history nil)
  (my/stream-captions-minor-mode 1)
  (<span class="org-keyword">setq</span> my/stream-captions-websocket (websocket-open <span class="org-string">"ws://localhost:8085"</span>
                                                     <span class="org-builtin">:on-message</span> #'my/stream-captions-on-message
                                                     <span class="org-builtin">:on-close</span> #'my/stream-captions-on-close)))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/stream-captions-process</span> nil)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/stream-captions-start</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((default-directory <span class="org-string">"~/code/speech"</span>))
    (<span class="org-keyword">setq</span> my/stream-captions-process (start-process <span class="org-string">"Stream captions"</span> (get-buffer-create <span class="org-string">"*stream captions*"</span>) <span class="org-string">"node"</span> <span class="org-string">"test.js"</span>))
    (sleep-for 2)
    (my/stream-captions-websocket-connect)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/stream-captions-sentinel</span> (process event)
  (<span class="org-keyword">let</span> ((status (process-status my/stream-captions-process)))
    (<span class="org-keyword">if</span> (member status '(stop exit signal))
        (my/stream-captions-minor-mode -1))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/stream-captions-stop</span> ()
  (<span class="org-keyword">interactive</span>)
  (stop-process my/stream-captions-process))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org4d7d932" class="outline-3">
<h3 id="org4d7d932">Other nifty Emacs things I want to learn</h3>
<div class="outline-text-3" id="text-org4d7d932">
</div>
<div id="outline-container-orgefb0fd2" class="outline-4">
<h4 id="orgefb0fd2">Smartparens mode&#xa0;&#xa0;&#xa0;<span class="tag"><span class="drill">drill</span></span></h4>
<div class="outline-text-4" id="text-orgefb0fd2">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">smartparens</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">progn</span>
    (<span class="org-keyword">require</span> '<span class="org-constant">smartparens-config</span>)
    (add-hook 'emacs-lisp-mode-hook 'smartparens-mode)
    (add-hook 'emacs-lisp-mode-hook 'show-smartparens-mode)

      <span class="org-comment-delimiter">;;;;;;;;;;;;;;;;;;;;;;;;</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">keybinding management</span>

    (define-key sp-keymap (kbd <span class="org-string">"C-c s r n"</span>) 'sp-narrow-to-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-f"</span>) 'sp-forward-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-b"</span>) 'sp-backward-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-d"</span>) 'sp-down-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-a"</span>) 'sp-backward-down-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-S-a"</span>) 'sp-beginning-of-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-S-d"</span>) 'sp-end-of-sexp)

    (define-key sp-keymap (kbd <span class="org-string">"C-M-e"</span>) 'sp-up-sexp)
    (define-key emacs-lisp-mode-map (kbd <span class="org-string">")"</span>) 'sp-up-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-u"</span>) 'sp-backward-up-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-t"</span>) 'sp-transpose-sexp)

    (define-key sp-keymap (kbd <span class="org-string">"C-M-n"</span>) 'sp-next-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-p"</span>) 'sp-previous-sexp)

    (define-key sp-keymap (kbd <span class="org-string">"C-M-k"</span>) 'sp-kill-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-w"</span>) 'sp-copy-sexp)

    (define-key sp-keymap (kbd <span class="org-string">"M-&lt;delete&gt;"</span>) 'sp-unwrap-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"M-&lt;backspace&gt;"</span>) 'sp-backward-unwrap-sexp)

    (define-key sp-keymap (kbd <span class="org-string">"C-&lt;right&gt;"</span>) 'sp-forward-slurp-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-&lt;left&gt;"</span>) 'sp-forward-barf-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-&lt;left&gt;"</span>) 'sp-backward-slurp-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-&lt;right&gt;"</span>) 'sp-backward-barf-sexp)

    (define-key sp-keymap (kbd <span class="org-string">"M-D"</span>) 'sp-splice-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-&lt;delete&gt;"</span>) 'sp-splice-sexp-killing-forward)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-&lt;backspace&gt;"</span>) 'sp-splice-sexp-killing-backward)
    (define-key sp-keymap (kbd <span class="org-string">"C-S-&lt;backspace&gt;"</span>) 'sp-splice-sexp-killing-around)

    (define-key sp-keymap (kbd <span class="org-string">"C-]"</span>) 'sp-select-next-thing-exchange)
    (define-key sp-keymap (kbd <span class="org-string">"C-&lt;left_bracket&gt;"</span>) 'sp-select-previous-thing)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-]"</span>) 'sp-select-next-thing)

    (define-key sp-keymap (kbd <span class="org-string">"M-F"</span>) 'sp-forward-symbol)
    (define-key sp-keymap (kbd <span class="org-string">"M-B"</span>) 'sp-backward-symbol)

    (define-key sp-keymap (kbd <span class="org-string">"C-c s t"</span>) 'sp-prefix-tag-object)
    (define-key sp-keymap (kbd <span class="org-string">"C-c s p"</span>) 'sp-prefix-pair-object)
    (define-key sp-keymap (kbd <span class="org-string">"C-c s c"</span>) 'sp-convolute-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-c s a"</span>) 'sp-absorb-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-c s e"</span>) 'sp-emit-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-c s p"</span>) 'sp-add-to-previous-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-c s n"</span>) 'sp-add-to-next-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-c s j"</span>) 'sp-join-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-c s s"</span>) 'sp-split-sexp)

      <span class="org-comment-delimiter">;;;;;;;;;;;;;;;;;;</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">pair management</span>

    (sp-local-pair 'minibuffer-inactive-mode <span class="org-string">"'"</span> nil <span class="org-builtin">:actions</span> nil)
    (sp-local-pair 'web-mode <span class="org-string">"&lt;"</span> nil <span class="org-builtin">:when</span> '(my/sp-web-mode-is-code-context))

      <span class="org-comment-delimiter">;;; </span><span class="org-comment">markdown-mode</span>
    (<span class="org-keyword">sp-with-modes</span> '(markdown-mode gfm-mode rst-mode)
      (sp-local-pair <span class="org-string">"*"</span> <span class="org-string">"*"</span> <span class="org-builtin">:bind</span> <span class="org-string">"C-*"</span>)
      (sp-local-tag <span class="org-string">"2"</span> <span class="org-string">"**"</span> <span class="org-string">"**"</span>)
      (sp-local-tag <span class="org-string">"s"</span> <span class="org-string">"```scheme"</span> <span class="org-string">"```"</span>)
      (sp-local-tag <span class="org-string">"&lt;"</span>  <span class="org-string">"&lt;_&gt;"</span> <span class="org-string">"&lt;/_&gt;"</span> <span class="org-builtin">:transform</span> 'sp-match-sgml-tags))

      <span class="org-comment-delimiter">;;; </span><span class="org-comment">tex-mode latex-mode</span>
    (<span class="org-keyword">sp-with-modes</span> '(tex-mode plain-tex-mode latex-mode)
      (sp-local-tag <span class="org-string">"i"</span> <span class="org-string">"1d5f8e69396c521f645375107197ea4dfbc7b792quot;&lt;"</span> <span class="org-string">"1d5f8e69396c521f645375107197ea4dfbc7b792quot;&gt;"</span>))

      <span class="org-comment-delimiter">;;; </span><span class="org-comment">html-mode</span>
    (<span class="org-keyword">sp-with-modes</span> '(html-mode sgml-mode web-mode)
      (sp-local-pair <span class="org-string">"&lt;"</span> <span class="org-string">"&gt;"</span>))

      <span class="org-comment-delimiter">;;; </span><span class="org-comment">lisp modes</span>
    (<span class="org-keyword">sp-with-modes</span> sp--lisp-modes
      (sp-local-pair <span class="org-string">"("</span> nil <span class="org-builtin">:bind</span> <span class="org-string">"C-("</span>))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org0aaaff1" class="outline-3">
<h3 id="org0aaaff1">Encryption</h3>
<div class="outline-text-3" id="text-org0aaaff1">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> epa-file-encrypt-to '(<span class="org-string">"sacha@sachachua.com"</span>))
(<span class="org-keyword">setq</span> epa-pinentry-mode 'loopback)
(<span class="org-keyword">setq</span> epg-pinentry-mode 'loopback)
</pre>
</div>
</div>
</div>
<div id="outline-container-org9bba70f" class="outline-3">
<h3 id="org9bba70f"><span class="done DONE">DONE</span> Scan ~/bin and turn the scripts into interactive commands</h3>
<div class="outline-text-3" id="text-org9bba70f">
<p>
I want to automate little things on my computer so that I don't have
to look up command lines or stitch together different applications.
Many of these things make sense to turn into shell scripts. That way,
I can call them from other programs and assign keyboard shortcuts to
them. Still, I spend most of my computer time in Emacs, and I don't
want to think about whether I've defined a command in Emacs Lisp or in
a shell script. Besides, I like the way <a href="http://sachachua.com/blog/2014/03/emacs-basics-call-commands-name-m-x-tips-better-completion-using-ido-helm/">Helm</a> lets me type parts of
commands in order to select and call them.
</p>

<p>
Emacs Lisp allows you to define a macro that results in Emacs Lisp
code. In this case, I want to define interactive functions so I can
call them with <code>M-x</code>. In case I decide to call them from Emacs Lisp,
such as <code>(my/shell/rotate-screen "left")</code>, I want to be able to pass
arguments. I'm also using <a href="https://github.com/magnars/dash.el">dash.el</a> to provide functions like <code>-filter</code>
and <code>-not</code>, although I could rewrite this to just use the standard
Emacs Lisp functions.
</p>

<p>
Here's the code that scans a given directory for executable files and
creates interactive functions, and some code that calls it for my <a href="https://github.com/sachac/scripts">~/bin</a> directory.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">require</span> '<span class="org-constant">dash</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">dash-functional</span>)
(<span class="org-keyword">defmacro</span> <span class="org-function-name">my/convert-shell-scripts-to-interactive-commands</span> (directory)
  <span class="org-doc">"Make the shell scripts in DIRECTORY available as interactive commands."</span>
  (cons 'progn
        (-map
         (<span class="org-keyword">lambda</span> (filename)
           (<span class="org-keyword">let</span> ((function-name (intern (concat <span class="org-string">"my/shell/"</span> (file-name-nondirectory filename)))))
             `(<span class="org-keyword">defun</span> ,function-name (<span class="org-type">&amp;rest</span> args)
                (<span class="org-keyword">interactive</span>)
                (<span class="org-keyword">cond</span>
                 ((not (called-interactively-p 'any))
                  (shell-command-to-string (mapconcat 'shell-quote-argument (cons ,filename args) <span class="org-string">" "</span>)))
                 ((region-active-p)
                  (apply 'call-process-region (point) (mark) ,filename nil (<span class="org-keyword">if</span> current-prefix-arg t nil) t args))
                 (t
                  (apply 'call-process ,filename nil (<span class="org-keyword">if</span> current-prefix-arg t nil) nil args))))))
         (-filter (-not #'file-directory-p)
                  (-filter #'file-executable-p (directory-files directory t))))))

(<span class="org-keyword">my/convert-shell-scripts-to-interactive-commands</span> <span class="org-string">"~/bin"</span>)
</pre>
</div>

<p>
Let's see how that goes!
</p>
</div>
</div>

<div id="outline-container-orgc9fd6f4" class="outline-3">
<h3 id="orgc9fd6f4">Syncthing</h3>
<div class="outline-text-3" id="text-orgc9fd6f4">
<p>
From <a href="https://www.reddit.com/r/emacs/comments/bqqqra/quickly_find_syncthing_conflicts_and_resolve_them/">https://www.reddit.com/r/emacs/comments/bqqqra/quickly_find_syncthing_conflicts_and_resolve_them/</a>
In termux, you also need to <code>pkg install diffutils</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/resolve-orgzly-syncthing</span> ()
  (<span class="org-keyword">interactive</span>)
  (ibizaman/syncthing-resolve-conflicts <span class="org-string">"~/sync/orgzly"</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">ibizaman/syncthing-resolve-conflicts</span> (directory)
  <span class="org-doc">"Resolve all conflicts under given DIRECTORY."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"D"</span>)
  (<span class="org-keyword">let*</span> ((all (ibizaman/syncthing--get-sync-conflicts directory))
         (chosen (ibizaman/syncthing--pick-a-conflict all)))
    (ibizaman/syncthing-resolve-conflict chosen)))


(<span class="org-keyword">defun</span> <span class="org-function-name">ibizaman/syncthing-show-conflicts-dired</span> (directory)
  <span class="org-doc">"Open dired buffer at DIRECTORY showing all syncthing conflicts."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"D"</span>)
  (find-name-dired directory <span class="org-string">"*.sync-conflict-*"</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">ibizaman/syncthing-resolve-conflict-dired</span> (<span class="org-type">&amp;optional</span> arg)
  <span class="org-doc">"Resolve conflict of first marked file in dired or close to point with ARG."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"P"</span>)
  (<span class="org-keyword">let</span> ((chosen (car (dired-get-marked-files nil arg))))
    (ibizaman/syncthing-resolve-conflict chosen)))

(<span class="org-keyword">defun</span> <span class="org-function-name">ibizaman/syncthing-resolve-conflict</span> (conflict)
  <span class="org-doc">"Resolve CONFLICT file using ediff."</span>
  (<span class="org-keyword">let*</span> ((normal (ibizaman/syncthing--get-normal-filename conflict)))
    (ibizaman/ediff-files
     (list conflict normal)
     `(<span class="org-keyword">lambda</span> ()
        (<span class="org-keyword">when</span> (y-or-n-p <span class="org-string">"Delete conflict file? "</span>)
          (kill-buffer (get-file-buffer ,conflict))
          (delete-file ,conflict))))))



(<span class="org-keyword">defun</span> <span class="org-function-name">ibizaman/syncthing--get-sync-conflicts</span> (directory)
  <span class="org-doc">"Return a list of all sync conflict files in a DIRECTORY."</span>
  (directory-files-recursively directory <span class="org-string">"\\.sync-conflict-"</span>))


(<span class="org-keyword">defvar</span> <span class="org-variable-name">ibizaman/syncthing--conflict-history</span> nil
  <span class="org-doc">"Completion conflict history"</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">ibizaman/syncthing--pick-a-conflict</span> (conflicts)
  <span class="org-doc">"Let user choose the next conflict from CONFLICTS to investigate."</span>
  (completing-read <span class="org-string">"Choose the conflict to investigate: "</span> conflicts
                   nil t nil ibizaman/syncthing--conflict-history))


(<span class="org-keyword">defun</span> <span class="org-function-name">ibizaman/syncthing--get-normal-filename</span> (conflict)
  <span class="org-doc">"Get non-conflict filename matching the given CONFLICT."</span>
  (replace-regexp-in-string <span class="org-string">"\\.sync-conflict-.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\..*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">$"</span> <span class="org-string">"\\1"</span> conflict))


(<span class="org-keyword">defun</span> <span class="org-function-name">ibizaman/ediff-files</span> (<span class="org-type">&amp;optional</span> files quit-hook)
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">lexical-let</span> ((files (<span class="org-keyword">or</span> files (dired-get-marked-files)))
                (quit-hook quit-hook)
                (wnd (current-window-configuration)))
    (<span class="org-keyword">if</span> (&lt;= (length files) 2)
        (<span class="org-keyword">let</span> ((file1 (car files))
              (file2 (<span class="org-keyword">if</span> (cdr files)
                         (cadr files)
                       (read-file-name
                        <span class="org-string">"file: "</span>
                        (dired-dwim-target-directory)))))
          (<span class="org-keyword">if</span> (file-newer-than-file-p file1 file2)
              (ediff-files file2 file1)
            (ediff-files file1 file2))
          (add-hook 'ediff-after-quit-hook-internal
                    (<span class="org-keyword">lambda</span> ()
                      (<span class="org-keyword">setq</span> ediff-after-quit-hook-internal nil)
                      (<span class="org-keyword">when</span> quit-hook (funcall quit-hook))
                      (set-window-configuration wnd))))
      (<span class="org-warning">error</span> <span class="org-string">"no more than 2 files should be marked"</span>))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc500905" class="outline-3">
<h3 id="orgc500905">Search logs</h3>
<div class="outline-text-3" id="text-orgc500905">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/search-irc-logs</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((helm-rg-default-directory <span class="org-string">"~/backups/server/home/.znc/users/sachac/moddata/log/freenode"</span>))
    (call-interactively 'helm-rg)))
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-links" class="outline-2">
<h2 id="links">Other cool configs you may want to check out</h2>
<div class="outline-text-2" id="text-links">
<p>
<a id="orge1321e2"></a>
</p>

<ul class="org-ul">
<li><a href="http://doc.norang.ca/org-mode.html">Bernt Hansen</a>: Lots of Org-related config. I picked up the graph-drawing stuff from this.</li>
<li><a href="https://github.com/bzg/dotemacs">Bastien Guerry</a>: Org, Gnus, ERC - Explained in this <a href="http://sachachua.com/blog/2013/05/emacs-chat-bastien-guerry/">Emacs Chat (~1h)</a></li>
<li><a href="https://github.com/iani/emacs-prelude">Iannis Zannos</a>: Explained in this <a href="https://www.youtube.com/watch?v=0F8aCbC9z3A">Emacs Chat (~1h)</a></li>
<li><a href="https://github.com/magnars/.emacs.d">Magnar Sveen</a>: <a href="http://whattheemacsd.com/">http://whattheemacsd.com/</a> has some explanations. <a href="http://sachachua.com/blog/2013/11/emacs-chat-magnar-sveen-emacs-rocks/">Emacs Chat (~1h)</a></li>
<li><a href="https://github.com/jwiegley/dot-emacs">John Wiegley</a>: Also see his <a href="http://www.youtube.com/watch?v=RvPFZL6NJNQ">Emacs Lisp Development talk</a> (sorry, sucky video) and <a href="http://www.youtube.com/watch?v=ytNsHmRLZGM">Emacs Chat video</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgbfcb161" class="outline-2">
<h2 id="orgbfcb161">Temporary workarounds</h2>
<div class="outline-text-2" id="text-orgbfcb161">
</div>
<div id="outline-container-org423520b" class="outline-3">
<h3 id="org423520b">Tablet clicks count as drags</h3>
<div class="outline-text-3" id="text-org423520b">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">widget-button-click</span> (event)
  <span class="org-doc">"Invoke the button that the mouse is pointing at."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"e"</span>)
  (<span class="org-keyword">if</span> (widget-event-point event)
      (<span class="org-keyword">let*</span> ((oevent event)
             (mouse-1 (memq (event-basic-type event) '(mouse-1 down-mouse-1)))
             (pos (widget-event-point event))
             (start (event-start event))
             (button (get-char-property
                      pos 'button (<span class="org-keyword">and</span> (windowp (posn-window start))
                                       (window-buffer (posn-window start)))))
             newpoint)
        (<span class="org-keyword">when</span> (<span class="org-keyword">or</span> (null button)
                  (<span class="org-keyword">catch</span> '<span class="org-constant">button-press-cancelled</span>
                    <span class="org-comment-delimiter">;; </span><span class="org-comment">Mouse click on a widget button.  Do the following</span>
                    <span class="org-comment-delimiter">;; </span><span class="org-comment">in a save-excursion so that the click on the button</span>
                    <span class="org-comment-delimiter">;; </span><span class="org-comment">doesn't change point.</span>
                    (<span class="org-keyword">save-selected-window</span>
                      (select-window (posn-window (event-start event)))
                      (<span class="org-keyword">save-excursion</span>
                        (goto-char (posn-point (event-start event)))
                        (<span class="org-keyword">let*</span> ((overlay (widget-get button <span class="org-builtin">:button-overlay</span>))
                               (pressed-face (<span class="org-keyword">or</span> (widget-get button <span class="org-builtin">:pressed-face</span>)
                                                 widget-button-pressed-face))
                               (face (overlay-get overlay 'face))
                               (mouse-face (overlay-get overlay 'mouse-face)))
                          (<span class="org-keyword">unwind-protect</span>
                              <span class="org-comment-delimiter">;; </span><span class="org-comment">Read events, including mouse-movement</span>
                              <span class="org-comment-delimiter">;; </span><span class="org-comment">events, waiting for a release event.  If we</span>
                              <span class="org-comment-delimiter">;; </span><span class="org-comment">began with a mouse-1 event and receive a</span>
                              <span class="org-comment-delimiter">;; </span><span class="org-comment">movement event, that means the user wants</span>
                              <span class="org-comment-delimiter">;; </span><span class="org-comment">to perform drag-selection, so cancel the</span>
                              <span class="org-comment-delimiter">;; </span><span class="org-comment">button press and do the default mouse-1</span>
                              <span class="org-comment-delimiter">;; </span><span class="org-comment">action.  For mouse-2, just highlight/</span>
                              <span class="org-comment-delimiter">;; </span><span class="org-comment">unhighlight the button the mouse was</span>
                              <span class="org-comment-delimiter">;; </span><span class="org-comment">initially on when we move over it.</span>
                              (<span class="org-keyword">save-excursion</span>
                                (<span class="org-keyword">when</span> face  <span class="org-comment-delimiter">; </span><span class="org-comment">avoid changing around image</span>
                                  (overlay-put overlay 'face pressed-face)
                                  (overlay-put overlay 'mouse-face pressed-face))
                                (<span class="org-keyword">unless</span> (widget-apply button <span class="org-builtin">:mouse-down-action</span> event)
                                  (<span class="org-keyword">let</span> ((track-mouse t))
                                    (<span class="org-keyword">while</span> (not (widget-button-release-event-p event))
                                      (<span class="org-keyword">setq</span> event (read-event))

                                      <span class="org-comment-delimiter">;; </span><span class="org-comment">Sacha: Commented this section out so that my stylus</span>
                                      <span class="org-comment-delimiter">;; </span><span class="org-comment">clicks don't get reported as mouse movement</span>

                                      <span class="org-comment-delimiter">;; </span><span class="org-comment">(when (and mouse-1 (mouse-movement-p event))</span>
                                      <span class="org-comment-delimiter">;;   </span><span class="org-comment">(push event unread-command-events)</span>
                                      <span class="org-comment-delimiter">;;   </span><span class="org-comment">(setq event oevent)</span>
                                      <span class="org-comment-delimiter">;;   </span><span class="org-comment">(throw 'button-press-cancelled t))</span>
                                      (<span class="org-keyword">unless</span> (<span class="org-keyword">or</span> (integerp event)
                                                  (memq (car event) '(switch-frame select-window))
                                                  (eq (car event) 'scroll-bar-movement))
                                        (<span class="org-keyword">setq</span> pos (widget-event-point event))
                                        (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> pos
                                                 (eq (get-char-property pos 'button)
                                                     button))
                                            (<span class="org-keyword">when</span> face
                                              (overlay-put overlay 'face pressed-face)
                                              (overlay-put overlay 'mouse-face pressed-face))
                                          (overlay-put overlay 'face face)
                                          (overlay-put overlay 'mouse-face mouse-face))))))

                                <span class="org-comment-delimiter">;; </span><span class="org-comment">When mouse is released over the button, run</span>
                                <span class="org-comment-delimiter">;; </span><span class="org-comment">its action function.</span>
                                (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> pos (eq (get-char-property pos 'button) button))
                                  (goto-char pos)
                                  (widget-apply-action button event)
                                  (<span class="org-keyword">if</span> widget-button-click-moves-point
                                      (<span class="org-keyword">setq</span> newpoint (point)))))
                            (overlay-put overlay 'face face)
                            (overlay-put overlay 'mouse-face mouse-face))))

                      (<span class="org-keyword">if</span> newpoint (goto-char newpoint))
                      <span class="org-comment-delimiter">;; </span><span class="org-comment">This loses if the widget action switches windows. -- cyd</span>
                      <span class="org-comment-delimiter">;; </span><span class="org-comment">(unless (pos-visible-in-window-p (widget-event-point event))</span>
                      <span class="org-comment-delimiter">;;   </span><span class="org-comment">(mouse-set-point event)</span>
                      <span class="org-comment-delimiter">;;   </span><span class="org-comment">(beginning-of-line)</span>
                      <span class="org-comment-delimiter">;;   </span><span class="org-comment">(recenter))</span>
                      )
                    nil))
          (<span class="org-keyword">let</span> ((up t) command)
            <span class="org-comment-delimiter">;; </span><span class="org-comment">Mouse click not on a widget button.  Find the global</span>
            <span class="org-comment-delimiter">;; </span><span class="org-comment">command to run, and check whether it is bound to an</span>
            <span class="org-comment-delimiter">;; </span><span class="org-comment">up event.</span>
            (<span class="org-keyword">if</span> mouse-1
                (<span class="org-keyword">cond</span> ((<span class="org-keyword">setq</span> command  <span class="org-comment-delimiter">;</span><span class="org-comment">down event</span>
                             (lookup-key widget-global-map [down-mouse-1]))
                       (<span class="org-keyword">setq</span> up nil))
                      ((<span class="org-keyword">setq</span> command  <span class="org-comment-delimiter">;</span><span class="org-comment">up event</span>
                             (lookup-key widget-global-map [mouse-1]))))
              (<span class="org-keyword">cond</span> ((<span class="org-keyword">setq</span> command  <span class="org-comment-delimiter">;</span><span class="org-comment">down event</span>
                           (lookup-key widget-global-map [down-mouse-2]))
                     (<span class="org-keyword">setq</span> up nil))
                    ((<span class="org-keyword">setq</span> command  <span class="org-comment-delimiter">;</span><span class="org-comment">up event</span>
                           (lookup-key widget-global-map [mouse-2])))))
            (<span class="org-keyword">when</span> up
              <span class="org-comment-delimiter">;; </span><span class="org-comment">Don't execute up events twice.</span>
              (<span class="org-keyword">while</span> (not (widget-button-release-event-p event))
                (<span class="org-keyword">setq</span> event (read-event))))
            (<span class="org-keyword">when</span> command
              (call-interactively command)))))
    (message <span class="org-string">"You clicked somewhere weird."</span>)))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org7bb7d66" class="outline-2">
<h2 id="org7bb7d66">Inactive/infrequent things</h2>
<div class="outline-text-2" id="text-org7bb7d66">
</div>
<div id="outline-container-org2676d3a" class="outline-3">
<h3 id="org2676d3a">Paint</h3>
<div class="outline-text-3" id="text-org2676d3a">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">paint</span>
  <span class="org-builtin">:disabled</span> t
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/cloud/elisp"</span>
  <span class="org-builtin">:init</span> 
  (<span class="org-keyword">progn</span>
    (<span class="org-keyword">setq</span> paint-foreground-color <span class="org-string">"white"</span> paint-background-color <span class="org-string">"black"</span>)
    (<span class="org-keyword">defun</span> <span class="org-function-name">my/paint</span> () (<span class="org-keyword">interactive</span>) (delete-other-windows) (paint 1600 900 nil))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org19b43f0" class="outline-3">
<h3 id="org19b43f0">Oddmuse</h3>
<div class="outline-text-3" id="text-org19b43f0">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">oddmuse</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/vendor/oddmuse-el"</span>
  <span class="org-builtin">:ensure</span> nil
  <span class="org-builtin">:config</span> (oddmuse-mode-initialize)
  <span class="org-builtin">:hook</span> (oddmuse-mode-hook .
                           (<span class="org-keyword">lambda</span> ()
                             (<span class="org-keyword">unless</span> (string-match <span class="org-string">"question"</span> oddmuse-post)
                               (<span class="org-keyword">when</span> (string-match <span class="org-string">"EmacsWiki"</span> oddmuse-wiki)
                                 (<span class="org-keyword">setq</span> oddmuse-post (concat <span class="org-string">"uihnscuskc=1;"</span> oddmuse-post)))
                               (<span class="org-keyword">when</span> (string-match <span class="org-string">"OddmuseWiki"</span> oddmuse-wiki)
                                 (<span class="org-keyword">setq</span> oddmuse-post (concat <span class="org-string">"ham=1;"</span> oddmuse-post)))))))
</pre>
</div>
</div>
</div>
<div id="outline-container-orga1306ea" class="outline-3">
<h3 id="orga1306ea">Building a today-I-learned habit, and displaying the documentation for random Emacs commands&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></h3>
<div class="outline-text-3" id="text-orga1306ea">
<p>
I'd like to build a habit of regularly learning one small thing each
day in one of three domains: tech, life, and learning. My measurable
output would probably be in the form of index cards, tweets, blog
posts, and notes (in org-capture, Dropbox, or Evernote). I can get
input from various sources like blog posts, videos, books, webpages,
and so on.
</p>

<p>
A little bit of randomness might be useful for learning more about
Emacs. Emacswiki has a <a href="http://www.emacswiki.org/emacs?action=random">random page</a> function, but the chunks are often
a little large or irrelevant. On the other hand, displaying a random
command from the packages that I already have loaded into my Emacs -
that might be a good way to discover interesting things.
</p>

<p>
I started by looking at <code>apropos-command</code>, which led me to
<code>apropos-internal</code>, which is a C function that referred to <code>obarray</code>.
Using <code>obarray</code> by itself didn't work (suspiciously few elements, so I
often ended up looking at emms-related functions). I eventually found
<a href="http://www.gnu.org/software/emacs/manual/html_node/elisp/Creating-Symbols.html">mapatoms</a>, which seems to do a better job at listing an appreciable
number of interactive functions. I filtered the list to include only
documented functions that had not been marked as obsolete: 8,415 in
my current Emacs, which should be plenty to go through. =)
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/describe-random-interactive-function</span> ()
  (<span class="org-keyword">interactive</span>)
  <span class="org-string">"Show the documentation for a random interactive function.</span>
<span class="org-string">     Consider only documented, non-obsolete functions."</span>
  (<span class="org-keyword">let</span> (result)
    (mapatoms
     (<span class="org-keyword">lambda</span> (s)
       (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (commandp s) 
                  (documentation s t)
                  (null (get s 'byte-obsolete-info)))
         (<span class="org-keyword">setq</span> result (cons s result)))))
    (describe-function (elt result (random (length result))))))
</pre>
</div>

<p>
I've added this to a <a href="https://www.emacswiki.org/emacs/KeyChord">key-chord</a> + <a href="https://github.com/abo-abo/hydra">hydra</a> keymap as a repeatable
function, so I can type <code>hh</code> to start my Hydra and then type <code>r</code> as
many times as I want in order to show the documentation for a random
interactive function. If you're curious about that, you can see the
<a href="http://sachachua.com/dotemacs#key-chord">key-chord section of my config</a>.
</p>

<p>
Anyway, today I learned more about <code>obarray</code> and <code>mapatoms</code> - they're
not interactive functions, but they were handy for building this
little bit of code. We'll see how it goes! =)
</p>
</div>
</div>

<div id="outline-container-org14f049b" class="outline-3">
<h3 id="org14f049b">Org - mapping blog posts and image URLs from bulk exports</h3>
<div class="outline-text-3" id="text-org14f049b">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-map-blog-and-image-urls</span> ()
  <span class="org-doc">"Extract and map blog post / image URLs."</span>
  (<span class="org-keyword">interactive</span>)
  (goto-char (point-min))
  (keep-lines <span class="org-string">"h2</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">img"</span>)
  (goto-char (point-min))
  (<span class="org-keyword">while</span> (re-search-forward
          <span class="org-string">"^.*?h2.*?a href=\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\".*$"</span> nil t)
    (replace-match <span class="org-string">"\\1"</span>))
  (goto-char (point-min))
  (<span class="org-keyword">while</span> (re-search-forward
          <span class="org-string">"^.*?src=\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\".*$"</span> nil t)
    (replace-match <span class="org-string">"\\1"</span>))
  (<span class="org-keyword">let</span> (last-post current-url result)
    (goto-char (point-min))
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"http://</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> nil t)
      (<span class="org-keyword">setq</span> current-url (match-string 0))
      (<span class="org-keyword">if</span> (string-match <span class="org-string">"/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">/]*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">_thumb</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">-640x.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?.png"</span> current-url)
          (<span class="org-keyword">setq</span> result (cons (concat (match-string 1 current-url) <span class="org-string">"\t"</span> last-post) result))
        (<span class="org-keyword">setq</span> last-post current-url)))
    (kill-new (mapconcat 'identity result <span class="org-string">"\n"</span>))))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc9da641" class="outline-3">
<h3 id="orgc9da641">Transcript editing</h3>
<div class="outline-text-3" id="text-orgc9da641">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/split-sentence-and-capitalize</span> ()
  (<span class="org-keyword">interactive</span>)
  (delete-char 1)
  (insert <span class="org-string">"."</span>)
  (capitalize-word 1))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/split-sentence-delete-word-and-capitalize</span> ()
  (<span class="org-keyword">interactive</span>)
  (delete-char 1)
  (insert <span class="org-string">"."</span>)
  (kill-word 1)
  (capitalize-word 1))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/delete-word-and-capitalize</span> ()
  (<span class="org-keyword">interactive</span>)
  (skip-syntax-backward <span class="org-string">"w"</span>)
  (kill-word 1)
  (capitalize-word 1))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/emms-player-mplayer-set-speed</span> (speed)
  <span class="org-doc">"Depends on mplayer's -slave mode"</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"MSpeed: "</span>)
  (process-send-string emms-player-simple-process-name
                       (format <span class="org-string">"speed_set %s\n"</span> speed)))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/emms-player-mplayer-speed-increment</span> 0.1)

(<span class="org-keyword">defun</span> <span class="org-function-name">my/emms-player-mplayer-speed-up</span> ()
  <span class="org-doc">"Depends on mplayer's -slave mode"</span>
  (<span class="org-keyword">interactive</span>)
  (process-send-string emms-player-simple-process-name
                       (format <span class="org-string">"speed_incr %f\n"</span> my/emms-player-mplayer-speed-increment)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/emms-player-mplayer-slow-down</span> ()
  <span class="org-doc">"Depends on mplayer's -slave mode"</span>
  (<span class="org-keyword">interactive</span>)
  (process-send-string emms-player-simple-process-name
                       (format <span class="org-string">"speed_incr %f\n"</span> (- 0 my/emms-player-mplayer-speed-increment))))


</pre>
</div>
</div>
</div>

<div id="outline-container-beeminder" class="outline-3">
<h3 id="beeminder">Beeminder</h3>
<div class="outline-text-3" id="text-beeminder">
<p>
<a id="orgff29da4"></a>
</p>

<p>
<a href="https://github.com/sachac/beeminder.el">https://github.com/sachac/beeminder.el</a>
</p>

<p>
This bit of code lets me track sent messages in Gnus:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/beeminder-track-message</span> ()
  (<span class="org-keyword">save-excursion</span>
    (goto-char (point-min))
    (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"Newsgroups: .*emacs"</span>)
      (goto-char (point-min))
      (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"Subject: </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> nil t)
        (beeminder-add-data <span class="org-string">"orgml"</span> <span class="org-string">"1"</span> (match-string 1))))))
</pre>
</div>

<p>
And this loads the beeminder code:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">beeminder</span>
  <span class="org-builtin">:disabled</span> t
  <span class="org-builtin">:config</span> (add-hook 'message-send-news-hook 'my/beeminder-track-message))
</pre>
</div>
</div>
</div>

<div id="outline-container-org689da29" class="outline-3">
<h3 id="org689da29">Strike through DONE headlines</h3>
<div class="outline-text-3" id="text-org689da29">
<p>
I wanted a quick way to visually distinguish DONE tasks from tasks I
still need to do. This <a href="http://lists.gnu.org/archive/html/emacs-orgmode/2007-03/msg00179.html">handy snippet from the Emacs Org-mode mailing list</a> does the trick by striking through the headlines for DONE tasks.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-fontify-done-headline t)
(custom-set-faces
 '(org-done ((t (<span class="org-builtin">:foreground</span> <span class="org-string">"PaleGreen"</span>
                             <span class="org-builtin">:weight</span> normal
                             <span class="org-builtin">:strike-through</span> t))))
 '(org-headline-done
   ((((class color) (min-colors 16) (background dark))
     (<span class="org-builtin">:foreground</span> <span class="org-string">"LightSalmon"</span> <span class="org-builtin">:strike-through</span> t)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org5efbdf0" class="outline-3">
<h3 id="org5efbdf0">Rainbow delimiters</h3>
<div class="outline-text-3" id="text-org5efbdf0">
<p>
I don't automatically turn this on because I think it slows things down a little.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">rainbow-delimiters</span> <span class="org-builtin">:disabled</span> t)
</pre>
</div>
</div>
</div>

<div id="outline-container-org895f5c2" class="outline-3">
<h3 id="org895f5c2">Org - send things to the bottom of the list</h3>
<div class="outline-text-3" id="text-org895f5c2">
<p>
Handy for collecting items together.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-send-to-bottom-of-list</span> ()
  <span class="org-doc">"Send the current line to the bottom of the list."</span>
  (<span class="org-keyword">interactive</span>)
  (beginning-of-line)
  (<span class="org-keyword">let</span> ((kill-whole-line t))
    (<span class="org-keyword">save-excursion</span>
      (kill-line 1)
      (org-end-of-item-list)
      (yank))))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbf9c725" class="outline-3">
<h3 id="orgbf9c725">Time tracking, previous weekly review</h3>
<div class="outline-text-3" id="text-orgbf9c725">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/org-quantified-categories</span>
  '((<span class="org-string">"Business"</span>
     (<span class="org-string">"Earn"</span> . <span class="org-string">"Business - Earn"</span>)
     (<span class="org-string">"E1"</span> . <span class="org-string">"Business - Earn - Consulting - E1"</span>)
     (<span class="org-string">"Connect"</span> . <span class="org-string">"Business - Connect"</span>)
     (<span class="org-string">"Build"</span> . <span class="org-string">"Business - Build"</span>))
    (<span class="org-string">"Discretionary"</span>
     (<span class="org-string">"Social"</span> . <span class="org-string">"Discretionary - Social"</span>)
     (<span class="org-string">"Productive"</span> . <span class="org-string">"Discretionary - Productive"</span>)
     (<span class="org-string">"Sewing"</span> . <span class="org-string">"Discretionary - Productive - Sewing"</span>)
     (<span class="org-string">"Writing"</span> . <span class="org-string">"Discretionary - Productive - Writing"</span>)
     (<span class="org-string">"Emacs"</span> . <span class="org-string">"Discretionary - Productive - Emacs"</span>)
     (<span class="org-string">"Play"</span> . <span class="org-string">"Discretionary - Play"</span>))
    (<span class="org-string">"Personal"</span> <span class="org-comment-delimiter">;</span><span class="org-comment">("Biking" . "Personal - Bike")</span>
     (<span class="org-string">"Routines"</span> . <span class="org-string">"Personal - Routines"</span>))
    (<span class="org-string">"Sleep"</span> nil)
    (<span class="org-string">"Unpaid work"</span>
     (<span class="org-string">"Commuting"</span> . <span class="org-string">"Unpaid work - Subway"</span>)
     (<span class="org-string">"Cook"</span> . <span class="org-string">"Unpaid work - Cook"</span>)
     (<span class="org-string">"Tidy"</span> . <span class="org-string">"Unpaid work - Tidy up"</span>)))
  <span class="org-doc">"Categories for time summary."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-summarize-time-use</span> (<span class="org-type">&amp;optional</span> start end)
  (<span class="org-keyword">interactive</span> (list (org-read-date) (org-read-date)))
  (<span class="org-keyword">let</span> ((time-summary (quantified-summarize-time start end))
        (categories my/org-quantified-categories)
        result)
    (<span class="org-keyword">setq</span> result
          (mapconcat
           (<span class="org-keyword">lambda</span> (a)
             (<span class="org-keyword">if</span> (assoc (car a) time-summary)
                 (concat
                  (format <span class="org-string">"- %s: %.1f hours"</span> (car a) (/ (cdr (assoc (car a) time-summary)) 3600.0))
                  (<span class="org-keyword">if</span> (cdr a)
                      (<span class="org-keyword">let</span> ((detail
                             (delq nil
                                   (mapcar (<span class="org-keyword">lambda</span> (b)
                                             (<span class="org-keyword">if</span> (assoc (cdr b) time-summary)
                                                 (format <span class="org-string">"%s: %.1f"</span>
                                                         (car b)
                                                         (/ (cdr (assoc (cdr b) time-summary)) 3600.0))
                                               nil))
                                           (cdr a)))))
                        (<span class="org-keyword">if</span> detail
                            (concat <span class="org-string">" ("</span> (mapconcat 'identity detail <span class="org-string">", "</span>) <span class="org-string">")"</span>)
                          <span class="org-string">""</span>))
                    <span class="org-string">""</span>)
                  (<span class="org-keyword">if</span> (string-equal (car a) <span class="org-string">"Sleep"</span>)
                      (format <span class="org-string">" - average of %.1f hours per day"</span> (/ (cdr (assoc (car a) time-summary)) 3600.0 7.0))
                    <span class="org-string">""</span>)
                  <span class="org-string">"\n"</span>)))
           categories <span class="org-string">""</span>))
    (<span class="org-keyword">if</span> (called-interactively-p 'any)
        (insert result)
      result)))
</pre>
</div>
</div>

<div id="outline-container-org4ffae5d" class="outline-4">
<h4 id="org4ffae5d">List upcoming tasks so that I can see if I'm overloaded</h4>
<div class="outline-text-4" id="text-org4ffae5d">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-summarize-upcoming-week</span> ()
  <span class="org-doc">"Summarize upcoming tasks as a list."</span>
  (<span class="org-keyword">interactive</span>)
  (org-agenda nil <span class="org-string">"w"</span>)
  (<span class="org-keyword">let</span> ((string (buffer-string))
        business relationships life)
    (<span class="org-keyword">with-temp-buffer</span>
      (insert string)
      (goto-char (point-min))
      (<span class="org-keyword">while</span> (re-search-forward my/weekly-review-line-regexp nil t)
        (<span class="org-keyword">cond</span>
         ((string= (match-string 1) <span class="org-string">"routines"</span>) nil) <span class="org-comment-delimiter">; </span><span class="org-comment">skip routine tasks</span>
         ((string= (match-string 1) <span class="org-string">"business"</span>)
          (add-to-list 'business (concat <span class="org-string">"  - [ ] "</span> (match-string 3))))
         ((string= (match-string 1) <span class="org-string">"people"</span>)
          (add-to-list 'relationships (concat <span class="org-string">"  - [ ] "</span> (match-string 3))))
         (t (add-to-list 'life (concat <span class="org-string">"  - [ ] "</span> (match-string 3)))))))
    (<span class="org-keyword">setq</span> string
          (concat
           <span class="org-string">"*Plans for next week*\n"</span>
           <span class="org-string">"- Business\n"</span>
           (mapconcat 'identity business <span class="org-string">"\n"</span>)
           <span class="org-string">"\n- Relationships\n"</span>
           (mapconcat 'identity relationships <span class="org-string">"\n"</span>)
           <span class="org-string">"\n- Life\n"</span>
           (mapconcat 'identity life <span class="org-string">"\n"</span>)))
    (<span class="org-keyword">if</span> (called-interactively-p 'any)
        (kill-new string)
      string)))
</pre>
</div>

<p>
This uses Org Agenda's log mode to summarize the tasks that I checked
off. I still need to match it up with the plans for the previous week
to see which items I'd planned ahead, and which ones were new tasks.
(Hmm, is it important to track those separately? I might just skip it.)
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-summarize-previous-week</span> ()
  <span class="org-doc">"Summarize previously-completed tasks as a list."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-window-excursion</span>
    (org-agenda nil <span class="org-string">"w"</span>)
    (org-agenda-later -1)
    (org-agenda-log-mode 16)
    (<span class="org-keyword">let</span> ((string (buffer-string))
          business relationships life)
      (<span class="org-keyword">with-temp-buffer</span>
        (insert string)
        (goto-char (point-min))
        (<span class="org-keyword">while</span> (re-search-forward my/weekly-review-line-regexp nil t)
          (<span class="org-keyword">cond</span>
           ((string= (match-string 1) <span class="org-string">"routines"</span>) nil) <span class="org-comment-delimiter">; </span><span class="org-comment">skip routine tasks</span>
           ((string= (match-string 1) <span class="org-string">"business"</span>)
            (add-to-list 'business (concat <span class="org-string">"  - "</span> (match-string 2))))
           ((string= (match-string 1) <span class="org-string">"people"</span>)
            (add-to-list 'relationships (concat <span class="org-string">"  - "</span> (match-string 2))))
           (t (add-to-list 'life (concat <span class="org-string">"  - "</span> (match-string 2)))))))
      (<span class="org-keyword">setq</span> string
            (concat
             <span class="org-string">"*Accomplished this week*\n\n"</span>
             <span class="org-string">"- Business\n"</span>
             (mapconcat 'identity business <span class="org-string">"\n"</span>)
             <span class="org-string">"\n- Relationships\n"</span>
             (mapconcat 'identity relationships <span class="org-string">"\n"</span>)
             <span class="org-string">"\n- Life\n"</span>
             (mapconcat 'identity life <span class="org-string">"\n"</span>)))
      (<span class="org-keyword">if</span> (called-interactively-p 'any)
          (kill-new string)
        string))))

</pre>
</div>
</div>
</div>

<div id="outline-container-orgb7b480d" class="outline-4">
<h4 id="orgb7b480d">Compare time use</h4>
<div class="outline-text-4" id="text-orgb7b480d">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/quantified-compare</span> (start1 end1 start2 end2 <span class="org-type">&amp;optional</span> categories label1 label2)
  <span class="org-doc">"Return a table comparing the times for START1 - END1 and START2 - END2."</span>
  (<span class="org-keyword">let*</span> ((start2 (org-read-date nil nil (<span class="org-keyword">or</span> start2 <span class="org-string">"-sat"</span>)))
         (end2 (org-read-date nil nil (<span class="org-keyword">or</span> end2 <span class="org-string">"+1"</span>)))
         (start1 (org-read-date nil nil (<span class="org-keyword">or</span> start1 <span class="org-string">"-4sat"</span>)))
         (end1 (org-read-date nil nil (<span class="org-keyword">or</span> end1 <span class="org-string">"-sat"</span>)))
         (time2 (quantified-summarize-time start2 end2))
         (time1 (quantified-summarize-time start1 end1))
         (label1 (<span class="org-keyword">or</span> label1 <span class="org-string">"Period 1 %"</span>))
         (label2 (<span class="org-keyword">or</span> label2 <span class="org-string">"Period 2 %"</span>))
         (total2 (* 0.01 (- (org-time-string-to-seconds end2) (org-time-string-to-seconds start2))))
         (total1 (* 0.01 (- (org-time-string-to-seconds end1) (org-time-string-to-seconds start1))))
         (keys (<span class="org-keyword">or</span> categories (-union (mapcar 'car time1) (mapcar 'car time2)))))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Build a list comparing the two</span>
    (append
     `((<span class="org-string">"Category"</span> ,label1 ,label2 <span class="org-string">"Diff %"</span> <span class="org-string">"h/wk"</span> <span class="org-string">"Diff h/wk"</span>) hline)
     (sort 
      (mapcar (<span class="org-keyword">lambda</span> (key)
                (list
                 key
                 (format <span class="org-string">"%.1f"</span> (/ (<span class="org-keyword">or</span> (assoc-default key time1) 0) total1))
                 (format <span class="org-string">"%.1f"</span> (/ (<span class="org-keyword">or</span> (assoc-default key time2) 0) total2))
                 (format <span class="org-string">"%.1f"</span> (- (/ (<span class="org-keyword">or</span> (assoc-default key time2) 0) total2)
                                   (/ (<span class="org-keyword">or</span> (assoc-default key time1) 0) total1)))
                 (format <span class="org-string">"%.1f"</span> (* (/ (<span class="org-keyword">or</span> (assoc-default key time2) 0) total1) 1.68))
                 (format <span class="org-string">"%.1f"</span>
                         (* (- (/ (<span class="org-keyword">or</span> (assoc-default key time2) 0) total2)
                               (/ (<span class="org-keyword">or</span> (assoc-default key time1) 0) total1)) <span class="org-warning">1.68))</span>
                 )) <span class="org-warning">keys)</span>
      (<span class="org-keyword">lambda</span> (a b)
        (&lt;
         (string-to-number (car (last b)))
         (string-to-number (car (last a)))))))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org761b0c0" class="outline-3">
<h3 id="org761b0c0">Animation for Emacs chats</h3>
<div class="outline-text-3" id="text-org761b0c0">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/animate-emacs-chat</span> ()
  (<span class="org-keyword">interactive</span>)
  (text-scale-set 6)
  (erase-buffer)
  (sit-for 3)
  (<span class="org-keyword">let</span> ((list '(<span class="org-string">"Emacs Chat: Sacha Chua"</span>
                <span class="org-string">"interviewed by Bastien Guerry"</span>
                <span class="org-string">""</span>
                <span class="org-string">"July 24, 2013"</span>
                <span class="org-string">"sachachua.com/emacs-chat"</span>))
        (approx-width 41)
        (approx-height 16)
        row)
    (<span class="org-keyword">setq</span> row (/ (- approx-height (length list)) 2))
    (mapcar
     (<span class="org-keyword">lambda</span> (x)
       (animate-string x
                       row
                       (/ (- approx-width (length x)) 2))
       (<span class="org-keyword">setq</span> row (1+ row)))
     list)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd45ff03" class="outline-3">
<h3 id="orgd45ff03">Idle timer</h3>
<div class="outline-text-3" id="text-orgd45ff03">
<p>
This snippet is from John Wiegley -
<a href="http://lists.gnu.org/archive/html/emacs-orgmode/2010-03/msg00367.html">http://lists.gnu.org/archive/html/emacs-orgmode/2010-03/msg00367.html</a>.
It shows the org agenda when Emacs is idle.
</p>

<p>
Thanks to winner-mode, I can get back to my previous buffers with C-c
left.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">jump-to-org-agenda</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((buf (get-buffer <span class="org-string">"*Org Agenda*"</span>))
        wind)
    (<span class="org-keyword">if</span> buf
        (<span class="org-keyword">if</span> (<span class="org-keyword">setq</span> wind (get-buffer-window buf))
            (select-window wind)
          (<span class="org-keyword">if</span> (called-interactively-p 'any)
              (<span class="org-keyword">progn</span>
                (select-window (display-buffer buf t t))
                (org-fit-window-to-buffer)
                <span class="org-comment-delimiter">;; </span><span class="org-comment">(org-agenda-redo)</span>
                )
            (<span class="org-keyword">with-selected-window</span> (display-buffer buf)
              (org-fit-window-to-buffer)
              <span class="org-comment-delimiter">;; </span><span class="org-comment">(org-agenda-redo)</span>
              )))
      (call-interactively 'org-agenda-list)))
  <span class="org-comment-delimiter">;;</span><span class="org-comment">(let ((buf (get-buffer "*Calendar*")))</span>
  <span class="org-comment-delimiter">;;  </span><span class="org-comment">(unless (get-buffer-window buf)</span>
  <span class="org-comment-delimiter">;;    </span><span class="org-comment">(org-agenda-goto-calendar)))</span>
  )

(run-with-idle-timer 300 t 'jump-to-org-agenda)

</pre>
</div>
</div>
</div>
<div id="outline-container-org1876955" class="outline-3">
<h3 id="org1876955">Old Flickr/Evernote export</h3>
<div class="outline-text-3" id="text-org1876955">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">I don't use these as much now that I have the functions above.</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my/evernote-extract-links</span> (filename)
  <span class="org-doc">"Extract note names and URLs from an ENEX file."</span>
  (<span class="org-keyword">interactive</span>)

  (goto-char (point-min))
  (<span class="org-keyword">let</span> (list)
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;title&gt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&lt;/title&gt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?\n</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">*?.*?href=\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\""</span> nil t)
      (<span class="org-keyword">setq</span> list (cons (cons (match-string-no-properties 1) (match-string-no-properties 3)) list)))
    (delete-region (point-min) (point-max))
    (insert (mapconcat (<span class="org-keyword">lambda</span> (x) (concat <span class="org-string">"- [["</span> (cdr x) <span class="org-string">"]["</span> (car x) <span class="org-string">"]]"</span>)) list <span class="org-string">"\n"</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/flickr-extract-this-week</span> ()
  <span class="org-doc">"Extract this week's sketch titles and URLs from the flickr_metadata CSV."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((base-date (apply 'encode-time (org-read-date-analyze <span class="org-string">"-fri"</span> nil '(0 0 0))))
        start end list)
    (<span class="org-keyword">setq</span> start (format-time-string <span class="org-string">"%Y-%m-%d"</span> (days-to-time (- (time-to-number-of-days base-date) 6))))
    (<span class="org-keyword">setq</span> end (format-time-string <span class="org-string">"%Y-%m-%d"</span> (days-to-time (1+ (time-to-number-of-days base-date)))))
    (<span class="org-keyword">setq</span> list (csv-parse-buffer t))
    (erase-buffer)
    (insert
     (mapconcat (<span class="org-keyword">lambda</span> (x) (concat <span class="org-string">"- [["</span> (car x) <span class="org-string">"]["</span> (cdr x) <span class="org-string">"]]"</span>))
                (sort
                 (delq nil
                       (mapcar (<span class="org-keyword">lambda</span> (x)
                                 (<span class="org-keyword">let</span> ((title (cdr (assoc <span class="org-string">"FileName"</span> x))))
                                   (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (not (string&lt; title start))
                                            (string&lt; title end))
                                       (cons (cdr (assoc <span class="org-string">"URL"</span> x)) title))))
                               list))
                 (<span class="org-keyword">lambda</span> (a b) (string&lt;  (cdr a) (cdr b)))
                 )
                <span class="org-string">"\n"</span>))))
</pre>
</div>
</div>
</div>
<div id="outline-container-org0fb423c" class="outline-3">
<h3 id="org0fb423c">Enable minibuffer completion</h3>
<div class="outline-text-3" id="text-org0fb423c">
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2013-03-31 Sun] </span></span> Superseded by ido-hacks?
</p>

<p>
It can be difficult to remember the full names of Emacs commands, so I
use <code>icomplete-mode</code> for minibuffer completion. This also makes it
easier to discover commands.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(icomplete-mode 1)
</pre>
</div>
</div>
</div>

<div id="outline-container-org9735b48" class="outline-3">
<h3 id="org9735b48">Encryption</h3>
<div class="outline-text-3" id="text-org9735b48">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">require</span> '<span class="org-constant">org-crypt</span>)
(org-crypt-use-before-save-magic)
(<span class="org-keyword">setq</span> org-tags-exclude-from-inheritance (<span class="org-keyword">quote</span> (<span class="org-string">"crypt"</span>)))

(<span class="org-keyword">setq</span> org-crypt-key nil)
<span class="org-comment-delimiter">;; </span><span class="org-comment">GPG key to use for encryption</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Either the Key ID or set to nil to use symmetric encryption.</span>

<span class="org-comment-delimiter">;;     </span><span class="org-comment">(setq auto-save-default nil)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Auto-saving does not cooperate with org-crypt.el: so you need</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">to turn it off if you plan to use org-crypt.el quite often.</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Otherwise, you'll get an (annoying) message each time you</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">start Org.</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">To turn it off only locally, you can insert this:</span>
<span class="org-comment-delimiter">;;</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment"># -*- buffer-auto-save-file-name: nil; -*-</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-org8aed466" class="outline-3">
<h3 id="org8aed466">Drawing</h3>
<div class="outline-text-3" id="text-org8aed466">
<p>
<a id="org276c762"></a>
</p>
</div>

<div id="outline-container-org1f1345f" class="outline-4">
<h4 id="org1f1345f">Finding sketches</h4>
<div class="outline-text-4" id="text-org1f1345f">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/sketch-directories</span>
  '(<span class="org-string">"~/sync/sketches"</span>
    <span class="org-string">"~/cloud/private-sketches"</span>
    <span class="org-string">"~/Dropbox/Inbox"</span>
    <span class="org-string">"~/Dropbox/Inbox/To blog"</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/get-sketch-filenames-between-dates</span> (start end filter)
  <span class="org-doc">"Returns index card filenames between START and END."</span>
  (<span class="org-keyword">setq</span> start (replace-regexp-in-string <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">0-9]"</span> <span class="org-string">""</span> start))
  (<span class="org-keyword">setq</span> end (replace-regexp-in-string <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">0-9]"</span> <span class="org-string">""</span> end))
  (my/get-sketch-filenames
   (<span class="org-keyword">lambda</span> (filename)
     (<span class="org-keyword">let</span> ((f (replace-regexp-in-string <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">0-9]"</span> <span class="org-string">""</span> (file-name-nondirectory filename))))
       (<span class="org-keyword">and</span> (string&gt; f start)
            (string&gt; end f)
            (<span class="org-keyword">or</span> (not filter) (string-match filter filename)))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/get-sketch-filenames</span> (base <span class="org-type">&amp;optional</span> as-regexp)
  (my/get-image-filenames base as-regexp my/sketch-directories))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/get-image-filenames</span> (base <span class="org-type">&amp;optional</span> as-regexp directories)
  <span class="org-doc">"Check several directories for files matching BASE.</span>
<span class="org-doc">           Return the matching filenames, if any.</span>
<span class="org-doc">           If AS-REGEXP is non-nil, treat BASE as a regular expression.</span>
<span class="org-doc">           If BASE is a function, use that to filter."</span>
  (-filter
   (<span class="org-keyword">lambda</span> (o) (not (string-match <span class="org-string">"\\.xmp"</span> o)))
   (sort (-flatten
          (delq nil
                (mapcar
                 (<span class="org-keyword">lambda</span> (dir)
                   (<span class="org-keyword">and</span> (file-directory-p dir)
                        (<span class="org-keyword">if</span> (functionp base)
                            (-filter base (directory-files dir t <span class="org-string">".*\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">png</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">psd</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">tiff</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">jpg</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?$"</span>))
                          (directory-files
                           dir t
                           (concat 
                            <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">"</span>
                            (<span class="org-keyword">if</span> as-regexp base (regexp-quote base))
                            <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
                            <span class="org-string">".*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">png</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">psd</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">tiff</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">jpg</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?$"</span>
                            )))))
                 (<span class="org-keyword">or</span> directories my/image-directories))))
         'string&lt;)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/get-image-filename</span> (base <span class="org-type">&amp;optional</span> as-regexp directories)
  <span class="org-doc">"Check several directories for files matching BASE.</span>
<span class="org-doc">           Return the first matching filename, if any.</span>
<span class="org-doc">           If AS-REGEXP is non-nil, treat BASE as a regular expression."</span>
  (<span class="org-keyword">if</span> (file-exists-p base)
      base
    (car (my/get-image-filenames base as-regexp directories))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/get-sketch-filename</span> (base <span class="org-type">&amp;optional</span> as-regexp)
  (my/get-image-filename base as-regexp my/sketch-directories))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/list-sketches</span> (regexp <span class="org-type">&amp;optional</span> full-filename directories)
  <span class="org-doc">"Return a list of sketch filenames matching REGEXP."</span>
  (<span class="org-keyword">interactive</span> (list (read-string <span class="org-string">"Filter: "</span>)))
  (<span class="org-keyword">let</span> ((my/sketch-directories (<span class="org-keyword">or</span> directories my/sketch-directories)))
    (funcall (<span class="org-keyword">if</span> (called-interactively-p 'interactive)
                 (<span class="org-keyword">lambda</span> (x) (insert (mapconcat (<span class="org-keyword">lambda</span> (y) (concat <span class="org-string">"- "</span> (org-link-make-string (concat <span class="org-string">"sketch:"</span> y)))) x <span class="org-string">"\n"</span>))) 'identity)
             (sort (-uniq
                    (mapcar (<span class="org-keyword">if</span> full-filename 'identity
                              'file-name-nondirectory)
                            (my/get-sketch-filenames regexp t)))
                   'string&gt;))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org49d2b3c" class="outline-4">
<h4 id="org49d2b3c">Org Mode sketch: links</h4>
<div class="outline-text-4" id="text-org49d2b3c">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/open-images-in-krita</span> (files)
  (apply 'call-process <span class="org-string">"krita"</span> nil 0 nil <span class="org-string">"--nosplash"</span> files))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/open-images-in-gwenview</span> (files)
  (apply 'call-process <span class="org-string">"gwenview"</span> nil 0 nil <span class="org-string">"--slideshow"</span> files))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/open-images-in-feh</span> (files)
  (apply 'call-process <span class="org-string">"feh"</span> nil nil nil <span class="org-string">"-D"</span> <span class="org-string">"1"</span> <span class="org-string">"-F"</span> files))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-image-open</span> (id <span class="org-type">&amp;optional</span> arg directories)
  <span class="org-doc">"Open image named ID.</span>
<span class="org-doc">      If ARG is specified, prompt for application to open it in."</span>
  (<span class="org-keyword">interactive</span> (list
                (completing-read <span class="org-string">"Sketch ID: "</span> (my/list-sketches <span class="org-string">"."</span>))
                (current-prefix-arg)))
  (<span class="org-keyword">let*</span> ((files (mapcar (<span class="org-keyword">lambda</span> (o) (my/get-image-filename o (<span class="org-keyword">or</span> my/image-directories))) (<span class="org-keyword">if</span> (listp id) id (list id))))
         (input (<span class="org-keyword">if</span> arg (read-char <span class="org-string">"(k)rita, (g)wenview, (f)eh: "</span>) ?k)))
    (funcall
     (<span class="org-keyword">cond</span>
      ((eq input ?g) 'my/open-images-in-gwenview)
      ((eq input ?f) 'my/open-images-in-feh)
      (t 'my/open-images-in-krita))
     files)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-sketch-open</span> (id <span class="org-type">&amp;optional</span> arg)
  (my/org-image-open id arg my/sketch-directories))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-image-export</span> (link description format)
  (<span class="org-keyword">let*</span> ((path (concat <span class="org-string">"https://sketches.sachachua.com/filename/"</span> link))
         (image (concat <span class="org-string">"https://sketches.sachachua.com/static/"</span> link))
         (desc (<span class="org-keyword">or</span> description link)))
    (<span class="org-keyword">cond</span>
     ((<span class="org-keyword">or</span> (eq format 'html) (eq format 'wp))
      (<span class="org-keyword">if</span> description
          (format <span class="org-string">"&lt;a target=\"_blank\" href=\"%s\"&gt;%s&lt;/a&gt;"</span> path desc)
        (format <span class="org-string">"&lt;a target=\"_blank\" href=\"%s\"&gt;&lt;img src=\"%s\"&gt;&lt;br /&gt;%s&lt;/a&gt;"</span> path image desc)))
     ((eq format 'latex) (format <span class="org-string">"\\href{%s}{%s}"</span> path desc))
     ((eq format 'texinfo) (format <span class="org-string">"@uref{%s,%s}"</span> path desc))
     ((eq format 'md)
      (<span class="org-keyword">if</span> (file-exists-p (expand-file-name link <span class="org-string">"~/sketches"</span>))
          (format <span class="org-string">"{{&lt;photo src=\"%s\"&gt;}}"</span> image)
        (format <span class="org-string">"{{&lt;photo nas=\"1\" src=\"%s\"&gt;}}"</span> link)))
     ((eq format 'ascii) (format <span class="org-string">"%s &lt;%s&gt;"</span> desc path))
     (t path))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-sketch-complete</span> (<span class="org-type">&amp;optional</span> prefix)
  (concat <span class="org-string">"sketch:"</span>
          (my/complete-sketch-filename)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-image-complete</span> (<span class="org-type">&amp;optional</span> prefix)
  (concat <span class="org-string">"image:"</span>
          (completing-read <span class="org-string">"Image: "</span> (my/list-sketches <span class="org-string">"."</span> nil my/image-directories))))
<span class="org-comment-delimiter">;; </span><span class="org-comment">Based on https://emacs.stackexchange.com/questions/38098/org-mode-custom-youtube-link-syntax</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-sketch-preview</span> (start end path bracketp)
  <span class="org-doc">"Include overlays for sketches."</span>
  (<span class="org-keyword">when</span> (display-graphic-p)
    (<span class="org-keyword">let</span> ((filename (my/get-sketch-filename path))
          (refresh nil)
          (link (<span class="org-keyword">save-excursion</span>
                  (goto-char start)
                  (org-element-lineage
                   (<span class="org-keyword">save-match-data</span> (org-element-context))
                   '(link) t)))) <span class="org-comment-delimiter">;; </span><span class="org-comment">set this someday</span>
      (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (not (org-element-property <span class="org-builtin">:contents-begin</span> link)) filename)
        (<span class="org-keyword">let</span> ((width
               <span class="org-comment-delimiter">;; </span><span class="org-comment">Apply `</span><span class="org-comment"><span class="org-constant">org-image-actual-width</span></span><span class="org-comment">' specifications.</span>
               (<span class="org-keyword">cond</span>
                ((not (image-type-available-p 'imagemagick)) nil)
                ((eq org-image-actual-width t) nil)
                ((numberp org-image-actual-width) org-image-actual-width)
                <span class="org-comment-delimiter">;; </span><span class="org-comment">Pick this up from the paragraph someday</span>
                ))
              (old (get-char-property-and-overlay start 'org-image-overlay)))
          (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (car-safe old) refresh)
              (image-refresh (overlay-get (cdr old) 'display))
            (<span class="org-keyword">let</span> ((image (create-image filename
                                       (<span class="org-keyword">and</span> width 'imagemagick)
                                       nil
                                       <span class="org-builtin">:width</span> width)))
              (<span class="org-keyword">when</span> image
                (<span class="org-keyword">let*</span> ((ov (make-overlay start end)))
                  (overlay-put ov 'display image)
                  (overlay-put ov 'face 'default)
                  (overlay-put ov 'org-image-overlay t)
                  (overlay-put
                   ov 'modification-hooks
                   (list 'org-display-inline-remove-overlay))
                  (<span class="org-keyword">push</span> ov org-inline-image-overlays))))))))))

(<span class="org-keyword">use-package</span> <span class="org-constant">org</span>
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> org-image-actual-width 600)
  (org-link-set-parameters
   <span class="org-string">"sketch"</span>
   <span class="org-builtin">:follow</span> 'my/org-sketch-open
   <span class="org-builtin">:export</span> 'my/org-image-export
   <span class="org-builtin">:complete</span> 'my/org-sketch-complete
   <span class="org-builtin">:activate-func</span> nil))

(<span class="org-keyword">use-package</span> <span class="org-constant">org</span>
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> org-image-actual-width 600)
  (org-link-set-parameters
   <span class="org-string">"image"</span>
   <span class="org-builtin">:follow</span> 'my/org-image-open
   <span class="org-builtin">:export</span> 'my/org-image-export
   <span class="org-builtin">:complete</span> 'my/org-image-complete))

</pre>
</div>
</div>
</div>
<div id="outline-container-org1c58ddf" class="outline-4">
<h4 id="org1c58ddf">Copy</h4>
<div class="outline-text-4" id="text-org1c58ddf">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">org</span>
  <span class="org-builtin">:config</span>
  (org-link-set-parameters
   <span class="org-string">"copy"</span>
   <span class="org-builtin">:follow</span> (<span class="org-keyword">lambda</span> (link) (kill-new link))
))

</pre>
</div>
</div>
</div>

<div id="outline-container-orgd8dfe50" class="outline-4">
<h4 id="orgd8dfe50">Config</h4>
<div class="outline-text-4" id="text-orgd8dfe50">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">org</span>
  <span class="org-builtin">:config</span>
  (org-link-set-parameters
   <span class="org-string">"config"</span>
   <span class="org-builtin">:follow</span> (<span class="org-keyword">lambda</span> (id) (org-open-link-from-string (format <span class="org-string">"[[~/code/.emacs.d/Sacha.org::%s]]"</span> id)))
   <span class="org-builtin">:export</span> (<span class="org-keyword">lambda</span> (link description format)
             (format <span class="org-string">"&lt;a href=\"https://sachachua.com/dotemacs#%s\"&gt;%s&lt;/a&gt;"</span> link description))))

</pre>
</div>
</div>
</div>
<div id="outline-container-orga548c8b" class="outline-4">
<h4 id="orga548c8b">Helm completion with my/helm-org-sketches</h4>
<div class="outline-text-4" id="text-orga548c8b">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/helm-source-org-sketch-list</span> ()
  (my/list-sketches <span class="org-string">"."</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/helm-org-insert-sketch-candidates</span> (<span class="org-type">&amp;optional</span> candidates)
  (mapc (<span class="org-keyword">lambda</span> (o)
          (org-insert-link nil (concat <span class="org-string">"sketch:"</span> o))
          (insert <span class="org-string">"\n"</span>))
        (helm-marked-candidates)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/helm-open-sketches-in-krita</span> (<span class="org-type">&amp;optional</span> candidates)
  (my/sketch-open-in-krita (helm-marked-candidates)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/helm-open-sketches-in-gwenview</span> (<span class="org-type">&amp;optional</span> candidates)
  (my/sketch-open-in-gwenview (helm-marked-candidates)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/helm-open-sketches-in-feh</span> (<span class="org-type">&amp;optional</span> candidates)
  (my/sketch-open-in-feh (helm-marked-candidates)))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/helm-source-org-sketches</span>
  '((name . <span class="org-string">"Sketches"</span>)
    (candidates . my/helm-source-org-sketch-list)
    (action . ((<span class="org-string">"Insert"</span> . my/helm-org-insert-sketch-candidates)
               (<span class="org-string">"Open in Krita"</span> . my/helm-open-sketches-in-krita)
               (<span class="org-string">"Open in Gwenview"</span> . my/helm-open-sketches-in-gwenview)
               (<span class="org-string">"Open as Feh slideshow"</span> . my/helm-open-sketches-in-feh)))
    (persistent-action . my/helm-open-sketches-in-gwenview)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/helm-org-sketches</span> ()
  (<span class="org-keyword">interactive</span>)
  (helm <span class="org-builtin">:sources</span> '(my/helm-source-org-sketches)
        <span class="org-builtin">:buffer</span> <span class="org-string">"*helm-org-sketches*"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd18041f" class="outline-4">
<h4 id="orgd18041f">Button-based interface</h4>
<div class="outline-text-4" id="text-orgd18041f">
<p>
This makes a buffer with big buttons so that I can easily tap them with my stylus.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/set-up-sketch-buffer</span> ()
  <span class="org-doc">"Populate a widget buffer with a few handy buttons."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">with-current-buffer</span> (get-buffer-create <span class="org-string">"*Done*"</span>)
    (<span class="org-keyword">let</span> ((inhibit-read-only t))
      (erase-buffer)
      (widget-create 'push-button
                     <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> ignore)
                               (my/org-clock-in-and-track-by-name <span class="org-string">"Draw"</span>))
                     <span class="org-string">"Track: Draw"</span>)        
      (widget-create 'push-button
                     <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> ignore)
                               (my/org-clock-in-and-track-by-name <span class="org-string">"Draw journal entries"</span>))
                     <span class="org-string">"Track: Journal"</span>)
      (widget-create 'push-button
                     <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> ignore)
                               (my/org-sketch-open (my/prepare-index-card-template)))
                     <span class="org-string">"New"</span>)
      (widget-create 'push-button
                     <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> ignore)
                               (my/org-sketch-open (my/prepare-large-template)))
                     <span class="org-string">"New large"</span>)
      (widget-create 'push-button
                     <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> ignore)
                               (my/org-sketch-open (my/prepare-index-card-template nil (org-read-date))))
                     <span class="org-string">"Date"</span>)
      (widget-create 'push-button
                     <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> ignore) (shell-command <span class="org-string">"~/bin/rotate-screen"</span>)) <span class="org-string">"Rotate"</span>)
      (insert <span class="org-string">"\n"</span>)        
      (widget-create 'push-button
                     <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> ignore)
                               (shell-command <span class="org-string">"~/bin/add-output-png"</span>))
                     <span class="org-string">"Add output.png"</span>)
      (widget-create 'push-button
                     <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> ignore)
                               (my/rotate-screen 0)
                               (kill-buffer)
                               (my/rename-scanned-cards))
                     <span class="org-string">"Process"</span>)
      (widget-create 'push-button
                     <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> ignore)
                               (my/rotate-screen 0)
                               (delete-window)
                               (my/rename-scanned-cards))
                     <span class="org-string">"Rename"</span>)        
      (widget-create 'push-button
                     <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> ignore)
                               (my/rotate-screen 0)
                               (delete-window)
                               (my/convert-and-upload-cards))
                     <span class="org-string">"Upload"</span>)
      (widget-create 'push-button
                     <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> ignore)
                               (my/rotate-screen 0)
                               (org-clock-out)
                               (kill-buffer))
                     <span class="org-string">"Quit"</span>)
      (text-scale-set 10)
      (widget-setup)
      (widget-minor-mode)
      (pop-to-buffer (current-buffer))
      (goto-char (point-min))
      (current-buffer))))

(<span class="org-keyword">setq</span> my/sketch-executable <span class="org-string">"krita"</span>
      my/sketch-inbox-directory <span class="org-string">"~/Dropbox/Inbox"</span>
      my/index-card-template-file <span class="org-string">"~/Dropbox/drawings/templates/0 - index.psd"</span>
      my/sketch-large-template-file <span class="org-string">"/home/sacha/Dropbox/drawings/templates/0 - base.psd"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/prepare-index-cards</span> (n)
  (<span class="org-keyword">interactive</span> (list (<span class="org-keyword">or</span> current-prefix-arg 5)))
  (<span class="org-keyword">let</span> ((counter 1)
        (directory <span class="org-string">"~/Dropbox/Inbox"</span>)
        (template my/index-card-template-file)
        (date (substring (org-read-date nil nil <span class="org-string">"."</span>) 0 10))
        temp-file)
    (quantified-track <span class="org-string">"Drawing"</span>)
    (<span class="org-keyword">dotimes</span> (i 5) (my/org-sketch-open (my/prepare-index-card-template)))
    (my/rotate-screen 180)
    (my/set-up-sketch-buffer)))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/index-card-file-name</span> nil <span class="org-doc">"Most recent index card file name."</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/rotate-screen</span> (degrees)
  (<span class="org-keyword">cond</span>
   ((eq system-type 'windows-nt)
    (shell-command (format <span class="org-string">"c:/sacha/Dropbox/bin/orient /rotate:%d"</span> degrees)))
   ((eq system-type 'gnu/linux)
    (shell-command (format <span class="org-string">"~/bin/rotate-screen %s"</span>
                           (<span class="org-keyword">cond</span>
                            ((= degrees 0) <span class="org-string">"normal"</span>)
                            ((= degrees 180) <span class="org-string">"inverted"</span>)
                            ((= degrees 90) <span class="org-string">"left"</span>)
                            ((= degrees 270) <span class="org-string">"right"</span>)))))))

</pre>
</div>
</div>
</div>

<div id="outline-container-org7302be3" class="outline-4">
<h4 id="org7302be3">Templates</h4>
<div class="outline-text-4" id="text-org7302be3">
<div class="org-src-container">
<pre class="src src-emacs-lisp">
(<span class="org-keyword">defun</span> <span class="org-function-name">my/prepare-drawing-template</span> (<span class="org-type">&amp;optional</span> name date template)
  <span class="org-doc">"Create the image file for NAME. Return the new filename."</span>
  (<span class="org-keyword">let*</span> ((date (<span class="org-keyword">or</span> date (substring (org-read-date nil nil <span class="org-string">"."</span>) 0 10)))
         (data (my/journal-post (<span class="org-keyword">or</span> name <span class="org-string">"sketch"</span>) <span class="org-builtin">:Date</span> date)))
    (<span class="org-keyword">setq</span> name (expand-file-name
                (concat (assoc-default 'ZIDString data)
                        (<span class="org-keyword">if</span> name
                            (concat <span class="org-string">" "</span>
                                    (my/convert-sketch-title-to-filename (<span class="org-keyword">or</span> name <span class="org-string">""</span>)))
                          
                              <span class="org-string">""</span>) 
                            <span class="org-string">"."</span> (file-name-extension template))
                    <span class="org-string">"~/Dropbox/Inbox"</span>))
    (copy-file (<span class="org-keyword">or</span> template my/index-card-template-file) name)
    name))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-insert-new-index-card-link</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((filename
         (my/prepare-index-card-template)))
    (insert <span class="org-string">"[[sketch:"</span> filename <span class="org-string">"]]\n"</span>)
    (<span class="org-keyword">save-window-excursion</span>
      (my/rotate-screen 180)
      (shell-command
       (concat (shell-quote-argument my/sketch-executable)
               <span class="org-string">" "</span> (shell-quote-argument filename) <span class="org-string">" &amp;"</span>)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/prepare-index-card-template</span> (<span class="org-type">&amp;optional</span> name date)
  <span class="org-doc">"Create the image file for NAME. Return the new filename."</span>
  (my/prepare-drawing-template name date my/index-card-template-file))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/prepare-large-template</span> (<span class="org-type">&amp;optional</span> name date)
  <span class="org-doc">"Create the image file for NAME. Return the new filename."</span>
  (my/prepare-drawing-template name date my/sketch-large-template-file))


(<span class="org-keyword">defun</span> <span class="org-function-name">my/prepare-index-card</span> (<span class="org-type">&amp;optional</span> name date)
  <span class="org-doc">"Prepare the index card for NAME.</span>
<span class="org-doc">              Rotate the screen and show a button to un-rotate the screen."</span>
  (<span class="org-keyword">interactive</span> (list (read-string <span class="org-string">"Name: "</span>)
                     (substring (<span class="org-keyword">if</span> current-prefix-arg (org-read-date) (org-read-date nil nil <span class="org-string">"."</span>)) 0 10)))
  (<span class="org-keyword">setq</span> my/index-card-file-name (my/prepare-index-card-template name date))
  (<span class="org-keyword">save-window-excursion</span>
    (my/rotate-screen 180)
    (shell-command
     (concat (shell-quote-argument my/sketch-executable)
             <span class="org-string">" "</span> (shell-quote-argument my/index-card-file-name) <span class="org-string">" &amp;"</span>)))
  (my/set-up-sketch-buffer))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/prepare-index-card-for-subtree</span> ()
  <span class="org-doc">"Create an index card template for the current subtree."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let*</span> ((heading (elt (org-heading-components) 4)))
    (<span class="org-keyword">unless</span> (org-entry-get (point) <span class="org-string">"Effort"</span>) (org-set-property <span class="org-string">"Effort"</span> <span class="org-string">"0:15"</span>))
    (<span class="org-keyword">if</span> (derived-mode-p 'org-agenda-mode) (org-agenda-clock-in) (org-clock-in))
    (my/org-quantified-track <span class="org-string">"Drawing"</span>)
    (<span class="org-keyword">if</span> (org-at-heading-p) (forward-line 1))
    (my/prepare-index-card heading)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/helm-org-prepare-index-card-for-subtree</span> (candidate)
  (<span class="org-keyword">let</span> ((location (org-refile--get-location candidate my/helm-org-refile-locations)))
    (<span class="org-keyword">save-window-excursion</span>
      (<span class="org-keyword">save-excursion</span>
        (org-refile 4 nil location)
        (my/prepare-index-card-for-subtree)) <span class="org-warning">t)))</span>




</pre>
</div>
</div>
</div>
<div id="outline-container-org4742107" class="outline-4">
<h4 id="org4742107">Easily backfill my journal</h4>
<div class="outline-text-4" id="text-org4742107">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/draw-journal-entry</span> (date)
  <span class="org-doc">"Creates a blank journal entry for DATE and brings up the log."</span>
  (<span class="org-keyword">interactive</span> (list (org-read-date)))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Open the Quantified Awesome time log for that date</span>
  (<span class="org-keyword">let</span> ((filename (my/get-journal-entry date))
        (day (format-time-string <span class="org-string">"%A"</span> (org-time-string-to-time date))))
    (<span class="org-keyword">if</span> filename
        (my/org-sketch-open filename)
      <span class="org-comment-delimiter">;; </span><span class="org-comment">(browse-url (format "http://quantifiedawesome.com/records?start=%s&amp;end=%s"</span>
      <span class="org-comment-delimiter">;;                     </span><span class="org-comment">date</span>
      <span class="org-comment-delimiter">;;                     </span><span class="org-comment">(format-time-string</span>
      <span class="org-comment-delimiter">;;                      </span><span class="org-comment">"%Y-%m-%d"</span>
      <span class="org-comment-delimiter">;;                      </span><span class="org-comment">(seconds-to-time</span>
      <span class="org-comment-delimiter">;;                       </span><span class="org-comment">(+ (org-time-string-to-seconds date) 86400)))))</span>
      (<span class="org-keyword">setq</span> filename
            (my/prepare-index-card-template (concat day <span class="org-string">" #daily #journal"</span>) date))
      (my/org-sketch-open filename))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/get-journal-entry</span> (date)
  <span class="org-doc">"Returns the filename for the journal sketch for DATE."</span>
  (car
   (-filter (<span class="org-keyword">lambda</span> (x) (not (string-match <span class="org-string">"weekly"</span> x)))
            (my/get-sketch-filenames
             (format <span class="org-string">"%s.* .*#daily"</span> date)
             t))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/get-missing-journal-dates</span> (start-date end-date)
  <span class="org-doc">"Return a list of dates missing journal entries.</span>
<span class="org-doc">      Range is specified by START-DATE (inclusive) and END-DATE (exclusive)."</span>
  (<span class="org-keyword">let*</span> ((current-day (org-time-string-to-absolute end-date))
         (start-day (org-time-string-to-absolute start-date))
         current-date
         current-date-string
         missing-list)
    (<span class="org-keyword">while</span> (&gt;= current-day start-day)
      (<span class="org-keyword">setq</span> current-date (calendar-gregorian-from-absolute current-day))
      (<span class="org-keyword">setq</span> current-date-string (format <span class="org-string">"%04d-%02d-%02d"</span> (elt current-date 2) (elt current-date 0) (elt current-date 1)))
      (<span class="org-keyword">unless</span> (my/get-journal-entry current-date-string)
        (add-to-list 'missing-list current-date-string))
      (<span class="org-keyword">setq</span> current-day (1- current-day)))
    missing-list))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/show-missing-journal-entries</span> (since)
  (<span class="org-keyword">interactive</span> (list (<span class="org-keyword">if</span> current-prefix-arg (org-read-date) (org-read-date nil nil <span class="org-string">"-7"</span>))))
  (<span class="org-keyword">let</span> ((missing-dates (my/get-missing-journal-dates since (org-read-date nil nil <span class="org-string">"."</span>))))
    (<span class="org-keyword">with-current-buffer</span> (my/set-up-sketch-buffer)
      (mapc
       (<span class="org-keyword">lambda</span> (date)
         (widget-create 'push-button
                        <span class="org-builtin">:date</span> date
                        <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (widget <span class="org-type">&amp;rest</span> ignore)
                                  (my/draw-journal-entry (plist-get (cdr widget) <span class="org-builtin">:date</span>)))
                        date))
       missing-dates)
      (widget-setup)
      (widget-minor-mode))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org514a139" class="outline-4">
<h4 id="org514a139">Rename scanned index cards</h4>
<div class="outline-text-4" id="text-org514a139">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">s</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/process-tiff</span> (files)
  <span class="org-doc">"Convert, display, rename, and upload FILES."</span>
  (<span class="org-keyword">interactive</span> (list (dired-get-marked-files)))
  (<span class="org-keyword">unless</span> (listp files) (<span class="org-keyword">setq</span> files (list files)))
  (<span class="org-keyword">save-window-excursion</span>
    (apply 'call-process <span class="org-string">"mogrify"</span> nil nil nil (append (list <span class="org-string">"-format"</span> <span class="org-string">"png"</span> <span class="org-string">"-quality"</span> <span class="org-string">"1"</span>) files))
    (delete-other-windows)
    (<span class="org-keyword">setq</span> files
          (mapcar
           (<span class="org-keyword">lambda</span> (filename)
             (find-file (<span class="org-keyword">setq</span> filename (s-append <span class="org-string">".png"</span> (s-chop-suffix <span class="org-string">".tif"</span> filename))))
             (<span class="org-keyword">let</span> ((new-name
                    (read-string <span class="org-string">"New name: "</span>
                                 (concat
                                  (<span class="org-keyword">if</span> (string-match <span class="org-string">"/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+-[0-9]+-[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"> ?.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\.png"</span> filename)
                                      (match-string 1 filename)
                                    filename)
                                  <span class="org-string">" "</span>))))
               (rename-file filename (concat new-name <span class="org-string">".png"</span>))
               (<span class="org-keyword">setq</span> filename (expand-file-name (concat new-name <span class="org-string">".png"</span>) (file-name-directory filename)))))
           files)))
  (find-file <span class="org-string">"~/Dropbox/Public/sharing/index.org"</span>)
  (goto-char (point-min))
  (<span class="org-keyword">when</span> (re-search-forward (regexp-quote <span class="org-string">"#+ORGLST: sketchinbox"</span>))
    (forward-line 1)
    (org-end-of-item-list)
    (apply 'call-process <span class="org-string">"up"</span> nil t nil files)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/convert-index-card-to-png</span> (o)
  (<span class="org-keyword">lambda</span> (o)
    (call-process <span class="org-string">"krita"</span> nil nil nil o <span class="org-string">"--export"</span> <span class="org-string">"--export-filename"</span>
                  (concat (file-name-sans-extension o) <span class="org-string">".png"</span>))
    (rename-file o <span class="org-string">"~/Dropbox/Inbox/backup/"</span> t)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/convert-index-card-tiffs-to-pngs</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((pattern <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">IMG</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">[0-9]+-[0-9]+-[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">.*.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">tif</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">psd</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">$"</span>))
    (<span class="org-keyword">when</span> (directory-files <span class="org-string">"~/Dropbox/Inbox/"</span> t pattern)
      <span class="org-comment-delimiter">;; </span><span class="org-comment">Convert the TIFFs first</span>
      (mapc 'my/convert-index-card-to-png
            (directory-files <span class="org-string">"~/Dropbox/Inbox/"</span> t pattern)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/convert-and-upload-cards</span> ()
  <span class="org-doc">"Trust in existing filenames, upload without modification."</span>
  (<span class="org-keyword">interactive</span>)
  (my/convert-index-card-tiffs-to-pngs)
  (my/upload-scanned-cards))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/rename-scanned-card</span> (filename)
  (find-file filename)
  (delete-other-windows)
  (<span class="org-keyword">let</span> ((base (file-name-sans-extension filename))
        notes)
    (<span class="org-keyword">when</span> (string-match <span class="org-string">"/IMG.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+-[0-9]+-[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"> ?.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> base)
      (<span class="org-keyword">let</span> ((kill-buffer-query-functions nil)
            old-name
            (new-name (read-string <span class="org-string">"New name: "</span>
                                   (<span class="org-keyword">if</span> (match-string 1 base)
                                       (concat (match-string 1 base))
                                     <span class="org-string">""</span>))))
        (<span class="org-keyword">while</span> (<span class="org-keyword">and</span> (string-match <span class="org-string">"^[0-9]+-[0-9]+-[0-9]+[a-z]"</span> new-name)
                    (<span class="org-keyword">setq</span> old-name (my/get-sketch-filename (match-string 0 new-name)))
                    (<span class="org-keyword">and</span> old-name
                         (not (string= old-name filename))
                         (not (string= (file-name-nondirectory old-name)
                                       (concat (s-trim new-name) <span class="org-string">"."</span> (file-name-extension filename))))))
          (<span class="org-keyword">setq</span> new-name
                (read-string (format <span class="org-string">"Already exists (%s) - new name: "</span> old-name)
                             new-name)))
        (<span class="org-keyword">when</span> (string-match new-name <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> *| *</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>)
          (<span class="org-keyword">with-current-buffer</span> (find-file <span class="org-string">"~/Dropbox/orgzly/Inbox.org"</span>)
            (goto-char (point-max))
            (insert <span class="org-string">"\n* "</span> (match-string 1 new-name) <span class="org-string">"\n"</span> (match-string 2 new-name))
            (save-buffer))
          (<span class="org-keyword">setq</span> new-name (match-string 1 new-name)))
        (<span class="org-keyword">when</span> (&gt; (length new-name) 0)
          (revert-buffer t t)
          (rename-file filename (concat (s-trim new-name) <span class="org-string">"."</span> (file-name-extension filename)) t)
          (kill-buffer))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/rename-scanned-cards</span> ()
  <span class="org-doc">"Display and rename the scanned or saved files."</span>
  (<span class="org-keyword">interactive</span>)
  (my/convert-index-card-tiffs-to-pngs)
  (mapc (<span class="org-keyword">lambda</span> (o)
          (<span class="org-keyword">when</span> (string= (file-name-extension o) <span class="org-string">"psd"</span>)
            (my/convert-index-card-to-png o)
            (<span class="org-keyword">setq</span> o (concat (file-name-sans-extension o) <span class="org-string">".png"</span>)))
          (my/rename-scanned-card o))
        (reverse (directory-files <span class="org-string">"~/Dropbox/Inbox/"</span> t <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">IMG</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">[0-9]+-[0-9]+-[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">.*.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">psd</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">png</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">jpg</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>)))
  (my/upload-scanned-cards))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/clean-index-card-directory</span> ()
  <span class="org-doc">"Remove files marked for deletion and move private files."</span>
  (shell-command <span class="org-string">"mv ~/Dropbox/Inbox/*delete* ~/Dropbox/Inbox/backup"</span>)
  (shell-command <span class="org-string">"mv ~/Dropbox/Inbox/*private* ~/cloud/private-sketches/"</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/upload-scanned-cards</span> ()
  (<span class="org-keyword">interactive</span>)
  (my/clean-index-card-directory)
  (<span class="org-keyword">with-current-buffer</span> (get-buffer-create <span class="org-string">"*Files to be uploaded*"</span>)
    (erase-buffer)
    (insert (mapconcat 'identity (directory-files <span class="org-string">"~/Dropbox/Inbox"</span> nil <span class="org-string">"^[0-9]+-[0-9]+-[0-9]+[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string"> ]? .*.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">png</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">jpg</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>) <span class="org-string">"\n"</span>))
    (goto-char (point-min))
    (switch-to-buffer (current-buffer))
    (delete-other-windows))
  (shell-command <span class="org-string">"~/bin/copy-sketches"</span>))
</pre>
</div>

<p>
I might tweak the files a little more after I rename them, so I don't
automatically upload them. When I'm happy with the files, I use a <a href="http://sachachua.com/blog/?p=27830&amp;shareadraft=baba27830_54b92ac511e86">Node
script</a> to upload the files to Flickr, move them to my <code>To blog</code>
directory, and copy Org-formatted text that I can paste into my
learning outline.
</p>
</div>
</div>

<div id="outline-container-org58b3752" class="outline-4">
<h4 id="org58b3752">Automatically resize images</h4>
<div class="outline-text-4" id="text-org58b3752">
<p>
The <code>image+</code> package is handy for displaying the images so
that they're scaled to the window size.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">image+</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-comment-delimiter">;;    </span><span class="org-comment">:load-path "~/elisp/Emacs-imagex"</span>
  <span class="org-builtin">:commands</span> (imagex-global-sticky-mode imagex-auto-adjust-mode)
  <span class="org-builtin">:init</span> (<span class="org-keyword">progn</span> (imagex-global-sticky-mode) (imagex-auto-adjust-mode)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orge64ab12" class="outline-4">
<h4 id="orge64ab12">Get information for sketched books</h4>
<div class="outline-text-4" id="text-orge64ab12">
<p>
For sketchnotes of books, I set up the filename based on properties in
my Org Mode tree for that book.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/prepare-sketchnote-file</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let*</span> ((base-name (org-entry-get-with-inheritance  <span class="org-string">"BASENAME"</span>)))
    (<span class="org-keyword">unless</span> base-name (<span class="org-warning">error</span> <span class="org-string">"Missing basename property"</span>))
    (my/org-sketch-open (my/prepare-large-template base-name))))
</pre>
</div>

<p>
By using Emacs Lisp functions to set up files that I'm going to use in
an external application, I minimize fussing about with the keyboard
while still being able to take advantage of structured information.
</p>

<p>
Do you work with external applications? Where does it make sense to
use Emacs Lisp to make setup or processing easier?
</p>
</div>
</div>

<div id="outline-container-org8eabcf7" class="outline-4">
<h4 id="org8eabcf7">Make it easy to follow up on a sketch</h4>
<div class="outline-text-4" id="text-org8eabcf7">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/follow-up-on-sketch</span> (filename)
  <span class="org-doc">"Prompt for FILENAME to follow up on.</span>
<span class="org-doc">      Create an index card with it as a layer, and add the ref to the filename."</span>
  (<span class="org-keyword">interactive</span> (list (helm-read-file-name <span class="org-string">"Image: "</span> <span class="org-builtin">:initial-input</span> <span class="org-string">"~/sketches/"</span>)))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Allow the specification of a short identifier</span>
  (<span class="org-keyword">unless</span> (file-exists-p filename) 
    (<span class="org-keyword">setq</span> filename (car (directory-files <span class="org-string">"~/sketches"</span> t (concat <span class="org-string">"^"</span> filename)))))
  (<span class="org-keyword">let</span> ((async-shell-command-buffer 'new-buffer)
        (index-card (my/prepare-index-card-template      
                     (format <span class="org-string">"-- index card ref %s"</span>
                             (<span class="org-keyword">and</span> (string-match <span class="org-string">"^[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string"> \\.]+"</span> (file-name-nondirectory filename))
                                  (match-string 0 (file-name-nondirectory filename)))))))
    (shell-command (format <span class="org-string">"convert %s %s -colorspace cmyk %s"</span>
                           (shell-quote-argument (expand-file-name my/index-card-template-file))
                           (shell-quote-argument (expand-file-name filename))
                           (shell-quote-argument (expand-file-name index-card))))
    (shell-command (format <span class="org-string">"%s %s &amp;"</span>
                           (shell-quote-argument my/sketch-executable)
                           (shell-quote-argument (expand-file-name index-card))))
    (my/rotate-screen 180)
    (my/set-up-sketch-buffer)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org58f5d5a" class="outline-4">
<h4 id="org58f5d5a">Move to-blog sketches to a staging folder for easier upload</h4>
<div class="outline-text-4" id="text-org58f5d5a">
<p>
This function moves the specified files from my <code>To blog</code> folder to my
<code>Selection</code> folder. That makes it easier to upload them to Wordpress
and then delete them afterwards. I use the Wordpress web interface
instead of org2blog's file upload support because sometimes the
Org2blog file uploads don't work as well as I'd like, and I haven't
looked into debugging that yet.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-stage-image-files-in-subtree</span> ()
  <span class="org-doc">"Move corresponding linked images to staging directory."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">save-restriction</span>
      (org-narrow-to-subtree)
      (goto-char (point-min))
      (<span class="org-keyword">while</span> (re-search-forward org-bracket-link-regexp nil t)
        (<span class="org-keyword">let</span> ((filename (file-name-nondirectory (<span class="org-keyword">or</span> (match-string 3) (match-string 1)))))
          (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (string-match <span class="org-string">"\\.png$"</span> filename)
                     (file-exists-p (expand-file-name filename <span class="org-string">"~/Dropbox/Inbox/To blog"</span>)))
            (rename-file
             (expand-file-name filename <span class="org-string">"~/Dropbox/Inbox/To blog"</span>)
             <span class="org-string">"~/Dropbox/Inbox/Selection"</span>)))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgeed3c33" class="outline-4">
<h4 id="orgeed3c33">Digital index piles with Emacs</h4>
<div class="outline-text-4" id="text-orgeed3c33">
<p>
Somewhat daunted by the prospect of categorizing more than a hundred
sketches and blog posts for my monthly review, I spent some time
figuring out how to create the digital equivalent of sorting index
cards into various piles.
</p>

<p>
<a href="https://www.flickr.com/photos/sachac/16234413499/">2015-02-01 Digital piles of index cards &#x2013; index card #indexing #organization #pkm</a>
</p>

<p>
In fact, wouldn't it be super-cool if the items could automatically
guess which category they should probably go in, prompting me only if
it wasn't clear?
</p>

<p>
I wanted to write a function that could take a list structured like this:
</p>

<ul class="org-ul">
<li>Keyword A
<ul class="org-ul">
<li>Previous links</li>
</ul></li>
<li>Keyword B
<ul class="org-ul">
<li>Previous links</li>
</ul></li>
<li>Link 1 with Keyword A</li>
<li>Link 2 with Keyword B</li>
<li>Link 3 with Keyword A</li>
<li><p>
Link 4
</p>

<p>
It should file Link 1 and 3 under Keyword A, Link 2 under Keyword B,
and prompt me for the category for Link 4. At that prompt, I should be
able to select Keyword A or Keyword B, or specify a new category.
</p>

<p>
Inspired by John Kitchin's recent post on <a href="http://kitchingroup.cheme.cmu.edu/blog/2015/01/24/Anatomy-of-a-helm-source/">defining a Helm source</a>, I
wanted to get it to work with Helm.
</p>

<p>
First step: I needed to figure out the structure of the list, maybe
including a sample from the category to make it clearer what's
included. <code>org-list.el</code> seemed to have useful functions for this.
<code>org-list-struct</code> gave me the structure of the current list. Let's say
that a category is anything whose text does not match
<code>org-bracket-link-regexp</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-get-list-categories</span> ()
  <span class="org-doc">"Return a list of (category indent matching-regexp sample).</span>
<span class="org-doc">        List categories are items that don't contain links."</span>
  (<span class="org-keyword">let</span> ((list (org-list-struct)) last-category results)
    (<span class="org-keyword">save-excursion</span>
      (mapc
       (<span class="org-keyword">lambda</span> (x)
         (goto-char (car x))
         (<span class="org-keyword">let</span> ((current-item
                (buffer-substring-no-properties
                 (+ (point)
                    (elt x 1)
                    (length (elt x 2)))
                 (line-end-position))))
           (<span class="org-keyword">if</span> (string-match
                org-bracket-link-regexp
                (buffer-substring-no-properties
                 (point)
                 (line-end-position)))
               <span class="org-comment-delimiter">;; </span><span class="org-comment">Link - update the last category</span>
               (<span class="org-keyword">when</span> last-category
                 (<span class="org-keyword">if</span> (&lt; (elt x 1) (elt last-category 1))
                     (<span class="org-keyword">setq</span> results
                           (cons (append last-category
                                         (list
                                          (match-string-no-properties
                                           3
                                           (buffer-substring-no-properties
                                            (point)
                                            (line-end-position)))))
                                 (cdr results))))
                 (<span class="org-keyword">setq</span> last-category nil))
             <span class="org-comment-delimiter">;; </span><span class="org-comment">Category</span>
             (<span class="org-keyword">setq</span> results
                   (cons
                    (<span class="org-keyword">setq</span> last-category
                          (list
                           current-item
                           (elt x 1)
                           (concat <span class="org-string">"^"</span>
                                   (make-string (elt x 1) ?\ )
                                   (regexp-quote
                                    (concat (elt x 2)
                                            current-item))
                                   <span class="org-string">"$"</span>)))
                    results)))))
       list))
    (append '((<span class="org-string">"x"</span> 2 <span class="org-string">"^$"</span> nil)) results)))
</pre>
</div>

<p>
The next step was to write a function that guessed the list category
based on the item text, and moved the item there.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/helm-org-list-candidates</span> nil)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/helm-org-list-categories-init-candidates</span> ()
  <span class="org-doc">"Return a list of categories from this list in a form ready for Helm."</span>
  (<span class="org-keyword">setq</span> my/helm-org-list-candidates
        (mapcar (<span class="org-keyword">lambda</span> (x)
                  (cons (<span class="org-keyword">if</span> (elt x 3)
                            (format <span class="org-string">"%s - %s"</span> (car x) (elt x 3))
                          (car x))
                        x))
                (my/org-get-list-categories))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-guess-list-category</span> (<span class="org-type">&amp;optional</span> categories)
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">cl-lib</span>)
  (<span class="org-keyword">unless</span> categories
    (<span class="org-keyword">setq</span> categories
          (my/helm-org-list-categories-init-candidates)))
  (<span class="org-keyword">let*</span> ((beg (line-beginning-position))
         (end (line-end-position))
         (string (buffer-substring-no-properties beg end))
         (found
          (cl-member string
                     categories
                     <span class="org-builtin">:test</span>
                     (<span class="org-keyword">lambda</span> (string cat-entry)
                       (<span class="org-keyword">unless</span> (string= (car cat-entry) <span class="org-string">"x"</span>)
                         (string-match (regexp-quote (downcase (car cat-entry)))
                                       string))))))
    (<span class="org-keyword">when</span> (car found)
      (my/org-move-current-item-to-category
       (cdr (car found)))
      t)))
</pre>
</div>

<p>
After that, I wrote a function that used Helm to prompt me for a
category in case it couldn't guess the category. It took me a while to
figure out that I needed to use <code>:init</code> instead of <code>:candidates</code>
because I wanted to read information from the buffer before Helm
kicked in.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/org-browse-link-while-categorizing</span> 'eww-readable
  <span class="org-doc">"Set to nil to skip browsing."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-guess-uncategorized</span> ()
  <span class="org-doc">"Interactively move linked list items to categories from the list.</span>
<span class="org-doc">        Try to guess categories based on substring matches."</span>
  (<span class="org-keyword">interactive</span>)
                                        <span class="org-comment-delimiter">;</span><span class="org-comment">(my/helm-org-list-categories-init-candidates)</span>
  (<span class="org-keyword">let</span> ((categories (my/org-get-list-categories))
        category)
    (<span class="org-keyword">while</span> (<span class="org-keyword">and</span> (looking-at <span class="org-string">"^[-+] \\[\\[</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">]]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\]\\[</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">]]+*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>)
                (not (string= <span class="org-string">"done"</span> category)))
      (<span class="org-keyword">save-excursion</span>
        <span class="org-comment-delimiter">;; </span><span class="org-comment">(when (eq my/org-browse-link-while-categorizing 'eww-readable)</span>
        <span class="org-comment-delimiter">;;   </span><span class="org-comment">(save-excursion (save-match-data (my/eww-browse-readable (match-string 1)))))</span>
        (<span class="org-keyword">setq</span> category (completing-read (match-string 2) categories))
        (<span class="org-keyword">unless</span> (string= category <span class="org-string">"done"</span>)
          (my/org-move-current-item-to-category category))))))

<span class="org-comment-delimiter">;; </span><span class="org-comment">From https://emacs.stackexchange.com/questions/36284/how-to-open-eww-in-readable-mode/47757</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my/eww-readable-nonce</span> ()
  <span class="org-doc">"Once-off call to `</span><span class="org-doc"><span class="org-constant">eww-readable</span></span><span class="org-doc">' after EWW is done rendering."</span>
  (<span class="org-keyword">unwind-protect</span>
      (eww-readable)
    (remove-hook 'eww-after-render-hook #'my/eww-readable-nonce)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/eww-browse-readable</span> (url)
  (<span class="org-keyword">when</span> (looking-at <span class="org-string">"^[-+] \\[\\[</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">]]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>)
    (add-hook 'eww-after-render-hook #'my/eww-readable-nonce)
    (eww (match-string 1))))

</pre>
</div>

<p>
Actually, it might be helpful to be able to sort lists by a keyword.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-sort-list-by-regexp</span> (regexp)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MRegexp: "</span>)
  (<span class="org-keyword">let</span> ((sort-func
         (<span class="org-keyword">lambda</span> ()
           (<span class="org-keyword">let</span> ((line (buffer-substring-no-properties (point) (line-end-position))))
             (<span class="org-keyword">if</span> (string-match regexp line)
                 (<span class="org-keyword">if</span> (string-match org-bracket-link-regexp line)
                     (match-string 2 line)
                   <span class="org-string">"ZZZ"</span>)
               <span class="org-string">"ZZZZZ"</span>)))))
    (funcall
     (<span class="org-keyword">cond</span>
      ((org-at-table-p) 'org-table-sort-lines)
      ((org-at-item-p) 'org-sort-list)
      (t 'org-sort-entries))
     nil ?f sort-func 'string&lt;)))
</pre>
</div>

<p>
This one files sketches into the headings I've started using in questions.org.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/refile-sketches-to-questions</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">while</span> (looking-at <span class="org-string">"^  \\+ \\[\\[</span><span class="org-string"><span class="org-constant">.*?\\</span></span><span class="org-string">]\\[</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> -- </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\]\\]\n"</span>)
    (<span class="org-keyword">let</span> ((link (match-string 0))
          (title (match-string 1)))
      (<span class="org-keyword">save-excursion</span>
        (<span class="org-keyword">if</span> (<span class="org-keyword">save-match-data</span> (search-forward (concat <span class="org-string">"* "</span> title) nil t))
            (<span class="org-keyword">progn</span> (forward-line) (insert (match-string 0)) (replace-match <span class="org-string">""</span>))
          (forward-line 1))))))
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-insert-point" class="outline-4">
<h4 id="insert-point">Sketched books</h4>
<div class="outline-text-4" id="text-insert-point">
<p>
Convenience functions to make my life easier when sketchnoting books.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> yas-indent-line 'fixed)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/convert-sketch-title-to-filename</span> (text)
  (<span class="org-keyword">setq</span> text (replace-regexp-in-string <span class="org-string">"[?!]$"</span> <span class="org-string">""</span> text))
  (<span class="org-keyword">setq</span> text (replace-regexp-in-string <span class="org-string">"[?!:] "</span> <span class="org-string">" - "</span> text)))
(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my/convert-sketch-title-to-filename</span> ()
  (<span class="org-keyword">should</span> (string= (my/convert-sketch-title-to-filename <span class="org-string">"Test"</span>) <span class="org-string">"Test"</span>))
  (<span class="org-keyword">should</span> (string= (my/convert-sketch-title-to-filename <span class="org-string">"Another Test!"</span>) <span class="org-string">"Another Test"</span>))
  (<span class="org-keyword">should</span> (string= (my/convert-sketch-title-to-filename <span class="org-string">"Does this work? Yes"</span>) <span class="org-string">"Does this work - Yes"</span>))
  (<span class="org-keyword">should</span> (string= (my/convert-sketch-title-to-filename <span class="org-string">"Title: Subtitle"</span>) <span class="org-string">"Title - Subtitle"</span>))
  )

(<span class="org-keyword">defun</span> <span class="org-function-name">my/convert-sketched-book-to-png</span> ()
  <span class="org-doc">"Convert TIFF to PNG."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((basename (org-entry-get-with-inheritance <span class="org-string">"BASENAME"</span>)))
    (shell-command (format <span class="org-string">"convert \"c:/sacha/dropbox/inbox/%s.tif\" \"c:/sacha/dropbox/inbox/%s.png\""</span>
                           basename
                           basename))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/index-sketched-book</span> ()
  <span class="org-doc">"Add entries to sketched books index."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let*</span> ((title (org-entry-get-with-inheritance <span class="org-string">"SHORT_TITLE"</span>))
         (author (org-entry-get-with-inheritance <span class="org-string">"AUTHOR"</span>))
         (basename (org-entry-get-with-inheritance <span class="org-string">"BASENAME"</span>))
         (base-file (format <span class="org-string">"~/Dropbox/Inbox/%s.png"</span> basename)))
    (<span class="org-keyword">when</span> (file-exists-p base-file)
      (copy-file base-file
                 (format <span class="org-string">"~/Dropbox/Packaging/sketched-books/%s.png"</span> basename) t t))
    (find-file <span class="org-string">"~/Dropbox/Packaging/sketched-books/index.org"</span>)
    (vc-git-register (list (format <span class="org-string">"%s.png"</span> basename)))
    (goto-char (point-min))
    (re-search-forward <span class="org-string">"&lt;&lt;insert-point&gt;&gt;"</span>)
    (insert (format <span class="org-string">"\n- [[file:%s.png][%s - %s (sketched %s)]]\n  [[file:%s.png]]\n\n"</span>
                    basename
                    title
                    author
                    (substring basename 0 10)
                    basename))
    (find-file <span class="org-string">"~/Dropbox/Packaging/sketched-books/ebook.org"</span>)
    (goto-char (point-min))
    (re-search-forward <span class="org-string">"&lt;&lt;insert-point&gt;&gt;"</span>)
    (insert (format <span class="org-string">"\n* %s - %s (sketched %s)\n\n[[file:%s.png]]\n\n"</span>
                    title
                    author
                    (substring basename 0 10)
                    basename))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/package-sketched-book</span> ()
  <span class="org-doc">"Add the latest sketch and package the collection."</span>
  (<span class="org-keyword">interactive</span>)
  (shell-command
   (format <span class="org-string">"plink -A vagrant@127.0.0.1 -P 2222 \"cd ~/Dropbox/Packaging/sketched-books; git add '%s.png'; git commit -m 'Added %s - %s' -a; git push; make all\" &amp;"</span>
           (org-entry-get-with-inheritance <span class="org-string">"BASENAME"</span>)
           (org-entry-get-with-inheritance <span class="org-string">"SHORT_TITLE"</span>)
           (org-entry-get-with-inheritance <span class="org-string">"AUTHOR"</span>))))

</pre>
</div>
</div>
</div>

<div id="outline-container-org877d3ec" class="outline-4">
<h4 id="org877d3ec">Other sketches</h4>
<div class="outline-text-4" id="text-org877d3ec">
<p>
Based on <a href="http://williamedwardscoder.tumblr.com/post/84505278488/making-image-mosaics">http://williamedwardscoder.tumblr.com/post/84505278488/making-image-mosaics</a>
Aspect ratio is width / height
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/get-tile-dimensions</span> (num-items orig-width orig-height target-aspect-ratio)
  (<span class="org-keyword">let</span> ((rows 1) (cols 1)
        (current-aspect (/ orig-width (float orig-height)))
        add-col-aspect
        add-row-aspect)
    (<span class="org-keyword">while</span> (&lt; (* rows cols) num-items)
      (<span class="org-keyword">setq</span> add-col-aspect (/ (* (1+ cols) (float orig-width))
                              (* rows orig-height))
            add-row-aspect (/ (* cols (float orig-width))
                              (* (1+ rows) orig-height)))
      (<span class="org-keyword">if</span> (&lt;  (abs (- add-col-aspect target-aspect-ratio))
              (abs (- add-row-aspect target-aspect-ratio)))
          (<span class="org-keyword">setq</span> cols (1+ cols))
        (<span class="org-keyword">setq</span> rows (1+ rows))))
    (cons cols rows)))
(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my/get-tile-dimensions</span> ()
  (<span class="org-keyword">should</span> (equal (my/get-tile-dimensions 2 2 1 1) (cons 1 2)))
  (<span class="org-keyword">should</span> (equal (my/get-tile-dimensions 4 2 1 0.5) (cons 1 4)))
  (<span class="org-keyword">should</span> (equal (my/get-tile-dimensions 12 1 1 (/ 4.0 3.0)) (cons 4 3)))
  (<span class="org-keyword">should</span> (equal (my/get-tile-dimensions 11 1 1 (/ 4.0 3.0)) (cons 4 3)))
  (<span class="org-keyword">should</span> (equal (my/get-tile-dimensions 13 1 1 (/ 4.0 3.0)) (cons 4 4))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/extract-image-filenames</span> (beg end)
  <span class="org-doc">"Return the filenames from the links in this region."</span>
  (<span class="org-keyword">let</span> (files)
    (<span class="org-keyword">save-excursion</span>
      (goto-char (min beg end))
      (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"sketch:"</span> (max beg end) t)
        (<span class="org-keyword">let</span> ((link (org-element-context)))
          (add-to-list 'files (org-element-property <span class="org-builtin">:path</span> link))))
      files)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/create-sketch-montage</span> (files <span class="org-type">&amp;optional</span> tiles)
  <span class="org-doc">"Combine the sketches in the region."</span>
  (<span class="org-keyword">interactive</span>
   (list
    (<span class="org-keyword">if</span> (derived-mode-p 'dired-mode)
        (dired-get-marked-files)
      (mapcar 'my/get-sketch-filename
              (my/extract-image-filenames (min (point) (mark)) (max (point) (mark)))))
    (<span class="org-keyword">if</span> current-prefix-arg (read-string <span class="org-string">"Tiling: "</span>))))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Extract the links</span>
  (<span class="org-keyword">let</span> ((output-file <span class="org-string">"~/Dropbox/Inbox/output.png"</span>))
    (<span class="org-keyword">unless</span> tiles
      (<span class="org-keyword">setq</span> tiles
            (format <span class="org-string">"%dx"</span>
                    (car (my/get-tile-dimensions (length files) 1500 900 (/ 4.0 3))))))
    (<span class="org-keyword">with-temp-buffer</span>
      (cd <span class="org-string">"~/Dropbox/Inbox/To blog"</span>)
      (apply 'call-process
             <span class="org-string">"montage"</span> nil nil nil
             (append
              files
              (list
               <span class="org-string">"-geometry"</span> <span class="org-string">"1500x900&gt;+0+0"</span>
               <span class="org-string">"-tile"</span> tiles
               (expand-file-name output-file)))))
    (<span class="org-keyword">if</span> (called-interactively-p 'any) (find-file output-file))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/create-week-montage</span> (beg end)
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">let*</span> ((date (org-read-date nil nil (<span class="org-keyword">unless</span> current-prefix-arg <span class="org-string">"-fri"</span>)))
         (filename (format <span class="org-string">"Week ending %s #journal #weekly"</span> date))
         (full-filename (my/get-sketch-filename filename)))
    (<span class="org-keyword">if</span> full-filename
        (my/org-sketch-open full-filename)
      (my/create-index-card-montage 
       (mapcar 'my/get-sketch-filename
               (my/extract-image-filenames (min (point) (mark)) (max (point) (mark)))) 
       <span class="org-string">"2x"</span>
       (my/prepare-index-card-template filename)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/create-index-card-montage</span> (files <span class="org-type">&amp;optional</span> tiling filename)
  <span class="org-doc">"Prepare an index card with a montage of the selected sketches as a layer."</span>
  (<span class="org-keyword">interactive</span>
   (list
    (<span class="org-keyword">if</span> (derived-mode-p 'dired-mode)
        (dired-get-marked-files)
      (mapcar 'my/get-sketch-filename
              (my/extract-image-filenames (min (point) (mark)) (max (point) (mark)))))))
  (<span class="org-keyword">let</span> ((async-shell-command-buffer 'new-buffer)
        (index-card (<span class="org-keyword">or</span> filename (my/prepare-index-card-template))))
    (my/create-sketch-montage files tiling)
    (shell-command
     (format <span class="org-string">"convert %s </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"> %s -resize 1500x900 </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> -colorspace cmyk %s"</span>
             (shell-quote-argument (expand-file-name my/index-card-template-file))
             (shell-quote-argument (expand-file-name <span class="org-string">"~/Dropbox/Inbox/output.png"</span>))
             (shell-quote-argument (expand-file-name index-card))))
    (shell-command (format <span class="org-string">"%s %s &amp;"</span>
                           (shell-quote-argument my/sketch-executable)
                           (shell-quote-argument (expand-file-name index-card))))
    (my/rotate-screen 180)
    (my/set-up-sketch-buffer)))

</pre>
</div>

<p>
add-output-png is:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">bash</span>

xdotool windowactivate --sync $(xdotool search --name krita | tail -1); sleep 1
xdotool key --delay 50 Alt+l n m ; sleep 3
xdotool type ~/Dropbox/Inbox/output.png ; sleep 1
xdotool key Return ; sleep 3
xdotool key Alt+l l ; sleep 1
xdotool key Tab Tab ; sleep 1
xdotool type 896 ; sleep 1
xdotool key Return
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfb2f682" class="outline-4">
<h4 id="orgfb2f682">Other sketch-related functions</h4>
<div class="outline-text-4" id="text-orgfb2f682">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/show-sketches-as-slideshow</span> (list <span class="org-type">&amp;optional</span> shuffle)
  <span class="org-doc">"Display a quick slideshow of sketches in LIST.</span>
<span class="org-doc">          If LIST is a string, look up those sketch filenames in my Flickr copy."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"MFilter: \nP"</span>)
  (apply 'call-process <span class="org-string">"feh"</span> nil nil nil <span class="org-string">"-D"</span> <span class="org-string">"1"</span> <span class="org-string">"-F"</span> (<span class="org-keyword">if</span> shuffle <span class="org-string">"-z"</span> <span class="org-string">""""</span>) 
         (-filter (<span class="org-keyword">lambda</span> (x) (string-match <span class="org-string">"photostream"</span> x))
                  (<span class="org-keyword">if</span> (stringp list)
                      (my/list-sketches list t)
                    list))))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/org-index-card-source</span> nil)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-prompt-index-cards</span> ()
  <span class="org-doc">"Display a buffer for easy selection of questions to work on."</span>
  (<span class="org-keyword">interactive</span>)
  (find-file <span class="org-string">"~/personal/questions.org"</span>)
  (<span class="org-keyword">let</span> ((questions
         (cl-sort (org-map-entries 'org-heading-components <span class="org-string">"TODO=\"DRAW\""</span>)
                  '&lt; <span class="org-builtin">:key</span> (<span class="org-keyword">lambda</span> (x) (<span class="org-keyword">or</span> (elt x 3) 100)))))
    (<span class="org-keyword">setq</span> my/org-index-card-source (current-buffer))
    (my/rotate-screen 180)
    (my/set-up-sketch-buffer)
    (mapc (<span class="org-keyword">lambda</span> (q)
            (widget-create 'push-button
                           <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (widget <span class="org-type">&amp;rest</span> ignore)
                                     (my/org-sketch-open
                                      (my/prepare-index-card-template
                                       (widget-value widget)))
                                     (<span class="org-keyword">with-current-buffer</span> my/org-index-card-source
                                       (<span class="org-keyword">save-excursion</span>
                                         (goto-char (org-find-exact-headline-in-buffer (widget-value widget) my/org-index-card-source t))
                                         (org-set-property <span class="org-string">"Effort"</span> <span class="org-string">"0:15"</span>)
                                         (org-clock-in)
                                         (org-todo <span class="org-string">"LINK"</span>)))
                                     (widget-delete widget))
                           (elt q 4))
            (insert <span class="org-string">"\n"</span>))
          questions)
    (text-scale-set 5)
    (widget-setup)
    (widget-minor-mode)
    (goto-char (point-min))
    (<span class="org-keyword">when</span> (functionp 'scroll-bar-mode) (scroll-bar-mode))
    (switch-to-buffer (current-buffer))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/prepare-index-card-for-journal</span> ()
  <span class="org-doc">"Create an index card for my process journal."</span>
  (<span class="org-keyword">interactive</span>)
  (quantified-track <span class="org-string">"Drawing"</span>)
  (my/prepare-index-card <span class="org-string">"Journal"</span>))

(add-to-list 'org-speed-commands-user '(<span class="org-string">"d"</span> call-interactively 'my/prepare-index-card-for-subtree))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd1691ed" class="outline-3">
<h3 id="orgd1691ed">Tools for organizing</h3>
<div class="outline-text-3" id="text-orgd1691ed">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/rename-bank-statements</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((months '(<span class="org-string">"Jan"</span> <span class="org-string">"Feb"</span> <span class="org-string">"Mar"</span> <span class="org-string">"Apr"</span> <span class="org-string">"May"</span> <span class="org-string">"Jun"</span> <span class="org-string">"Jul"</span> <span class="org-string">"Aug"</span> <span class="org-string">"Sep"</span> <span class="org-string">"Oct"</span> <span class="org-string">"Nov"</span> <span class="org-string">"Dec"</span>)))
    (<span class="org-keyword">cl-loop</span> for i from 1 to 12 do
             (message <span class="org-string">"%d"</span> i)
             (goto-char (point-min))
             (<span class="org-keyword">while</span> (re-search-forward (elt months (1- i)) nil t)
               (<span class="org-keyword">ignore-errors</span>
                 (replace-match (format <span class="org-string">"%02d"</span> i))
                 )))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my/rename-scanned-receipts</span> ()
  <span class="org-doc">"Display and rename the scanned or saved files."</span>
  (<span class="org-keyword">interactive</span>)
  (delete-other-windows)
  (mapc (<span class="org-keyword">lambda</span> (o)
          (find-file o)
          (<span class="org-keyword">let</span> ((new-name (concat (read-string <span class="org-string">"New filename: "</span>) <span class="org-string">".jpg"</span>)))
            (kill-buffer)
            (<span class="org-keyword">unless</span> (string= new-name <span class="org-string">".jpg"</span>)
              (rename-file o new-name))))
        (<span class="org-keyword">or</span> (<span class="org-keyword">if</span> (derived-mode-p 'dired-mode)
                (dired-get-marked-files))
            (directory-files default-directory t <span class="org-string">"^[-_0-9]+\\.jpg"</span>))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb0d45fe" class="outline-3">
<h3 id="orgb0d45fe">Games</h3>
<div class="outline-text-3" id="text-orgb0d45fe">
</div>
<div id="outline-container-org08bc4b2" class="outline-4">
<h4 id="org08bc4b2">Typing of Emacs</h4>
<div class="outline-text-4" id="text-org08bc4b2">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">typing</span> <span class="org-builtin">:disabled</span> t
  <span class="org-builtin">:init</span>
  (autoload 'typing-of-emacs <span class="org-string">"typing"</span> nil t)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">progn</span>
    (<span class="org-keyword">setq</span> toe-starting-length 6)
    (<span class="org-keyword">setq</span> toe-starting-time-per-word 2)
    (<span class="org-keyword">setq</span> toe-max-length 20)))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd9a4fb5" class="outline-3">
<h3 id="orgd9a4fb5">Speech synthesis (experimental)</h3>
<div class="outline-text-3" id="text-orgd9a4fb5">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/espeak-command</span> <span class="org-string">"c:/program files (x86)/espeak/command_line/espeak.exe"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my/say</span> (string <span class="org-type">&amp;optional</span> speed)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MString: "</span>)
  (<span class="org-keyword">setq</span> speed (<span class="org-keyword">or</span> speed 175))
  (call-process my/espeak-command nil nil nil string <span class="org-string">"-s"</span> speed))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3c53962" class="outline-2">
<h2 id="org3c53962">Exwm</h2>
<div class="outline-text-2" id="text-org3c53962">
<p>
Hmmm, I'm having a hard time getting used to this.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> <span class="org-constant">exwm</span>
  <span class="org-builtin">:if</span> my/laptop-p
  <span class="org-builtin">:init</span> 
  (<span class="org-keyword">progn</span> 
    (<span class="org-keyword">require</span> '<span class="org-constant">exwm-config</span>)
    (exwm-config-default)
    (exwm-enable)
    (exwm-input-set-key (kbd <span class="org-string">"s-p"</span>) 'fhd/toggle-exwm-input-line-mode-passthrough)
    (exwm-input-set-key (kbd <span class="org-string">"s-i"</span>) #'fhd/exwm-input-toggle-mode)))

<span class="org-comment-delimiter">;; </span><span class="org-comment">https://emacs.stackexchange.com/questions/33326/how-do-i-cut-and-paste-effectively-between-applications-while-using-exwm</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">fhd/exwm-input-line-mode</span> ()
  <span class="org-doc">"Set exwm window to line-mode and show mode line"</span>
  (call-interactively #'exwm-input-grab-keyboard)
  (exwm-layout-show-mode-line))

(<span class="org-keyword">defun</span> <span class="org-function-name">fhd/exwm-input-char-mode</span> ()
  <span class="org-doc">"Set exwm window to char-mode and hide mode line"</span>
  (call-interactively #'exwm-input-release-keyboard)
  (exwm-layout-hide-mode-line))

(<span class="org-keyword">defun</span> <span class="org-function-name">fhd/exwm-input-toggle-mode</span> ()
  <span class="org-doc">"Toggle between line- and char-mode"</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">with-current-buffer</span> (window-buffer)
    (<span class="org-keyword">when</span> (eq major-mode 'exwm-mode)
      (<span class="org-keyword">if</span> (equal (second (second mode-line-process)) <span class="org-string">"line"</span>)
          (fhd/exwm-input-char-mode)
        (fhd/exwm-input-line-mode)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">fhd/toggle-exwm-input-line-mode-passthrough</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">if</span> exwm-input-line-mode-passthrough
      (<span class="org-keyword">progn</span>
        (<span class="org-keyword">setq</span> exwm-input-line-mode-passthrough nil)
        (message <span class="org-string">"App receives all the keys now (with some simulation)"</span>))
    (<span class="org-keyword">progn</span>
      (<span class="org-keyword">setq</span> exwm-input-line-mode-passthrough t)
      (message <span class="org-string">"emacs receives all the keys now"</span>)))
  (force-mode-line-update))
</pre>
</div>
</div>
</div>

<div id="outline-container-org175a6f2" class="outline-2">
<h2 id="org175a6f2">Path</h2>
<div class="outline-text-2" id="text-org175a6f2">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">when</span> (eq system-type 'windows-nt)
  (setenv <span class="org-string">"PATH"</span> (concat <span class="org-string">"\"c:/program files/postgresql/9.3/bin;\""</span> (getenv <span class="org-string">"PATH"</span>))))
</pre>
</div>
</div>
</div>


<div id="outline-container-orge124634" class="outline-2">
<h2 id="orge124634">Local Variables</h2>
<div class="outline-text-2" id="text-orge124634">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my/unfocusing</span> nil)
(<span class="org-keyword">defun</span> <span class="org-function-name">run-with-local-idle-timer</span> (secs repeat function <span class="org-type">&amp;rest</span> args)
  <span class="org-doc">"Like `</span><span class="org-doc"><span class="org-constant">run-with-idle-timer</span></span><span class="org-doc">', but always runs in the `</span><span class="org-doc"><span class="org-constant">current-buffer</span></span><span class="org-doc">'.</span>

<span class="org-doc">Cancels itself, if this buffer was killed."</span>
  (<span class="org-keyword">let*</span> (<span class="org-comment-delimiter">;; </span><span class="org-comment">Chicken and egg problem.</span>
         (fns (make-symbol <span class="org-string">"local-idle-timer"</span>))
         (timer (apply 'run-with-idle-timer secs repeat fns args))
         (fn `(<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> args)
                (<span class="org-keyword">if</span> (not (buffer-live-p ,(current-buffer)))
                    (cancel-timer ,timer)
                  (<span class="org-keyword">with-current-buffer</span> ,(current-buffer)
                    (apply (<span class="org-keyword">function</span> ,function) args))))))
    (fset fns fn)
    fn))
(<span class="org-keyword">defun</span> <span class="org-function-name">my/org-babel-tangle-if-saved-in-focus</span> ()
  (<span class="org-keyword">unless</span> my/unfocusing
    (run-with-local-idle-timer 5 nil #'org-babel-tangle)))
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

       <style type="text/css">
       .back-to-top {
           position: fixed;
           bottom: 2em;
           right: 0px;
           text-decoration: none;
           color: #000000;
           background-color: rgba(235, 235, 235, 0.80);
           font-size: 12px;
           padding: 1em;
           display: none;
       }

       .back-to-top:hover {
           background-color: rgba(135, 135, 135, 0.50);
       }
       </style>

       <div class="back-to-top">
       <a href="#top">Back to top</a> | <a href="mailto:sacha@sachachua.com">E-mail me</a>
       </div>

       <script type="text/javascript">
           var offset = 220;
           var duration = 500;
           jQuery(window).scroll(function() {
               if (jQuery(this).scrollTop() > offset) {
                   jQuery('.back-to-top').fadeIn(duration);
               } else {
                   jQuery('.back-to-top').fadeOut(duration);
               }
           });
       </script>
</div>
</body>
</html>
